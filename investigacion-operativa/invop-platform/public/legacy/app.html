<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INVOP AI — Operations Research Intelligence</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2G8NYT7VQS"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-2G8NYT7VQS');</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
:root{--p:#6C3CE1;--pl:#8B5CF6;--ac:#06D6A0;--bg:#0F0F1A;--bg2:#1A1A2E;--card:#22223A;--card2:#2A2A44;--tx:#E8E8F0;--ts:#9898B0;--bd:#33334D;--ok:#06D6A0;--wr:#FFD166;--dn:#EF476F;--glow:0 0 20px rgba(108,60,225,.25);--sh:0 2px 8px rgba(0,0,0,.3);--shl:0 8px 32px rgba(0,0,0,.4);--radius:16px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--tx);height:100vh;overflow:hidden;-webkit-text-size-adjust:100%}
body.landing-mode{overflow-y:auto;height:auto}

/* LANDING PAGE */
.landing{min-height:100vh;position:relative;z-index:100}
.app-wrap{display:flex;flex-direction:column;height:100vh;opacity:0;pointer-events:none;transition:opacity .6s ease}
body.app-mode .landing{display:none}
body.app-mode .app-wrap{opacity:1;pointer-events:all}

/* Landing hero */
.land-hero{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:2rem;position:relative;overflow:hidden}
.land-hero::before{content:'';position:absolute;width:600px;height:600px;background:radial-gradient(circle,rgba(108,60,225,.15),transparent 70%);top:-100px;right:-100px;pointer-events:none}
.land-hero::after{content:'';position:absolute;width:500px;height:500px;background:radial-gradient(circle,rgba(6,214,160,.1),transparent 70%);bottom:-100px;left:-100px;pointer-events:none}
.land-hero h1{font-size:clamp(2rem,5vw,3.5rem);font-weight:800;line-height:1.15;margin-bottom:1rem;position:relative}
.land-hero h1 span{background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.land-sub{font-size:clamp(.95rem,2vw,1.2rem);color:var(--ts);max-width:600px;line-height:1.7;margin-bottom:2.5rem;position:relative}
.scroll-hint{position:absolute;bottom:2rem;animation:float 2s ease-in-out infinite;cursor:pointer;color:var(--ts);font-size:.8rem;display:flex;flex-direction:column;align-items:center;gap:.3rem}
.scroll-hint svg{width:24px;height:24px;stroke:var(--ac);stroke-width:2;fill:none}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(8px)}}

/* Landing sections */
.land-section{min-height:auto;display:flex;align-items:center;justify-content:center;padding:3.5rem 2rem;position:relative}
.land-section:nth-child(even){background:var(--bg2)}
.land-content{max-width:900px;width:100%}
.land-content h2{font-size:clamp(1.5rem,3.5vw,2.2rem);font-weight:800;margin-bottom:1rem;line-height:1.2}
.land-content h2 span{background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.land-content>p{color:var(--ts);font-size:clamp(.9rem,1.5vw,1.05rem);line-height:1.7;margin-bottom:2rem;max-width:650px}

/* 3 pillars grid */
.pillars{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-top:1.5rem}
.pillars-4{grid-template-columns:repeat(4,1fr)}
.pillars-7{grid-template-columns:repeat(4,1fr)}
.pillar{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:1.8rem 1.5rem;position:relative;overflow:hidden;transition:all .35s}
.pillar::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--p),var(--ac));transform:scaleX(0);transition:transform .35s;transform-origin:left}
.pillar:hover{border-color:var(--pl);transform:translateY(-4px);box-shadow:var(--glow)}.pillar:hover::before{transform:scaleX(1)}
.pillar-icon{font-size:2.2rem;margin-bottom:.8rem;display:block}
.pillar h3{font-size:1rem;font-weight:700;margin-bottom:.5rem;color:var(--tx)}
.pillar p{font-size:.85rem;color:var(--ts);line-height:1.6}

/* 3 questions */
.questions{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-top:1.5rem}
.q-card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:1.8rem 1.5rem;position:relative;transition:all .35s}
.q-card::after{content:'';position:absolute;inset:0;border-radius:16px;background:linear-gradient(135deg,var(--p),var(--ac));opacity:0;transition:opacity .35s;z-index:0}
.q-card:hover{transform:translateY(-4px);box-shadow:var(--glow)}.q-card:hover::after{opacity:.06}
.q-card>*{position:relative;z-index:1}
.q-num{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;margin-bottom:.5rem}
.q-card h3{font-size:.95rem;font-weight:700;margin-bottom:.5rem;color:var(--tx);line-height:1.3}
.q-card p{font-size:.82rem;color:var(--ts);line-height:1.6}
.q-tag{display:inline-block;margin-top:.7rem;padding:.2rem .6rem;border-radius:2rem;font-size:.7rem;font-weight:600;border:1px solid var(--bd);color:var(--ac)}

/* Impact grid */
.impact-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-top:1.5rem}
.impact-card{text-align:center;padding:2rem 1.5rem;background:var(--card);border:1px solid var(--bd);border-radius:16px;transition:all .35s}
.impact-card:hover{transform:translateY(-4px);border-color:var(--ac);box-shadow:0 0 30px rgba(6,214,160,.15)}
.impact-num{font-size:clamp(1.8rem,3vw,2.5rem);font-weight:800;background:linear-gradient(135deg,var(--ac),var(--pl));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.3rem}
.impact-card h4{font-size:.85rem;font-weight:600;margin-bottom:.3rem}.impact-card p{font-size:.78rem;color:var(--ts);line-height:1.5}

/* CTA section */
.land-cta{min-height:auto;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:3rem 2rem;background:var(--bg2);position:relative;overflow:hidden}
.land-cta::before{content:'';position:absolute;width:100%;height:100%;background:radial-gradient(ellipse at center,rgba(108,60,225,.08),transparent 60%);pointer-events:none}
.land-cta h2{font-size:clamp(1.5rem,3.5vw,2.2rem);font-weight:800;margin-bottom:.6rem;position:relative}
.land-cta p{color:var(--ts);font-size:1rem;margin-bottom:2rem;max-width:500px;position:relative;line-height:1.6}
.cta-btn{padding:1rem 2.5rem;background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border:none;border-radius:14px;font-size:1.1rem;font-weight:700;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;letter-spacing:.3px}
.cta-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--ac),var(--pl));opacity:0;transition:opacity .3s}
.cta-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(108,60,225,.4)}.cta-btn:hover::before{opacity:.3}
.cta-btn span{position:relative;z-index:1}

/* From To cards */
.fromto-stack{display:flex;flex-direction:column;gap:2rem;margin-top:1.5rem}
.fromto-row{display:grid;grid-template-columns:1fr auto 1fr;gap:1rem;align-items:center}
.fromto-card{border-radius:16px;padding:1.5rem;position:relative;overflow:hidden;transition:all .35s}
.fromto-card.from{background:var(--card);border:1px solid var(--bd)}
.fromto-card.to{background:linear-gradient(135deg,rgba(108,60,225,.08),rgba(6,214,160,.08));border:1px solid rgba(6,214,160,.2)}
.fromto-card:hover{transform:translateY(-2px)}
.fromto-card.from:hover{box-shadow:0 4px 20px rgba(0,0,0,.3)}
.fromto-card.to:hover{box-shadow:var(--glow)}
.fromto-label{font-size:.6rem;text-transform:uppercase;letter-spacing:1.5px;font-weight:700;margin-bottom:.6rem;display:flex;align-items:center;gap:.4rem}
.fromto-card.from .fromto-label{color:var(--dn)}
.fromto-card.to .fromto-label{color:var(--ac)}
.fromto-formula{font-family:'Courier New',monospace;font-size:.78rem;color:var(--ts);line-height:1.8;white-space:pre-wrap;word-break:break-word}
.fromto-formula .fn{color:var(--pl)}.fromto-formula .op{color:var(--dn)}.fromto-formula .var{color:var(--wr)}
.fromto-natural{font-size:.88rem;color:var(--tx);line-height:1.7;font-style:italic}
.fromto-natural em{font-style:normal;color:var(--ac);font-weight:600}
.fromto-arrow{display:flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:50%;background:var(--card);border:1px solid var(--bd);color:var(--ac);font-size:1.2rem;flex-shrink:0}
.fromto-tag{display:inline-block;margin-top:.6rem;padding:.15rem .5rem;border-radius:2rem;font-size:.65rem;font-weight:600}
.fromto-card.from .fromto-tag{background:rgba(239,71,111,.1);color:var(--dn);border:1px solid rgba(239,71,111,.2)}
.fromto-card.to .fromto-tag{background:rgba(6,214,160,.1);color:var(--ac);border:1px solid rgba(6,214,160,.2)}

/* HERO BADGE */
.hero-badge{margin-top:1.2rem;padding:.5rem 1.2rem;background:rgba(6,214,160,.06);border:1px solid rgba(6,214,160,.2);border-radius:2rem;font-size:.82rem;color:var(--ac);font-weight:500;display:inline-flex;align-items:center;gap:.4rem;letter-spacing:.2px}

/* SOCIAL PROOF / TRUST BAR */
.trust-bar{padding:2rem 2rem;border-top:1px solid var(--bd);border-bottom:1px solid var(--bd)}
.trust-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:2rem;text-align:center;max-width:700px;margin:0 auto}
.trust-num{font-size:2.2rem;font-weight:800;background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.2}
.trust-label{color:var(--ts);font-size:.82rem;margin-top:.3rem}

/* MODULE TABS */
.modules-nav{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin:1.5rem 0 2rem}
.module-tab{padding:.55rem 1rem;background:var(--card);border:1px solid var(--bd);border-radius:2rem;color:var(--ts);font-size:.82rem;font-weight:600;cursor:pointer;transition:all .25s;white-space:nowrap}
.module-tab:hover{border-color:var(--pl);color:var(--tx);background:rgba(108,60,225,.06)}
.module-tab.active{background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border-color:transparent;box-shadow:0 4px 16px rgba(108,60,225,.3)}
.module-display{min-height:280px}
.module-content{text-align:center}
.module-content h3{font-size:1.2rem;font-weight:700;margin-bottom:.4rem;color:var(--tx)}
.module-content>p{color:var(--ts);margin-bottom:1.5rem;font-size:.95rem}
.module-example{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:1.5rem;max-width:600px;margin:0 auto;text-align:left;transition:all .3s}
.module-example:hover{border-color:rgba(6,214,160,.3);box-shadow:0 4px 20px rgba(6,214,160,.08)}
.module-example .me-q{color:var(--tx);font-size:.88rem;line-height:1.7;font-style:italic;margin-bottom:1rem}
.module-example .me-divider{border-top:1px solid var(--bd);padding-top:1rem}
.module-example .me-tag{color:var(--ac);font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1px}
.module-example .me-a{color:var(--tx);font-size:.92rem;margin-top:.5rem;line-height:1.5}

/* LANDING NAVBAR */
.land-nav{position:fixed;top:0;left:0;right:0;z-index:500;background:rgba(15,15,26,.85);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);padding:.6rem 2rem;display:flex;align-items:center;justify-content:space-between;transform:translateY(-100%);transition:transform .4s cubic-bezier(.4,0,.2,1);opacity:0}
.land-nav.visible{transform:translateY(0);opacity:1}
body.app-mode .land-nav{display:none}
.land-nav-logo{font-size:1.1rem;font-weight:800;display:flex;align-items:center;gap:.4rem;letter-spacing:-.3px}
.land-nav-logo .nav-icon{width:26px;height:26px;background:linear-gradient(135deg,var(--p),var(--ac));border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.75rem;color:#fff;font-weight:800}
.land-nav-logo span{background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.land-nav-links{display:flex;gap:1.5rem;align-items:center}
.land-nav-links a{color:var(--ts);font-size:.82rem;font-weight:500;text-decoration:none;transition:color .25s;position:relative}
.land-nav-links a:hover{color:var(--tx)}
.land-nav-links a::after{content:'';position:absolute;bottom:-3px;left:0;width:0;height:2px;background:linear-gradient(90deg,var(--pl),var(--ac));transition:width .25s}
.land-nav-links a:hover::after{width:100%}
.land-nav-cta{padding:.45rem 1.2rem;background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border:none;border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .25s;letter-spacing:.2px}
.land-nav-cta:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(108,60,225,.4)}

/* Demo animations */
@keyframes demoFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes demoFadeOut{from{opacity:1}to{opacity:0;height:0;padding:0;margin:0;overflow:hidden}}

/* Animations */
.fade-up{opacity:0;transform:translateY(30px);transition:all .7s cubic-bezier(.16,1,.3,1)}.fade-up.visible{opacity:1;transform:translateY(0)}
.fade-up-d1{transition-delay:.1s}.fade-up-d2{transition-delay:.2s}.fade-up-d3{transition-delay:.3s}.fade-up-d4{transition-delay:.4s}

/* Landing Responsive */
@media(max-width:1024px){.pillars-7{grid-template-columns:repeat(3,1fr)}}
@media(max-width:768px){.pillars,.pillars-4,.pillars-7,.questions,.impact-grid{grid-template-columns:1fr}.land-section{padding:2rem 1.5rem;min-height:auto}.fromto-row{grid-template-columns:1fr;gap:.5rem}.fromto-arrow{transform:rotate(90deg);margin:0 auto}.land-nav-links a:not(.land-nav-cta){display:none}.land-nav{padding:.5rem 1rem}.trust-metrics{grid-template-columns:repeat(3,1fr);gap:1rem}.trust-num{font-size:1.6rem}.trust-label{font-size:.75rem}.modules-nav{gap:.35rem}.module-tab{padding:.45rem .75rem;font-size:.78rem}.module-display{min-height:auto}}
@media(max-width:480px){.land-section{padding:1.5rem 1rem}.pillars{gap:1rem}.pillar{padding:1.3rem 1.1rem}.questions{gap:1rem}.q-num{font-size:2rem}.impact-num{font-size:clamp(1.5rem,4vw,2rem)}.impact-card{padding:1.2rem .8rem}.impact-card h4{font-size:.8rem}.impact-card p{font-size:.72rem}.cta-btn{padding:.85rem 1.8rem;font-size:.95rem}.trust-bar{padding:1.5rem 1rem}.trust-num{font-size:1.4rem}.module-tab{padding:.4rem .6rem;font-size:.72rem}.module-example{padding:1.2rem}.hero-badge{font-size:.75rem;padding:.4rem .8rem}}
@media(max-width:374px){.land-section{padding:1.2rem .8rem}.pillars{gap:.8rem}.questions{gap:.8rem}.q-card{padding:1rem .85rem}.fromto-stack{gap:1.2rem}.cta-btn{padding:.75rem 1.5rem;font-size:.88rem;border-radius:12px}}

/* HEADER */
header{background:var(--bg2);border-bottom:1px solid var(--bd);padding:.6rem 1.5rem;display:flex;align-items:center;gap:1rem;z-index:10;backdrop-filter:blur(10px)}
.logo{font-size:1.4rem;font-weight:800;letter-spacing:-.5px;display:flex;align-items:center;gap:.5rem}
.logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--p),var(--ac));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem}
.logo span{background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hbadges{display:flex;gap:.4rem;margin-left:auto}
.badge{padding:.2rem .6rem;border-radius:2rem;font-size:.65rem;font-weight:600;background:var(--card);border:1px solid var(--bd);color:var(--ts);transition:all .3s}
.badge.on{background:rgba(6,214,160,.15);border-color:var(--ac);color:var(--ac)}

/* MAIN LAYOUT */
.main{flex:1;display:flex;overflow:hidden}

/* SIDEBAR */
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
.ssec{padding:.85rem 1rem;border-bottom:1px solid var(--bd)}
.ssec h3{font-size:.65rem;text-transform:uppercase;color:var(--ts);letter-spacing:1px;margin-bottom:.65rem;font-weight:600}
.mcard{padding:.65rem .75rem;border-radius:10px;cursor:pointer;transition:all .25s;margin-bottom:.4rem;border:1px solid transparent;background:transparent;position:relative;overflow:hidden}
.mcard::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--p),var(--ac));opacity:0;transition:opacity .25s;border-radius:10px}
.mcard:hover{border-color:var(--bd);background:var(--card)}.mcard:hover::before{opacity:.05}
.mcard.sel{border-color:var(--pl);background:rgba(108,60,225,.1)}.mcard.sel::before{opacity:.08}
.mcard h4{font-size:.82rem;color:var(--tx);position:relative;font-weight:600}.mcard p{font-size:.7rem;color:var(--ts);margin-top:.2rem;position:relative}
.si{display:flex;align-items:center;gap:.5rem;font-size:.75rem;margin-bottom:.4rem;color:var(--ts)}
.sd{width:7px;height:7px;border-radius:50%;background:var(--bd);transition:all .4s;flex-shrink:0}.sd.on{background:var(--ok);box-shadow:0 0 6px var(--ok)}.sd.pn{background:var(--wr);box-shadow:0 0 6px var(--wr)}

/* CHAT */
.chat-c{flex:1;display:flex;flex-direction:column;min-width:0;position:relative}
.msgs{flex:1;overflow-y:auto;padding:1.25rem 1.5rem;display:flex;flex-direction:column;gap:.75rem;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
.msg{max-width:82%;animation:msgIn .35s cubic-bezier(.16,1,.3,1)}
@keyframes msgIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.msg.u{align-self:flex-end}.msg.a{align-self:flex-start}
.bubble{padding:.8rem 1rem;border-radius:var(--radius);line-height:1.6;font-size:.85rem;position:relative}
.msg.u .bubble{background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 12px rgba(108,60,225,.3)}
.msg.a .bubble{background:var(--card);border:1px solid var(--bd);border-bottom-left-radius:4px;box-shadow:var(--sh)}
.mlbl{font-size:.65rem;color:var(--ts);margin-bottom:.2rem;padding:0 .4rem;display:flex;align-items:center;gap:.35rem;font-weight:500}
.msg.a .mlbl::before{content:'';width:14px;height:14px;background:linear-gradient(135deg,var(--p),var(--ac));border-radius:4px;display:inline-block}
.bubble strong{font-weight:700;color:var(--ac)}.msg.u .bubble strong{color:#fff}
.bubble em{font-style:italic;color:var(--ts)}.msg.u .bubble em{color:rgba(255,255,255,.7)}
.bubble ul,.bubble ol{margin:.4rem 0;padding-left:1.2rem}.bubble li{margin:.2rem 0}
.bubble{overflow-x:auto;-webkit-overflow-scrolling:touch}
.bubble table{border-collapse:collapse;margin:.6rem 0;font-size:.78rem;width:100%;border-radius:8px;overflow:hidden;min-width:280px}
.bubble th,.bubble td{border:1px solid var(--bd);padding:.35rem .5rem;text-align:left}
.bubble th{background:var(--card2);font-weight:600;color:var(--ac);border-bottom:2px solid var(--pl)}
.bubble td{background:var(--bg2)}
.bubble hr{border:none;border-top:1px solid var(--bd);margin:.6rem 0}

/* TYPING */
.typing{display:flex;gap:4px;padding:.8rem 1rem;align-items:center}
.typing span{width:6px;height:6px;background:var(--ts);border-radius:50%;animation:bounce .6s infinite alternate}
.typing span:nth-child(2){animation-delay:.15s}.typing span:nth-child(3){animation-delay:.3s}
@keyframes bounce{to{transform:translateY(-5px);background:var(--ac)}}

/* WELCOME */
.welcome{text-align:center;padding:1.5rem 1rem 1rem;max-width:640px;margin:auto}
.welcome h2{font-size:1.5rem;font-weight:800;margin-bottom:.4rem;background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.welcome p{color:var(--ts);line-height:1.6;margin-bottom:1.25rem;font-size:.88rem}
.wel-hint{color:var(--ts);font-size:.75rem;margin-top:1rem;opacity:.6}
/* SPEECH BUBBLE */
.speech-bubble{position:relative;display:inline-block;margin:.6rem auto 1.2rem;padding:.7rem 1.4rem;background:linear-gradient(135deg,rgba(108,60,225,.1),rgba(6,214,160,.08));border:1.5px solid var(--pl);border-radius:18px;font-size:1.05rem;font-weight:700;color:var(--tx);animation:bubbleIn .5s cubic-bezier(.16,1,.3,1) both}
.bubble-arrow{position:absolute;top:-8px;left:50%;margin-left:-7px;width:14px;height:14px;background:linear-gradient(135deg,rgba(108,60,225,.1),rgba(6,214,160,.08));border-left:1.5px solid var(--pl);border-top:1.5px solid var(--pl);transform:rotate(45deg);border-radius:2px 0 0 0}
@keyframes bubbleIn{from{opacity:0;transform:scale(.85) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
/* QUESTION GRID */
.question-grid{display:grid;grid-template-columns:1fr 1fr;gap:.9rem;margin:.5rem auto 0;max-width:560px}
.question-card{padding:1.1rem .9rem;background:var(--card);border:1.5px solid var(--bd);border-radius:14px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);text-align:center;position:relative;overflow:hidden;animation:cardEntry .45s cubic-bezier(.16,1,.3,1) both}
.qc-1{animation-delay:0s}.qc-2{animation-delay:.07s}.qc-3{animation-delay:.14s}.qc-4{animation-delay:.21s}.qc-5{animation-delay:.28s}
.question-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--p),var(--ac));opacity:0;transition:opacity .3s;border-radius:14px}
.question-card:hover{border-color:var(--pl);transform:translateY(-4px);box-shadow:0 8px 28px rgba(108,60,225,.25)}
.question-card:hover::before{opacity:.07}
.q-icon{font-size:1.9rem;margin-bottom:.45rem;position:relative;z-index:1}
.question-card h3{font-size:.85rem;font-weight:700;color:var(--tx);margin:0 0 .4rem;line-height:1.35;position:relative;z-index:1}
.q-hint{font-size:.7rem;color:var(--ac);font-weight:600;position:relative;z-index:1;opacity:.8}
@keyframes cardEntry{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
/* BACK BUTTON */
.back-btn{background:none;border:1px solid var(--bd);color:var(--ts);font-size:.8rem;padding:.4rem 1rem;border-radius:2rem;cursor:pointer;margin:0.5rem 0 0 0.8rem;transition:all .25s;align-self:flex-start}
.back-btn:hover{border-color:var(--pl);color:var(--pl);background:rgba(108,60,225,.08)}
/* SOLUTION CHARTS */
.chart-container{margin:1rem 0;padding:0.8rem;background:rgba(15,15,26,.6);border:1px solid var(--bd);border-radius:12px}
.chart-container canvas{max-height:280px;width:100%!important}
.chart-title{font-size:.8rem;font-weight:700;color:var(--ac);margin-bottom:.5rem;text-align:center}
.chart-row{display:flex;gap:1rem;flex-wrap:wrap}.chart-row .chart-container{flex:1;min-width:250px}

/* Legacy excards (keep for compat) */
.excards{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:.6rem}
.exc{padding:.85rem;border:1px solid var(--bd);border-radius:12px;cursor:pointer;transition:all .25s;text-align:left;background:var(--card);position:relative;overflow:hidden}
.exc::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--p),var(--ac));opacity:0;transition:opacity .25s}
.exc:hover{border-color:var(--pl);transform:translateY(-2px);box-shadow:var(--glow)}.exc:hover::after{opacity:.06}
.exc h4{font-size:.78rem;color:var(--tx);margin-bottom:.3rem;position:relative;z-index:1;font-weight:600}.exc p{font-size:.7rem;color:var(--ts);position:relative;z-index:1}

/* AVATAR */
.avatar-wrap{margin-bottom:1rem;position:relative}
.avatar-container{width:100px;height:100px;margin:0 auto;position:relative;cursor:pointer}
.avatar-container:hover .avatar-ring{transform:scale(1.05)}
.avatar-ring{position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(var(--p),var(--ac),var(--p));animation:spin 8s linear infinite;transition:transform .3s}
@keyframes spin{to{transform:rotate(360deg)}}
.avatar-ring.thinking{animation:spin 1.5s linear infinite}
.avatar-ring.solved{background:conic-gradient(var(--ok),var(--ac),var(--ok));animation:pulse-ring 2s ease infinite}
@keyframes pulse-ring{0%,100%{opacity:.7}50%{opacity:1}}
.avatar-bg{position:absolute;inset:2px;border-radius:50%;background:var(--bg2);z-index:1}
.avatar-face{position:absolute;inset:0;z-index:2;display:flex;align-items:center;justify-content:center}
.avatar-face svg{width:60px;height:60px}
.avatar-status{position:absolute;bottom:2px;right:2px;width:14px;height:14px;border-radius:50%;background:var(--ok);border:2px solid var(--bg2);z-index:3;transition:background .3s}
.avatar-status.thinking{background:var(--wr);animation:pulse-dot 1s infinite}
.avatar-status.error{background:var(--dn)}
@keyframes pulse-dot{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
.avatar-mood{font-size:.7rem;text-align:center;color:var(--ts);margin-top:.4rem;font-weight:500;min-height:1.2em}

/* INPUT */
.iarea{padding:.75rem 1.25rem;background:var(--bg2);border-top:1px solid var(--bd)}
.icont{display:flex;gap:.6rem;align-items:flex-end}
.iwrap{flex:1;position:relative}
textarea{width:100%;padding:.7rem .9rem;border:2px solid var(--bd);border-radius:12px;font-size:.85rem;font-family:inherit;resize:none;outline:none;transition:all .25s;min-height:44px;max-height:150px;background:var(--card);color:var(--tx)}
textarea:focus{border-color:var(--pl);box-shadow:0 0 0 3px rgba(108,60,225,.15)}
textarea::placeholder{color:var(--ts)}
.sbtn{padding:.7rem 1.1rem;background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border:none;border-radius:12px;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .25s;white-space:nowrap;position:relative;overflow:hidden}
.sbtn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--ac),var(--pl));opacity:0;transition:opacity .25s}
.sbtn:hover::before{opacity:.3}
.sbtn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(108,60,225,.4)}
.sbtn:active{transform:translateY(0)}
.sbtn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.sbtn span{position:relative;z-index:1}
.sbtn.ld{animation:pls 1.2s infinite}@keyframes pls{0%,100%{opacity:.5}50%{opacity:1}}
.qa{display:flex;gap:.4rem;margin-top:.5rem;flex-wrap:wrap}
.qb{padding:.3rem .65rem;border:1px solid var(--bd);border-radius:2rem;background:transparent;font-size:.7rem;cursor:pointer;color:var(--ts);transition:all .25s;font-weight:500}
.qb:hover{border-color:var(--pl);color:var(--pl);background:rgba(108,60,225,.08)}
#pp{font-size:.75rem;color:var(--ts)}
#pp div{margin-bottom:3px;padding:.15rem 0}
#pp strong{color:var(--tx);font-weight:600}

/* EXPORT */
.export-btn{width:100%;padding:.5rem .75rem;background:transparent;border:1px solid var(--bd);border-radius:8px;color:var(--ts);font-size:.72rem;font-weight:500;cursor:pointer;transition:all .25s;text-align:left}
.export-btn:hover{border-color:var(--ac);color:var(--ac);background:rgba(6,214,160,.06)}

/* C1: STEPPER VISUAL */
.chat-stepper{display:flex;align-items:center;gap:0;padding:.5rem 1.25rem;background:var(--bg2);border-bottom:1px solid var(--bd);overflow-x:auto;scrollbar-width:none}
.chat-stepper::-webkit-scrollbar{display:none}
.step{display:flex;align-items:center;gap:.4rem;padding:.3rem .7rem;border-radius:20px;font-size:.68rem;font-weight:600;color:var(--ts);transition:all .4s cubic-bezier(.4,0,.2,1);white-space:nowrap;position:relative}
.step.active{color:var(--pl);background:rgba(108,60,225,.12)}
.step.done{color:var(--ac)}
.step .step-dot{width:8px;height:8px;border-radius:50%;background:var(--bd);transition:all .4s;flex-shrink:0}
.step.active .step-dot{background:var(--pl);box-shadow:0 0 8px rgba(108,60,225,.5);animation:stepPulse 1.5s infinite}
.step.done .step-dot{background:var(--ac);box-shadow:0 0 6px rgba(6,214,160,.4)}
@keyframes stepPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.7}}
.step-line{width:20px;height:2px;background:var(--bd);transition:background .4s;flex-shrink:0}
.step-line.done{background:var(--ac)}

/* C2: TRANSITIONS & MICRO-ANIMATIONS */
@keyframes solveSuccess{0%{opacity:0;transform:scale(.95) translateY(8px)}40%{transform:scale(1.02) translateY(-2px)}100%{opacity:1;transform:scale(1) translateY(0)}}
@keyframes solveGlow{0%{box-shadow:0 0 0 0 rgba(6,214,160,.3)}50%{box-shadow:0 0 20px 4px rgba(6,214,160,.15)}100%{box-shadow:0 0 0 0 rgba(6,214,160,0)}}
.msg.a.solve-result .bubble{animation:solveSuccess .5s cubic-bezier(.16,1,.3,1),solveGlow 1.5s ease .3s}
.msg.a.solve-result .bubble::before{content:'';position:absolute;inset:-1px;border-radius:inherit;background:linear-gradient(135deg,rgba(6,214,160,.15),rgba(108,60,225,.1));z-index:-1;border-radius:var(--radius);border-bottom-left-radius:4px}
@keyframes stageSlide{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.stage-transition{animation:stageSlide .3s ease-out}
.typing-indicator{display:flex;gap:4px;padding:.6rem .8rem;align-items:center}
.typing-indicator span{width:5px;height:5px;background:var(--pl);border-radius:50%;animation:typeDots .8s infinite alternate}
.typing-indicator span:nth-child(2){animation-delay:.15s}
.typing-indicator span:nth-child(3){animation-delay:.3s}
@keyframes typeDots{0%{transform:translateY(0);opacity:.4}100%{transform:translateY(-4px);opacity:1}}

/* C3: ONBOARDING TOUR — Spotlight + Tooltip */
.onboard-spotlight{position:fixed;z-index:900;border-radius:12px;box-shadow:0 0 0 9999px rgba(10,10,30,.55);pointer-events:none;transition:all .4s cubic-bezier(.16,1,.3,1)}
.onboard-clickblock{position:fixed;inset:0;z-index:899;pointer-events:all;cursor:default}
.onboard-tip{position:fixed;background:var(--card);border:1px solid var(--pl);border-radius:14px;padding:1.1rem 1.3rem;max-width:310px;box-shadow:0 8px 32px rgba(108,60,225,.3);pointer-events:all;animation:tipIn .4s cubic-bezier(.16,1,.3,1);z-index:902}
@keyframes tipIn{from{opacity:0;transform:translateY(10px) scale(.94)}to{opacity:1;transform:translateY(0) scale(1)}}
.onboard-tip::after{content:'';position:absolute;width:12px;height:12px;background:var(--card);border-right:1px solid var(--pl);border-bottom:1px solid var(--pl);transform:rotate(45deg)}
.onboard-tip.arrow-top::after{top:-7px;left:50%;margin-left:-6px;transform:rotate(-135deg)}
.onboard-tip.arrow-bottom::after{bottom:-7px;left:50%;margin-left:-6px;transform:rotate(45deg)}
.onboard-tip.arrow-left::after{left:-7px;top:50%;margin-top:-6px;transform:rotate(135deg)}
.onboard-tip.arrow-right::after{right:-7px;top:50%;margin-top:-6px;transform:rotate(-45deg)}
.onboard-tip h4{font-size:.9rem;font-weight:700;margin-bottom:.35rem;color:var(--ac)}
.onboard-tip p{font-size:.8rem;color:var(--ts);line-height:1.5;margin-bottom:.7rem}
.onboard-tip .tip-actions{display:flex;gap:.5rem;justify-content:flex-end;align-items:center}
.onboard-tip .tip-skip{padding:.35rem .7rem;background:none;border:1px solid var(--bd);border-radius:8px;color:var(--ts);font-size:.72rem;cursor:pointer;transition:all .2s}
.onboard-tip .tip-skip:hover{border-color:var(--ts);background:rgba(255,255,255,.03)}
.onboard-tip .tip-next{padding:.35rem .9rem;background:linear-gradient(135deg,var(--p),#5B2ECF);border:none;border-radius:8px;color:#fff;font-size:.72rem;font-weight:600;cursor:pointer;transition:all .2s}
.onboard-tip .tip-next:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(108,60,225,.3)}
.onboard-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.15rem .5rem;background:rgba(108,60,225,.1);border:1px solid rgba(108,60,225,.2);border-radius:6px;font-size:.65rem;color:var(--pl);font-weight:600;margin-bottom:.4rem}
.onboard-progress{display:flex;gap:4px;margin-bottom:.6rem}
.onboard-dot{width:8px;height:8px;border-radius:50%;background:var(--bd);transition:all .3s}
.onboard-dot.active{background:var(--ac);transform:scale(1.2)}
.onboard-dot.done{background:var(--pl)}
.onboard-emoji{font-size:1.3rem;margin-bottom:.3rem;display:block}

/* C4: MOBILE RESPONSIVE */
.hamburger{display:none;background:none;border:none;color:var(--tx);cursor:pointer;padding:.3rem;border-radius:6px;transition:background .2s}
.hamburger:hover{background:var(--card)}
.hamburger svg{width:22px;height:22px;stroke:currentColor;stroke-width:2;fill:none}
.sidebar-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;backdrop-filter:blur(4px)}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--ts)}

/* ═══════════════════════════════════════════════════════════════
   RESPONSIVE — MOBILE UX v2
   Breakpoints: 768px (tablet), 600px (large phone), 480px (phone), 374px (small phone)
   ═══════════════════════════════════════════════════════════════ */

/* ─── TABLET & BELOW (768px) ─── */
@media(max-width:768px){
 .hamburger{display:block}
 .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:60;transform:translateX(-100%);transition:transform .35s cubic-bezier(.4,0,.2,1);box-shadow:none;width:min(260px,80vw)}
 .sidebar.open{transform:translateX(0);box-shadow:4px 0 20px rgba(0,0,0,.4)}
 .sidebar-backdrop.show{display:block}
 .excards{grid-template-columns:1fr 1fr}
 .question-grid{grid-template-columns:1fr 1fr;gap:.75rem;max-width:480px}
 .question-card{padding:.9rem .8rem}
 .speech-bubble{font-size:.95rem;padding:.6rem 1.1rem}
 .msgs{padding:.75rem 1rem}
 .floating-cta{bottom:1rem;right:1rem;padding:.75rem 1.5rem;font-size:.9rem}
 .iarea{padding:.5rem .75rem;padding-bottom:max(.5rem,env(safe-area-inset-bottom))}
 .icont{gap:.5rem}
 textarea{font-size:16px;min-height:44px;-webkit-appearance:none}
 .sbtn{padding:.65rem 1rem;min-height:44px;min-width:64px;font-size:.85rem}
 .chat-stepper{padding:.4rem .75rem;gap:0}
 .step{padding:.25rem .55rem;font-size:.68rem}
 .step-line{width:14px}
 .onboard-tip{max-width:260px}
 .chart-row .chart-container{flex:1 1 100%;min-width:100%}
 .chart-container canvas{max-height:240px}
 .msg{max-width:88%}
 header{padding:.5rem 1rem;gap:.6rem}
 .logo{font-size:1.2rem}
 .logo-icon{width:28px;height:28px;font-size:.85rem}
 .modal-box{padding:clamp(1.2rem,5vw,2.5rem)}
 .fromto-card{padding:1.2rem}
 .fromto-formula{font-size:.75rem}
 .fromto-natural{font-size:.82rem}
 /* M1: Hamburger touch target */
 .hamburger{padding:.6rem;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}
 /* M2: Quick actions horizontal scroll with fade */
 .qa{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;mask-image:linear-gradient(to right,transparent,#000 6%,#000 94%,transparent);-webkit-mask-image:linear-gradient(to right,transparent,#000 6%,#000 94%,transparent);padding-bottom:.35rem}
 .qa::-webkit-scrollbar{display:none}
 .qb{flex-shrink:0}
 /* M6: Touch feedback — all interactives */
 .sbtn:active{transform:scale(.96);opacity:.85}
 .qb:active{border-color:var(--pl);color:var(--pl);background:rgba(108,60,225,.12);transform:scale(.96)}
 .mcard:active{border-color:var(--pl);background:rgba(108,60,225,.1);transform:scale(.97)}
 .question-card:active{border-color:var(--pl);transform:scale(.97);box-shadow:0 4px 16px rgba(108,60,225,.2)}
 .cta-btn:active{transform:scale(.97);opacity:.9}
 .back-btn:active{border-color:var(--pl);color:var(--pl)}
 .pillar:active{border-color:var(--pl);transform:scale(.97)}
 .google-btn:active{background:#f0f0f0;transform:scale(.98)}
 .upgrade-btn:active{transform:scale(.97);opacity:.9}
 .export-btn:active{transform:scale(.96);opacity:.85}
 .sens-toggle:active{transform:scale(.98)}
}

/* ─── LARGE PHONE (600px) ─── */
@media(max-width:600px){
 /* M8: Show only active module badge */
 .hbadges{display:flex}
 .hbadges .badge:not(.on){display:none}
 .hbadges .badge.on{font-size:.6rem;padding:.15rem .4rem}
 .logo{font-size:1.15rem;white-space:nowrap}
 header{gap:.5rem}
 /* M5: Welcome cards 2-col compact with scroll hint */
 .question-grid{grid-template-columns:1fr 1fr;gap:.5rem;max-width:none;max-height:52vh;overflow-y:auto;scrollbar-width:none;mask-image:linear-gradient(to bottom,#000 82%,transparent);-webkit-mask-image:linear-gradient(to bottom,#000 82%,transparent)}
 .question-grid::-webkit-scrollbar{display:none}
 .question-card{padding:.65rem .55rem}
 .question-card h3{font-size:.73rem;line-height:1.3}
 .q-icon{font-size:1.3rem;margin-bottom:.15rem}
 .excards{grid-template-columns:1fr}
 .msgs{padding:.75rem .85rem}
 .welcome{padding:1rem .75rem .5rem}
 .welcome h2{font-size:1.3rem}
 .welcome p{font-size:.82rem}
 .avatar-container{width:80px;height:80px}
 .avatar-face svg{width:48px;height:48px}
 .bubble table{font-size:.72rem}
 .bubble th,.bubble td{padding:.3rem .4rem}
 .fromto-arrow{width:40px;height:40px;font-size:1rem}
 .pillar{padding:1.3rem 1.1rem}
 .pillar-icon{font-size:1.9rem}
 .pillar p{font-size:.8rem}
 .q-card{padding:1.3rem 1.1rem}
 .q-card p{font-size:.78rem}
 .impact-card{padding:1.5rem 1rem}
 .land-hero h1{font-size:clamp(1.6rem,5vw,2.5rem)}
 .land-sub{font-size:clamp(.85rem,2vw,1rem)}
 .land-cta h2{font-size:clamp(1.3rem,4vw,1.8rem)}
}

/* ─── STANDARD PHONE (480px) ─── */
@media(max-width:480px){
 .question-card{padding:.8rem .7rem}
 .q-icon{font-size:1.6rem;margin-bottom:.3rem}
 .question-card h3{font-size:.8rem}
 .q-hint{font-size:.65rem}
 .speech-bubble{font-size:.88rem;padding:.5rem 1rem}
 .iarea{padding:.4rem .6rem;padding-bottom:max(.4rem,env(safe-area-inset-bottom))}
 .icont{gap:.4rem}
 textarea{min-height:42px;max-height:120px;padding:.6rem .75rem}
 .sbtn{padding:.6rem .85rem;font-size:.8rem;border-radius:10px}
 .qa{flex-direction:row;flex-wrap:wrap;gap:.35rem;margin-top:.4rem}
 /* M1: Touch target fix — min 44px */
 .qb{padding:.4rem .6rem;font-size:.68rem;min-height:44px;flex:0 0 auto;text-align:center;white-space:nowrap;display:inline-flex;align-items:center}
 .chat-stepper{padding:.35rem .5rem}
 .step{padding:.2rem .4rem;font-size:.63rem}
 .step-line{width:10px}
 .step .step-dot{width:6px;height:6px}
 .msgs{padding:.6rem .7rem;gap:.6rem}
 .msg{max-width:92%}
 .bubble{padding:.7rem .85rem;font-size:.82rem}
 /* M3: Tables responsive — remove min-width */
 .bubble table{font-size:.7rem;min-width:auto}
 .bubble{overflow-x:auto;-webkit-overflow-scrolling:touch}
 .bubble th,.bubble td{padding:.25rem .35rem}
 .chart-container{padding:.5rem;margin:.7rem 0}
 .chart-container canvas{max-height:220px}
 .chart-title{font-size:.72rem}
 .modal-box{padding:1.2rem;border-radius:18px}
 .modal-box h2{font-size:1.2rem}
 .modal-box p{font-size:.82rem}
 .google-btn{padding:.75rem 1rem;font-size:.88rem}
 .upgrade-btn{padding:.85rem;font-size:.92rem}
 .paywall-box .plan-card{padding:1rem}
 .paywall-box .plan-price{font-size:1.6rem}
 .paywall-box .plan-features li{font-size:.78rem}
 .modal-close{width:36px;height:36px;top:.7rem;right:.7rem}
 .back-btn{font-size:.75rem;padding:.35rem .8rem;margin:.4rem 0 0 .6rem}
 .sidebar .ssec{padding:.7rem .8rem}
 .sidebar .mcard{padding:.55rem .65rem}
 .sidebar .mcard h4{font-size:.78rem}
 .sidebar .mcard p{font-size:.67rem}
 .fromto-card{padding:1rem}
 .fromto-formula{font-size:.72rem;line-height:1.6}
 .fromto-natural{font-size:.78rem;line-height:1.6}
 .fromto-arrow{width:36px;height:36px;font-size:.9rem}
 .fromto-label{font-size:.55rem}
 .fromto-tag{font-size:.6rem}
 .land-section{padding:1.5rem 1rem}
 .land-content h2{font-size:clamp(1.2rem,4vw,1.6rem)}
 .land-content>p{font-size:clamp(.82rem,1.5vw,.95rem)}
 .hero-demo{padding:1rem !important;font-size:.8rem !important}
 .onboard-tip{max-width:240px;padding:.8rem 1rem}
 .onboard-tip h4{font-size:.8rem}
 .onboard-tip p{font-size:.72rem}
 #langToggle{padding:.25rem .45rem;font-size:.7rem}
}

/* ─── SMALL PHONE (374px) ─── */
@media(max-width:374px){
 header{padding:.4rem .6rem;gap:.35rem}
 .logo{font-size:1rem;gap:.35rem}
 .logo-icon{width:24px;height:24px;font-size:.75rem;border-radius:6px}
 .welcome{padding:.7rem .5rem .3rem}
 .welcome h2{font-size:1.15rem}
 .welcome p{font-size:.78rem;margin-bottom:.8rem}
 .avatar-container{width:70px;height:70px}
 .avatar-face svg{width:42px;height:42px}
 .avatar-mood{font-size:.65rem}
 .speech-bubble{font-size:.82rem;padding:.45rem .85rem;margin:.4rem auto .8rem}
 .question-card{padding:.7rem .6rem}
 .q-icon{font-size:1.4rem;margin-bottom:.2rem}
 .question-card h3{font-size:.75rem;line-height:1.3}
 .q-hint{font-size:.6rem}
 .wel-hint{font-size:.68rem}
 .iarea{padding:.35rem .5rem;padding-bottom:max(.35rem,env(safe-area-inset-bottom))}
 textarea{padding:.55rem .65rem;font-size:16px}
 .sbtn{padding:.55rem .75rem;font-size:.78rem;min-width:56px}
 .qa{gap:.3rem}
 /* M1: Touch target — still 42px min */
 .qb{padding:.35rem .5rem;font-size:.65rem;min-height:42px}
 .chat-stepper{padding:.3rem .4rem}
 .step{padding:.15rem .3rem;font-size:.58rem}
 .step-line{width:8px}
 .msgs{padding:.5rem .55rem;gap:.5rem}
 .bubble{padding:.6rem .7rem;font-size:.78rem;line-height:1.55}
 .bubble table{font-size:.65rem;min-width:auto}
 .bubble th,.bubble td{padding:.2rem .25rem}
 .chart-container{padding:.4rem}
 .chart-container canvas{max-height:180px}
 .chart-title{font-size:.65rem}
 .modal-box{padding:1rem;border-radius:16px;width:94%}
 .modal-box h2{font-size:1.05rem}
 .modal-box p{font-size:.78rem;margin-bottom:1rem}
 .google-btn{padding:.65rem .8rem;font-size:.82rem;gap:.5rem}
 .upgrade-btn{padding:.75rem;font-size:.85rem;border-radius:12px}
 .paywall-box .plan-card{padding:.85rem}
 .paywall-box .plan-price{font-size:1.4rem}
 .paywall-box .plan-features li{font-size:.73rem}
 .modal-divider{font-size:.68rem;margin:.8rem 0}
 .modal-footer{font-size:.65rem}
 /* M7: Sidebar card legibility */
 .sidebar .ssec{padding:.6rem .65rem}
 .sidebar .mcard{padding:.5rem .6rem;margin-bottom:.35rem;min-height:44px}
 .sidebar .mcard h4{font-size:.78rem}
 .sidebar .mcard p{font-size:.66rem;line-height:1.35}
 .sidebar .ssec h3{font-size:.62rem}
 .back-btn{font-size:.7rem;padding:.3rem .65rem;margin:.3rem 0 0 .5rem}
 .land-hero h1{font-size:1.4rem}
 .land-sub{font-size:.82rem;margin-bottom:1.5rem}
 .pillar{padding:1rem .9rem}
 .pillar-icon{font-size:1.7rem;margin-bottom:.5rem}
 .pillar h3{font-size:.9rem}
 .pillar p{font-size:.75rem}
 .fromto-card{padding:.85rem}
 .fromto-formula{font-size:.68rem;line-height:1.5}
 .fromto-natural{font-size:.75rem;line-height:1.5}
 .fromto-arrow{width:32px;height:32px;font-size:.8rem}
 .onboard-tip{max-width:220px;padding:.7rem .85rem}
 #langToggle{padding:.2rem .35rem;font-size:.65rem}
}

/* ═══ SENSITIVITY SLIDERS ═══ */
.sens-panel{margin:1rem 0;border:1px solid var(--bd);border-radius:12px;overflow:hidden;animation:msgIn .35s cubic-bezier(.16,1,.3,1)}
.sens-toggle{width:100%;padding:.7rem 1rem;background:var(--card);border:none;color:var(--ac);font-size:.82rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:background .2s}
.sens-toggle:hover{background:var(--card2)}
.sens-toggle:active{background:var(--card2)}
.sens-toggle-icon{transition:transform .3s;font-size:.7rem}
.sens-toggle-icon.open{transform:rotate(180deg)}
.sens-body{padding:0 1rem;max-height:0;overflow:hidden;background:var(--bg2);transition:max-height .4s cubic-bezier(.4,0,.2,1),padding .4s}
.sens-body.open{max-height:800px;padding:1rem}
.sens-row{margin-bottom:1rem}
.sens-row:last-child{margin-bottom:.3rem}
.sens-label{display:flex;justify-content:space-between;align-items:center;font-size:.75rem;color:var(--ts);margin-bottom:.4rem}
.sens-param-name{font-weight:500}
.sens-value{color:var(--ac);font-weight:700;font-size:.78rem;font-variant-numeric:tabular-nums}
.sens-slider{width:100%;-webkit-appearance:none;appearance:none;height:6px;border-radius:3px;background:linear-gradient(90deg,var(--bd) 0%,var(--bd) 100%);outline:none;cursor:pointer;transition:opacity .15s}
.sens-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--ac));cursor:pointer;box-shadow:0 2px 8px rgba(108,60,225,.35);transition:transform .15s}
.sens-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--ac));cursor:pointer;border:none;box-shadow:0 2px 8px rgba(108,60,225,.35)}
.sens-slider:active::-webkit-slider-thumb{transform:scale(1.2)}
.sens-slider:active::-moz-range-thumb{transform:scale(1.2)}
.sens-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem;margin-top:.8rem;padding:.6rem;background:var(--card);border-radius:8px;border:1px solid var(--bd)}
.sens-metric{text-align:center}
.sens-metric-label{font-size:.65rem;color:var(--ts);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.15rem}
.sens-metric-val{font-size:.9rem;font-weight:700;color:var(--tx);font-variant-numeric:tabular-nums}
.sens-delta{display:inline-block;font-size:.68rem;margin-left:.3rem;padding:.1rem .4rem;border-radius:4px;font-weight:600;vertical-align:middle}
.sens-delta.pos{background:rgba(6,214,160,.12);color:var(--ac)}
.sens-delta.neg{background:rgba(239,71,111,.12);color:var(--dn)}
.sens-delta.zero{background:rgba(152,152,176,.1);color:var(--ts)}
.sens-reset{display:block;margin:.6rem auto 0;padding:.35rem .8rem;background:none;border:1px solid var(--bd);border-radius:8px;color:var(--ts);font-size:.7rem;cursor:pointer;transition:all .2s}
.sens-reset:hover{border-color:var(--pl);color:var(--pl)}
.sens-reset:active{transform:scale(.95)}
@media(max-width:480px){
 .sens-slider::-webkit-slider-thumb{width:24px;height:24px}
 .sens-slider::-moz-range-thumb{width:24px;height:24px}
 .sens-body.open{padding:.75rem}
 .sens-metrics{grid-template-columns:1fr 1fr;gap:.4rem;padding:.5rem}
 .sens-metric-val{font-size:.82rem}
 .sens-toggle{font-size:.78rem;padding:.6rem .8rem}
}

/* FLOATING CTA */
.floating-cta{position:fixed;bottom:2rem;right:2rem;padding:1rem 2rem;background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border:none;border-radius:50px;font-size:1rem;font-weight:700;cursor:pointer;z-index:200;box-shadow:0 6px 30px rgba(108,60,225,.5);transition:all .35s cubic-bezier(.4,0,.2,1);opacity:0;transform:translateY(20px);pointer-events:none;letter-spacing:.3px}
.floating-cta.show{opacity:1;transform:translateY(0);pointer-events:all}
.floating-cta:hover{transform:translateY(-3px);box-shadow:0 10px 40px rgba(108,60,225,.6)}
.floating-cta .cta-pulse{position:absolute;inset:0;border-radius:50px;border:2px solid var(--ac);animation:ctaPulse 2s infinite;pointer-events:none}
@keyframes ctaPulse{0%{opacity:.6;transform:scale(1)}100%{opacity:0;transform:scale(1.15)}}
body.app-mode .floating-cta{display:none}

/* ═══ SCROLL-TO-BOTTOM FAB ═══ */
.scroll-bottom-btn{position:absolute;bottom:4.5rem;right:1rem;width:38px;height:38px;border-radius:50%;background:var(--card);border:1px solid var(--bd);color:var(--ts);font-size:1.1rem;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:20;opacity:0;transform:translateY(10px) scale(.8);pointer-events:none;transition:all .25s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;justify-content:center}
.scroll-bottom-btn.show{opacity:1;transform:translateY(0) scale(1);pointer-events:all}
.scroll-bottom-btn:hover{border-color:var(--pl);color:var(--pl);box-shadow:0 6px 20px rgba(108,60,225,.2)}
.scroll-bottom-btn:active{transform:scale(.92)}

/* ═══ BACK-TO-TOP BUTTON (landing) ═══ */
.back-to-top{position:fixed;bottom:5.5rem;right:1.5rem;width:44px;height:44px;border-radius:50%;background:var(--card);border:1px solid var(--bd);color:var(--ts);font-size:1.2rem;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:199;opacity:0;transform:translateY(10px);pointer-events:none;transition:all .3s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;justify-content:center}
.back-to-top.show{opacity:1;transform:translateY(0);pointer-events:all}
.back-to-top:hover{border-color:var(--pl);color:var(--pl);box-shadow:0 6px 20px rgba(108,60,225,.2)}
body.app-mode .back-to-top{display:none}

/* ═══ WELCOME→CHAT TRANSITION ═══ */
.welcome{transition:opacity .35s ease,transform .35s ease}
.welcome.hiding{opacity:0;transform:translateY(-15px);pointer-events:none}
.msgs .msg{animation:msgSlideIn .3s cubic-bezier(.16,1,.3,1) both}
@keyframes msgSlideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ═══ QUICK ACTIONS ANIMATION ═══ */
.qa .qb{animation:qbIn .3s cubic-bezier(.16,1,.3,1) both}
.qa .qb:nth-child(1){animation-delay:0s}
.qa .qb:nth-child(2){animation-delay:.04s}
.qa .qb:nth-child(3){animation-delay:.08s}
.qa .qb:nth-child(4){animation-delay:.12s}
.qa .qb:nth-child(5){animation-delay:.16s}
.qa .qb:nth-child(6){animation-delay:.2s}
.qa .qb:nth-child(7){animation-delay:.24s}
@keyframes qbIn{from{opacity:0;transform:translateY(6px) scale(.92)}to{opacity:1;transform:translateY(0) scale(1)}}

/* ═══ MODAL SCROLL LOCK ═══ */
body.modal-open{overflow:hidden;position:fixed;width:100%;top:var(--scroll-y,0)}

/* SCENARIO COMPARISON */
.scenario-item{display:flex;align-items:center;gap:.5rem;padding:.45rem .65rem;margin:.25rem 0;border-radius:8px;border:1px solid transparent;cursor:pointer;transition:all .2s;font-size:.78rem;color:var(--tx)}
.scenario-item:hover{background:var(--card2);border-color:var(--bd)}
.scenario-item.selected{border-color:var(--pl);background:rgba(108,60,225,.08)}
.scenario-item-icon{font-size:.9rem;flex-shrink:0}
.scenario-item-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500}
.scenario-item-time{font-size:.65rem;color:var(--ts);flex-shrink:0}
.scenario-item-metric{font-size:.65rem;color:var(--ac);flex-shrink:0;font-weight:600}
.scenario-item-delete{background:none;border:none;color:var(--ts);font-size:.7rem;cursor:pointer;padding:2px 4px;border-radius:4px;transition:all .2s;flex-shrink:0;opacity:.5}
.scenario-item-delete:hover{opacity:1;color:var(--dn);background:rgba(239,71,111,.1)}
.scenario-hint{font-size:.65rem;color:var(--ts);text-align:center;padding:.3rem;margin-top:.3rem;font-style:italic}
#compareBtn{width:100%;margin-top:.5rem;font-size:.78rem;padding:.5rem .75rem;background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s}
#compareBtn:hover{transform:translateY(-1px);box-shadow:0 3px 12px rgba(108,60,225,.3)}
#compareBtn:active{transform:scale(.97)}
.comparison-modal-box{background:var(--bg);border:1px solid var(--bd);border-radius:20px;padding:0;max-width:95vw;width:95vw;height:92vh;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:modalIn .35s cubic-bezier(.4,0,.2,1)}
.comparison-header{display:flex;align-items:center;justify-content:space-between;padding:1.2rem 1.5rem;border-bottom:1px solid var(--bd);background:var(--card);flex-shrink:0}
.comparison-header h2{font-size:1.1rem;font-weight:700;color:var(--tx);margin:0}
.comparison-header h2 span{background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.comparison-close{background:none;border:none;color:var(--ts);font-size:1.3rem;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s}
.comparison-close:hover{background:var(--card2);color:var(--tx)}
.comparison-body{flex:1;min-height:0;overflow-y:auto;padding:1.5rem}
.comparison-section{margin-bottom:1.5rem}
.comparison-section-title{font-size:.85rem;font-weight:700;color:var(--ac);margin-bottom:.75rem;text-transform:uppercase;letter-spacing:.5px}
.comparison-table{width:100%;border-collapse:collapse;font-size:.82rem}
.comparison-table th{padding:.55rem .75rem;text-align:left;color:var(--ac);font-weight:600;border-bottom:2px solid var(--pl);background:var(--card);font-size:.75rem;text-transform:uppercase;letter-spacing:.3px}
.comparison-table td{padding:.5rem .75rem;border-bottom:1px solid var(--bd);color:var(--tx)}
.comparison-table tr:hover{background:var(--card2)}
.comparison-table .changed{background:rgba(108,60,225,.06);font-weight:600}
.comparison-table .best{color:var(--ac);font-weight:700}
.comparison-charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;margin-top:1rem}
.comparison-chart-card{padding:.8rem;background:var(--card);border:1px solid var(--bd);border-radius:12px;position:relative;height:280px}
.comparison-chart-card canvas{max-height:230px!important;width:100%!important}
.comparison-chart-card .chart-title{font-size:.78rem;font-weight:600;color:var(--ac);margin-bottom:.5rem;text-align:center}
@media(max-width:600px){
 .comparison-modal-box{max-width:100vw;width:100vw;height:100vh;max-height:100vh;border-radius:0}
 .comparison-body{padding:1rem}
 .comparison-charts-grid{grid-template-columns:1fr}
 .comparison-table{font-size:.72rem}
 .comparison-table th,.comparison-table td{padding:.4rem .5rem}
}

/* CALCULADORA λ/μ */
.calc-section{background:var(--bg);border:1px solid var(--bd);border-radius:14px;padding:1rem 1.2rem;margin-bottom:1rem}
.calc-section h3{font-size:.9rem;font-weight:700;margin-bottom:.6rem;color:var(--pl)}
.calc-section select{width:100%;padding:.55rem .8rem;border:1px solid var(--bd);border-radius:10px;background:var(--card);color:var(--tx);font-size:.82rem;margin-bottom:.7rem;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6' fill='%239898B0'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .8rem center}
.calc-section select:focus{outline:none;border-color:var(--pl)}
.calc-input-group{margin-bottom:.5rem}
.calc-input-group label{display:block;font-size:.75rem;color:var(--ts);margin-bottom:.25rem;font-weight:500}
.calc-input-group input{width:100%;padding:.5rem .75rem;border:1px solid var(--bd);border-radius:10px;background:var(--card);color:var(--tx);font-size:.88rem;box-sizing:border-box}
.calc-input-group input:focus{outline:none;border-color:var(--pl);box-shadow:0 0 0 3px rgba(108,60,225,.12)}
.calc-input-row{display:flex;gap:.5rem;align-items:center}
.calc-input-row input{flex:1}
.calc-input-row select{flex:0 0 100px;margin-bottom:0}
.calc-result-box{background:rgba(108,60,225,.06);border:1px solid rgba(108,60,225,.15);border-radius:10px;padding:.6rem .9rem;margin-top:.5rem;font-size:.85rem;color:var(--tx);font-weight:500}
.calc-result-box .calc-val{font-size:1.1rem;font-weight:800;color:var(--pl)}
.calc-actions{display:flex;gap:.8rem;margin-top:1.2rem}
.calc-actions .qb{flex:0 0 auto}
.calc-actions .sbtn{flex:1}
@media(max-width:480px){.calc-section{padding:.8rem .9rem}.calc-input-row{flex-direction:column}.calc-input-row select{flex:unset;width:100%}}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:1000;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
.modal-overlay.show{display:flex;opacity:1}
.modal-box{background:var(--card);border:1px solid var(--bd);border-radius:24px;padding:2.5rem;max-width:420px;width:90%;text-align:center;position:relative;box-shadow:var(--shl);animation:modalIn .35s cubic-bezier(.4,0,.2,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.92) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-box h2{font-size:1.5rem;font-weight:800;margin-bottom:.4rem}
.modal-box h2 span{background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.modal-box p{color:var(--ts);font-size:.9rem;line-height:1.6;margin-bottom:1.5rem}
.modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--ts);font-size:1.2rem;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s}
.modal-close:hover{background:var(--card2);color:var(--tx)}
.google-btn{display:flex;align-items:center;justify-content:center;gap:.75rem;width:100%;padding:.9rem 1.5rem;background:#fff;border:1px solid #dadce0;border-radius:12px;font-size:.95rem;font-weight:600;color:#3c4043;cursor:pointer;transition:all .25s}
.google-btn:hover{box-shadow:0 2px 12px rgba(0,0,0,.15);border-color:#bbb}
.google-btn svg{width:20px;height:20px;flex-shrink:0}
.modal-divider{display:flex;align-items:center;gap:.75rem;margin:1.2rem 0;color:var(--ts);font-size:.75rem}
.modal-divider::before,.modal-divider::after{content:'';flex:1;height:1px;background:var(--bd)}
.modal-footer{margin-top:1rem;font-size:.72rem;color:var(--ts);line-height:1.5}

/* PAYWALL */
.paywall-box{max-width:480px}
.paywall-box .plan-card{background:linear-gradient(135deg,rgba(108,60,225,.12),rgba(6,214,160,.08));border:1px solid var(--pl);border-radius:16px;padding:1.5rem;margin:1rem 0;text-align:left}
.paywall-box .plan-card h3{font-size:1.1rem;font-weight:700;margin-bottom:.3rem;display:flex;align-items:center;gap:.5rem}
.paywall-box .plan-price{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.paywall-box .plan-price small{font-size:.85rem;-webkit-text-fill-color:var(--ts)}
.paywall-box .plan-features{list-style:none;margin:.8rem 0 0;display:flex;flex-direction:column;gap:.4rem}
.paywall-box .plan-features li{font-size:.82rem;color:var(--tx);display:flex;align-items:center;gap:.5rem}
.paywall-box .plan-features li::before{content:'✓';color:var(--ac);font-weight:700}
.upgrade-btn{width:100%;padding:1rem;background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff;border:none;border-radius:14px;font-size:1rem;font-weight:700;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
.upgrade-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(108,60,225,.5)}
.usage-bar{background:var(--card2);border-radius:8px;height:6px;margin:.5rem 0 1rem;overflow:hidden}
.usage-bar-fill{height:100%;background:linear-gradient(90deg,var(--ac),var(--pl));border-radius:8px;transition:width .5s ease}
.usage-text{font-size:.78rem;color:var(--ts);text-align:left}

/* USER PILL */
.user-pill{display:none;align-items:center;gap:.5rem;padding:.35rem .75rem;background:var(--card);border:1px solid var(--bd);border-radius:50px;cursor:pointer;transition:all .25s}
.user-pill:hover{border-color:var(--pl)}
.user-pill img{width:24px;height:24px;border-radius:50%}
.user-pill span{font-size:.75rem;color:var(--tx);font-weight:500;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
body.app-mode .user-pill.logged{display:flex}

/* ═══ PRICING TIERS (3 plans) ═══ */
.pricing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-top:2rem}
.pricing-card{background:var(--card);border:1px solid var(--bd);border-radius:20px;padding:2rem 1.5rem;text-align:center;position:relative;transition:all .35s}
.pricing-card:hover{transform:translateY(-4px);box-shadow:var(--glow)}
.pricing-card.featured{border-color:var(--ac);background:linear-gradient(135deg,rgba(108,60,225,.08),rgba(6,214,160,.06))}
.pricing-card.featured::before{content:'Más popular';position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--ac),var(--pl));color:#fff;font-size:.65rem;font-weight:700;padding:.25rem .8rem;border-radius:2rem;letter-spacing:.5px;text-transform:uppercase}
.pricing-card h3{font-size:1.15rem;font-weight:700;margin-bottom:.3rem}
.pricing-card .price-tag{font-size:2.2rem;font-weight:800;margin:.8rem 0;background:linear-gradient(135deg,var(--pl),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.pricing-card .price-tag small{font-size:.8rem;-webkit-text-fill-color:var(--ts)}
.pricing-card .price-tag .price-free{font-size:1.6rem}
.pricing-card ul{list-style:none;text-align:left;margin:1.2rem 0;display:flex;flex-direction:column;gap:.5rem}
.pricing-card li{font-size:.82rem;color:var(--tx);display:flex;align-items:flex-start;gap:.5rem;line-height:1.4}
.pricing-card li::before{content:'✓';color:var(--ac);font-weight:700;flex-shrink:0}
.pricing-card li.disabled{color:var(--ts);opacity:.5}
.pricing-card li.disabled::before{content:'✕';color:var(--dn)}
.pricing-cta{width:100%;padding:.85rem;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .3s;border:none}
.pricing-cta.primary{background:linear-gradient(135deg,var(--p),#5B2ECF);color:#fff}
.pricing-cta.primary:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(108,60,225,.4)}
.pricing-cta.secondary{background:var(--card2);color:var(--tx);border:1px solid var(--bd)}
.pricing-cta.secondary:hover{border-color:var(--pl)}
.pricing-cta.outline{background:transparent;border:2px solid var(--ac);color:var(--ac)}
.pricing-cta.outline:hover{background:rgba(6,214,160,.1)}
@media(max-width:768px){.pricing-grid{grid-template-columns:1fr;max-width:340px;margin-left:auto;margin-right:auto}.pricing-card.featured{order:-1}}

/* ═══ SHOPIFY DASHBOARD ═══ */
.shopify-panel{background:linear-gradient(135deg,rgba(6,214,160,.06),rgba(108,60,225,.04));border:1px solid rgba(6,214,160,.2);border-radius:12px;padding:1rem;margin:.5rem 0}
.shopify-panel h4{font-size:.78rem;font-weight:700;color:var(--ac);margin-bottom:.5rem;display:flex;align-items:center;gap:.4rem}
.shopify-status{display:flex;align-items:center;gap:.4rem;font-size:.72rem;color:var(--ts);margin-bottom:.5rem}
.shopify-status .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.shopify-status .dot.green{background:var(--ac)}
.shopify-status .dot.yellow{background:var(--wr)}
.shopify-status .dot.red{background:var(--dn)}
.shopify-connect-btn{width:100%;padding:.6rem;background:linear-gradient(135deg,#96bf48,#5a8a1e);color:#fff;border:none;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;gap:.4rem}
.shopify-connect-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(90,138,30,.4)}
.shopify-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;margin-top:.5rem}
.shopify-stat{background:var(--card);border:1px solid var(--bd);border-radius:8px;padding:.5rem;text-align:center}
.shopify-stat .stat-num{font-size:1.1rem;font-weight:800;color:var(--ac)}
.shopify-stat .stat-label{font-size:.6rem;color:var(--ts);text-transform:uppercase;letter-spacing:.5px}

/* ═══ DATA FORM INPUTS ═══ */
.df-in{width:100%;padding:.45rem .6rem;background:var(--bg);border:1px solid var(--bd);border-radius:8px;font-size:.78rem;color:var(--tx);font-family:inherit;transition:border-color .2s,box-shadow .2s;box-sizing:border-box}
.df-in:focus{outline:none;border-color:var(--pl);box-shadow:0 0 0 3px rgba(108,60,225,.12)}
.df-in::placeholder{color:var(--ts);opacity:.6}
.df-in[type="number"]{-moz-appearance:textfield}
.df-in[type="number"]::-webkit-inner-spin-button,.df-in[type="number"]::-webkit-outer-spin-button{opacity:1}
.df-row{margin-bottom:.35rem}
#dataFormModal label{display:block;margin-bottom:.2rem;font-size:.72rem;font-weight:600;color:var(--ts)}
#dataFormModal h3{font-size:.85rem;font-weight:700;color:var(--tx);margin:0 0 .4rem}

/* ═══ AI INSIGHTS PANEL ═══ */
.ai-insight-card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:1rem;margin:.5rem 0;transition:all .25s}
.ai-insight-card:hover{border-color:var(--pl)}
.ai-insight-card h5{font-size:.8rem;font-weight:700;color:var(--tx);margin-bottom:.3rem;display:flex;align-items:center;gap:.4rem}
.ai-insight-card p{font-size:.75rem;color:var(--ts);line-height:1.5}
.ai-insight-card .insight-tag{display:inline-block;margin-top:.4rem;padding:.15rem .5rem;border-radius:2rem;font-size:.6rem;font-weight:600}
.ai-insight-card .insight-tag.high{background:rgba(239,71,111,.1);color:var(--dn);border:1px solid rgba(239,71,111,.2)}
.ai-insight-card .insight-tag.medium{background:rgba(255,209,102,.1);color:var(--wr);border:1px solid rgba(255,209,102,.2)}
.ai-insight-card .insight-tag.low{background:rgba(6,214,160,.1);color:var(--ac);border:1px solid rgba(6,214,160,.2)}

/* ═══ SHOPIFY CONNECT MODAL ═══ */
.shopify-modal-box{max-width:520px}
.shopify-modal-box .shop-input-wrap{display:flex;gap:.5rem;margin:1rem 0}
.shopify-modal-box .shop-input{flex:1;padding:.75rem 1rem;background:var(--card);border:1px solid var(--bd);border-radius:10px;color:var(--tx);font-size:.9rem;font-family:inherit}
.shopify-modal-box .shop-input:focus{outline:none;border-color:var(--pl)}
.shopify-modal-box .shop-input::placeholder{color:var(--ts)}
.shopify-modal-box .shop-suffix{padding:.75rem;background:var(--card2);border:1px solid var(--bd);border-radius:10px;color:var(--ts);font-size:.8rem;display:flex;align-items:center}
.shopify-modal-box .connect-steps{margin:1.5rem 0;display:flex;flex-direction:column;gap:.8rem}
.shopify-modal-box .connect-step{display:flex;align-items:flex-start;gap:.6rem;font-size:.82rem;color:var(--ts);line-height:1.5}
.shopify-modal-box .step-num{width:24px;height:24px;border-radius:50%;background:var(--card);border:1px solid var(--bd);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:var(--pl);flex-shrink:0}

/* ═══ PLAN BADGE IN HEADER ═══ */
.plan-badge{padding:.2rem .6rem;border-radius:2rem;font-size:.62rem;font-weight:700;letter-spacing:.3px;text-transform:uppercase}
.plan-badge.free{background:var(--card);border:1px solid var(--bd);color:var(--ts)}
.plan-badge.starter{background:rgba(108,60,225,.12);border:1px solid rgba(108,60,225,.3);color:var(--pl)}
.plan-badge.pro{background:rgba(6,214,160,.12);border:1px solid rgba(6,214,160,.3);color:var(--ac)}

/* ═══ PRO LOCK OVERLAY ═══ */
.pro-lock-wrap{position:relative}
.pro-lock-wrap.locked .shopify-panel{filter:blur(2px);opacity:.5;pointer-events:none}
.pro-lock-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2;background:rgba(15,15,26,.55);border-radius:12px;backdrop-filter:blur(2px);gap:.5rem}
.pro-lock-overlay .lock-icon{font-size:1.5rem}
.pro-lock-overlay .lock-text{font-size:.72rem;color:var(--ts);text-align:center;line-height:1.4;max-width:160px}
.pro-lock-overlay .lock-badge{display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .8rem;border-radius:2rem;font-size:.68rem;font-weight:700;background:linear-gradient(135deg,var(--ac),var(--pl));color:#fff;cursor:pointer;transition:all .25s;border:none}
.pro-lock-overlay .lock-badge:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(6,214,160,.4)}
</style>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="landing-mode">

<!-- LANDING NAVBAR -->
<nav class="land-nav" id="landNav">
 <div class="land-nav-logo"><div class="nav-icon">I</div>INVOP<span>.AI</span></div>
 <div class="land-nav-links">
  <a href="#como-funciona">Cómo funciona</a>
  <a href="#modulos">7 módulos</a>
  <a href="#precios">Precios</a>
  <button class="land-nav-cta" onclick="handleStart()">Empezá gratis</button>
 </div>
</nav>

<!-- LANDING PAGE -->
<div class="landing" id="landing">

<!-- HERO -->
<section class="land-hero">
 <button id="landingLangToggle" style="position:absolute;top:2rem;right:2rem;padding:.4rem .7rem;background:rgba(108,60,225,.15);border:1px solid var(--pl);border-radius:8px;color:var(--pl);font-size:.75rem;font-weight:600;cursor:pointer;transition:all .25s;z-index:10" onclick="switchLanguage(currentLanguage==='es'?'en':'es')">ES | EN</button>
 <h1><span>Tu negocio tiene preguntas.</span><br>INVOP AI tiene las respuestas.</h1>
 <p class="land-sub">¿Cuánto producir? ¿Cuánto stockear? ¿Me conviene invertir? ¿Cuánto voy a vender? Describilo en español y recibí la respuesta óptima en segundos.</p>
 <div class="hero-demo" id="heroDemo" style="margin-top:2rem;padding:1.5rem;background:var(--card);border:1px solid var(--bd);border-radius:16px;max-width:600px;text-align:left;font-size:.85rem;position:relative;overflow:hidden">
  <div style="position:absolute;top:.8rem;right:1rem;display:flex;gap:.3rem">
   <span style="width:8px;height:8px;border-radius:50%;background:var(--dn);opacity:.5"></span>
   <span style="width:8px;height:8px;border-radius:50%;background:var(--wr);opacity:.5"></span>
   <span style="width:8px;height:8px;border-radius:50%;background:var(--ok);opacity:.5"></span>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.8rem">
   <div style="font-size:.65rem;color:var(--ts);text-transform:uppercase;letter-spacing:1px;font-weight:600">Demo en vivo</div>
   <div id="heroDemoTag" style="font-size:.6rem;padding:.15rem .5rem;border-radius:2rem;font-weight:600;background:rgba(6,214,160,.1);color:var(--ac);border:1px solid rgba(6,214,160,.2);transition:all .4s">📦 Inventario</div>
  </div>
  <div id="heroDemoContent">
   <div class="demo-msg" style="margin-bottom:.8rem;padding:.6rem .8rem;background:var(--bg2);border-radius:8px;border-left:3px solid var(--pl);opacity:0;animation:demoFadeIn .5s .5s forwards">
    <div style="color:var(--ts);margin-bottom:.2rem;font-size:.72rem;font-weight:600">👤 Tú:</div>
    <div id="heroDemoQ" style="color:var(--tx);font-size:.82rem">"Vendo 15.000 unidades/año. Cada pedido cuesta $200, almacenar $3/un/año, me cuesta $45..."</div>
   </div>
   <div class="demo-typing" style="padding:.4rem .8rem;opacity:0;animation:demoFadeIn .3s 1.5s forwards,demoFadeOut .3s 2.5s forwards">
    <span style="display:inline-flex;gap:3px;align-items:center"><span style="font-size:.72rem;color:var(--ac);font-weight:600">INVOP AI</span> <span style="display:flex;gap:3px"><span style="width:4px;height:4px;background:var(--ac);border-radius:50%;animation:bounce .6s infinite alternate"></span><span style="width:4px;height:4px;background:var(--ac);border-radius:50%;animation:bounce .6s .15s infinite alternate"></span><span style="width:4px;height:4px;background:var(--ac);border-radius:50%;animation:bounce .6s .3s infinite alternate"></span></span></span>
   </div>
   <div class="demo-msg" style="padding:.6rem .8rem;background:rgba(6,214,160,.08);border-radius:8px;border-left:3px solid var(--ac);opacity:0;animation:demoFadeIn .5s 2.8s forwards">
    <div style="color:var(--ac);margin-bottom:.2rem;font-size:.72rem;font-weight:600">✨ INVOP AI:</div>
    <div id="heroDemoA" style="color:var(--tx);font-size:.82rem"><strong>Lote óptimo:</strong> 1.414 un. <strong>Frecuencia:</strong> cada 34 días. <strong>Costo anual:</strong> $677.500</div>
    <div style="color:var(--ts);font-size:.7rem;margin-top:.3rem">Resuelto en 12ms — Sin login. Sin código.</div>
   </div>
  </div>
 </div>
 <button class="cta-btn" style="margin-top:2rem" onclick="handleStart()"><span>Empezá gratis — sin tarjeta →</span></button>
 <div class="hero-badge">✓ Sin tarjeta · Sin código · Sin fórmulas</div>
 <div class="scroll-hint" onclick="document.getElementById('como-funciona').scrollIntoView({behavior:'smooth'})">
  <span>Descubrí qué resuelve</span>
  <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
 </div>
</section>

<!-- SOCIAL PROOF BAR -->
<section class="trust-bar">
 <div class="trust-metrics">
  <div class="fade-up fade-up-d1">
   <div class="trust-num">500+</div>
   <div class="trust-label">Problemas resueltos</div>
  </div>
  <div class="fade-up fade-up-d2">
   <div class="trust-num">7</div>
   <div class="trust-label">Módulos de optimización</div>
  </div>
  <div class="fade-up fade-up-d3">
   <div class="trust-num">&lt;1s</div>
   <div class="trust-label">Tiempo de respuesta</div>
  </div>
 </div>
</section>

<!-- SECTION: Cómo funciona -->
<section class="land-section" id="como-funciona">
 <div class="land-content">
  <h2 class="fade-up"><span>Cómo funciona en 3 pasos</span></h2>
  <p class="fade-up fade-up-d1">Desde tu problema real hasta la decisión óptima, sin complejidad matemática.</p>
  <div class="pillars">
   <div class="pillar fade-up fade-up-d1">
    <span class="pillar-icon">💬</span>
    <h3>Describí tu problema</h3>
    <p>Contá tu situación en español natural. Producción, stock, atención, inversión, pronósticos, rentabilidad o flujo de caja.</p>
   </div>
   <div class="pillar fade-up fade-up-d2">
    <span class="pillar-icon">🧠</span>
    <h3>INVOP AI lo analiza</h3>
    <p>Detecta cuál de los 7 módulos aplica, extrae los datos de tu texto y arma el modelo matemático por vos.</p>
   </div>
   <div class="pillar fade-up fade-up-d3">
    <span class="pillar-icon">📊</span>
    <h3>Recibí la solución</h3>
    <p>Solución óptima con explicación paso a paso, análisis de sensibilidad y escenarios "¿qué pasa si?".</p>
   </div>
  </div>
 </div>
</section>

<!-- SECTION: 7 Módulos (tabs interactivos) -->
<section class="land-section" id="modulos">
 <div class="land-content">
  <h2 class="fade-up"><span>7 módulos,</span> <span>un solo lenguaje: el tuyo</span></h2>
  <p class="fade-up fade-up-d1">Describí tu problema en español. La AI detecta el módulo y resuelve al instante.</p>
  <div class="modules-nav fade-up fade-up-d2">
   <button class="module-tab active" data-module="lp" onclick="switchModule('lp')">🏭 Producción</button>
   <button class="module-tab" data-module="stock" onclick="switchModule('stock')">📦 Inventario</button>
   <button class="module-tab" data-module="queue" onclick="switchModule('queue')">🎯 Atención</button>
   <button class="module-tab" data-module="invest" onclick="switchModule('invest')">📊 Inversión</button>
   <button class="module-tab" data-module="forecast" onclick="switchModule('forecast')">📈 Pronóstico</button>
   <button class="module-tab" data-module="rent" onclick="switchModule('rent')">💰 Rentabilidad</button>
   <button class="module-tab" data-module="fc" onclick="switchModule('fc')">💵 Flujo de Caja</button>
  </div>
  <div class="module-display fade-up fade-up-d3">
   <div id="mod-lp" class="module-content">
    <h3>¿Qué me conviene producir?</h3>
    <p>Maximizá ganancia eligiendo el mix ideal con tus recursos limitados.</p>
    <div class="module-example">
     <div class="me-q">"Tengo una panadería. Hago pan, medialunas y tortas. Tengo 100 kg de harina y 30 kg de azúcar. El pan me deja $0.60, la medialuna $0.80 y la torta $7. ¿Qué me conviene producir?"</div>
     <div class="me-divider">
      <div class="me-tag">Respuesta óptima</div>
      <div class="me-a"><strong>Mix óptimo:</strong> 150 pan + 200 medialunas + 50 tortas. <strong>Ganancia máxima:</strong> $890/día</div>
     </div>
    </div>
   </div>
   <div id="mod-stock" class="module-content" style="display:none">
    <h3>¿Cuánto pedir y cada cuánto?</h3>
    <p>Lote óptimo para no tener faltantes ni exceso de stock.</p>
    <div class="module-example">
     <div class="me-q">"Vendo 15.000 unidades/año. Cada pedido cuesta $200. Almacenar sale $3/un/año. Me cuesta $45. El proveedor tarda 10 días."</div>
     <div class="me-divider">
      <div class="me-tag">Respuesta óptima</div>
      <div class="me-a"><strong>Lote óptimo:</strong> 1.414 un. <strong>Frecuencia:</strong> cada 34 días. <strong>Costo anual:</strong> $677.500</div>
     </div>
    </div>
   </div>
   <div id="mod-queue" class="module-content" style="display:none">
    <h3>¿Cuántos puestos necesito?</h3>
    <p>Dimensioná tu equipo sin sobre-invertir ni perder clientes por espera.</p>
    <div class="module-example">
     <div class="me-q">"Tengo una clínica. Llegan 18 pacientes/hora. Cada médico tarda 15 min. Médico cuesta $40/hora. Espera cuesta $25/hora."</div>
     <div class="me-divider">
      <div class="me-tag">Respuesta óptima</div>
      <div class="me-a"><strong>Médicos recomendados:</strong> 5. <strong>Espera promedio:</strong> 2.3 min. <strong>Costo total:</strong> $200/hora</div>
     </div>
    </div>
   </div>
   <div id="mod-invest" class="module-content" style="display:none">
    <h3>¿Dónde me conviene invertir?</h3>
    <p>Compará alternativas con VAN, TIR y payback. Elegí con datos.</p>
    <div class="module-example">
     <div class="me-q">"Comparo 2 máquinas. Una cuesta $50k, otra $70k. Ingreso $40k/año, costos $15k. Mi tasa es 12%. ¿Cuál elijo?"</div>
     <div class="me-divider">
      <div class="me-tag">Respuesta óptima</div>
      <div class="me-a"><strong>Mejor opción:</strong> Máquina A. <strong>VAN:</strong> $89.500. <strong>TIR:</strong> 18%. <strong>Payback:</strong> 2.1 años</div>
     </div>
    </div>
   </div>
   <div id="mod-forecast" class="module-content" style="display:none">
    <h3>¿Cuánto voy a vender?</h3>
    <p>Pronosticá demanda con datos reales. Compará todos los métodos.</p>
    <div class="module-example">
     <div class="me-q">"Mis ventas mensuales: 120, 135, 142, 128, 155. ¿Cuánto voy a vender el próximo mes?"</div>
     <div class="me-divider">
      <div class="me-tag">Respuesta óptima</div>
      <div class="me-a"><strong>Mejor método:</strong> SES (α=0.3). <strong>Pronóstico:</strong> 148 un. <strong>Error (MAD):</strong> 8.2</div>
     </div>
    </div>
   </div>
   <div id="mod-rent" class="module-content" style="display:none">
    <h3>¿Cuánto gano por producto?</h3>
    <p>Punto de equilibrio, margen por producto y análisis ABC.</p>
    <div class="module-example">
     <div class="me-q">"Vendo remeras a $2500, me cuestan $1200, costos fijos $180.000/mes. ¿Cuántas necesito vender para no perder?"</div>
     <div class="me-divider">
      <div class="me-tag">Respuesta óptima</div>
      <div class="me-a"><strong>Punto de equilibrio:</strong> 139 un/mes. <strong>Margen unitario:</strong> $1.300. <strong>Margen %:</strong> 52%</div>
     </div>
    </div>
   </div>
   <div id="mod-fc" class="module-content" style="display:none">
    <h3>¿Me va a alcanzar la plata?</h3>
    <p>Proyectá tu flujo de caja mes a mes y anticipá problemas.</p>
    <div class="module-example">
     <div class="me-q">"Cobro $500k/mes, pago sueldos $200k, alquiler $80k, proveedores $150k. Tengo $100k en caja. ¿Me alcanza 6 meses?"</div>
     <div class="me-divider">
      <div class="me-tag">Respuesta óptima</div>
      <div class="me-a"><strong>Flujo neto:</strong> +$70k/mes. <strong>Caja mínima:</strong> $45k (mes 2). <strong>Margen de seguridad:</strong> 5.6 meses</div>
     </div>
    </div>
   </div>
  </div>
 </div>
</section>

<!-- SECTION: Precios -->
<section class="land-section" id="precios">
 <div class="land-content" style="text-align:center">
  <h2 class="fade-up"><span>Probá gratis.</span> <span>Upgradea cuando quieras.</span></h2>
  <p class="fade-up fade-up-d1" style="margin:0 auto 1rem">Sin tarjeta de crédito. Resolvé 3 problemas gratis, hoy.</p>
  <div class="pricing-grid">
   <div class="pricing-card fade-up fade-up-d1">
    <h3>Free</h3>
    <div class="price-tag"><span class="price-free">Gratis</span></div>
    <ul>
     <li>3 problemas por módulo</li>
     <li>7 módulos de optimización</li>
     <li>Input por chat natural</li>
     <li class="disabled">Exportar resultados</li>
     <li class="disabled">Conexión Shopify</li>
     <li class="disabled">AI Analysis</li>
    </ul>
    <button class="pricing-cta secondary" onclick="handleStart()">Empezar gratis</button>
   </div>
   <div class="pricing-card featured fade-up fade-up-d2">
    <h3>Starter</h3>
    <div class="price-tag">$3.99<small>/mes</small></div>
    <ul>
     <li>Problemas ilimitados</li>
     <li>7 módulos de optimización</li>
     <li>Exportar PDF y Excel</li>
     <li>Análisis de sensibilidad</li>
     <li>Historial de soluciones</li>
     <li class="disabled">Conexión Shopify</li>
    </ul>
    <button class="pricing-cta primary" onclick="handleUpgrade('starter')">Comenzar con Starter</button>
   </div>
   <div class="pricing-card fade-up fade-up-d3">
    <h3>Pro</h3>
    <div class="price-tag">$49.99<small>/mes</small></div>
    <ul>
     <li>Todo lo de Starter</li>
     <li>Conexión nativa con Shopify</li>
     <li>AI analiza tu negocio</li>
     <li>Reportes automáticos</li>
     <li>Notificaciones inteligentes</li>
     <li>Soporte prioritario</li>
    </ul>
    <button class="pricing-cta outline" onclick="handleUpgrade('pro')">Ir a Pro</button>
   </div>
  </div>
 </div>
</section>

<!-- FINAL CTA -->
<section class="land-cta">
 <h2 class="fade-up">Cada decisión sin datos <span style="color:var(--dn)">te cuesta plata</span></h2>
 <p class="fade-up fade-up-d1">Resolvé tu primer problema en 30 segundos. Gratis, sin registrarte.</p>
 <button class="cta-btn fade-up fade-up-d2" onclick="handleStart()"><span>Empezá gratis — sin tarjeta →</span></button>
</section>

</div>

<!-- BACK TO TOP -->
<button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Volver arriba">↑</button>

<!-- FLOATING CTA -->
<button class="floating-cta" id="floatingCta" onclick="handleStart()">
 <span>Empezá gratis</span>
 <div class="cta-pulse"></div>
</button>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="authModal">
 <div class="modal-box">
  <button class="modal-close" onclick="closeModal('authModal')">&times;</button>
  <h2>Bienvenido a <span>INVOP AI</span></h2>
  <p>Iniciá sesión para guardar tu progreso y resolver hasta 3 problemas gratis.</p>
  <div id="googleSignInBtn" style="display:flex;justify-content:center;min-height:44px"></div>
  <div class="modal-divider">o explorá sin registrarte</div>
  <button class="cta-btn" style="width:100%;margin-top:1rem;background:var(--surface2);color:var(--text1)" onclick="enterAppGuest()">Explorar sin resolver</button>
  <p style="font-size:.75rem;color:var(--text2);margin-top:.5rem;text-align:center">Podés ver los módulos, pero necesitás cuenta para resolver.</p>
  <p class="modal-footer" style="margin-top:1.5rem">Al continuar, aceptás los Términos de servicio y la Política de privacidad.</p>
 </div>
</div>

<!-- PAYWALL MODAL -->
<div class="modal-overlay" id="paywallModal">
 <div class="modal-box paywall-box" style="max-width:560px">
  <button class="modal-close" onclick="closeModal('paywallModal')">&times;</button>
  <h2><span>Desbloqueá</span> más poder</h2>
  <p>Usaste tus 3 problemas gratuitos. Elegí un plan para seguir resolviendo.</p>
  <div class="usage-text"><span>Problemas resueltos:</span> <strong><span id="pwUsage">3</span> / 3</strong></div>
  <div class="usage-bar"><div class="usage-bar-fill" style="width:100%"></div></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin:1rem 0">
   <div class="plan-card" style="margin:0">
    <h3>Starter</h3>
    <div class="plan-price">$3.99 <small>/ mes</small></div>
    <ul class="plan-features">
     <li>Problemas ilimitados</li>
     <li>Exportar PDF y Excel</li>
     <li>Análisis de sensibilidad</li>
    </ul>
    <button class="upgrade-btn" style="margin-top:.8rem;font-size:.85rem;padding:.7rem" onclick="handleUpgrade('starter')">Starter</button>
   </div>
   <div class="plan-card" style="margin:0;border-color:var(--ac)">
    <h3>Pro</h3>
    <div class="plan-price">$49.99 <small>/ mes</small></div>
    <ul class="plan-features">
     <li>Todo lo de Starter</li>
     <li>Shopify + AI Analysis</li>
     <li>Reportes automáticos</li>
    </ul>
    <button class="upgrade-btn" style="margin-top:.8rem;font-size:.85rem;padding:.7rem;background:linear-gradient(135deg,var(--ac),var(--pl))" onclick="handleUpgrade('pro')">Pro</button>
   </div>
  </div>
 </div>
</div>

<!-- COMPARISON MODAL -->
<div class="modal-overlay" id="comparisonModal">
 <div class="comparison-modal-box">
  <div class="comparison-header">
   <h2><span id="comparisonTitle">Comparación de escenarios</span></h2>
   <button class="comparison-close" onclick="closeModal('comparisonModal')">✕</button>
  </div>
  <div class="comparison-body" id="comparisonBody"></div>
 </div>
</div>

<!-- SHOPIFY CONNECT MODAL -->
<div class="modal-overlay" id="shopifyModal">
 <div class="modal-box shopify-modal-box">
  <button class="modal-close" onclick="closeModal('shopifyModal')">&times;</button>
  <h2 style="display:flex;align-items:center;gap:.5rem"><span style="font-size:1.5rem">🛍️</span> Conectar <span>Shopify</span></h2>
  <p>Conectá tu tienda y dejá que la AI analice tu negocio automáticamente.</p>
  <div class="shop-input-wrap">
   <input class="shop-input" id="shopDomainInput" type="text" placeholder="tu-tienda" autocomplete="off">
   <span class="shop-suffix">.myshopify.com</span>
  </div>
  <div class="connect-steps">
   <div class="connect-step"><div class="step-num">1</div><span>Ingresá el nombre de tu tienda Shopify</span></div>
   <div class="connect-step"><div class="step-num">2</div><span>Autorizá los permisos en Shopify (productos, órdenes, inventario)</span></div>
   <div class="connect-step"><div class="step-num">3</div><span>Sincronizamos tu data y la AI genera insights al instante</span></div>
  </div>
  <button class="shopify-connect-btn" style="padding:.85rem;font-size:.9rem;border-radius:12px" onclick="startShopifyOAuth()">
   <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M15.34 3.27c-.07-.02-.14.01-.17.08l-1.04 2.53-1.48-1.14s-.08-.05-.12-.05c-.05-.01-.1.01-.13.05-.03.04-.04.09-.03.14l.89 3.77-3.53.83c-.07.02-.12.07-.14.14-.02.06 0 .13.05.18l2.48 2.09-2.48 5.98a.18.18 0 0 0 .11.24l2.27.55a.18.18 0 0 0 .22-.12l3.52-8.52 1.89.73c.06.02.13.01.18-.03.05-.04.07-.1.06-.17l-1.03-5.12c-.01-.06-.05-.11-.1-.14l-1.35-.85L15.5 3.4c0-.07-.04-.12-.08-.14z"/></svg>
   Conectar Shopify
  </button>
  <p style="font-size:.7rem;color:var(--ts);margin-top:.8rem;text-align:center">Solo lectura. No modificamos nada en tu tienda.</p>
 </div>
</div>

<!-- AI ANALYSIS MODAL -->
<!-- DATA FORM MODAL — structured input alternative to NLP -->
<div class="modal-overlay" id="dataFormModal">
 <div class="modal-box" style="max-width:500px;text-align:left;max-height:85vh;overflow-y:auto">
  <button class="modal-close" onclick="closeModal('dataFormModal')">&times;</button>
  <h2 style="text-align:center"><span id="dfTitle">Cargar datos</span></h2>
  <p style="text-align:center;margin-bottom:1rem;font-size:.75rem;color:var(--ts)">Completá los campos y hacé click en Cargar</p>
  <div id="dfContent"></div>
  <button class="shopify-connect-btn" style="width:100%;margin-top:1rem;background:linear-gradient(135deg,var(--p),var(--ac))" onclick="submitDataForm()">✅ Cargar datos</button>
 </div>
</div>

<div class="modal-overlay" id="aiAnalysisModal">
 <div class="modal-box" style="max-width:600px;text-align:left;max-height:85vh;overflow-y:auto;display:flex;flex-direction:column">
  <button class="modal-close" onclick="closeModal('aiAnalysisModal')">&times;</button>
  <h2 style="text-align:center;flex-shrink:0"><span>AI Analysis</span></h2>
  <p style="text-align:center;margin-bottom:1rem;flex-shrink:0">Analizando tu data de Shopify con Claude AI...</p>
  <div id="aiAnalysisContent" style="flex:1;overflow-y:auto">
   <div style="text-align:center;padding:2rem">
    <div class="avatar-ring" style="width:40px;height:40px;margin:0 auto 1rem;border:3px solid var(--ac);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>
    <p style="font-size:.85rem;color:var(--ts)">Procesando productos, órdenes e inventario...</p>
   </div>
  </div>
 </div>
</div>

<!-- CALCULADORA λ/μ MODAL -->
<div class="modal-overlay" id="calcLambdaMuModal">
 <div class="modal-box" style="max-width:480px;text-align:left">
  <button class="modal-close" onclick="closeModal('calcLambdaMuModal')">&times;</button>
  <h2 style="text-align:center">Calculadora <span>λ/μ</span></h2>
  <p style="text-align:center;margin-bottom:1rem">Convertí tus datos a tasas por hora</p>

  <div class="calc-section">
   <h3>λ — Tasa de Llegada</h3>
   <select id="lambdaFormat" onchange="renderCalcInputs()">
    <option value="perHour">Clientes por hora</option>
    <option value="interval">1 cliente cada X minutos</option>
    <option value="batch">X clientes en Y horas</option>
   </select>
   <div id="lambdaInputs"></div>
   <div class="calc-result-box">λ = <span class="calc-val" id="lambdaResult">—</span> clientes/hora</div>
  </div>

  <div class="calc-section">
   <h3>μ — Tasa de Servicio</h3>
   <select id="muFormat" onchange="renderCalcInputs()">
    <option value="perHour">Clientes atendidos por hora</option>
    <option value="serviceMin">Cada atención dura X minutos</option>
    <option value="serviceHour">Cada atención dura X horas</option>
   </select>
   <div id="muInputs"></div>
   <div class="calc-result-box">μ = <span class="calc-val" id="muResult">—</span> clientes/hora</div>
  </div>

  <div class="calc-actions">
   <button class="qb" onclick="closeModal('calcLambdaMuModal')">Cancelar</button>
   <button class="sbtn" onclick="useCalcValues()">Usar estos valores</button>
  </div>
 </div>
</div>

<!-- APP WRAP -->
<div class="app-wrap" id="appWrap">
<header>
 <button class="hamburger" id="hamburgerBtn" onclick="toggleSidebar()"><svg viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
 <div class="logo"><div class="logo-icon">I</div>INVOP<span>.AI</span></div>
 <button id="langToggle" style="padding:.3rem .6rem;background:var(--card);border:1px solid var(--bd);border-radius:8px;color:var(--ts);font-size:.75rem;font-weight:600;cursor:pointer;transition:all .25s;white-space:nowrap" onclick="switchLanguage(currentLanguage==='es'?'en':'es')">EN</button>
 <span class="plan-badge free" id="planBadge">FREE</span>
 <div class="hbadges">
  <span class="badge" id="bmod">Sin módulo</span>
  <span class="badge" id="bstg">Esperando</span>
  <span class="badge on" id="brag">Solvers</span>
 </div>
 <div class="user-pill" id="userPill" onclick="showUsageInfo()">
  <img id="userAvatar" src="" alt="">
  <span id="userName"></span>
 </div>
</header>
<div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>
<div class="main">
 <aside class="sidebar" id="sidebarEl">
  <div class="ssec">
   <h3>Actividades</h3>
   <div class="mcard" data-m="LP" onclick="selMod('LP')"><h4>🏭 Producción</h4><p>¿Qué fabricar, cuánto, con qué recursos?</p></div>
   <div class="mcard" data-m="STOCK" onclick="selMod('STOCK')"><h4>📦 Almacenamiento</h4><p>¿Cuánto pedir y cada cuánto reponer?</p></div>
   <div class="mcard" data-m="QUEUE" onclick="selMod('QUEUE')"><h4>🎯 Atención</h4><p>¿Cuántos puestos necesito para atender bien?</p></div>
   <div class="mcard" data-m="INVEST" onclick="selMod('INVEST')"><h4>📊 Planificación</h4><p>¿Invierto en A o en B? Decidí con datos.</p></div>
   <div class="mcard" data-m="FORECAST" onclick="selMod('FORECAST')"><h4>📈 Pronósticos</h4><p>¿Cuál será la demanda futura?</p></div>
   <div class="mcard" data-m="RENTABILIDAD" onclick="selMod('RENTABILIDAD')"><h4>💰 Rentabilidad</h4><p>¿Cuánto gano por producto? ¿Qué conviene vender?</p></div>
   <div class="mcard" data-m="FLUJO_CAJA" onclick="selMod('FLUJO_CAJA')"><h4>💵 Flujo de Caja</h4><p>¿Me alcanza la plata? ¿Cuándo necesito financiamiento?</p></div>
  </div>
  <div class="ssec" id="shopifySection">
   <h3>Shopify + AI</h3>
   <div id="shopifyPanelContent" class="pro-lock-wrap">
    <!-- Lock overlay for non-Pro users -->
    <div class="pro-lock-overlay" id="proLockOverlay" style="display:none">
     <div class="lock-icon">🔒</div>
     <div class="lock-text">Conectá Shopify y analizá tu negocio con AI</div>
     <button class="lock-badge" onclick="handleUpgrade('pro')">⚡ Upgrade a Pro</button>
    </div>
    <div class="shopify-panel" id="shopifyNotConnected">
     <h4>🛍️ Conectá tu tienda</h4>
     <p style="font-size:.72rem;color:var(--ts);margin-bottom:.5rem;line-height:1.4">La AI analiza tu negocio y genera insights automáticos.</p>
     <button class="shopify-connect-btn" onclick="showModal('shopifyModal')">Conectar Shopify</button>
    </div>
    <div class="shopify-panel" id="shopifyConnected" style="display:none">
     <h4>🟢 <span id="shopStoreName">Tu tienda</span></h4>
     <div class="shopify-status"><div class="dot green"></div><span id="shopSyncStatus">Sincronizado</span></div>
     <div class="shopify-stats">
      <div class="shopify-stat"><div class="stat-num" id="shopProductCount">0</div><div class="stat-label">Productos</div></div>
      <div class="shopify-stat"><div class="stat-num" id="shopOrderCount">0</div><div class="stat-label">Órdenes</div></div>
     </div>
     <div style="display:flex;gap:.4rem;margin-top:.5rem">
      <button class="shopify-connect-btn" style="flex:1;background:linear-gradient(135deg,var(--p),var(--ac))" onclick="runAIAnalysis()">Analizar con AI</button>
      <button class="shopify-connect-btn" id="resyncBtn" style="flex:0 0 auto;padding:.4rem .6rem;background:var(--s2);font-size:.68rem" onclick="resyncShopify()" title="Re-sincronizar datos de Shopify">🔄</button>
     </div>
     <div id="syncFeedback" style="display:none;font-size:.65rem;color:var(--ts);margin-top:.3rem;text-align:center"></div>
    </div>
   </div>
   <div id="aiInsightsContainer"></div>
  </div>
  <div class="ssec" id="pipeP" style="display:none">
   <h3>Pipeline</h3>
   <div class="si"><div class="sd" id="s1"></div><span>Interpretación</span></div>
   <div class="si"><div class="sd" id="s2"></div><span>Clasificación</span></div>
   <div class="si"><div class="sd" id="s3"></div><span>Validación</span></div>
   <div class="si"><div class="sd" id="s4"></div><span>Problem Spec</span></div>
   <div class="si"><div class="sd" id="s5"></div><span>Resolución</span></div>
   <div class="si"><div class="sd" id="s6"></div><span>Sensibilidad</span></div>
  </div>
  <div class="ssec" id="parP" style="display:none">
   <h3>Parámetros</h3>
   <div id="pp"></div>
  </div>
  <div class="ssec" style="margin-top:auto">
   <h3>Registro</h3>
   <div style="display:flex;align-items:center;gap:.5rem;font-size:.75rem;color:var(--ts);margin-bottom:.5rem">
    <div class="sd on" style="width:6px;height:6px"></div><span id="logCount">0 entradas</span>
   </div>
   <button class="export-btn" onclick="exportLog()">📥 Exportar log (.xlsx)</button>
  </div>
  <div class="ssec" id="scenariosSection" style="display:none">
   <h3>📊 Escenarios guardados</h3>
   <div id="scenariosList"></div>
   <div class="scenario-hint" id="scenarioHint"></div>
   <button id="compareBtn" onclick="compareScenarios()" style="display:none">⚖️ Comparar seleccionados</button>
  </div>
 </aside>
 <main class="chat-c">
  <div class="chat-stepper" id="chatStepper">
   <div class="step active" data-step="detect"><div class="step-dot"></div>Módulo</div>
   <div class="step-line"></div>
   <div class="step" data-step="collect"><div class="step-dot"></div>Datos</div>
   <div class="step-line"></div>
   <div class="step" data-step="confirm"><div class="step-dot"></div>Confirmar</div>
   <div class="step-line"></div>
   <div class="step" data-step="solved"><div class="step-dot"></div>Solución</div>
  </div>
  <button class="back-btn" id="backBtn" onclick="goBackToWelcome()" style="display:none">← Volver a elegir</button>
  <div class="msgs" id="msgs">
   <div class="welcome" id="wel">
    <div class="avatar-wrap">
     <div class="avatar-container" id="avatarMain" onclick="avatarClick()">
      <div class="avatar-ring" id="avatarRing"></div>
      <div class="avatar-bg"></div>
      <div class="avatar-face" id="avatarFace">
       <svg viewBox="0 0 60 60" fill="none">
        <circle cx="30" cy="30" r="24" fill="url(#av-grad)" opacity=".15"/>
        <circle cx="22" cy="25" r="3" fill="#E8E8F0" class="av-eye av-eye-l"/>
        <circle cx="38" cy="25" r="3" fill="#E8E8F0" class="av-eye av-eye-r"/>
        <circle cx="22" cy="25" r="1.5" fill="#1A1A2E" class="av-pupil av-pupil-l"/>
        <circle cx="38" cy="25" r="1.5" fill="#1A1A2E" class="av-pupil av-pupil-r"/>
        <path d="M22 37 Q30 44 38 37" stroke="#06D6A0" stroke-width="2.5" stroke-linecap="round" fill="none" class="av-mouth"/>
        <circle cx="15" cy="32" r="3" fill="#EF476F" opacity=".2" class="av-blush-l"/>
        <circle cx="45" cy="32" r="3" fill="#EF476F" opacity=".2" class="av-blush-r"/>
        <defs><linearGradient id="av-grad" x1="6" y1="6" x2="54" y2="54"><stop stop-color="#6C3CE1"/><stop offset="1" stop-color="#06D6A0"/></linearGradient></defs>
       </svg>
      </div>
      <div class="avatar-status" id="avatarStatus"></div>
     </div>
     <div class="avatar-mood" id="avatarMood">Listo para resolver</div>
    </div>
    <div class="speech-bubble">
     <span>¿Con qué te puedo ayudar?</span>
     <div class="bubble-arrow"></div>
    </div>
    <div class="question-grid">
     <div class="question-card qc-1" onclick="selectQuestion('lp')">
      <div class="q-icon">🏭</div>
      <h3>¿Qué me conviene producir y cuánto?</h3>
      <span class="q-hint">Producción</span>
     </div>
     <div class="question-card qc-2" onclick="selectQuestion('stock')">
      <div class="q-icon">📦</div>
      <h3>¿Cuánto stockear y cada cuánto reponer?</h3>
      <span class="q-hint">Almacenamiento</span>
     </div>
     <div class="question-card qc-3" onclick="selectQuestion('queue')">
      <div class="q-icon">🎯</div>
      <h3>¿Cuántos puestos de atención necesito?</h3>
      <span class="q-hint">Atención</span>
     </div>
     <div class="question-card qc-4" onclick="selectQuestion('invest')">
      <div class="q-icon">📊</div>
      <h3>¿Invierto en A o en B?</h3>
      <span class="q-hint">Planificación</span>
     </div>
     <div class="question-card qc-5" onclick="selectQuestion('forecast')">
      <div class="q-icon">📈</div>
      <h3>¿Cuánto voy a vender el mes que viene?</h3>
      <span class="q-hint">Pronósticos</span>
     </div>
     <div class="question-card qc-6" onclick="selectQuestion('rent')">
      <div class="q-icon">💰</div>
      <h3>¿Cuánto gano por cada producto que vendo?</h3>
      <span class="q-hint">Rentabilidad</span>
     </div>
     <div class="question-card qc-7" onclick="selectQuestion('fc')">
      <div class="q-icon">💵</div>
      <h3>¿Me va a alcanzar la plata los próximos meses?</h3>
      <span class="q-hint">Flujo de Caja</span>
     </div>
    </div>
    <p class="wel-hint">Elegí una pregunta o escribí tu propio problema abajo</p>
   </div>
  </div>
  <button class="scroll-bottom-btn" id="scrollBottomBtn" onclick="scrollChatBottom()" title="Ir al final">↓</button>
  <div class="iarea">
   <div class="icont">
    <div class="iwrap"><textarea id="inp" rows="1" placeholder="Describí tu problema operativo..." onkeydown="hKey(event)" oninput="aRsz(this)"></textarea></div>
    <button class="sbtn" id="sbt" onclick="send()"><span>Enviar</span></button>
   </div>
   <div class="qa" id="quickActions">
    <button class="qb" onclick="qSend('Quiero resolver un problema de producción')">🏭 Producción</button>
    <button class="qb" onclick="qSend('Quiero resolver un problema de inventario')">📦 Almacenamiento</button>
    <button class="qb" onclick="qSend('Quiero resolver un problema de atención al cliente')">🎯 Atención</button>
    <button class="qb" onclick="qSend('Quiero evaluar un proyecto de inversión')">📊 Planificación</button>
    <button class="qb" onclick="qSend('Quiero analizar la rentabilidad de mis productos')">💰 Rentabilidad</button>
    <button class="qb" onclick="qSend('Quiero proyectar el flujo de caja de mi negocio')">💵 Flujo de Caja</button>
   </div>
  </div>
 </main>
</div>
</div>

<!-- Onboarding elements created dynamically by JS -->

<script>
// Rate limiting
let lastMsgTime = 0;
const MSG_DELAY = 1000;

// Helper function to escape HTML
function escapeHtml(text){const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":" &#039;"};return text.replace(/[&<>"']/g,m=>map[m]);}

// SOLVERS - Linear Programming
function r0(v){return Math.round(v)}function r1(v){return Math.round(v*10)/10}function r2(v){return Math.round(v*100)/100}function r3(v){return Math.round(v*1000)/1000}function r4(v){return Math.round(v*10000)/10000}function r6(v){return Math.round(v*1000000)/1000000}function fact(n){let r=1;for(let i=2;i<=n;i++)r*=i;return r}

const LP={
  // ── CONFIG ──────────────────────────────────────────────────────
  EPS: 1e-8,            // Unified epsilon for all zero comparisons
  EPS_PIVOT: 1e-10,     // Minimum acceptable pivot element
  EPS_FEAS: 1e-6,       // Feasibility tolerance for artificial variables
  ROUND_DEC: 1e8,       // Internal rounding precision (8 decimals)
  MAX_IT: 2000,         // Max simplex iterations (raised from 500)
  TIME_LIMIT_MS: 15000, // 15-second wall-clock timeout
  // ── ADAPTIVE BIG-M ─────────────────────────────────────────────
  _computeBigM(oc, cs) {
    let mx = 1;
    for (const v in oc) mx = Math.max(mx, Math.abs(oc[v]));
    for (const c of cs) { for (const v in c.coeffs) mx = Math.max(mx, Math.abs(c.coeffs[v])); mx = Math.max(mx, Math.abs(c.rhs || 0)); }
    return Math.max(100 * mx, 1e4);
  },
  // ── MATRIX SCALING (Equilibration) ─────────────────────────────
  _scaleMatrix(A, b, c_s, m, n) {
    const rS = new Array(m).fill(1), cS = new Array(n).fill(1);
    for (let rd = 0; rd < 3; rd++) {
      for (let i = 0; i < m; i++) { let mx = Math.abs(b[i]); for (let j = 0; j < n; j++) mx = Math.max(mx, Math.abs(A[i][j])); if (mx > this.EPS) { const s = 1.0 / mx; rS[i] *= s; for (let j = 0; j < n; j++) A[i][j] *= s; b[i] *= s; } }
      for (let j = 0; j < n; j++) { let mx = Math.abs(c_s[j]); for (let i = 0; i < m; i++) mx = Math.max(mx, Math.abs(A[i][j])); if (mx > this.EPS) { const s = 1.0 / mx; cS[j] *= s; for (let i = 0; i < m; i++) A[i][j] *= s; c_s[j] *= s; } }
    }
    return { rS, cS };
  },
  // ── MAIN SOLVER ────────────────────────────────────────────────
  solve(spec) {
    try {
      const t0 = performance.now();
      const { objective_type: ot, objective_coefficients: oc, constraints: cs } = spec;
      // ── Input validation
      if (!ot || !['MAX', 'MIN'].includes(ot)) return { status: 'ERROR', message: 'objective_type debe ser MAX o MIN' };
      if (!oc || typeof oc !== 'object' || !Object.keys(oc).length) return { status: 'ERROR', message: 'objective_coefficients vacío' };
      if (!Array.isArray(cs) || !cs.length) return { status: 'ERROR', message: 'Se requieren restricciones' };
      for (const [v, coef] of Object.entries(oc)) { if (isNaN(coef)) return { status: 'ERROR', message: `Coeficiente inválido para ${v}` }; }
      // ── Variable setup
      const vars = new Set(Object.keys(oc));
      cs.forEach(c => Object.keys(c.coeffs).forEach(v => vars.add(v)));
      const vl = [...vars].sort(), n = vl.length, m = cs.length;
      const vi = {}; vl.forEach((v, i) => vi[v] = i);
      // ── Build standard form
      const c_obj = vl.map(v => -(oc[v] || 0) * (ot === 'MAX' ? 1 : -1));
      const A = [], b = [];
      for (let i = 0; i < m; i++) {
        const row = new Array(n).fill(0);
        for (const [v, co] of Object.entries(cs[i].coeffs)) { if (vi[v] !== undefined) row[vi[v]] = co; }
        let sense = cs[i].sense || '<=', rhs = cs[i].rhs || 0;
        if (sense === '>=') { row.forEach((_, j) => row[j] *= -1); rhs *= -1; sense = '<='; }
        A.push(row); b.push(rhs);
      }
      // ── Matrix scaling (equilibration)
      const c_sc = [...c_obj];
      const { rS, cS } = this._scaleMatrix(A, b, c_sc, m, n);
      // ── Adaptive Big-M
      const BIG_M = this._computeBigM(oc, cs);
      // ── Artificial variables
      const needArt = [];
      for (let i = 0; i < m; i++) { if (b[i] < -this.EPS) needArt.push(i); }
      const nArt = needArt.length, N = n + m + nArt;
      // ── Cost vector
      const C = new Array(N).fill(0);
      for (let j = 0; j < n; j++) C[j] = c_sc[j];
      for (let k = 0; k < nArt; k++) C[n + m + k] = BIG_M;
      // ── Tableau
      const Ab = A.map((row, i) => { const nr = new Array(N).fill(0); row.forEach((v, j) => nr[j] = v); nr[n + i] = 1; return nr; });
      const basis = Array.from({ length: m }, (_, i) => n + i);
      for (let k = 0; k < nArt; k++) { const i = needArt[k]; for (let j = 0; j < N; j++) Ab[i][j] *= -1; b[i] *= -1; Ab[i][n + m + k] = 1; basis[i] = n + m + k; }
      const basisSet = new Set(basis);
      // ── SIMPLEX with BLAND'S RULE ──────────────────────────────
      let it = 0;
      while (it++ < this.MAX_IT) {
        if (performance.now() - t0 > this.TIME_LIMIT_MS) return { status: 'TIMEOUT', message: `Tiempo límite excedido (${this.TIME_LIMIT_MS / 1000}s, ${it} iteraciones). Problema muy grande para el solver del navegador.`, iterations: it };
        const cB = basis.map(j => C[j]);
        // BLAND entering: smallest index j with rc < -EPS
        let pivCol = -1;
        for (let j = 0; j < N; j++) {
          if (basisSet.has(j)) continue;
          let zj = 0; for (let i = 0; i < m; i++) zj += cB[i] * Ab[i][j];
          if (C[j] - zj < -this.EPS) { pivCol = j; break; }
        }
        if (pivCol === -1) break;
        // BLAND leaving: min ratio, tie-break smallest basis index
        let pivRow = -1, minR = Infinity;
        for (let i = 0; i < m; i++) {
          if (Ab[i][pivCol] > this.EPS_PIVOT) {
            const r = b[i] / Ab[i][pivCol];
            if (r < minR - this.EPS) { minR = r; pivRow = i; }
            else if (Math.abs(r - minR) < this.EPS && pivRow >= 0 && basis[i] < basis[pivRow]) { pivRow = i; }
          }
        }
        if (pivRow === -1) return { status: 'NO_ACOTADO', message: 'Función objetivo no acotada. Revise restricciones.', iterations: it };
        // Pivot
        const pv = Ab[pivRow][pivCol];
        for (let j = 0; j < N; j++) Ab[pivRow][j] /= pv;
        b[pivRow] /= pv;
        for (let i = 0; i < m; i++) {
          if (i === pivRow) continue;
          const f = Ab[i][pivCol];
          if (Math.abs(f) < this.EPS_PIVOT) continue;
          for (let j = 0; j < N; j++) Ab[i][j] -= f * Ab[pivRow][j];
          b[i] -= f * b[pivRow];
        }
        basisSet.delete(basis[pivRow]); basis[pivRow] = pivCol; basisSet.add(pivCol);
      }
      // ── Timeout check
      if (it > this.MAX_IT) return { status: 'TIMEOUT', message: `Máximo de iteraciones alcanzado (${this.MAX_IT}). Posible degeneración.`, iterations: it };
      // ── Infeasibility check
      for (let k = 0; k < nArt; k++) { const ai = n + m + k; for (let i = 0; i < m; i++) { if (basis[i] === ai && b[i] > this.EPS_FEAS) return { status: 'INFACTIBLE', message: 'El problema no tiene solución factible. Revise las restricciones.', iterations: it }; } }
      // ── Extract solution (unscale)
      const vals = {}; vl.forEach(v => vals[v] = 0);
      for (let i = 0; i < m; i++) { if (basis[i] < n) vals[vl[basis[i]]] = Math.round(b[i] * cS[basis[i]] * this.ROUND_DEC) / this.ROUND_DEC; }
      let Z = 0; for (const [v, co] of Object.entries(oc)) Z += co * (vals[v] || 0);
      Z = Math.round(Z * this.ROUND_DEC) / this.ROUND_DEC;
      // ── Constraint details + shadow prices
      const cdet = cs.map((ct, i) => {
        let lhs = 0; for (const [v, co] of Object.entries(ct.coeffs)) lhs += co * (vals[v] || 0);
        lhs = Math.round(lhs * this.ROUND_DEC) / this.ROUND_DEC;
        const oSense = ct.sense || '<=';
        const sl = oSense === '<=' ? ct.rhs - lhs : oSense === '>=' ? lhs - ct.rhs : 0;
        const cB2 = basis.map(j => j >= n + m ? 0 : C[j]);
        let sp = 0; for (let k = 0; k < m; k++) sp += cB2[k] * Ab[k][n + i];
        sp = sp * rS[i] * (ot === 'MAX' ? -1 : 1);
        return { name: ct.name || `R${i + 1}`, lhs: Math.round(lhs * 1e4) / 1e4, sense: oSense, rhs: ct.rhs, slack: Math.round(sl * 1e4) / 1e4, shadow_price: Math.round(sp * 1e4) / 1e4, binding: Math.abs(sl) < 0.001 };
      });
      // ── Sensitivity
      const sens = { rhs_ranges: {}, interpretation: [] };
      cdet.forEach(cd => { if (cd.binding) { sens.rhs_ranges[cd.name] = { shadow_price: cd.shadow_price, binding: true }; sens.interpretation.push(`Recurso '${cd.name}' saturado. Cada unidad adicional ${ot === 'MAX' ? 'aumenta' : 'disminuye'} Z en $${Math.abs(cd.shadow_price)}`); } else { sens.rhs_ranges[cd.name] = { slack: cd.slack, binding: false }; sens.interpretation.push(`'${cd.name}' tiene ${cd.slack} unidades sin usar`); } });
      // ── Decision
      const bots = cdet.filter(c => c.binding).map(c => c.name);
      const acts = []; for (const [v, val] of Object.entries(vals)) { if (val > this.EPS_FEAS) acts.push(`Producir ${Number.isInteger(val) ? val : val.toFixed(2)} unidades de ${v.replace('x_', '')}. `); }
      if (bots.length) acts.push(`Cuellos de botella: ${bots.join(', ')}`);
      const solveMs = Math.round(performance.now() - t0);
      return { status: 'ÓPTIMO', objective_value: Z, variable_values: vals, constraint_details: cdet, sensitivity: sens, iterations: it, solve_time_ms: solveMs, solver_info: { engine: 'simplex-js-v2', big_m: BIG_M, scaling: 'equilibration', bland: true }, decision: { summary: `Solución óptima ${ot === 'MAX' ? 'maximiza ganancia' : 'minimiza costo'} en $${Z.toLocaleString('es-AR', { minimumFractionDigits: 2 })}`, actions: acts, bottlenecks: bots } };
    } catch (error) { return { status: 'ERROR', message: `Error: ${error.message}` }; }
  }
};

// STOCK Solver
const STOCK={solve(p){try{const D=+p.demand_D,k=+p.order_cost_k,c1=+p.holding_cost_c1,b=+p.acquisition_cost_b,T=+(p.planning_horizon_T||1),LT=+(p.lead_time_LT||0),Sp=+(p.safety_stock_Sp||0),c2=p.shortage_cost_c2!=null?+p.shortage_cost_c2:null;if(isNaN(D)||D<=0)return{status:"ERROR",message:"Demanda debe ser positiva"};if(isNaN(c1)||c1<=0)return{status:"ERROR",message:"Costo almacenamiento debe ser positivo"};if(isNaN(k)||k<0)return{status:"ERROR",message:"Costo pedido no puede ser negativo"};if(isNaN(b)||b<0)return{status:"ERROR",message:"Costo adquisición no puede ser negativo"};if(c2!==null&&c2>0){const qo=Math.sqrt(2*k*D*(c1+c2)/(T*c1*c2)),So=qo*Math.sqrt(c2/(c1+c2)),sm=qo-So,to=(T/D)*qo,no=D/qo;const ca=b*D,co=(D/qo)*k,ch=(So*So*T*c1)/(2*qo),cs2=((qo-So)**2*T*c2)/(2*qo),csp=Sp*c1*T,CTE=ca+co+ch+cs2+csp;const SR=(LT*D)/T+Sp-sm;return{status:"ÓPTIMO",subtype:"EOQ con agotamiento",results:{qo:r2(qo),So:r2(So),shortage_max:r2(sm),to_days:r2(to*365),no_orders:r2(no),SR:r2(SR),CTE:r2(CTE)},decision:{summary:"Modelo EOQ con agotamiento",actions:[`Pedir ${r0(qo)} unidades cada vez`,`Cada ${r1(to*365)} días`,`Stock máximo: ${r0(So)} un. Faltante máximo: ${r0(sm)} un.`,`CTE: $${r2(CTE).toLocaleString("es-AR")}/año`]},sensitivity:{interpretation:"La curva de costo es muy plana"},formulas:{qo:"√(2kD(c₁+c₂)/Tc₁c₂)",source:"Miranda Cap.4"}}}const qo=Math.sqrt(2*k*D/(T*c1)),to=(T/D)*qo,no=D/qo;const ca=b*D,co=(D/qo)*k,ch=(qo/2)*T*c1,csp=Sp*c1*T,CTE=ca+co+ch+csp;const dd=D/365,SR=(LT*D)/T+Sp,Smax=qo+Sp;return{status:"ÓPTIMO",subtype:"EOQ básico",results:{qo:r2(qo),to_days:r1(to*365),no_orders:r1(no),SR_reorder_point:r0(SR),S_max:r0(Smax),d_daily:r1(dd),CTE:r2(CTE)},decision:{summary:"Modelo EOQ básico",actions:[`Pedir ${r0(qo)} unidades (lote óptimo)`,`Cada ${r1(to*365)} días (${r1(no)} pedidos/año)`,`Reorden en ${r0(SR)} unidades`,`Stock máximo: ${r0(Smax)} un.`,`Costo total anual: $${r2(CTE).toLocaleString("es-AR")}`],costs:{adquisicion:r2(ca),pedidos:r2(co),almacenamiento:r2(ch),proteccion:r2(csp),total:r2(CTE)}},sensitivity:{interpretation:"Desviaciones de ±30% producen solo ~4-5% de aumento en costo"},formulas:{qo:"√(2kD/Tc₁)",source:"Miranda Cap.2"}}}catch(error){return{status:"ERROR",message:`Error: ${error.message}`}}}};

// QUEUE Solver
const QUEUE={solve(p){try{const lam=+p.arrival_rate_lambda,mu=+p.service_rate_mu,M=+(p.num_servers_M||1),N=p.system_capacity_N!=null?+p.system_capacity_N:null,ce=p.cost_per_wait_ce!=null?+p.cost_per_wait_ce:null,cs=p.cost_per_server_cs!=null?+p.cost_per_server_cs:null;if(isNaN(lam)||lam<=0)return{status:"ERROR",message:"Tasa de llegada debe ser positiva"};if(isNaN(mu)||mu<=0)return{status:"ERROR",message:"Tasa de servicio debe ser positiva"};if(isNaN(M)||M<1)return{status:"ERROR",message:"Servidores debe ser >= 1"};let res;if(N!==null){res=M===1?this._mm1n(lam,mu,N):this._mmmn(lam,mu,M,N)}else{res=M===1?this._mm1(lam,mu):this._mmm(lam,mu,M)}if(res.status==="ERROR"||res.status==="INESTABLE")return res;if(ce!==null&&cs!==null)res.economic_analysis=this._econ(lam,mu,M,N,ce,cs);res.decision=this._dec(res,M,lam,mu,ce,cs);return res}catch(error){return{status:"ERROR",message:`Error: ${error.message}`}}},_mm1(lam,mu){const rho=lam/mu;if(rho>=1)return{status:"INESTABLE",message:`ρ=${r3(rho)}≥1. Sistema inestable`,rho:r4(rho)};const p0=1-rho,L=lam/(mu-lam),Lc=lam**2/(mu*(mu-lam)),W=1/(mu-lam),Wc=lam/(mu*(mu-lam)),H=rho;const sp={};for(let n=0;n<=10;n++)sp[n]=r6(rho**n*(1-rho));return{status:"ÓPTIMO",model:"M/M/1",results:{rho:r4(rho),p0:r4(p0),L:r4(L),Lc:r4(Lc),W_hours:r4(W),W_minutes:r2(W*60),Wc_minutes:r2(Wc*60),H:r4(H),utilization_pct:r2(rho*100)},state_probabilities:sp,formulas:{L:"λ/(μ-λ)",source:"Miranda"}}},_mm1n(lam,mu,N){const rho=lam/mu;let p0,sp={};if(Math.abs(rho-1)<1e-10){p0=1/(N+1);for(let n=0;n<=N;n++)sp[n]=r6(p0)}else{p0=(1-rho)/(1-rho**(N+1));for(let n=0;n<=N;n++)sp[n]=r6(rho**n*p0)}const pN=sp[N],leff=lam*(1-pN),rej=lam*pN;let L;if(Math.abs(rho-1)<1e-10){L=N/2}else{L=(rho*(1-(N+1)*rho**N+N*rho**(N+1)))/((1-rho)*(1-rho**(N+1)))}const H=leff/mu,Lc=L-H,W=leff>0?L/leff:0,Wc=leff>0?Lc/leff:0;return{status:"ÓPTIMO",model:"M/M/1/N",results:{rho:r4(rho),N_capacity:N,p0:r6(p0),pN_rejection:r6(pN),lambda_effective:r4(leff),rejection_rate:r4(rej),L:r4(L),Lc:r4(Lc),W_hours:r4(W),W_minutes:r2(W*60),Wc_minutes:r2(Wc*60),H:r4(H),utilization_pct:r2(H*100)},state_probabilities:sp,formulas:{source:"Miranda"}}},_mmm(lam,mu,M){const rt=lam/mu,rho=lam/(M*mu);if(rho>=1)return{status:"INESTABLE",message:`ρ=${r3(rho)}≥1. Se necesitan ${Math.ceil(lam/mu)} servidores`,rho:r4(rho),min_servers:Math.ceil(lam/mu)};const m=this._mmmCalc(lam,mu,M);const sp={};for(let n=0;n<Math.min(M+10,20);n++)sp[n]=r6(n<M?(rt**n/fact(n))*m.p0:(rt**n/(fact(M)*M**(n-M)))*m.p0);return{status:"ÓPTIMO",model:"M/M/M",results:{M_servers:M,rho_per_server:r4(rho),rho_total:r4(rt),p0:r6(m.p0),prob_wait:r4(m.Ce),L:r4(m.L),Lc:r4(m.Lc),W_hours:r4(m.W),W_minutes:r2(m.W*60),Wc_minutes:r2(m.Wc*60),H:r4(m.H),utilization_pct:r2(rho*100)},state_probabilities:sp,formulas:{source:"Miranda"}}},_mmmn(lam,mu,M,N){const rt=lam/mu,co=[];for(let n=0;n<=N;n++)co.push(n<=M?rt**n/fact(n):rt**n/(fact(M)*M**(n-M)));const p0=1/co.reduce((a,b)=>a+b,0);const sp={};for(let n=0;n<=N;n++)sp[n]=r6(co[n]*p0);const pN=sp[N],leff=lam*(1-pN);let L=0;for(let n=0;n<=N;n++)L+=n*sp[n];const H=leff/mu,Lc=L-H,W=leff>0?L/leff:0,Wc=leff>0?Lc/leff:0;return{status:"ÓPTIMO",model:"M/M/M/N",results:{M_servers:M,N_capacity:N,rho_per_server:r4(rho),p0:r6(p0),pN_rejection:r6(pN),lambda_effective:r4(leff),L:r4(L),Lc:r4(Lc),W_minutes:r2(W*60),Wc_minutes:r2(Wc*60),H:r4(H),utilization_pct:r2((leff/mu/M)*100)},state_probabilities:sp,formulas:{source:"Miranda"}}},_mmmCalc(lam,mu,M){const rt=lam/mu,rho=lam/(M*mu);if(rho>=1)return null;let s1=0;for(let n=0;n<M;n++)s1+=rt**n/fact(n);const s2=(rt**M/fact(M))*(1/(1-rho)),p0=1/(s1+s2),Ce=(rt**M/fact(M))*(1/(1-rho))*p0,Lc=(Ce*rho)/(1-rho),H=rt,L=Lc+H,Wc=Lc/lam,W=Wc+1/mu;return{p0,Ce,Lc,L,Wc,W,H,rho}},_econ(lam,mu,Mcur,N,ce,cs){const Mmin=Math.max(1,Math.ceil(lam/mu)),Mmax=Mmin+5,comp=[];for(let Mt=Math.max(1,Mmin-1);Mt<=Mmax;Mt++){const rho=lam/(Mt*mu);if(N===null&&rho>=1){comp.push({M:Mt,status:"INESTABLE"});continue}let L,Lc,Wch;if(N!==null){const r=Mt>1?this._mmmn(lam,mu,Mt,N):this._mm1n(lam,mu,N);L=r.results.L;Lc=r.results.Lc;Wch=r.results.Wc_hours||0}else if(Mt===1){L=lam/(mu-lam);Lc=lam**2/(mu*(mu-lam));Wch=lam/(mu*(mu-lam))}else{const m=this._mmmCalc(lam,mu,Mt);if(!m){comp.push({M:Mt,status:"INESTABLE"});continue}L=m.L;Lc=m.Lc;Wch=m.Wc}const cw=ce*L,csv=cs*Mt,ct=cw+csv;comp.push({M:Mt,status:"ESTABLE",rho:r4(rho),Wc_minutes:r2((Wch||0)*60),Lc:r2(Lc),L:r2(L),cost_wait_per_hour:r2(cw),cost_servers_per_hour:r2(csv),cost_total_per_hour:r2(ct)})}const stab=comp.filter(c=>c.status==="ESTABLE");if(stab.length){const opt=stab.reduce((a,b)=>a.cost_total_per_hour<b.cost_total_per_hour?a:b);opt.is_optimal=true}return{comparisons:comp,optimal_M:stab.length?stab.reduce((a,b)=>a.cost_total_per_hour<b.cost_total_per_hour?a:b).M:null}},_dec(res,M,lam,mu,ce,cs){const r=res.results;const dec={summary:`Modelo ${res.model} resuelto. Utilización: ${r.utilization_pct||r2((r.rho||0)*100)}%.`,actions:[]};dec.actions.push(`Espera en cola: ${r.Wc_minutes} minutos.`);dec.actions.push(`Clientes en cola: ${r.Lc}.`);const ec=res.economic_analysis;if(ec&&ec.optimal_M){if(ec.optimal_M>M){dec.actions.push(`Agregar ${ec.optimal_M-M} servidor(es)`)}else if(ec.optimal_M<M){dec.actions.push(`Se podrían reducir servidores`)}}return dec}};

// INVEST Solver - Project Evaluation
const INVEST={
solve(p){
 try{
  if(!p.alternatives||!Array.isArray(p.alternatives)||p.alternatives.length<1)return{status:"ERROR",message:"Se requiere al menos una alternativa"};
  const invResults=p.alternatives.map((alt,idx)=>this.solveAlt(alt,idx,p.decision_type));
  const hasErr=invResults.find(r=>r.status==='ERROR');
  if(hasErr)return hasErr;
  const decision=this._decideAlt(invResults,p.decision_type);
  return{status:"ÓPTIMO",decision_type:p.decision_type||'independent',alternatives:invResults,comparison:decision,interpretation:decision.interpretation};
 }catch(e){return{status:"ERROR",message:"Error: "+e.message};}
},
solveAlt(alt,idx,dtype){
 const I0=+alt.initial_investment;
 const WC=+(alt.working_capital||0);
 const T=+alt.useful_life;
 const Rv=+(alt.residual_value||0);
 const R=+alt.annual_revenue;
 const VC=+(alt.variable_costs||0);
 const FC=+(alt.fixed_costs||0);
 const tr=+(alt.tax_rate||0.35);
 const r=+(alt.discount_rate||0.12);
 if(isNaN(I0)||I0<=0)return{status:"ERROR",message:"Alt "+(idx+1)+": Inversión inicial debe ser positiva"};
 if(isNaN(T)||T<=0)return{status:"ERROR",message:"Alt "+(idx+1)+": Vida útil debe ser positiva"};
 if(isNaN(r)||r<0)return{status:"ERROR",message:"Alt "+(idx+1)+": Tasa descuento debe ser no negativa"};
 const D=I0/T;
 const fcfTable=[];
 for(let t=0;t<=T;t++){
  let fcf;
  if(t===0){fcf=-I0-WC;}
  else{
   const EBIT=R-VC-FC-D;
   const tax=Math.max(0,EBIT*tr);
   let opCF=EBIT-tax+D;
   if(t===T){opCF+=Rv+WC;}
   fcf=opCF;
  }
  fcfTable.push({year:t,fcf:Math.round(fcf*100)/100});
 }
 const npvVal=function(rate){let n=0;for(let t=0;t<=T;t++){n+=fcfTable[t].fcf/Math.pow(1+rate,t);}return n;};
 const van=Math.round(npvVal(r)*100)/100;
 // TIR via Newton-Raphson
 let tir=0.1;
 for(let i=0;i<200;i++){
  const f=npvVal(tir);
  const fp=(npvVal(tir+0.0001)-f)/0.0001;
  if(Math.abs(fp)<1e-12)break;
  const next=tir-f/fp;
  if(Math.abs(next-tir)<1e-8){tir=next;break;}
  tir=next;
 }
 if(isNaN(tir)||!isFinite(tir)||tir<-0.99)tir=0;
 // Payback simple
 let pbSimp=null,cumS=0;
 for(let t=0;t<=T;t++){
  const prev=cumS;cumS+=fcfTable[t].fcf;
  if(cumS>=0&&pbSimp===null&&t>0){pbSimp=t-1+(Math.abs(prev))/(Math.abs(fcfTable[t].fcf));break;}
 }
 // Payback descontado
 let pbDesc=null,cumD=0;
 for(let t=0;t<=T;t++){
  const pv=fcfTable[t].fcf/Math.pow(1+r,t);
  const prev=cumD;cumD+=pv;
  if(cumD>=0&&pbDesc===null&&t>0){pbDesc=t-1+(Math.abs(prev))/(Math.abs(pv));break;}
 }
 // Profitability index
 let pvFuture=0;for(let t=1;t<=T;t++){pvFuture+=fcfTable[t].fcf/Math.pow(1+r,t);}
 const ir=I0>0?pvFuture/I0:0;
 // Sensitivity
 const sensitivity={};
 const sensParams=[['revenue',R],['variable_costs',VC],['discount_rate',r]];
 for(const[pName,baseVal]of sensParams){
  sensitivity[pName]={};
  const deltas=pName==='discount_rate'?[-2,-1,1,2]:[-10,-5,5,10];
  for(const d of deltas){
   const testAlt={...alt};
   if(pName==='revenue')testAlt.annual_revenue=R*(1+d/100);
   else if(pName==='variable_costs')testAlt.variable_costs=VC*(1+d/100);
   else testAlt.discount_rate=r+d/100;
   const testFCF=[];
   const tI0=+testAlt.initial_investment,tWC=+(testAlt.working_capital||0),tT=+testAlt.useful_life,tRv=+(testAlt.residual_value||0),tR=+testAlt.annual_revenue,tVC=+(testAlt.variable_costs||0),tFC=+(testAlt.fixed_costs||0),ttr=+(testAlt.tax_rate||0.35),tr2=+(testAlt.discount_rate||0.12),tD=tI0/tT;
   for(let t=0;t<=tT;t++){
    let f2;
    if(t===0){f2=-tI0-tWC;}
    else{const E2=tR-tVC-tFC-tD;const tx2=Math.max(0,E2*ttr);let o2=E2-tx2+tD;if(t===tT){o2+=tRv+tWC;}f2=o2;}
    testFCF.push(f2);
   }
   let testVan=0;for(let t=0;t<=tT;t++){testVan+=testFCF[t]/Math.pow(1+tr2,t);}
   testVan=Math.round(testVan*100)/100;
   sensitivity[pName][d]={van:testVan,change_pct:van!==0?Math.round((testVan-van)/Math.abs(van)*10000)/100:0};
  }
 }
 return{
  name:alt.name||("Alternativa "+(idx+1)),
  van:van,
  tir:Math.round(tir*10000)/100,
  payback_simple:pbSimp!==null?Math.round(pbSimp*100)/100:T+1,
  payback_descontado:pbDesc!==null?Math.round(pbDesc*100)/100:T+1,
  profitability_index:Math.round(ir*10000)/10000,
  annual_fcf_table:fcfTable,
  sensitivity:sensitivity,
  status:"ÓPTIMO"
 };
},
_decideAlt(results,dtype){
 dtype=dtype||'independent';
 const decision={interpretation:[],winner:null,recommendation:''};
 if(results.length===1){
  const r=results[0];
  decision.winner=r.name;
  decision.recommendation="Alternativa: **"+r.name+"**\n- VAN: $"+r.van.toLocaleString('es-AR')+"\n- TIR: "+r.tir+"%\n- Payback: "+r.payback_simple.toFixed(1)+" años\n- Índice rentabilidad: "+r.profitability_index.toFixed(3);
  decision.interpretation.push("Proyecto **"+r.name+"**: VAN "+(r.van>0?"positivo (viable).":"negativo (no viable)."));
  if(r.tir>0)decision.interpretation.push("TIR = "+r.tir+"% indica retorno anual.");
  return decision;
 }
 if(dtype==='mutually_exclusive'){
  const sorted=results.slice().sort(function(a,b){return b.van-a.van;});
  const best=sorted[0];
  const second=sorted[1];
  decision.winner=best.name;
  decision.interpretation.push("Comparación VAN (criterio principal para mutuamente excluyentes):");
  results.forEach(function(r){decision.interpretation.push("- **"+r.name+"**: VAN = $"+r.van.toLocaleString('es-AR'));});
  if(best.van>0){decision.interpretation.push("✅ **"+best.name+"** es la mejor opción (VAN más alto).");}
  else{decision.interpretation.push("⚠️ Todas las alternativas tienen VAN < 0. Ninguna es recomendable.");}
  if(second&&Math.abs(best.van-second.van)<0.01*Math.abs(best.van)){decision.interpretation.push("📌 Las dos mejores son muy similares en VAN. Considerar factores cualitativos.");}
  var maxTir=Math.max.apply(null,results.map(function(r){return r.tir;}));
  if(best.tir<maxTir){decision.interpretation.push("⚠️ Conflicto VAN vs TIR: Prima VAN sobre TIR para mutuamente excluyentes.");}
  decision.recommendation="**Elegir: "+best.name+"**\n\nComparación:\n";
  results.forEach(function(r){decision.recommendation+="\n- **"+r.name+"**\n  - VAN: $"+r.van.toLocaleString('es-AR')+"\n  - TIR: "+r.tir+"%\n  - Payback: "+r.payback_descontado.toFixed(1)+" años";});
  decision.recommendation+="\n\n**Razón:** Mayor VAN garantiza mayor riqueza creada.";
  return decision;
 }
 if(dtype==='independent'){
  const viable=results.filter(function(r){return r.van>0;});
  decision.interpretation.push("Análisis de proyectos independientes (todos con VAN > 0 son viables):");
  results.forEach(function(r){decision.interpretation.push("- **"+r.name+"**: VAN = $"+r.van.toLocaleString('es-AR')+", TIR = "+r.tir+"%");});
  if(viable.length===0){
   decision.interpretation.push("⚠️ Ningún proyecto tiene VAN positivo.");
   decision.recommendation="**Rechazar todos** — Ninguno crea valor (VAN ≤ 0).";
  }else{
   decision.recommendation="**Aceptar proyectos viables:**\n\n";
   viable.forEach(function(v){decision.recommendation+="✅ **"+v.name+"** (VAN = $"+v.van.toLocaleString('es-AR')+")\n";});
   decision.interpretation.push("✅ Aceptar todos los proyectos con VAN > 0.");
  }
  return decision;
 }
 return decision;
}
};

// ═══════════════════════════════════════════════════════════
// FORECAST — Demand Forecasting Solver
// ═══════════════════════════════════════════════════════════
const FORECAST={
solve(p){
 const data=p.timeseries;
 const method=p.method;
 const ahead=p.periods_ahead||1;
 if(!data||data.length<3)return{status:'ERROR',message:'Se necesitan al menos 3 períodos de datos históricos.'};
 if(method==='ALL')return this._solveAll(p);
 if(method==='SMA')return this._solveSMA(data,p.window||3,ahead);
 if(method==='WMA')return this._solveWMA(data,p.weights||[],ahead);
 if(method==='SES')return this._solveSES(data,p.alpha||0.2,ahead);
 if(method==='REG')return this._solveRegression(data,ahead);
 return{status:'ERROR',message:'Método no reconocido: '+method};
},

_errorMetrics(actual,forecast){
 const pairs=[];
 for(let i=0;i<actual.length;i++){
  if(forecast[i]!==null&&forecast[i]!==undefined&&actual[i]!==null&&actual[i]!==undefined){
   pairs.push({a:actual[i],f:forecast[i]});
  }
 }
 if(pairs.length===0)return{mad:0,mse:0,mape:0,rsfe:0,tracking_signal:0,n:0};
 let sumAbsErr=0,sumSqErr=0,sumPctErr=0,rsfe=0;
 const detail=[];
 let cumAbsErr=0;
 for(let i=0;i<pairs.length;i++){
  const err=pairs[i].a-pairs[i].f;
  const absErr=Math.abs(err);
  const sqErr=err*err;
  const pctErr=pairs[i].a!==0?Math.abs(err)/Math.abs(pairs[i].a):0;
  rsfe+=err;
  sumAbsErr+=absErr;
  sumSqErr+=sqErr;
  sumPctErr+=pctErr;
  cumAbsErr+=absErr;
  const mad_t=cumAbsErr/(i+1);
  const ts_t=mad_t!==0?rsfe/mad_t:0;
  detail.push({error:err,abs_error:absErr,sq_error:sqErr,pct_error:pctErr,rsfe,mad_t:r2(mad_t),ts_t:r2(ts_t)});
 }
 const n=pairs.length;
 return{
  mad:r2(sumAbsErr/n),
  mse:r2(sumSqErr/n),
  mape:r2((sumPctErr/n)*100),
  rsfe:r2(rsfe),
  tracking_signal:r2(sumAbsErr>0?rsfe/(sumAbsErr/n):0),
  n,detail
 };
},

_solveSMA(data,n,ahead){
 if(n>data.length)return{status:'ERROR',message:`Se necesitan al menos ${n} períodos para SMA(${n}). Tenés ${data.length}.`};
 const fitted=new Array(data.length).fill(null);
 // Forecast for periods n+1 onward (using previous n values)
 for(let i=n;i<data.length;i++){
  let sum=0;
  for(let j=i-n;j<i;j++)sum+=data[j];
  fitted[i]=r2(sum/n);
 }
 // Error metrics on fitted vs actual (starting from period n)
 const metrics=this._errorMetrics(data,fitted);
 // Build detail table
 const detail_table=[];
 for(let i=0;i<data.length;i++){
  const row={period:i+1,actual:data[i],forecast:fitted[i]};
  if(fitted[i]!==null){
   const idx=i-n; // index into metrics.detail
   if(idx>=0&&idx<metrics.detail.length){
    Object.assign(row,metrics.detail[idx]);
   }
  }
  detail_table.push(row);
 }
 // Future forecast
 const forecast=[];
 let window=[...data.slice(-n)];
 for(let h=0;h<ahead;h++){
  const f=r2(window.reduce((a,b)=>a+b,0)/n);
  forecast.push(f);
  window.push(f);window.shift();
 }
 const tsOk=Math.abs(metrics.tracking_signal)<=4;
 return{
  status:'ÓPTIMO',
  model:`Promedio Móvil Simple (n=${n})`,
  method:'SMA',
  results:{
   forecast,fitted,
   errors:metrics,
   detail_table,
   params_used:{n}
  },
  decision:{
   summary:`Pronóstico SMA(${n})`,
   actions:[
    `Próximo período: ~${forecast[0]} unidades`,
    `Error promedio (MAD): ±${metrics.mad} unidades`,
    `MAPE: ${metrics.mape}%`,
    tsOk?`Tracking Signal: ${metrics.tracking_signal} → dentro del rango [-4, 4], modelo confiable`:`⚠️ Tracking Signal: ${metrics.tracking_signal} → FUERA del rango [-4, 4], revisar modelo`
   ]
  }
 };
},

_solveWMA(data,weights,ahead){
 const n=weights.length;
 if(n<2)return{status:'ERROR',message:'Se necesitan al menos 2 pesos para WMA.'};
 if(n>data.length)return{status:'ERROR',message:`Se necesitan al menos ${n} períodos para WMA con ${n} pesos. Tenés ${data.length}.`};
 const wSum=weights.reduce((a,b)=>a+b,0);
 if(Math.abs(wSum-1)>0.05)return{status:'ERROR',message:`Los pesos deben sumar 1.0. Actualmente suman ${r2(wSum)}.`};
 // Normalize weights just in case
 const w=weights.map(x=>x/wSum);
 const fitted=new Array(data.length).fill(null);
 for(let i=n;i<data.length;i++){
  let sum=0;
  for(let j=0;j<n;j++){sum+=data[i-n+j]*w[n-1-j];} // w[0] = most recent weight
  fitted[i]=r2(sum);
 }
 const metrics=this._errorMetrics(data,fitted);
 const detail_table=[];
 for(let i=0;i<data.length;i++){
  const row={period:i+1,actual:data[i],forecast:fitted[i]};
  if(fitted[i]!==null){
   const idx=i-n;
   if(idx>=0&&idx<metrics.detail.length)Object.assign(row,metrics.detail[idx]);
  }
  detail_table.push(row);
 }
 const forecast=[];
 let window=[...data.slice(-n)];
 for(let h=0;h<ahead;h++){
  let sum=0;
  for(let j=0;j<n;j++)sum+=window[j]*w[n-1-j];
  const f=r2(sum);
  forecast.push(f);
  window.push(f);window.shift();
 }
 const tsOk=Math.abs(metrics.tracking_signal)<=4;
 return{
  status:'ÓPTIMO',
  model:`Promedio Móvil Ponderado (n=${n})`,
  method:'WMA',
  results:{forecast,fitted,errors:metrics,detail_table,params_used:{n,weights:w}},
  decision:{
   summary:`Pronóstico WMA(${n})`,
   actions:[
    `Próximo período: ~${forecast[0]} unidades`,
    `Pesos: ${w.map(x=>r2(x)).join(', ')} (más reciente primero)`,
    `Error promedio (MAD): ±${metrics.mad} unidades`,
    `MAPE: ${metrics.mape}%`,
    tsOk?`Tracking Signal: ${metrics.tracking_signal} → modelo confiable`:`⚠️ Tracking Signal: ${metrics.tracking_signal} → FUERA de rango, revisar modelo`
   ]
  }
 };
},

_solveSES(data,alpha,ahead){
 if(alpha<=0||alpha>=1)return{status:'ERROR',message:'Alpha debe estar entre 0 y 1 (exclusivo).'};
 const fitted=new Array(data.length).fill(null);
 // F(1) = D(0) (first actual value as initial forecast)
 fitted[1]=data[0];
 for(let i=2;i<data.length;i++){
  fitted[i]=r2(alpha*data[i-1]+(1-alpha)*fitted[i-1]);
 }
 const metrics=this._errorMetrics(data,fitted);
 const detail_table=[];
 let detailIdx=0;
 for(let i=0;i<data.length;i++){
  const row={period:i+1,actual:data[i],forecast:fitted[i]};
  if(fitted[i]!==null){
   if(detailIdx<metrics.detail.length)Object.assign(row,metrics.detail[detailIdx++]);
  }
  detail_table.push(row);
 }
 // Future forecast
 const forecast=[];
 let lastF=r2(alpha*data[data.length-1]+(1-alpha)*fitted[data.length-1]);
 for(let h=0;h<ahead;h++){
  forecast.push(lastF);
  // SES flat forecast: all future values are the same
 }
 const tsOk=Math.abs(metrics.tracking_signal)<=4;
 return{
  status:'ÓPTIMO',
  model:`Suavización Exponencial Simple (α=${alpha})`,
  method:'SES',
  results:{forecast,fitted,errors:metrics,detail_table,params_used:{alpha}},
  decision:{
   summary:`Pronóstico SES(α=${alpha})`,
   actions:[
    `Próximo período: ~${forecast[0]} unidades`,
    `Alpha: ${alpha} (${alpha<0.2?'bajo — mucho suavizado':alpha<0.4?'moderado':'alto — reactivo a cambios'})`,
    `Error promedio (MAD): ±${metrics.mad} unidades`,
    `MAPE: ${metrics.mape}%`,
    tsOk?`Tracking Signal: ${metrics.tracking_signal} → modelo confiable`:`⚠️ Tracking Signal: ${metrics.tracking_signal} → FUERA de rango, revisar modelo`
   ]
  }
 };
},

_solveRegression(data,ahead){
 const n=data.length;
 // t = 1,2,...,n
 let sumT=0,sumD=0,sumTD=0,sumT2=0;
 for(let i=0;i<n;i++){
  const t=i+1;
  sumT+=t;sumD+=data[i];sumTD+=t*data[i];sumT2+=t*t;
 }
 const tBar=sumT/n;
 const dBar=sumD/n;
 const b1=(sumTD-n*tBar*dBar)/(sumT2-n*tBar*tBar);
 const b0=dBar-b1*tBar;
 const fitted=[];
 let ssRes=0,ssTot=0;
 for(let i=0;i<n;i++){
  const f=r2(b0+b1*(i+1));
  fitted.push(f);
  ssRes+=(data[i]-f)**2;
  ssTot+=(data[i]-dBar)**2;
 }
 const R2=ssTot>0?r2(1-ssRes/ssTot):0;
 const metrics=this._errorMetrics(data,fitted);
 const detail_table=[];
 for(let i=0;i<n;i++){
  const row={period:i+1,actual:data[i],forecast:fitted[i]};
  if(i<metrics.detail.length)Object.assign(row,metrics.detail[i]);
  detail_table.push(row);
 }
 const forecast=[];
 for(let h=1;h<=ahead;h++){
  forecast.push(r2(b0+b1*(n+h)));
 }
 const trend=b1>0?'creciente':'decreciente';
 const tsOk=Math.abs(metrics.tracking_signal)<=4;
 return{
  status:'ÓPTIMO',
  model:'Regresión Lineal',
  method:'REG',
  results:{forecast,fitted,errors:metrics,detail_table,params_used:{b0:r2(b0),b1:r2(b1),R2},R2},
  decision:{
   summary:'Pronóstico por Regresión Lineal',
   actions:[
    `Ecuación: ŷ = ${r2(b0)} + ${r2(b1)} × t`,
    `R² = ${R2} (${R2>0.8?'buen ajuste':R2>0.5?'ajuste moderado':'ajuste débil'})`,
    `Tendencia ${trend}: ${b1>0?'+':''} ${r2(b1)} unidades por período`,
    `Próximo período: ~${forecast[0]} unidades`,
    `Error promedio (MAD): ±${metrics.mad} unidades`,
    `MAPE: ${metrics.mape}%`,
    tsOk?`Tracking Signal: ${metrics.tracking_signal} → modelo confiable`:`⚠️ Tracking Signal: ${metrics.tracking_signal} → FUERA de rango`
   ]
  }
 };
},

_solveAll(p){
 const data=p.timeseries;
 const ahead=p.periods_ahead||1;
 const smaN=Math.max(2,Math.round(p.window||3));
 const sesA=p.alpha||0.2;
 const methods=[];
 // SMA with n (default 3, adjustable via sensitivity)
 try{const r=this._solveSMA(data,smaN,ahead);if(r.status==='ÓPTIMO')methods.push({name:'SMA('+smaN+')',method:'SMA',result:r});}catch(e){}
 // WMA with default weights [0.5,0.3,0.2]
 try{const r=this._solveWMA(data,[0.5,0.3,0.2],ahead);if(r.status==='ÓPTIMO')methods.push({name:'WMA(3)',method:'WMA',result:r});}catch(e){}
 // SES with alpha (default 0.2, adjustable via sensitivity)
 try{const r=this._solveSES(data,sesA,ahead);if(r.status==='ÓPTIMO')methods.push({name:'SES(α='+sesA.toFixed(2)+')',method:'SES',result:r});}catch(e){}
 // Regression
 try{const r=this._solveRegression(data,ahead);if(r.status==='ÓPTIMO')methods.push({name:'Regresión',method:'REG',result:r});}catch(e){}
 if(methods.length===0)return{status:'ERROR',message:'No se pudo calcular ningún método.'};
 // Compare by MAD
 methods.sort((a,b)=>(a.result.results.errors.mad)-(b.result.results.errors.mad));
 const best=methods[0];
 const comparison=methods.map((m,i)=>({
  method:m.name,
  mad:m.result.results.errors.mad,
  mse:m.result.results.errors.mse,
  mape:m.result.results.errors.mape,
  tracking_signal:m.result.results.errors.tracking_signal,
  forecast_next:m.result.results.forecast[0],
  is_best:i===0
 }));
 return{
  status:'ÓPTIMO',
  model:'Comparación de Métodos',
  method:'ALL',
  best_method:best.name,
  results:{
   forecast:best.result.results.forecast,
   fitted:best.result.results.fitted,
   errors:best.result.results.errors,
   detail_table:best.result.results.detail_table,
   comparison,
   all_methods:methods.map(m=>({name:m.name,method:m.method,result:m.result}))
  },
  decision:{
   summary:`Mejor método: ${best.name} (menor MAD)`,
   actions:[
    `${best.name} tiene el menor error (MAD: ${best.result.results.errors.mad})`,
    `Pronóstico próximo período: ~${best.result.results.forecast[0]} unidades`,
    `MAPE: ${best.result.results.errors.mape}%`,
    ...comparison.filter(c=>!c.is_best).map(c=>`${c.method}: MAD=${c.mad}, MAPE=${c.mape}%, forecast=${c.forecast_next}`)
   ]
  }
 };
}
};

// ═══════════════════════════════════════════════════════════
// RENTABILIDAD — Profitability Analysis Solver
// ═══════════════════════════════════════════════════════════
const RENTABILIDAD={
solve(p){
 const products=p.products||[];
 if(products.length===0)return{status:'ERROR',message:'Se necesita al menos un producto para analizar rentabilidad.'};
 const fixedCosts=+(p.fixed_costs||0);
 const results=[];let totalRevenue=0,totalCost=0,totalProfit=0;
 for(const prod of products){
  const price=+(prod.price||0);
  const unitCost=+(prod.unit_cost||0);
  const qty=+(prod.quantity||0);
  if(price<=0)return{status:'ERROR',message:`Precio de "${prod.name}" debe ser mayor a 0.`};
  if(unitCost<0)return{status:'ERROR',message:`Costo unitario de "${prod.name}" no puede ser negativo.`};
  const margin=price-unitCost;
  const marginPct=price>0?r2((margin/price)*100):0;
  const revenue=r2(price*qty);
  const variableCost=r2(unitCost*qty);
  const contribution=r2(margin*qty);
  // Break-even for this product (considering its share of fixed costs)
  const fixedShare=products.length>0?fixedCosts/products.length:fixedCosts;
  const breakEvenUnits=margin>0?Math.ceil(fixedShare/margin):Infinity;
  const breakEvenRevenue=r2(breakEvenUnits*price);
  totalRevenue+=revenue;
  totalCost+=variableCost;
  totalProfit+=contribution;
  results.push({name:prod.name,price,unit_cost:unitCost,quantity:qty,margin:r2(margin),margin_pct:marginPct,revenue,variable_cost:variableCost,contribution,break_even_units:breakEvenUnits,break_even_revenue:breakEvenRevenue,fixed_share:r2(fixedShare)});
 }
 totalCost+=fixedCosts;
 const netProfit=r2(totalProfit-fixedCosts);
 const netMarginPct=totalRevenue>0?r2((netProfit/totalRevenue)*100):0;
 // Global break-even
 const avgContribMargin=products.length>0?totalProfit/products.reduce((s,p)=>s+(+(p.quantity||0)),0):0;
 const globalBreakEvenUnits=avgContribMargin>0?Math.ceil(fixedCosts/avgContribMargin):Infinity;
 // Ranking by margin %
 const ranked=[...results].sort((a,b)=>b.margin_pct-a.margin_pct);
 // Best and worst
 const best=ranked[0];
 const worst=ranked[ranked.length-1];
 // Decision
 const actions=[];
 actions.push(`Ingreso total: $${totalRevenue.toLocaleString('es-AR')}`);
 actions.push(`Costo total (variable + fijo): $${totalCost.toLocaleString('es-AR')}`);
 actions.push(`Ganancia neta: $${netProfit.toLocaleString('es-AR')} (${netMarginPct}% sobre ventas)`);
 if(products.length>1){
  actions.push(`Producto más rentable: ${best.name} (margen ${best.margin_pct}%)`);
  if(worst.margin_pct<10)actions.push(`⚠️ ${worst.name} tiene margen bajo (${worst.margin_pct}%) — revisar precio o costos`);
 }
 if(netProfit<0)actions.push('⚠️ Operación a pérdida. Revisar precios, costos o volumen.');
 return{
  status:'ÓPTIMO',
  model:'Análisis de Rentabilidad',
  results:{products:results,total_revenue:totalRevenue,total_variable_cost:r2(totalCost-fixedCosts),fixed_costs:fixedCosts,total_cost:totalCost,net_profit:netProfit,net_margin_pct:netMarginPct,global_break_even_units:globalBreakEvenUnits,avg_contribution_margin:r2(avgContribMargin),ranking:ranked},
  decision:{summary:netProfit>=0?`Ganancia neta: $${netProfit.toLocaleString('es-AR')} (${netMarginPct}% margen)`:`Pérdida: $${Math.abs(netProfit).toLocaleString('es-AR')}`,actions},
  sensitivity:{price_5pct:this._sensPrice(products,fixedCosts,5),price_10pct:this._sensPrice(products,fixedCosts,10),cost_5pct:this._sensCost(products,fixedCosts,5),cost_10pct:this._sensCost(products,fixedCosts,10)}
 };
},
_sensPrice(products,fc,pct){
 let rev=0,cost=fc,profit=0;
 for(const p of products){
  const newPrice=(+(p.price||0))*(1+pct/100);
  const qty=+(p.quantity||0);
  const uc=+(p.unit_cost||0);
  rev+=newPrice*qty;cost+=uc*qty;profit+=(newPrice-uc)*qty;
 }
 return{net_profit:r2(profit-fc),total_revenue:r2(rev)};
},
_sensCost(products,fc,pct){
 let rev=0,cost=fc,profit=0;
 for(const p of products){
  const price=+(p.price||0);
  const qty=+(p.quantity||0);
  const newCost=(+(p.unit_cost||0))*(1+pct/100);
  rev+=price*qty;cost+=newCost*qty;profit+=(price-newCost)*qty;
 }
 return{net_profit:r2(profit-fc),total_revenue:r2(rev)};
}
};

// ─── FLUJO DE CAJA SOLVER ───
const FLUJO_CAJA={
 solve(p){
  const opening=+(p.opening_balance||0);
  const nPeriods=+(p.periods||6);
  const inflows=p.inflows||[];
  const outflows=p.outflows||[];
  const dso=+(p.dso||0); // Days Sales Outstanding (plazo cobro)
  const dpo=+(p.dpo||0); // Days Payable Outstanding (plazo pago)
  if(inflows.length===0&&outflows.length===0)return{status:'ERROR',message:'Se necesita al menos un ingreso o egreso.'};
  const totalIn=inflows.reduce((s,i)=>s+(+(i.amount||0)),0);
  const totalOut=outflows.reduce((s,o)=>s+(+(o.amount||0)),0);
  // DSO/DPO: convert days to fraction of month delayed
  const dsoMonths=dso/30; // e.g. 45 days = 1.5 months
  const dpoMonths=dpo/30;
  // Effective cash received per month = totalIn * (30 / (30 + DSO_extra_days))
  // Simplified: in month M, we receive sales from M - dsoMonths ago
  // For first dsoMonths months, partial inflows; after that, steady state
  const netMonthly=totalIn-totalOut;
  const timeline=[];
  let bal=opening;
  let minBal=opening,minMonth=1,negMonths=0,firstNeg=null;
  // Accumulate deferred inflows/outflows
  const dsoLagMonths=Math.ceil(dsoMonths);
  const dpoLagMonths=Math.ceil(dpoMonths);
  for(let m=1;m<=nPeriods;m++){
   const ob=bal;
   // DSO effect: first dsoLag months have reduced inflows (sales made but not yet collected)
   let effectiveIn=totalIn;
   if(dso>0&&m<=dsoLagMonths){
    // Ramp up: in month 1 with 60-day DSO, you collect 0; month 2, partial; month 3+, full
    const collectFraction=Math.max(0,Math.min(1,(m-dsoMonths)));
    effectiveIn=r2(totalIn*Math.max(0,collectFraction));
   }
   // DPO effect: first dpoLag months have reduced outflows (you delay paying suppliers)
   let effectiveOut=totalOut;
   if(dpo>0&&m<=dpoLagMonths){
    const payFraction=Math.max(0,Math.min(1,(m-dpoMonths)));
    effectiveOut=r2(totalOut*Math.max(0,payFraction));
   }
   const cb=r2(ob+effectiveIn-effectiveOut);
   timeline.push({month:m,opening:r2(ob),inflows:r2(effectiveIn),outflows:r2(effectiveOut),closing:cb});
   if(cb<0){negMonths++;if(firstNeg===null)firstNeg=m;}
   if(cb<minBal){minBal=cb;minMonth=m;}
   bal=cb;
  }
  const finalBal=timeline[timeline.length-1].closing;
  const totalInAll=r2(totalIn*nPeriods);
  const totalOutAll=r2(totalOut*nPeriods);
  // Decision
  let summary,severity;
  if(negMonths===0&&finalBal>opening){summary='Tu caja crece de forma sostenida. Buen panorama financiero.';severity='OK';}
  else if(negMonths===0&&finalBal<=opening){summary='Tu caja se mantiene estable pero no crece. Revisá márgenes.';severity='WARN';}
  else if(negMonths>0&&negMonths<=nPeriods/2){summary=`Tu caja entra en rojo en el mes ${firstNeg}. Necesitás financiamiento o reducir egresos.`;severity='WARN';}
  else{summary=`Tu caja está en rojo ${negMonths} de ${nPeriods} meses. Situación crítica — revisá urgente.`;severity='CRITICAL';}
  const actions=[];
  if(negMonths>0)actions.push('Buscar financiamiento antes del mes '+firstNeg);
  if(totalOut>totalIn)actions.push('Reducir egresos o aumentar ingresos — flujo neto negativo');
  if(finalBal<0)actions.push('El saldo final es negativo: $'+r0(finalBal).toLocaleString('es-AR'));
  if(netMonthly>0&&negMonths===0)actions.push('Flujo neto positivo de $'+r0(netMonthly).toLocaleString('es-AR')+'/mes');
  if(dso>0)actions.push('DSO (plazo cobro): '+dso+' días — cobrás en promedio '+Math.round(dso)+' días después de vender');
  if(dpo>0)actions.push('DPO (plazo pago): '+dpo+' días — pagás proveedores en '+Math.round(dpo)+' días');
  if(dso>0&&dpo>0){const ccc=dso-dpo;if(ccc>0)actions.push('Ciclo de conversión de caja: '+Math.round(ccc)+' días — necesitás financiar '+Math.round(ccc)+' días de operación');else actions.push('Ciclo de conversión de caja: '+Math.round(Math.abs(ccc))+' días a favor — tus proveedores te financian');}
  if(dso>0&&negMonths>0)actions.push('Reducir DSO (cobrar más rápido) mejoraría tu liquidez en los primeros meses');
  // Sensitivity
  const sensIn10=FLUJO_CAJA._sensInflows(opening,totalIn,totalOut,nPeriods,-0.10);
  const sensIn20=FLUJO_CAJA._sensInflows(opening,totalIn,totalOut,nPeriods,-0.20);
  const sensOut10=FLUJO_CAJA._sensOutflows(opening,totalIn,totalOut,nPeriods,0.10);
  const sensOut20=FLUJO_CAJA._sensOutflows(opening,totalIn,totalOut,nPeriods,0.20);
  return{
   status:severity==='CRITICAL'?'⚠️ CRÍTICO':severity==='WARN'?'⚠️ ATENCIÓN':'ÓPTIMO',
   model:'Proyección de Flujo de Caja',
   results:{opening,nPeriods,inflows,outflows,totalIn,totalOut,net_monthly:r2(netMonthly),totalInAll,totalOutAll,timeline,final_balance:finalBal,min_balance:minBal,min_month:minMonth,neg_months:negMonths,first_neg_month:firstNeg,dso,dpo,ccc:Math.max(0,dso-dpo)},
   decision:{summary,actions,severity},
   sensitivity:{inflows_minus10:sensIn10,inflows_minus20:sensIn20,outflows_plus10:sensOut10,outflows_plus20:sensOut20}
  };
 },
 _sensInflows(opening,tin,tout,n,pct){
  let bal=opening;const adj=tin*(1+pct);
  for(let m=1;m<=n;m++)bal=bal+adj-tout;
  return{final_balance:r2(bal),net_monthly:r2(adj-tout)};
 },
 _sensOutflows(opening,tin,tout,n,pct){
  let bal=opening;const adj=tout*(1+pct);
  for(let m=1;m<=n;m++)bal=bal+tin-adj;
  return{final_balance:r2(bal),net_monthly:r2(tin-adj)};
 }
};

function r0(v){return Math.round(v);}

// ═══ MODULE CHAINING — connect solver outputs to next solver inputs ═══
const CHAIN_MAP={
 FORECAST:[
  {to:'STOCK',label:'Inventario',extract:function(sol,par){
   var fc=sol.results.forecast||[];var monthly=fc[0]||0;var annual=r2(monthly*12);
   return{params:{demand_D:annual,order_cost_k:undefined,holding_cost_c1:undefined,acquisition_cost_b:undefined,planning_horizon_T:1,lead_time_LT:0,safety_stock_Sp:0},description:'Demanda pronosticada: '+monthly.toLocaleString('es-AR')+'/mes → '+annual.toLocaleString('es-AR')+'/año'};
  }},
  {to:'FLUJO_CAJA',label:'Flujo de Caja',extract:function(sol,par){
   var fc=sol.results.forecast||[];var monthly=fc[0]||0;
   return{params:{opening_balance:undefined,periods:6,inflows:[{name:'Ingreso estimado (pronóstico)',amount:r2(monthly)}],outflows:[],dso:undefined,dpo:undefined},description:'Ingreso mensual estimado: $'+monthly.toLocaleString('es-AR')};
  }}
 ],
 STOCK:[
  {to:'FLUJO_CAJA',label:'Flujo de Caja',extract:function(sol,par){
   var cte=sol.results.CTE||0;var monthlyCost=r2(cte/12);
   var unitCost=par.acquisition_cost_b||0;var qo=sol.results.qo||0;
   var nOrders=sol.results.no_orders||0;var monthlyPurchase=r2(unitCost*qo*nOrders/12);
   var outs=[{name:'Costos inventario (EOQ)',amount:monthlyCost}];
   if(monthlyPurchase>0)outs.push({name:'Compras de mercadería',amount:monthlyPurchase});
   return{params:{opening_balance:undefined,periods:6,inflows:[],outflows:outs,dso:undefined,dpo:undefined},description:'Costo inventario: $'+monthlyCost.toLocaleString('es-AR')+'/mes'+(monthlyPurchase>0?' + compras $'+monthlyPurchase.toLocaleString('es-AR')+'/mes':'')};
  }}
 ],
 RENTABILIDAD:[
  {to:'FLUJO_CAJA',label:'Flujo de Caja',extract:function(sol,par){
   var res=sol.results;var ins=[];var outs=[];
   if(res.products){res.products.forEach(function(pr){if(pr.revenue>0)ins.push({name:pr.name+' (ventas)',amount:r2(pr.revenue)});});}
   if(res.total_variable_cost>0)outs.push({name:'Costos variables',amount:r2(res.total_variable_cost)});
   if(res.fixed_costs>0)outs.push({name:'Costos fijos',amount:r2(res.fixed_costs)});
   return{params:{opening_balance:undefined,periods:6,inflows:ins,outflows:outs,dso:undefined,dpo:undefined},description:'Ingresos: $'+r2(res.total_revenue||0).toLocaleString('es-AR')+'/mes — Costos: $'+r2(res.total_cost||0).toLocaleString('es-AR')+'/mes'};
  }}
 ],
 INVEST:[
  {to:'FLUJO_CAJA',label:'Flujo de Caja',extract:function(sol,par){
   var alt=sol.alternatives&&sol.alternatives[0]?sol.alternatives[0]:null;
   if(!alt)return{params:{opening_balance:0,periods:6,inflows:[],outflows:[],dso:undefined,dpo:undefined},description:'Sin datos de inversión'};
   var I0=Math.abs(alt.annual_fcf_table&&alt.annual_fcf_table[0]?alt.annual_fcf_table[0].fcf:0);
   var avgFCF=0;var fcfTable=alt.annual_fcf_table||[];
   for(var i=1;i<fcfTable.length;i++)avgFCF+=fcfTable[i].fcf;
   if(fcfTable.length>1)avgFCF=r2(avgFCF/(fcfTable.length-1)/12);
   var ins=avgFCF>0?[{name:'FCF proyecto '+alt.name,amount:avgFCF}]:[];
   var outs=avgFCF<0?[{name:'Costos proyecto '+alt.name,amount:Math.abs(avgFCF)}]:[];
   return{params:{opening_balance:r2(-I0),periods:Math.min((alt.useful_life||5)*12,24),inflows:ins,outflows:outs,dso:undefined,dpo:undefined},description:'Inversión: $'+I0.toLocaleString('es-AR')+' — FCF mensual: $'+Math.abs(avgFCF).toLocaleString('es-AR')};
  }}
 ],
 QUEUE:[
  {to:'FLUJO_CAJA',label:'Flujo de Caja',extract:function(sol,par){
   var optM=sol.economic_analysis&&sol.economic_analysis.optimal_M?sol.economic_analysis.optimal_M:(par.num_servers_M||1);
   var cs=par.cost_per_server_cs||0;
   var monthlyStaff=r2(optM*cs*160);// 160 hrs/mes
   return{params:{opening_balance:undefined,periods:6,inflows:[],outflows:[{name:'Personal ('+optM+' servidores)',amount:monthlyStaff}],dso:undefined,dpo:undefined},description:optM+' servidores × $'+cs+'/hr = $'+monthlyStaff.toLocaleString('es-AR')+'/mes'};
  }}
 ]
};

function startChain(targetModule){
 var chains=CHAIN_MAP[session.module];
 if(!chains)return;
 var chain=null;
 for(var i=0;i<chains.length;i++){if(chains[i].to===targetModule){chain=chains[i];break;}}
 if(!chain)return;
 var extracted=chain.extract(session.solution,session.params);
 var chainSource={module:session.module,moduleName:MODULE_DEFS[session.module].name,description:extracted.description};
 session.module=targetModule;
 session.subtype=null;
 session.stage='collect';
 session.params=extracted.params;
 session.assumptions=[];
 session.solution=null;
 session._chainSource=chainSource;
 updUI();updateQuickButtons();
 var msg='🔗 **Encadené los datos de '+chainSource.moduleName+'.**\n';
 msg+='📊 '+extracted.description+'\n\n';
 msg+=checkAndAsk();
 addMsg('a',msg);
 updateQuickButtons();
}

// ─── COMPLETE CONVERSATIONAL ENGINE FROM ORIGINAL ─────────────
// Update all text in dynamic UI
function updateAllUIText() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const translated = t(key);
    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
      el.placeholder = translated;
    } else if (el.tagName === 'BUTTON' && el.id !== 'langToggle' && el.id !== 'landingLangToggle') {
      el.textContent = translated;
    } else if (!el.hasAttribute('data-keep-children')) {
      el.textContent = translated;
    }
  });
  document.querySelectorAll('[data-i18n-html]').forEach(el => {
    const key = el.getAttribute('data-i18n-html');
    const translated = t(key);
    if (translated && translated !== key) {
      el.innerHTML = translated;
    }
  });
  if (typeof currentMood !== 'undefined') {
    const moodText = getMoodText(currentMood);
    const moodEl = document.getElementById('avatarMood');
    if (moodEl) moodEl.textContent = moodText;
  }
}

function getMoodText(mood) {
  const moods = {
    es: {
      'idle': 'Listo para resolver',
      'listening': 'Escuchando...',
      'thinking': 'Analizando datos...',
      'confirm': 'Revisemos juntos',
      'solved': '¡Resuelto!',
      'error': 'Algo falló...',
      'collecting': 'Necesito más datos'
    },
    en: {
      'idle': 'Ready to solve',
      'listening': 'Listening...',
      'thinking': 'Analyzing data...',
      'confirm': 'Let\'s review together',
      'solved': 'Solved!',
      'error': 'Something went wrong...',
      'collecting': 'Need more data'
    }
  };
  return (moods[currentLanguage]||moods['es'])[mood] || (moods['es'])[mood] || mood;
}

function tMsg(msgKey) {
  const translations = {
    es: {
      'prod_request': '¿Qué **productos** fabricás o vendés? Podés contarme todo junto o ir de a partes — arrancá por los productos.',
      'stock_intro': 'Perfecto, **Almacenamiento**. Describí tu problema con: demanda anual, costo de pedido, costo de almacenamiento, precio unitario y tiempo de entrega.',
      'queue_intro': 'Perfecto, **Atención**. Describí tu problema con: clientes por hora, tiempo de servicio, cantidad de servidores y costos.',
      'module_choice': '¿Qué tipo de problema querés resolver?\n\n1. **Producción** — Decidir qué fabricar y cuánto con recursos limitados.\n2. **Almacenamiento** — Cuánto pedir y cada cuánto reponer.\n3. **Atención** — Cuántos puestos necesitás para atender bien.\n4. **Planificación** — ¿Invierto en A o en B?\n5. **Pronósticos** — ¿Cuál será la demanda futura?\n6. **Rentabilidad** — ¿Cuánto gano por producto? ¿Qué conviene vender?\n7. **Flujo de Caja** — ¿Me alcanza la plata? ¿Cuándo necesito financiamiento?\n\nElegí un número o describí tu problema con detalle.',
      'adjust_data': 'Entendido. ¿Qué dato querés ajustar?',
      'new_problem': 'Perfecto, empezamos de nuevo. Describí tu problema.',
      'solved_options': 'Problema resuelto. Podés:\n- Preguntar sobre **sensibilidad**\n- Pedir que **explique el modelo**\n- Iniciar un **nuevo problema**',
      'describe_problem': 'Describí tu problema operativo.',
      'stock_q_demand': '**¿Cuántas unidades vendés o consumís por año?**\n\n_(La demanda anual (D) es el parámetro central del EOQ.)_',
      'stock_q_order': '**¿Cuánto cuesta hacer un pedido? (flete + admin)**\n\n_(El costo de pedido (k) determina cuántos pedidos conviene hacer.)_',
      'stock_q_hold': '**¿Cuánto cuesta mantener una unidad en stock por año?**\n\n_(El costo de almacenamiento (c₁) penaliza tener mucho stock.)_',
      'stock_q_price': '**¿Cuál es el precio unitario de compra?**\n\n_(El precio (b) impacta el costo total.)_',
      'queue_q_lambda': '**¿Cuántos clientes llegan por hora en promedio?**\n\n_(La tasa de llegada (λ) define la demanda del sistema.)_',
      'queue_q_mu': '**¿Cuántos clientes atiende un servidor por hora?**\n\n_(La tasa de servicio (μ) determina la capacidad.)_',
      'queue_q_ce': '**¿Cuánto cuesta la espera por cliente por hora? (ce)**\n\n_(El costo de espera por cliente por hora permite evaluar el trade-off.)_',
      'queue_q_cs': '**¿Cuánto cuesta un servidor por hora? (cs)**\n\n_(El costo por servidor por hora define el trade-off contra espera.)_',
      'queue_q_servers': '**¿Cuántos servidores (cajeros/ventanillas) tenés?**\n\n_(M cambia el modelo: M=1 es M/M/1, M>1 es M/M/M.)_',
      'free_limit': '🔒 **Llegaste al límite gratuito.** Usaste tus 3 problemas gratis.\n\n<button class="upgrade-btn" onclick="handleUpgrade(\'starter\')" style="margin-top:.5rem;padding:.7rem 1.5rem;font-size:.9rem">✨ Starter — $3.99/mes (ilimitado)</button>\n<button class="upgrade-btn" onclick="handleUpgrade(\'pro\')" style="margin-top:.5rem;padding:.7rem 1.5rem;font-size:.85rem;background:linear-gradient(135deg,var(--ac),var(--pl))">🚀 Pro — $49.99/mes (Shopify + AI)</button>',
      'lp_ask_products': '¿Qué **productos** fabricás o vendés? Por ejemplo: _"Hago pan, medialunas y tortas"_',
      'invest_intro': 'Perfecto, **Planificación**. Describí tu problema con: inversión inicial, ingresos anuales, costos, vida útil y tasa de descuento.',
      'invest_q_investment': '**¿Cuál es la inversión inicial (I₀)?**\n\n_(El desembolso inicial determina el costo del proyecto.)_',
      'invest_q_revenue': '**¿Cuál es el ingreso anual (R)?**\n\n_(Ingreso anual proyectado del proyecto.)_',
      'invest_q_costs': '**¿Cuáles son los costos anuales (variable + fijo)?**\n\n_(Costos operacionales anuales.)_',
      'invest_q_rate': '**¿Cuál es la tasa de descuento (WACC)?**\n\n_(Costo del capital para descontar flujos.)_',
      'invest_q_life': '**¿Cuál es la vida útil del proyecto (años)?**\n\n_(Horizonte de evaluación del proyecto.)_',
      'forecast_intro': 'Perfecto, **Pronósticos de Demanda**. Ingresá los datos históricos de demanda separados por coma.',
      'forecast_q_data': '**Ingresá los datos de demanda histórica separados por coma**\n\n_(Ej: 1295, 1010, 1085, 1145, 1445, 1170...)_',
      'forecast_q_method': '**¿Qué método de pronóstico querés usar?**\n\nUsá los botones de abajo para elegir.',
      'forecast_q_window': '**¿De cuántos períodos el promedio móvil?**\n\n_(Ej: 3, 4 o 5 períodos)_',
      'forecast_q_weights': '**Ingresá los pesos separados por coma** (deben sumar 1.0)\n\n_(Ej: 0.5, 0.3, 0.2 — el más reciente primero)_',
      'forecast_q_alpha': '**¿Qué valor de α (alfa) querés usar?**\n\n_(Entre 0.05 y 0.50. Mayor α = más peso al dato reciente. Ej: 0.2)_',
      'rent_intro': 'Perfecto, **Rentabilidad**. Contame qué productos vendés, a qué precio, cuánto te cuesta cada uno, y cuántos vendés.',
      'rent_q_products': '**¿Qué productos vendés?** Contame el nombre, precio de venta y costo unitario de cada uno.\n\n_(Ej: "Hamburguesa: vendo a $2500, me cuesta $900. Pizza: vendo a $3000, cuesta $1100")_',
      'rent_q_quantity': '**¿Cuántas unidades vendés de cada producto?** (por día, semana o mes)\n\n_(Ej: "50 hamburguesas y 30 pizzas por día")_',
      'rent_q_fixed': '**¿Tenés costos fijos?** (alquiler, sueldos, servicios, etc.)\n\n_(Ej: "$500.000 por mes" o "no tengo")_',
      'fc_intro': 'Perfecto, **Flujo de Caja**. Contame tu saldo inicial, ingresos, egresos y cuántos meses querés proyectar.',
      'fc_q_data': '**Contame los datos de tu negocio:**\n\n1. ¿Con cuánta plata arrancás? (saldo inicial)\n2. ¿Cuánto cobrás por mes? (ingresos)\n3. ¿Cuánto pagás por mes? (egresos)\n4. ¿Cuántos meses querés proyectar?\n\n_(Ej: "Arranco con $500.000. Cobro $800.000 de ventas. Pago $300.000 de proveedores, $200.000 de sueldos y $150.000 de alquiler. Proyectar 6 meses")_',
      'fc_q_opening': '**¿Con cuánta plata arrancás?** (saldo en caja hoy)\n\n_(Ej: "$500.000" o "$1.200.000")_',
      'fc_q_inflows': '**¿Cuáles son tus ingresos mensuales?**\n\n_(Ej: "Cobro $800.000 de ventas y $50.000 de alquiler de un local")_',
      'fc_q_outflows': '**¿Cuáles son tus egresos mensuales?**\n\n_(Ej: "Pago $300.000 de proveedores, $200.000 de sueldos y $150.000 de alquiler")_',
      'fc_q_periods': '**¿Cuántos meses querés proyectar?**\n\n_(Ej: "6 meses" o "12 meses")_',
    },
    en: {
      'prod_request': 'What **products** do you make or sell? You can tell me everything at once or step by step — start with the products.',
      'stock_intro': 'Perfect, **Inventory**. Describe your problem with: annual demand, order cost, holding cost, unit price, and lead time.',
      'queue_intro': 'Perfect, **Queueing Theory**. Describe your problem with: customers per hour, service time, number of servers, and costs.',
      'invest_intro': 'Perfect, **Project Evaluation**. Describe your problem with: initial investment, annual revenue, costs, useful life, and discount rate.',
      'module_choice': 'What type of problem do you want to solve?\n\n1. **Linear Programming** — Decide how much to produce/allocate with limited resources.\n2. **Inventory/Stock** — How much to order and how often.\n3. **Queueing Theory** — Waiting times, how many servers you need.\n4. **Project Evaluation** — NPV, IRR, Payback, compare alternatives.\n5. **Forecasting** — What will future demand be?\n6. **Profitability** — How much do you earn per product? What should you sell?\n7. **Cash Flow** — Will you have enough cash? When will you need financing?\n\nChoose a number or describe your problem in detail.',
      'adjust_data': 'Got it. What data would you like to adjust?',
      'new_problem': 'Perfect, let\'s start over. Describe your problem.',
      'solved_options': 'Problem solved. You can:\n- Ask about **sensitivity**\n- Request to **explain the model**\n- Start a **new problem**',
      'describe_problem': 'Describe your operations problem.',
      'stock_q_demand': '**How many units do you sell or consume per year?**\n\n_(Annual demand (D) is the core EOQ parameter.)_',
      'stock_q_order': '**How much does it cost to place an order? (shipping + admin)**\n\n_(Order cost (k) determines how many orders are optimal.)_',
      'stock_q_hold': '**How much does it cost to hold one unit in stock per year?**\n\n_(Holding cost (c₁) penalizes excess inventory.)_',
      'stock_q_price': '**What is the unit purchase price?**\n\n_(Price (b) impacts total cost.)_',
      'queue_q_lambda': '**How many customers arrive per hour on average?**\n\n_(Arrival rate (λ) defines system demand.)_',
      'queue_q_mu': '**How many customers can one server handle per hour?**\n\n_(Service rate (μ) determines capacity.)_',
      'queue_q_ce': '**What is the waiting cost per customer per hour? (ce)**\n\n_(Wait cost per customer per hour enables the trade-off analysis.)_',
      'queue_q_cs': '**How much does one server cost per hour? (cs)**\n\n_(Server cost per hour defines the trade-off against waiting.)_',
      'queue_q_servers': '**How many servers (cashiers/windows) do you have?**\n\n_(M changes the model: M=1 is M/M/1, M>1 is M/M/M.)_',
      'free_limit': '🔒 **You\'ve reached the free limit.** You used your 3 free problems.\n\n<button class="upgrade-btn" onclick="handleUpgrade(\'starter\')" style="margin-top:.5rem;padding:.7rem 1.5rem;font-size:.9rem">✨ Starter — $3.99/mo (unlimited)</button>\n<button class="upgrade-btn" onclick="handleUpgrade(\'pro\')" style="margin-top:.5rem;padding:.7rem 1.5rem;font-size:.85rem;background:linear-gradient(135deg,var(--ac),var(--pl))">🚀 Pro — $49.99/mo (Shopify + AI)</button>',
      'lp_ask_products': 'What **products** do you make or sell? For example: _"I make bread, croissants, and cakes"_',
      'forecast_intro': 'Perfect, **Demand Forecasting**. Enter historical demand data separated by commas.',
      'forecast_q_data': '**Enter historical demand data separated by commas**\n\n_(E.g.: 1295, 1010, 1085, 1145, 1445, 1170...)_',
      'forecast_q_method': '**Which forecasting method do you want to use?**\n\nUse the buttons below to choose.',
      'forecast_q_window': '**How many periods for the moving average?**\n\n_(E.g.: 3, 4 or 5 periods)_',
      'forecast_q_weights': '**Enter weights separated by commas** (must sum to 1.0)\n\n_(E.g.: 0.5, 0.3, 0.2 — most recent first)_',
      'forecast_q_alpha': '**What alpha (α) value do you want to use?**\n\n_(Between 0.05 and 0.50. Higher α = more weight on recent data. E.g.: 0.2)_',
      'rent_intro': 'Perfect, **Profitability Analysis**. Tell me what products you sell, at what price, how much each one costs you, and how many you sell.',
      'rent_q_products': '**What products do you sell?** Tell me the name, selling price, and unit cost of each one.\n\n_(E.g.: "Burger: sell at $12, costs me $4. Pizza: sell at $15, costs $5")_',
      'rent_q_quantity': '**How many units of each product do you sell?** (per day, week, or month)\n\n_(E.g.: "50 burgers and 30 pizzas per day")_',
      'rent_q_fixed': '**Do you have fixed costs?** (rent, salaries, utilities, etc.)\n\n_(E.g.: "$5000 per month" or "none")_',
      'fc_intro': 'Perfect, **Cash Flow Projection**. Tell me your starting balance, monthly income, expenses, and how many months to project.',
      'fc_q_data': '**Tell me your business data:**\n\n1. Starting cash balance\n2. Monthly income (inflows)\n3. Monthly expenses (outflows)\n4. How many months to project?\n\n_(E.g.: "Starting with $5000. Income $8000 from sales. Expenses $3000 suppliers, $2000 salaries, $1500 rent. Project 6 months")_',
      'fc_q_opening': '**What is your starting cash balance?**\n\n_(E.g.: "$5000" or "$12000")_',
      'fc_q_inflows': '**What are your monthly income sources?**\n\n_(E.g.: "I collect $8000 from sales and $500 from a rental")_',
      'fc_q_outflows': '**What are your monthly expenses?**\n\n_(E.g.: "I pay $3000 for suppliers, $2000 salaries, and $1500 rent")_',
      'fc_q_periods': '**How many months do you want to project?**\n\n_(E.g.: "6 months" or "12 months")_',
    }
  };
  return translations[currentLanguage][msgKey] || translations['es'][msgKey] || msgKey;
}

function extractForecast(txt){
 const p={};
 const tl=txt.toLowerCase().trim();
 // Extract time series data: look for sequences of numbers
 const nums=txt.match(/[\d]+[.,]?[\d]*/g);
 if(nums&&nums.length>=3){
  const parsed=nums.map(n=>parseFloat(n.replace(',','.')));
  const allValid=parsed.every(n=>!isNaN(n)&&n>0);
  if(allValid&&parsed.length>=3)p.timeseries=parsed;
 }
 // Extract method
 if(/promedio\s*m[oó]vil\s*simple|\bsma\b|media\s*m[oó]vil\s*simple/i.test(tl))p.method='SMA';
 else if(/promedio\s*m[oó]vil\s*ponderado|\bwma\b|media\s*m[oó]vil\s*ponderada/i.test(tl))p.method='WMA';
 else if(/suavizaci[oó]n\s*exponencial|\bses\b|exponential\s*smooth/i.test(tl))p.method='SES';
 else if(/regresi[oó]n\s*lineal|\breg\b|linear\s*regression/i.test(tl))p.method='REG';
 else if(/\bcompar|\btodos\b|\ball\b/i.test(tl))p.method='ALL';
 // Extract window/n
 const windowM=tl.match(/(?:\bper[ií]odos?\b|\bventana\b|\bwindow\b)\s*(?:=|:)?\s*(\d+)/i)||tl.match(/\bn\s*[=:]\s*(\d+)/i);
 if(windowM)p.window=parseInt(windowM[1]);
 else if(p.method==='SMA'&&nums&&nums.length===1&&parseInt(nums[0])>=2&&parseInt(nums[0])<=20)p.window=parseInt(nums[0]);
 // Extract alpha
 const alphaM=tl.match(/(?:alpha|alfa|α)\s*(?:=|:)?\s*(0?[.,]\d+)/i);
 if(alphaM)p.alpha=parseFloat(alphaM[1].replace(',','.'));
 else if(p.method==='SES'&&nums&&nums.length===1){
  const v=parseFloat(nums[0].replace(',','.'));
  if(v>0&&v<1)p.alpha=v;
 }
 // Extract weights
 if(p.method==='WMA'&&!p.weights){
  const wM=tl.match(/((?:0[.,]\d+[\s,;]+)+0[.,]\d+)/);
  if(wM){
   const ws=wM[0].match(/0[.,]\d+/g);
   if(ws&&ws.length>=2)p.weights=ws.map(w=>parseFloat(w.replace(',','.')));
  }
 }
 return p;
}

function extractRentabilidad(txt){
 const p={products:[],fixed_costs:undefined};
 const tl=txt.toLowerCase().replace(/(\d)\.(\d{3})(?!\d)/g,'$1$2');
 // ── Fixed costs
 const fcM=tl.match(/(?:costos?\s+fijos?|gastos?\s+fijos?|alquiler|fijos?)\s*(?:son|de|=|:)?\s*\$?\s*([\d.,]+)/i);
 if(fcM)p.fixed_costs=parseFloat(fcM[1].replace(/,/g,'.'));
 const seen=new Set();
 function addProd(name,price,cost,qty){
  const key=name.toLowerCase();
  if(!seen.has(key)){seen.add(key);p.products.push({name:name,price:price,unit_cost:cost,quantity:qty||0});}
 }
 let m;
 // ── P1: "vendo X a $P, me cuesta $C" — most natural spoken Spanish
 const p1=/(?:vendo|hago|fabrico|produzco)\s+(?:la\s+|el\s+|los\s+|las\s+)?([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)\s+(?:a|por|en)\s+\$?\s*([\d.,]+)[\s.,;]+(?:y\s+)?(?:me\s+)?(?:cuestan?|costo|sale)\s*\$?\s*([\d.,]+)/gi;
 while((m=p1.exec(tl))!==null){
  let nm=m[1].trim();if(nm.length>1&&!/^(?:a|por|en|cada)$/i.test(nm))addProd(nm.charAt(0).toUpperCase()+nm.slice(1),parseFloat(m[2].replace(/,/g,'.')),parseFloat(m[3].replace(/,/g,'.')),0);
 }
 // ── P2: "Name: vendo a $P, cuesta $C" — structured with colon
 const p2=/([a-záéíóúñü][\wáéíóúñü\s]{1,30}?)[\s:,\-]+(?:la\s+)?(?:vendo|precio|cobro|sale)\s*(?:a|en|por|=|:)?\s*\$?\s*([\d.,]+)[\s.,;]+(?:y\s+)?(?:me\s+)?(?:cuestan?|costo|sale|gasto)\s*(?:=|:)?\s*\$?\s*([\d.,]+)/gi;
 while((m=p2.exec(tl))!==null){
  let nm=m[1].trim().replace(/^(?:el|la|los|las|un[ao]?s?|mi|mis|y|también|tambien)\s+/i,'').replace(/[-:]+$/,'').trim();
  if(nm.length>1&&!/^(?:vendo|precio|costo|la|el|lo|un|y|tambien|también)$/i.test(nm))addProd(nm.charAt(0).toUpperCase()+nm.slice(1),parseFloat(m[2].replace(/,/g,'.')),parseFloat(m[3].replace(/,/g,'.')),0);
 }
 // ── P3: list-style "- Name: $P / $C"
 if(p.products.length===0){
  const p3=/(?:^|[\n\-•])\s*([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)[\s:]+\$?\s*([\d.,]+)\s*[\/,;]\s*(?:costo\s*)?(?:=|:)?\s*\$?\s*([\d.,]+)/gim;
  while((m=p3.exec(tl))!==null){
   let nm=m[1].trim();if(nm.length>1&&!/^(?:precio|costo|vendo|costos?\s*fijo)$/i.test(nm))addProd(nm.charAt(0).toUpperCase()+nm.slice(1),parseFloat(m[2].replace(/,/g,'.')),parseFloat(m[3].replace(/,/g,'.')),0);
  }
 }
 // ── Quantity extraction
 for(const prod of p.products){
  if(prod.quantity>0)continue;
  const pn=prod.name.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  // "Vendo 200 por dia" after product name (may be across sentence boundary)
  let qm=tl.match(new RegExp(pn+'[\\s\\S]{0,80}?(?:vendo|hago)\\s+(\\d[\\d.,]*)','i'));
  if(qm){prod.quantity=parseFloat(qm[1].replace(/,/g,'.'));continue;}
  // "200 empanadas" or "vendo 200 empanadas"
  qm=tl.match(new RegExp('(\\d[\\d.,]*)\\s*(?:'+pn+'s?)(?:\\s|,|\\.|$)','i'));
  if(qm){prod.quantity=parseFloat(qm[1].replace(/,/g,'.'));continue;}
  // "empanada... 200 por dia" (may cross sentence boundary)
  qm=tl.match(new RegExp(pn+'[\\s\\S]{0,80}?(\\d+)\\s*(?:por\\s+(?:d[ií]a|semana|mes)|al\\s+d[ií]a|diaria)','i'));
  if(qm){prod.quantity=parseFloat(qm[1]);}
 }
 // ── P4 FALLBACK: Extract plain product names when no prices/costs found
 // Handles: "Zapatos y Botas", "hago tortas, empanadas y medialunas", "vendo zapatos"
 if(p.products.length===0){
  // Remove noise words and split by comma, "y", newline
  var cleaned=txt.replace(/(?:^|\s)(?:vendo|fabrico|hago|produzco|vendemos|fabricamos|mis\s+productos\s+son|los\s+productos|tengo)\s*/gi,' ').trim();
  var parts=cleaned.split(/\s*(?:,|;|\n|\sy\s)\s*/);
  for(var i=0;i<parts.length;i++){
   var nm=parts[i].trim().replace(/^(?:el|la|los|las|un[ao]?s?)\s+/i,'').replace(/[.!?]+$/,'').trim();
   if(nm.length>1&&nm.length<40&&!/^(?:también|tambien|ademas|además|etc|bueno|hola|quiero|necesito)$/i.test(nm)){
    addProd(nm.charAt(0).toUpperCase()+nm.slice(1),0,0,0);
   }
  }
 }
 return p;
}

function extractFlujoCaja(txt){
 const p={opening_balance:undefined,periods:undefined,inflows:[],outflows:[],dso:undefined,dpo:undefined};
 const tl=txt.toLowerCase().replace(/(\d)\.(\d{3})(?!\d)/g,'$1$2');
 // Opening balance
 let m=tl.match(/(?:arranco|empiezo|tengo|saldo\s+inicial|caja\s+inicial|inicio|abro)\s*(?:con|de|en|:)?\s*\$?\s*([\d.,]+)/i);
 if(m)p.opening_balance=parseFloat(m[1].replace(/,/g,'.'));
 if(p.opening_balance===undefined){m=tl.match(/(?:saldo|caja|balance|capital)\s*(?:inicial|de\s+arranque|hoy)?\s*(?:de|:|\s)\s*\$?\s*([\d.,]+)/i);if(m)p.opening_balance=parseFloat(m[1].replace(/,/g,'.'));}
 // Periods
 m=tl.match(/(?:proyectar|ver|analizar|próximos|proximos|durante)\s*(?:los\s+)?(\d+)\s*(?:meses?|períodos?|periodos?)/i);
 if(m)p.periods=parseInt(m[1]);
 if(!p.periods){m=tl.match(/(\d+)\s*(?:meses?|períodos?|periodos?)\s*(?:de\s+)?(?:proyección|proyeccion|análisis|analisis)?/i);if(m)p.periods=parseInt(m[1]);}
 // ── Strategy 1: Section-based "Name: $Amount" list parsing
 // Split text into ingresos/egresos sections by header keywords
 let im;
 const inSection=tl.match(/(?:ingresos|cobros|entradas)\s*(?:mensuales?|del\s+mes)?\s*:\s*([\s\S]*?)(?=(?:mis\s+)?(?:egresos|gastos|pagos|salidas)|quiero|$)/i);
 const outSection=tl.match(/(?:egresos|gastos|pagos|salidas)\s*(?:mensuales?|del\s+mes)?\s*:\s*([\s\S]*?)(?=quiero|arranco|tengo|$)/i);
 const listItemRx=/([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)\s*:\s*\$?\s*([\d.,]+)/gi;
 if(inSection){
  while((im=listItemRx.exec(inSection[1]))!==null){
   const nm=im[1].trim();const amt=parseFloat(im[2].replace(/,/g,'.'));
   if(nm.length>1&&amt>0&&!/ingreso|cobro/i.test(nm))p.inflows.push({name:nm.charAt(0).toUpperCase()+nm.slice(1),amount:amt});
  }
 }
 if(outSection){
  const listItemRx2=/([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)\s*:\s*\$?\s*([\d.,]+)/gi;
  while((im=listItemRx2.exec(outSection[1]))!==null){
   const nm=im[1].trim();const amt=parseFloat(im[2].replace(/,/g,'.'));
   if(nm.length>1&&amt>0&&!/egreso|gasto/i.test(nm))p.outflows.push({name:nm.charAt(0).toUpperCase()+nm.slice(1),amount:amt});
  }
 }
 // ── Strategy 2: "cobro $X de Y" / "pago $X de Y" (verb-first) — relaxed patterns
 const seenIn=new Set(p.inflows.map(i=>i.name.toLowerCase()));
 const seenOut=new Set(p.outflows.map(o=>o.name.toLowerCase()));
 if(p.inflows.length===0){
  const inPatterns=[
   /(?:cobro|ingreso|recibo|factur[oe]|vendo|ventas?|me\s+entra[n]?)\s*(?:de|por|en)?\s*\$?\s*([\d.,]+)\s*(?:de|por)?\s*(?:las?\s+|los?\s+|el\s+)?([a-záéíóúñü][\wáéíóúñü\s]{1,30}?)(?:\s*[.,;y]|$)/gi,
   /([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)\s*(?:me\s+)?(?:genera[n]?|entra[n]?|deja[n]?|aporta[n]?|ingresa[n]?)\s*\$?\s*([\d.,]+)/gi
  ];
  for(var ipat=0;ipat<inPatterns.length;ipat++){
   var inRx=inPatterns[ipat];inRx.lastIndex=0;
   while((im=inRx.exec(tl))!==null){
    var amt,nm2;
    if(ipat===0){amt=parseFloat(im[1].replace(/,/g,'.'));nm2=im[2];}
    else{nm2=im[1];amt=parseFloat(im[2].replace(/,/g,'.'));}
    nm2=nm2.trim().replace(/\s*(por\s+mes|mensuales?|al\s+mes|cada\s+mes)\s*$/i,'').trim();
    if(nm2.length>1&&amt>0&&!seenIn.has(nm2.toLowerCase())&&!/egreso|gasto|pago/i.test(nm2)){seenIn.add(nm2.toLowerCase());p.inflows.push({name:nm2.charAt(0).toUpperCase()+nm2.slice(1),amount:amt});}
   }
  }
 }
 // ── Strategy 3: "$X de nombre_conocido" (keyword match, additive — fills gaps)
 {
  const inRx2=/(?:\$|,)\s*([\d.,]+)\s*(?:de|por)\s+([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)(?:\s*[.,;y]|$)/gi;
  while((im=inRx2.exec(tl))!==null){
   const amt=parseFloat(im[1].replace(/,/g,'.'));
   let nm=im[2].trim().replace(/\s*(por\s+mes|mensuales?)\s*$/i,'').trim();
   if(nm.length>1&&amt>0&&/venta|cobr|ingres/i.test(nm)&&!seenIn.has(nm.toLowerCase())){seenIn.add(nm.toLowerCase());p.inflows.push({name:nm.charAt(0).toUpperCase()+nm.slice(1),amount:amt});}
  }
 }
 if(p.outflows.length===0){
  const outPatterns=[
   /(?:pago|gasto|egreso|me\s+sale[n]?|cuesta[n]?|abono|erogaci[oó]n)\s*(?:de|por|en)?\s*\$?\s*([\d.,]+)\s*(?:de|por|en)?\s*(?:las?\s+|los?\s+|el\s+)?([a-záéíóúñü][\wáéíóúñü\s]{1,30}?)(?:\s*[.,;y]|$)/gi,
   /([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)\s*(?:me\s+)?(?:cuesta[n]?|sale[n]?|gasto|consume[n]?)\s*\$?\s*([\d.,]+)/gi
  ];
  for(var opat=0;opat<outPatterns.length;opat++){
   var outRx=outPatterns[opat];outRx.lastIndex=0;
   while((im=outRx.exec(tl))!==null){
    var oamt,onm;
    if(opat===0){oamt=parseFloat(im[1].replace(/,/g,'.'));onm=im[2];}
    else{onm=im[1];oamt=parseFloat(im[2].replace(/,/g,'.'));}
    onm=onm.trim().replace(/\s*(por\s+mes|mensuales?|al\s+mes)\s*$/i,'').trim();
    if(onm.length>1&&oamt>0&&!seenOut.has(onm.toLowerCase())&&!/ingreso|cobro|venta/i.test(onm)){seenOut.add(onm.toLowerCase());p.outflows.push({name:onm.charAt(0).toUpperCase()+onm.slice(1),amount:oamt});}
   }
  }
 }
 // Additive keyword fallback for outflows
 {
  const outRx2=/(?:\$|,)\s*([\d.,]+)\s*(?:de|por)\s+([a-záéíóúñü][\wáéíóúñü\s]{1,25}?)(?:\s*[.,;y]|$)/gi;
  while((im=outRx2.exec(tl))!==null){
   const amt=parseFloat(im[1].replace(/,/g,'.'));
   let nm=im[2].trim().replace(/\s*(por\s+mes|mensuales?)\s*$/i,'').trim();
   if(nm.length>1&&amt>0&&/proveedor|sueldo|salario|alquiler|servicio|luz|gas|impuesto|cuota|gasto|costo|egres/i.test(nm)&&!seenOut.has(nm.toLowerCase())){seenOut.add(nm.toLowerCase());p.outflows.push({name:nm.charAt(0).toUpperCase()+nm.slice(1),amount:amt});}
  }
 }
 // ── DSO: Days Sales Outstanding (plazo de cobro)
 var dsoM=tl.match(/(?:dso|plazo\s+de\s+cobro|cobro\s+a|me\s+pagan\s+(?:a|en)|tardo\s+en\s+cobrar|demora\s+(?:de\s+)?cobro|días?\s+(?:de\s+)?cobro)\s*(?:de|en|:)?\s*(\d+)\s*(?:d[ií]as?)?/i);
 if(dsoM)p.dso=parseInt(dsoM[1]);
 if(!p.dso){dsoM=tl.match(/(\d+)\s*(?:d[ií]as?)\s*(?:de\s+)?(?:cobro|plazo\s+cobro|para\s+cobrar|dso)/i);if(dsoM)p.dso=parseInt(dsoM[1]);}
 // ── DPO: Days Payable Outstanding (plazo de pago)
 var dpoM=tl.match(/(?:dpo|plazo\s+de\s+pago|pago\s+a|pago\s+(?:a|en)|tardo\s+en\s+pagar|demora\s+(?:de\s+)?pago|días?\s+(?:de\s+)?pago\s+(?:a\s+)?proveedor)\s*(?:de|en|:)?\s*(\d+)\s*(?:d[ií]as?)?/i);
 if(dpoM)p.dpo=parseInt(dpoM[1]);
 if(!p.dpo){dpoM=tl.match(/(\d+)\s*(?:d[ií]as?)\s*(?:de\s+)?(?:pago|plazo\s+pago|para\s+pagar|dpo)/i);if(dpoM)p.dpo=parseInt(dpoM[1]);}
 return p;
}

function fmtConfirmFlujoCaja(){
 const S=session,p=S.params;
 let s='**Voy a proyectar el flujo de caja con estos datos:**\n\n';
 s+=`- Saldo inicial: **$${(+(p.opening_balance||0)).toLocaleString('es-AR')}**\n`;
 s+=`- Períodos: **${p.periods||6} meses**\n\n`;
 if(p.inflows&&p.inflows.length>0){
  s+='**Ingresos mensuales:**\n';
  p.inflows.forEach(i=>s+=`- ${i.name}: $${(+(i.amount||0)).toLocaleString('es-AR')}\n`);
  s+=`- **Total ingresos: $${p.inflows.reduce((s,i)=>s+(+(i.amount||0)),0).toLocaleString('es-AR')}/mes**\n\n`;
 }
 if(p.outflows&&p.outflows.length>0){
  s+='**Egresos mensuales:**\n';
  p.outflows.forEach(o=>s+=`- ${o.name}: $${(+(o.amount||0)).toLocaleString('es-AR')}\n`);
  s+=`- **Total egresos: $${p.outflows.reduce((s,o)=>s+(+(o.amount||0)),0).toLocaleString('es-AR')}/mes**\n\n`;
 }
 const net=p.inflows.reduce((s,i)=>s+(+(i.amount||0)),0)-p.outflows.reduce((s,o)=>s+(+(o.amount||0)),0);
 s+=`- Flujo neto mensual: **$${net.toLocaleString('es-AR')}**\n`;
 if(p.dso||p.dpo){
  s+='\n**Plazos de cobro/pago:**\n';
  if(p.dso)s+=`- DSO (plazo de cobro): **${p.dso} días**\n`;
  if(p.dpo)s+=`- DPO (plazo de pago): **${p.dpo} días**\n`;
  const ccc=(p.dso||0)-(p.dpo||0);
  s+=`- Ciclo de conversión de caja: **${ccc} días** ${ccc>0?'(necesitás financiar '+ccc+' días)':'(tus proveedores te financian)'}\n`;
 }
 if(S.assumptions.length){s+='\n**Supuestos:**\n';S.assumptions.forEach(a=>s+=`- ${a}\n`);}
 s+='\n¿Es correcto? Puedo **resolver** o ajustar algo.';
 return s;
}

function fmtConfirmRentabilidad(){
 const S=session,p=S.params;
 let s='**Voy a analizar la rentabilidad con estos datos:**\n\n';
 if(p.products&&p.products.length>0){
  s+='| Producto | Precio | Costo | Cantidad |\n|----------|--------|-------|----------|\n';
  p.products.forEach(prod=>{
   s+=`| ${prod.name} | $${prod.price} | $${prod.unit_cost} | ${prod.quantity||'—'} |\n`;
  });
 }
 if(p.fixed_costs!==undefined)s+=`\n- Costos fijos: $${p.fixed_costs.toLocaleString('es-AR')}\n`;
 if(S.assumptions.length){s+='\n**Supuestos:**\n';S.assumptions.forEach(a=>s+=`- ${a}\n`);}
 s+='\n¿Es correcto? Puedo **resolver** o ajustar algo.';
 return s;
}

function fmtConfirmForecast(){
 const S=session,p=S.params;
 const methodNames={SMA:'Promedio Móvil Simple',WMA:'Promedio Móvil Ponderado',SES:'Suavización Exponencial Simple',REG:'Regresión Lineal',ALL:'Comparación de todos los métodos'};
 let s=`**Voy a resolver un modelo de Pronósticos con estos datos:**\n\n`;
 s+=`- Datos históricos: ${p.timeseries.length} períodos [${p.timeseries.slice(0,5).join(', ')}${p.timeseries.length>5?', ...':''}]\n`;
 s+=`- Método: **${methodNames[p.method]||p.method}**\n`;
 if(p.method==='SMA'&&p.window)s+=`- Períodos del promedio: ${p.window}\n`;
 if(p.method==='WMA'&&p.weights)s+=`- Pesos: ${p.weights.join(', ')}\n`;
 if(p.method==='SES'&&p.alpha)s+=`- Alpha (α): ${p.alpha}\n`;
 s+=`- Períodos a pronosticar: ${p.periods_ahead||1}\n`;
 if(S.assumptions.length){s+='\n**Supuestos:**\n';S.assumptions.forEach(a=>s+=`- ${a}\n`);}
 s+='\n¿Es correcto? Puedo **resolver** o ajustar algo.';
 return s;
}

function isMultiPeriodPlan(txt){
 const tl=txt.toLowerCase();
 const hasPeriods=(tl.match(/mes\s*\d/g)||[]).length>=2||(tl.match(/per[ií]odo\s*\d/g)||[]).length>=2||(tl.match(/semana\s*\d/g)||[]).length>=2;
 const hasVarDemand=(tl.match(/mes\s*\d\s*:\s*[\d.,]+/g)||[]).length>=2||(tl.match(/per[ií]odo\s*\d\s*:\s*[\d.,]+/g)||[]).length>=2;
 const hasProdCap=/capacidad\s*(?:m[áa]xima)?\s*(?:de\s+)?producci[oó]n|producci[oó]n\s*(?:m[áa]xima)?\s*(?:mensual|semanal)/i.test(tl);
 const hasInvCost=/(?:costo\s+de\s+)?almacen/i.test(tl);
 const hasMinObj=/minimizar|menor\s+costo|m[ií]nimo|al\s+menor\s+costo/i.test(tl);
 const hasHorizon=/horizonte|planificaci[oó]n|plan\s+de\s+producci[oó]n/i.test(tl);
 return (hasPeriods||hasVarDemand)&&(hasProdCap||hasInvCost)&&(hasMinObj||hasHorizon);
}

function formulateMultiPeriodLP(txt){
 const normalizeNums=(s)=>s.replace(/(\d)\.(\d{3})(?!\d)/g,'$1$2').replace(/,/g,'.');
 const tl=normalizeNums(txt.toLowerCase());
 const pn=v=>parseFloat(v.toString().replace(',','.'));
 let periodLabel='mes';
 if(/per[ií]odo\s*\d/i.test(txt))periodLabel='período';
 if(/semana\s*\d/i.test(txt))periodLabel='semana';
 const plRx=periodLabel==='período'?'per[ií]odo':periodLabel==='semana'?'semana':'mes';
 const demands={};
 const allDemRx=new RegExp('([\\wáéíóúñ]*\\s+(?:del\\s+)?)?' + plRx+'\\s*(\\d+)\\s*:\\s*([\\d.]+)\\s*(?:unidades?)?','gi');
 let dm;while((dm=allDemRx.exec(tl))!==null){
  const prefix=(dm[1]||'').trim().toLowerCase();
  if(/(?:del|final|inicio|al)$/i.test(prefix))continue;
  const t=parseInt(dm[2]);
  if(!demands[t])demands[t]=pn(dm[3]);
 }
 const T=Object.keys(demands).length;
 if(T<2)return null;
 const periods=Object.keys(demands).map(Number).sort((a,b)=>a-b);
 const capPatterns=[
  /capacidad\s*(?:m[áa]xima)?\s*(?:de\s+)?producci[oó]n\s*(?:mensual|semanal)?\s*:\s*([\d.]+)/i,
  /producci[oó]n\s*(?:m[áa]xima)?\s*(?:mensual|semanal)?\s*:\s*([\d.]+)/i,
  /(?:puedo|puede)\s+producir\s+(?:hasta|como\s+m[áa]ximo)\s+([\d.]+)/i
 ];
 let cap=null;
 for(const rx of capPatterns){const m=tl.match(rx);if(m){cap=pn(m[1]);break;}}
 const pcPatterns=[
  /costo\s+de\s+producci[oó]n\s*:\s*(?:usd|\$|us\$)?\s*([\d.]+)/i,
  /producir\s+(?:cada\s+(?:unidad|una?))\s*(?:cuesta|sale)\s*(?:usd|\$)?\s*([\d.]+)/i,
  /(?:usd|\$)\s*([\d.]+)\s*(?:por\s+)?(?:unidad)?\s*(?:de\s+)?(?:producci[oó]n|producir)/i
 ];
 let pc=0;
 for(const rx of pcPatterns){const m=tl.match(rx);if(m){pc=pn(m[1]);break;}}
 const hcPatterns=[
  /costo\s+de\s+almacenamiento\s*:\s*(?:usd|\$|us\$)?\s*([\d.]+)/i,
  /almacenar?\s*(?:inventario)?\s*(?:tiene|cuesta|sale)\s*(?:un\s+)?(?:costo)?\s*(?:usd|\$)?\s*([\d.]+)/i,
  /(?:usd|\$)\s*([\d.]+)\s*(?:por\s+)?(?:unidad)?\s*(?:por\s+)?(?:mes|semana|a[ñn]o)?\s*(?:de\s+)?almacen/i
 ];
 let hc=0;
 for(const rx of hcPatterns){const m=tl.match(rx);if(m){hc=pn(m[1]);break;}}
 const i0Patterns=[
  /stock\s+inicial\s*(?:\([^)]*\))?\s*:\s*([\d.]+)/i,
  /inventario\s+inicial\s*(?:\([^)]*\))?\s*:\s*([\d.]+)/i,
  /(?:inicio|comienzo)\s*(?:del)?\s*(?:mes|per[ií]odo)\s*\d?\s*\)?\s*:\s*([\d.]+)/i,
  /(?:tengo|hay|dispongo)\s*(?:de\s+)?([\d.]+)\s*(?:unidades?)?\s*(?:en\s+)?(?:stock|inventario)\s*(?:inicial|al\s+inicio)/i
 ];
 let I0=0;
 for(const rx of i0Patterns){const m=tl.match(rx);if(m){I0=pn(m[1]);break;}}
 const ifPatterns=[
  /stock\s+final\s*(?:m[ií]nimo)?\s*(?:requerido)?\s*(?:\([^)]*\))?\s*:\s*([\d.]+)/i,
  /inventario\s+final\s*(?:m[ií]nimo)?\s*(?:requerido)?\s*:\s*([\d.]+)/i,
  /(?:al\s+)?final\s*(?:del)?\s*(?:mes|per[ií]odo)\s*\d+\s*:\s*([\d.]+)/i,
  /(?:quedar|terminar)\s*(?:con)?\s*(?:al\s+menos\s+)?([\d.]+)\s*(?:unidades?)?\s*(?:en\s+)?(?:stock|inventario)/i
 ];
 let IF=0;
 for(const rx of ifPatterns){const m=tl.match(rx);if(m){IF=pn(m[1]);break;}}
 const oc={};
 for(let t=1;t<=T;t++){
  const pIdx=periods.indexOf(t);
  oc[`x_${periodLabel}${t}`]=pc+hc*(T-pIdx);
 }
 const cs=[];
 if(cap){
  for(let t=1;t<=T;t++){
   const coeffs={};
   for(let s=1;s<=T;s++) coeffs[`x_${periodLabel}${s}`]=(s===t)?1:0;
   cs.push({name:`Capacidad ${periodLabel} ${t}`,coeffs,sense:'<=',rhs:cap});
  }
 }
 let cumD=0;
 for(let t=1;t<=T;t++){
  cumD+=(demands[t]||0);
  const coeffs={};
  for(let s=1;s<=T;s++) coeffs[`x_${periodLabel}${s}`]=(s<=t)?1:0;
  const minStock=(t===T)?IF:0;
  const rhs=cumD-I0+minStock;
  cs.push({name:t===T?`Stock final ≥ ${IF}`:`Stock ${periodLabel} ${t} ≥ 0`,coeffs,sense:'>=',rhs});
 }
 let cumDSum=0,cd=0;
 for(let t=1;t<=T;t++){cd+=(demands[t]||0);cumDSum+=cd;}
 const objConstant=hc*(T*I0-cumDSum);
 return{
  objective_type:'MIN',objective_coefficients:oc,constraints:cs,
  _meta:{type:'multiperiod',periodLabel,T,demands,capacity:cap,prod_cost:pc,hold_cost:hc,I0,IF,obj_constant:objConstant,periods}
 };
}

function fmtConfirmMultiPeriod(spec){
 const m=spec._meta,pl=m.periodLabel;
 const capPl=pl.charAt(0).toUpperCase()+pl.slice(1);
 let s=`**Problema de Producción-Inventario Multi-período detectado**\n\n`;
 s+=`Identifico un problema de **planificación de producción** con ${m.T} ${pl}es:\n\n`;
 s+=`| ${capPl} | Demanda |\n|-----|---------|\n`;
 for(let t=1;t<=m.T;t++){
  s+=`| ${t} | ${(m.demands[t]||0).toLocaleString('es-AR')} un |\n`;
 }
 s+='\n**Parámetros:**\n';
 if(m.capacity)s+=`- Capacidad máx. producción: ${m.capacity.toLocaleString('es-AR')} un/${pl}\n`;
 s+=`- Costo producción: $${m.prod_cost}/un\n`;
 s+=`- Costo almacenamiento: $${m.hold_cost}/un/${pl}\n`;
 s+=`- Stock inicial: ${m.I0.toLocaleString('es-AR')} un\n`;
 if(m.IF>0)s+=`- Stock final requerido: ≥ ${m.IF.toLocaleString('es-AR')} un\n`;
 s+='\n**Formulación LP:**\n';
 s+=`MIN Z = ${Object.entries(spec.objective_coefficients).map(([v,c])=>`${c}·${v.replace('x_','').charAt(0).toUpperCase()+v.replace('x_','').slice(1)}`).join(' + ')}`;
 if(spec._meta.obj_constant!==0)s+=` + (${r0(spec._meta.obj_constant)})`;
 s+='\n\nSujeto a restricciones de capacidad, balance de inventario y stock final.\n';
 s+='\n¿Resuelvo? Puedo **resolver** o ajustar datos.';
 return s;
}

function fmtMultiPeriodSolution(res){
 const m=session.params._meta,pl=m.periodLabel;
 const capPl=pl.charAt(0).toUpperCase()+pl.slice(1);
 if(res.status!=='ÓPTIMO')return null;
 const vals=res.variable_values;
 const schedule=[];
 let stock=m.I0;
 let totalProd=0,totalHold=0;
 for(let t=1;t<=m.T;t++){
  const prod=vals[`x_${pl}${t}`]||0;
  const dem=m.demands[t]||0;
  stock=stock+prod-dem;
  totalProd+=prod;
  totalHold+=stock;
  schedule.push({t,prod:r0(prod),demand:r0(dem),stock_end:r0(stock)});
 }
 const prodCost=m.prod_cost*totalProd;
 const holdCost=m.hold_cost*totalHold;
 const totalCost=prodCost+holdCost;
 let s=`✅ **Plan de Producción Óptimo** — ${m.T} ${pl}es\n\n`;
 s+=`**Costo total mínimo: $${r0(totalCost).toLocaleString('es-AR')}**\n\n`;
 s+=`| ${capPl} | Producción | Demanda | Stock final |\n|-----|-----------|---------|-------------|\n`;
 s+=`| 0 | — | — | ${m.I0.toLocaleString('es-AR')} (inicial) |\n`;
 schedule.forEach(r=>{
  const capUtil=m.capacity?` (${r2(r.prod/m.capacity*100)}%)`:'';
  s+=`| ${r.t} | ${r.prod.toLocaleString('es-AR')}${capUtil} | ${r.demand.toLocaleString('es-AR')} | ${r.stock_end.toLocaleString('es-AR')} |\n`;
 });
 s+='\n**Desglose de costos:**\n';
 s+=`- Producción: ${r0(totalProd).toLocaleString('es-AR')} un × $${m.prod_cost} = **$${r0(prodCost).toLocaleString('es-AR')}**\n`;
 s+=`- Almacenamiento: ${r0(totalHold).toLocaleString('es-AR')} un·${pl} × $${m.hold_cost} = **$${r0(holdCost).toLocaleString('es-AR')}**\n`;
 s+=`- **Total: $${r0(totalCost).toLocaleString('es-AR')}**\n`;
 s+='\n**Análisis:**\n';
 const atCap=schedule.filter(r=>m.capacity&&Math.abs(r.prod-m.capacity)<1);
 if(atCap.length===m.T)s+=`• Se requiere producir a **capacidad máxima todos los ${pl}es**.\n`;
 else if(atCap.length>0)s+=`• Producción a capacidad máxima en ${pl}(es): ${atCap.map(r=>r.t).join(', ')}.\n`;
 const minStock=Math.min(...schedule.map(r=>r.stock_end));
 const maxStock=Math.max(...schedule.map(r=>r.stock_end));
 s+=`• Stock mínimo: ${r0(minStock).toLocaleString('es-AR')} un (${pl} ${schedule.find(r=>r.stock_end===minStock).t}). `;
 s+=`Stock máximo: ${r0(maxStock).toLocaleString('es-AR')} un (${pl} ${schedule.find(r=>r.stock_end===maxStock).t}).\n`;
 const totalDem=Object.values(m.demands).reduce((a,b)=>a+b,0);
 if(m.capacity&&totalDem+m.IF-m.I0>m.capacity*m.T*0.95)
  s+=`• ⚠️ La demanda total (${r0(totalDem).toLocaleString('es-AR')}) está muy cerca de la capacidad total (${r0(m.capacity*m.T).toLocaleString('es-AR')}). Poco margen.\n`;
 s+='\n---\n_Preguntá sobre **sensibilidad**, pedí **explicar el modelo**, o iniciá un **nuevo problema**._';
 return s;
}

function extractStock(t){
 const tl=t.toLowerCase().replace(/,/g,'.'),p={};
 const m=(rx)=>{const r=tl.match(rx);return r?parseFloat(r[1].replace(',','.')):null;};
 const D=m(/(?:vendo|consumo|demanda|venta|uso|gasto|necesito)\s*(?:de\s+)?(?:unas?\s+)?(?:como\s+)?([\d.]+)/)||
  m(/([\d.]+)\s*(?:unidades?|un\.?|piezas?|cajas?|bolsas?|kg|litros?)\s*(?:por\s+)?(?:al?\s+)?(?:a[ñn]o|mes|semana|d[ií]a)/)||
  m(/demanda\s*(?:anual|mensual|diaria|semanal)?\s*(?:de\s+)?\s*(?:es\s+de\s+)?([\d.]+)/)||
  m(/(?:se\s+)?(?:venden?|consumen?|usan?)\s*(?:unas?\s+)?(?:como\s+)?([\d.]+)/);
 if(D)p.demand_D=D;
 const k=m(/(?:pedido|pedir|orden).*?(?:gasto|cuesta|costo|sale)\s*(?:como\s*)?\$?\s*([\d.]+)/)||
  m(/(?:gasto|cuesta|sale)\s*(?:como\s*)?\$?\s*([\d.]+).*?(?:flete|papeleo|pedido|env[ií]o|transporte)/)||
  m(/costo\s*(?:de\s+)?(?:pedido|orden|pedir)\s*:?\s*\$?\s*([\d.]+)/)||
  m(/\$?\s*([\d.]+)\s*(?:por\s+)?(?:cada\s+)?pedido/);
 if(k)p.order_cost_k=k;
 const c1=m(/almacenar.*?(?:cuesta|costo)\s*(?:m[aá]s\s+o\s+menos\s*)?\$?\s*([\d.]+)/)||
  m(/\$?\s*([\d.]+)\s*(?:por\s+)?(?:unidad\s+)?(?:por\s+)?(?:a[ñn]o|mes)?\s*(?:de\s+)?(?:almac|stock|mantener|guardar|depositar)/)||
  m(/(?:mantener|guardar|almacenar|tener\s+en\s+stock)\s*(?:cada\s+)?(?:una?\s+)?(?:unidad\s+)?(?:cuesta|sale|vale)\s*\$?\s*([\d.]+)/)||
  m(/costo\s*(?:de\s+)?(?:almacen|mantenim|stock)\w*\s*:?\s*\$?\s*([\d.]+)/);
 if(c1)p.holding_cost_c1=c1;
 const b2=m(/(?:me\s+)?(?:sale|cuesta|vale|compro\s+a)\s*\$?\s*([\d.]+)\s*(?:cada\s+un[oa]|por\s+unidad|c\/u)?/)||
  m(/(?:precio\s+(?:unitario|de\s+compra|de\s+adquisición))\s*:?\s*\$?\s*([\d.]+)/)||
  m(/\$?\s*([\d.]+)\s*(?:por\s+)?(?:unidad|cada\s+un[oa]|c\/u)/);
 if(b2)p.acquisition_cost_b=b2;
 const lt=m(/(?:tarda|demora|entrega|llega|demoran?|tardan?)\s*(?:unos?\s*)?([\d.]+)\s*d[ií]as/)||
  m(/([\d.]+)\s*d[ií]as?\s*(?:de\s+)?(?:en\s+)?(?:entreg|llegar|demora|espera)/)||
  m(/(?:plazo|tiempo)\s*(?:de\s+)?(?:entrega|reposición|envío)\s*:?\s*([\d.]+)\s*d[ií]as/);
 if(lt)p.lead_time_LT=lt/365;
 const c2=m(/(?:costo\s+(?:de\s+)?(?:faltante|escasez|agotamiento|ruptura))\s*:?\s*\$?\s*([\d.]+)/)||
  m(/(?:faltante|escasez)\s*(?:cuesta|sale)\s*\$?\s*([\d.]+)/);
 if(c2)p.shortage_cost_c2=c2;
 return p;
}

function extractQueue(t){
 const tl=t.toLowerCase().replace(/\./g,'').replace(/,/g,'.');
 const normalizeNums=(s)=>s.replace(/(\d)\.(\d{3})(?!\d)/g,'$1$2').replace(/,/g,'.');
 const tln=normalizeNums(t.toLowerCase());
 const p={};
 const m=(rx)=>{const r=tln.match(rx);return r?parseFloat(r[1].replace(',','.')):null;};
 const lam=m(/([\d.]+)\s*(?:clientes?|personas?|pacientes?|autos?|veh[ií]culos?|llamadas?|usuarios?)\s*(?:por|\/)\s*hora/)||
  m(/llegan?\s*(?:en\s+promedio\s+)?(?:unos?\s+)?([\d.]+)\s*(?:clientes?|personas?|pacientes?)?\s*(?:por|\/)\s*hora/)||
  m(/(?:tasa\s+de\s+llegada|arribo|λ|lambda)\s*:?\s*(?:de\s+)?([\d.]+)/)||
  m(/(?:demanda|llegada)\s*(?:de\s+)?(?:pacientes?|clientes?)?\s*:?.*?(?:en\s+promedio\s*,?\s*)?(?:llegan?\s*)?(?:en\s+promedio\s+)?([\d.]+)\s*(?:pacientes?|clientes?|personas?)?\s*(?:por|\/)\s*hora/)||
  m(/(?:cada\s+hora\s+)?(?:llegan?|entran?|arriban?|vienen?)\s*(?:en\s+promedio\s+)?(?:unos?\s+)?([\d.]+)/);
 if(lam)p.arrival_rate_lambda=lam;
 let mu=m(/(?:atiende[n]?|procesa[n]?|sirve[n]?)\s*(?:en\s+promedio\s+)?(?:a\s+)?(?:unos?\s+)?([\d.]+)\s*(?:clientes?|personas?|pacientes?)?\s*(?:por|\/)\s*hora/)||
  m(/(?:tasa\s+de\s+servicio|μ|mu)\s*:?\s*(?:de\s+)?([\d.]+)/)||
  m(/(?:capacidad|velocidad)\s*(?:de\s+)?(?:atención|servicio)\s*:?\s*([\d.]+)\s*(?:por|\/)\s*hora/);
 if(mu){p.service_rate_mu=mu;}
 else{
  const svcTime=m(/(?:tarda|demora|dura|lleva|toma)\s*(?:en\s+promedio\s+)?(?:unos?\s+)?([\d.]+)\s*(?:minutos?|min)\s*(?:en\s+)?(?:atender|procesar|servir|cada|por)/)||
   m(/(?:tiempo\s+(?:de\s+)?(?:atención|servicio|consulta))\s*(?:promedio)?\s*:?\s*(?:de\s+)?(?:unos?\s+)?([\d.]+)\s*(?:minutos?|min)/)||
   m(/(?:atención|servicio|consulta)\s*(?:dura|tarda|toma|lleva)\s*(?:en\s+promedio\s+)?([\d.]+)\s*(?:minutos?|min)/)||
   m(/(?:cada\s+)?(?:m[ée]dico|cajero|servidor|empleado|operador)\s*(?:tarda|demora)\s*(?:en\s+promedio\s+)?([\d.]+)\s*(?:minutos?|min)/)||
   m(/([\d.]+)\s*(?:minutos?|min)\s*(?:en\s+promedio\s+)?(?:por\s+)?(?:paciente|cliente|persona|atención|servicio|consulta)/);
  if(svcTime&&svcTime>0)p.service_rate_mu=Math.round(60/svcTime*1000)/1000;
  else{
   const svcH=m(/(?:tarda|demora|dura)\s*(?:en\s+promedio\s+)?([\d.]+)\s*(?:horas?|hs?)\s*(?:en\s+)?(?:atender|procesar|servir)/);
   if(svcH&&svcH>0)p.service_rate_mu=Math.round(1/svcH*1000)/1000;
  }
 }
 const sv=tln.match(/([\d]+)\s*(?:cajeros?|servidores?|ventanillas?|cajas?|empleados?|operadores?|agentes?|m[ée]dicos?|doctores?|puestos?|enfermeros?)/);
 const sv2=tln.match(/(?:tengo|hay|cuento\s+con|tiene|disponemos\s+de)\s*(?:unos?\s+)?([\d]+)\s*(?:cajeros?|servidores?|ventanillas?|cajas?|empleados?|m[ée]dicos?|puestos?)/);
 const findM=/cu[áa]ntos?\s*(?:m[ée]dicos?|cajeros?|servidores?|empleados?|ventanillas?|puestos?)|definir\s+cu[áa]ntos|determinar\s+cu[áa]ntos|necesito\s+m[áa]s|debo\s+tener|optimizar.*(?:servidores?|m[ée]dicos?|cajeros?)/i.test(tln);
 if(sv2){p.num_servers_M=Math.round(parseFloat(sv2[1]));}
 else if(sv&&!findM){p.num_servers_M=Math.round(parseFloat(sv[1]));}
 if(findM)p._find_optimal_M=true;
 const ce=m(/(?:usd|\$)\s*([\d.]+)\s*(?:por\s+)?(?:paciente|cliente|persona)\s*(?:por\s+)?(?:hora)?\s*(?:de\s+)?(?:espera|en\s+el\s+sistema)/)||
  m(/(?:costo\s+)?(?:asociado\s+)?(?:a\s+)?(?:la\s+)?(?:espera|insatisfacci[oó]n|p[ée]rdida)\s*(?:de\s+los\s+pacientes?)?\s*(?:\([^)]*\))?\s*:?\s*(?:estimado\s+en\s+)?(?:usd|\$)\s*([\d.]+)\s*(?:por\s+)?(?:paciente|cliente|persona)\s*(?:por\s+)?hora/)||
  m(/\$?\s*([\d.]+)\s*(?:por\s+)?(?:cada\s+)?(?:paciente|cliente|persona)?\s*(?:por\s+)?hora\s*(?:de\s+)?(?:espera|promedio)/)||
  m(/(?:espera|satisfacci[oó]n|p[ée]rdida|insatisfacci[oó]n|abandono)\s*(?:[\s\S]*?)(?:usd|\$)\s*([\d.]+)\s*(?:por\s+)?(?:paciente|cliente)?\s*(?:por\s+)?hora/)||
  m(/costo\s*(?:de\s+)?(?:espera|insatisfacci[oó]n)\s*:?\s*(?:usd|\$)?\s*([\d.]+)/);
 if(ce)p.cost_per_wait_ce=ce;
 const cs=m(/(?:costo\s+(?:por\s+)?(?:de\s+)?)?(?:m[ée]dico|cajero|servidor|empleado|ventanilla|puesto|operador)\s*:?\s*(?:usd|\$)\s*([\d.]+)\s*(?:por\s+|\/)?hora/)||
  m(/(?:usd|\$)\s*([\d.]+)\s*(?:por\s+|\/)?hora\s*(?:por\s+)?(?:cada\s+)?(?:m[ée]dico|cajero|servidor|empleado)/)||
  m(/(?:cada\s+)?(?:m[ée]dico|cajero|servidor|empleado)\s*(?:me\s+)?(?:cuesta|sale|vale|cobra)\s*(?:usd|\$)?\s*([\d.]+)\s*(?:por\s+|\/)?hora/)||
  m(/costo\s*(?:por\s+)?(?:de\s+)?(?:m[ée]dico|cajero|servidor|empleado)\s*(?:es\s+(?:de\s+)?)?:?\s*(?:usd|\$)\s*([\d.]+)\s*(?:por\s+|\/)?hora/)||
  m(/costo\s*(?:por\s+)?(?:de\s+)?(?:m[ée]dico|cajero|servidor)\s*:?\s*(?:usd|\$)?\s*([\d.]+)/);
 if(cs)p.cost_per_server_cs=cs;
 return p;
}

function extractInvest(t){
 // Parse Spanish-format numbers: "250.000" → 250000, "1.200.000" → 1200000, "15" → 15
 function parseNum(s){
  if(!s)return null;
  s=s.trim().replace(/[$usd\s]/gi,'');
  // Spanish thousands separator: 250.000 or 1.200.000 (dots with 3-digit groups)
  if(/^\d{1,3}(\.\d{3})+$/.test(s))return parseFloat(s.replace(/\./g,''));
  // Comma as thousands: 250,000
  if(/^\d{1,3}(,\d{3})+$/.test(s))return parseFloat(s.replace(/,/g,''));
  return parseFloat(s.replace(/,/g,'.'));
 }
 // Extract a number after a regex match
 function mNum(text,rx){
  const r=text.match(rx);
  if(!r)return null;
  return parseNum(r[1]);
 }
 // Split input into alternative blocks
 function splitAlternatives(text){
  const parts=text.split(/(?=alternativa\s+[a-z](?:\s|–|-))/i);
  if(parts.length>=2){
   // First part might be empty or preamble; take blocks that start with "alternativa"
   return parts.filter(p=>/alternativa\s+[a-z]/i.test(p));
  }
  // Try "opción 1 / opción 2"
  const parts2=text.split(/(?=opci[oó]n\s+\d)/i);
  if(parts2.length>=2)return parts2.filter(p=>/opci[oó]n\s+\d/i.test(p));
  return [text]; // single block
 }
 // Parse one alternative block
 function parseAlt(block,defaultName){
  const tl=block.toLowerCase();
  // Name extraction
  const nm=block.match(/alternativa\s+[a-z]\s*[–\-:]\s*([a-záéíóúñü\s]+?)(?=\s+inversi[oó]n|\s+capital|\s+cuesta|\s+monto|$)/i)||
           block.match(/opci[oó]n\s+\d\s*[–\-:]\s*([a-záéíóúñü\s]+?)(?=\s+inversi[oó]n|\s+capital|$)/i);
  const name=nm?nm[1].trim().substring(0,40):defaultName;
  // Number pattern allowing dots as thousands separators
  const NP='([\\d]+(?:[.,]\\d{3})*(?:[.,]\\d{1,2})?)';
  // Investment
  const I0=mNum(tl,new RegExp('inversi[oó]n[^:]*:\\s*'+NP))||
           mNum(tl,new RegExp('(?:capital|desembolso|cuesta|monto)[^:]*:\\s*'+NP))||
           mNum(tl,new RegExp('(?:invert(?:ir|í))\\s+'+NP));
  // Revenue / Income / Savings
  const R=mNum(tl,new RegExp('ingreso[s]?[^:]*:\\s*'+NP))||
          mNum(tl,new RegExp('(?:ventas?|revenue|facturaci[oó]n)[^:]*:\\s*'+NP))||
          mNum(tl,new RegExp('(?:gano|gana|genera)\\s+'+NP));
  // Additional income (e.g., "incremento ingresos": 40.000 + "ahorro costos": 80.000)
  const ahorro=mNum(tl,new RegExp('ahorro[s]?[^:]*:\\s*'+NP));
  const incremento=mNum(tl,new RegExp('incremento[s]?[^:]*:\\s*'+NP));
  const totalRevenue=(R||0)+(ahorro||0)+(incremento||0);
  // Costs
  const VC=mNum(tl,new RegExp('costos?\\s+(?:operativo|variable|directo)[s]?[^:]*:\\s*'+NP))||
           mNum(tl,new RegExp('(?:operat|variable|directo)[s]?[^:]*:\\s*'+NP));
  const FC=mNum(tl,new RegExp('costos?\\s+(?:fijo|administraci[oó]n|overhead)[s]?[^:]*:\\s*'+NP));
  const maint=mNum(tl,new RegExp('(?:mantenimiento|manten)[^:]*:\\s*'+NP));
  const addlCost=mNum(tl,new RegExp('costos?\\s+adicional[es]*[^:]*:\\s*'+NP));
  const totalCosts=(VC||0)+(FC||0)+(maint||0)+(addlCost||0);
  // Life / Horizon
  const T=mNum(tl,new RegExp('vida\\s+(?:[uú]til|estimada)[^:]*:\\s*'+NP))||
          mNum(tl,new RegExp('horizonte[^:]*:\\s*'+NP))||
          mNum(tl,new RegExp(NP+'\\s*a[ñn]os'));
  // Residual value
  const Rv=/sin\s+valor\s+residual/i.test(tl)?0:
           mNum(tl,new RegExp('(?:valor\\s+residual|salvage|terminal|residual)[^:]*:\\s*'+NP));
  // Discount rate
  const rate=mNum(tl,new RegExp('tasa\\s+(?:de\\s+)?descuento[^:]*:\\s*'+NP))||
             mNum(tl,new RegExp('(?:wacc|costo\\s+del\\s+capital)[^:]*:\\s*'+NP))||
             mNum(tl,new RegExp('descuento[^:]*:\\s*'+NP));
  // Working capital
  const WC=mNum(tl,new RegExp('capital\\s+de\\s+trabajo[^:]*:\\s*'+NP));
  // Tax rate
  const tax=mNum(tl,new RegExp('(?:impuesto|tax|tasa\\s+impositiva)[^:]*:\\s*'+NP));
  // Only create alt if we got at least investment or revenue
  if(I0===null&&totalRevenue===0)return null;
  return {
   name:name,
   initial_investment:I0||0,
   working_capital:WC||0,
   useful_life:T||5,
   residual_value:Rv||0,
   annual_revenue:totalRevenue||0,
   variable_costs:totalCosts||0,
   fixed_costs:0,
   tax_rate:tax?tax/100:0.35,
   discount_rate:rate?(rate>=1?rate/100:rate):0.12
  };
 }
 const p={alternatives:[],_raw:t};
 const dtype=/(?:mutuamente\s+excluyentes?|elegir\s+(?:uno|una)|una\s+u\s+otra)/i.test(t)?'mutually_exclusive':
             /independientes?/i.test(t)?'independent':'mutually_exclusive';
 p.decision_type=dtype;
 const blocks=splitAlternatives(t);
 blocks.forEach((block,i)=>{
  const alt=parseAlt(block,'Alternativa '+'ABCDEFGH'[i]);
  if(alt)p.alternatives.push(alt);
 });
 // Shared discount rate: if multiple alternatives, propagate the rate from the first one if others default
 if(p.alternatives.length>1){
  const rates=p.alternatives.map(a=>a.discount_rate).filter(r=>r!==0.12);
  if(rates.length>0){
   const sharedRate=rates[0];
   p.alternatives.forEach(a=>{if(a.discount_rate===0.12)a.discount_rate=sharedRate;});
  }
 }
 return p;
}

// ─── MODULE DESCRIPTIONS FOR TF-IDF SEMANTIC MATCHING ───
const MODULE_DEFS={
 LP:{
  name:'Producción',
  desc:'Decidir cuánto producir fabricar de cada producto para maximizar ganancias o minimizar costos con recursos limitados como harina azúcar materia prima horas de trabajo maquinado',
  // weight 3 = definitivo, 2 = fuerte, 1 = contextual
  terms:{
   'programación lineal':3,'simplex':3,'función objetivo':3,'maximizar ganancia':3,'minimizar costo':3,
   'producir':2,'fabricar':2,'restricciones':2,'recursos limitados':2,'ganancia por unidad':2,
   'cuánto producir':2,'cuanto producir':2,'mezcla':2,'asignar':2,'precio de venta':2,'costo variable':2,
   'horas disponibles':2,'maquinado':2,'materia prima':2,'mano de obra':2,'presupuesto':2,
   'panadería':1,'panaderia':1,'taller':1,'planta':1,
   'kg de harina':1,'para producir':1,'disponibles por día':1,'unidades de':1,
   'torta':1,'medialuna':1,'pieza':1,'artículo':1,'producto':1,'producción':1,
   'recurso':1,'restricción':1,'ganancia':1,'tratamiento':1,'conviene':1
  }
 },
 STOCK:{
  name:'Almacenamiento',
  desc:'Cuánto pedir cada cuánto reponer inventario stock lote óptimo punto de reorden demanda anual costo de almacenamiento costo de pedido proveedor entrega faltante',
  terms:{
   'eoq':3,'lote óptimo':3,'punto de reorden':3,'cuánto pedir':3,'cada cuánto':3,'cuantas unidades pedir':3,
   'inventario':2,'stock':2,'almacén':2,'almacenar':2,'proveedor':2,'reposición':2,'lote':2,
   'demanda anual':2,'costo de pedido':2,'costo de almacenamiento':2,'lead time':2,
   'no puedo permitir faltantes':3,'cuántas unidades pedir':3,'cuanto pedir':3,
   'pedir':1,'pedido':1,'faltante':2,'faltantes':2,'depósito':1,'deposito':1,'bodega':1,
   'comprar':1,'reabastecer':1,'cuantas unidades':1,'almacenamiento':1,
   'unidades por año':1,'costo por unidad':1,'vendo':1,'distribuidor':1,
   'demanda mensual':2,'demanda por mes':2,'demanda conocida':2,
   'pierdo al cliente':2,'no entrego':2,'agotamiento':2,'ruptura de stock':3,
   'cuándo pedir':2,'cuando pedir':2,'nivel de reorden':2,
   'unidades por mes':1,'costo de mantener':2,'costo almacenar':2
  }
 },
 QUEUE:{
  name:'Atención',
  desc:'Tiempos de espera en cola fila cuántos servidores cajeros necesito tasa de llegada tasa de servicio clientes por hora pacientes médico ventanilla',
  terms:{
   'teoría de colas':3,'m/m/1':3,'m/m/m':3,'tasa de llegada':3,'tasa de servicio':3,
   'cola':2,'fila':2,'espera':2,'cajero':2,'servidor':2,'ventanilla':2,'atención':2,
   'clientes por hora':2,'tiempo de espera':2,'cuántos cajeros':2,'cuántas cajas':2,
   'paciente':2,'médico':2,'medico':2,'atiende':2,'llegan':2,
   'banco':1,'hospital':1,'peaje':1,'call center':1,'supermercado':1,'turnero':1,
   'clínica':1,'clinica':1,'consultorio':1,'tarda':1,'demora':1,'en atender':1,'por hora':1,
   'filas de espera':1,'servidores':1,'costo de espera':1
  }
 },
 INVEST:{
  name:'Planificación',
  desc:'Evaluación de proyectos de inversión VAN valor actual neto TIR tasa interna de retorno NPV IRR flujo de caja payback alternativas decisión financiera CAPEX depreciación impuestos tasa descuento rentabilidad índice de rentabilidad análisis incremental',
  terms:{
   'evaluación de proyectos':3,'van':3,'tir':3,'valor actual neto':3,'tasa interna de retorno':3,'npv':3,'irr':3,
   'inversión':2,'proyecto de inversión':2,'payback':2,'flujo de caja':2,'capital':2,'capex':2,'wacc':2,'rentabilidad':2,
   'alternativa':1,'retorno':1,'descuento':1,'depreciación':1,'impuestos':1,'residual':1,'comparar alternativas':2,
   'mutuamente excluyentes':2,'independientes':1,'reemplazo':1,'expansión':1,'año 0':1,'horizonte':1,'sensibilidad':1
  }
 },
 FORECAST:{
  name:'Pronósticos',
  desc:'Pronóstico de demanda futura serie temporal promedio móvil suavización exponencial regresión lineal tendencia estacionalidad forecast predecir demanda histórica ventas futuras',
  terms:{
   'pronóstico':3,'pronostico':3,'forecast':3,'demanda futura':3,'predecir demanda':3,
   'serie temporal':3,'promedio móvil':3,'promedio movil':3,'suavización exponencial':3,'suavizacion exponencial':3,
   'regresión lineal':2,'regresion lineal':2,'tendencia':2,'moving average':3,
   'ventas futuras':2,'demanda histórica':2,'demanda historica':2,'predecir':2,
   'pronosticar':2,'estimación':1,'estimacion':1,'proyección':1,'proyeccion':1,
   'mad':2,'mape':2,'tracking signal':2,'media móvil':3,'media movil':3,
   'alpha':1,'alfa':1,'ponderado':1,'exponencial':1,'forecast':3
  }
 },
 RENTABILIDAD:{
  name:'Rentabilidad',
  desc:'Análisis de rentabilidad margen de ganancia por producto punto de equilibrio break-even precio costo unitario contribución marginal cuánto me queda cuánto gano por unidad conviene vender',
  terms:{
   'rentabilidad':3,'margen':3,'margen de ganancia':3,'punto de equilibrio':3,'break even':3,'breakeven':3,
   'cuánto gano':3,'cuanto gano':3,'cuánto me queda':3,'cuanto me queda':3,'ganancia por unidad':3,
   'contribución marginal':3,'contribucion marginal':3,'margen bruto':3,'margen neto':3,
   'precio de venta':2,'costo unitario':2,'costo por unidad':2,'costo variable':2,'costos fijos':2,
   'precio y costo':2,'costo de producción':2,'costo de produccion':2,
   'rentable':2,'conviene vender':2,'qué producto conviene':2,'qué producto es mejor':2,
   'gano más':2,'gano mas':2,'más margen':2,'mas margen':2,'mejor margen':2,
   'equilibrio':2,'receta':1,'costo ingredientes':1,'food cost':2,
   'menú':1,'menu':1,'carta':1,'plato':1,'hamburguesa':1,'pizza':1,'café':1,'cafe':1,
   'empanada':1,'producto más rentable':2,'producto mas rentable':2,
   'margen porcentaje':2,'utilidad':2,'beneficio':2,'lucro':1,
   'vendo a':1,'me cuesta':1,'cuánto cobro':1,'cuanto cobro':1
  }
 },
 FLUJO_CAJA:{
  name:'Flujo de Caja',
  desc:'Flujo de caja cash flow proyección de caja ingresos egresos saldo caja liquidez financiamiento cobros pagos mensuales',
  terms:{
   'flujo de caja':3,'flujo de fondos':3,'cash flow':3,'proyección de caja':3,'proyeccion de caja':3,
   'me alcanza la plata':3,'me alcanza':3,'alcanza la plata':3,'llego a fin de mes':3,
   'cuánta plata':3,'cuanta plata':3,'cuánto me queda en caja':3,
   'saldo de caja':3,'liquidez':3,'caja mensual':3,
   'necesito financiamiento':3,'necesito plata':3,'me falta plata':2,
   'ingresos y egresos':3,'cobros y pagos':3,'entradas y salidas':3,
   'proyectar meses':2,'proyectar caja':2,'próximos meses':2,'proximos meses':2,
   'cobro mensual':2,'pago mensual':2,'cuánto cobro':2,'cuanto cobro':2,
   'cuánto pago':2,'cuanto pago':2,'cuánto gasto':2,'cuanto gasto':2,
   'saldo inicial':2,'caja inicial':2,'arranco con':2,
   'proveedor':1,'sueldo':1,'alquiler':1,'servicios':1
  }
 }
};

// Normalize text: remove accents for fuzzy matching
function normTxt(s){return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();}

let session={module:null,subtype:null,params:{},assumptions:[],stage:'detect',solution:null,history:[]};

// ═══════════════════════════════════════════════════════════
// SCENARIO COMPARISON — Data Layer
// ═══════════════════════════════════════════════════════════
let scenarios=[];
const SCENARIOS_KEY='invop_scenarios';
const MAX_SCENARIOS_PER_MODULE=5;

function loadScenarios(){
 try{scenarios=JSON.parse(localStorage.getItem(SCENARIOS_KEY)||'[]');}
 catch(e){console.warn('[SCEN] Load failed:',e);scenarios=[];}
}
function saveScenariosToDisk(){
 try{localStorage.setItem(SCENARIOS_KEY,JSON.stringify(scenarios));}
 catch(e){console.warn('[SCEN] Save failed:',e);}
}
function initScenarios(){
 loadScenarios();
 updateScenariosUI();
}

function detectMod(t){
 const tl=t.toLowerCase();
 const tn=normTxt(t);
 const scores={};
 let totalScore=0;

 for(const[mod,def]of Object.entries(MODULE_DEFS)){
  let score=0;
  // 1) Weighted keyword matching (exact + normalized)
  for(const[term,weight]of Object.entries(def.terms)){
   const termN=normTxt(term);
   if(tl.includes(term)||tn.includes(termN)){
    score+=weight;
   }else{
    // Partial/fuzzy: check each word of multi-word terms
    const words=termN.split(/\s+/);
    if(words.length>1){
     const matched=words.filter(w=>tn.includes(w)).length;
     if(matched>=Math.ceil(words.length*0.6))score+=weight*0.5;
    }
   }
  }
  // 2) TF-IDF-like: boost terms that are unique to this module
  const descWords=normTxt(def.desc).split(/\s+/);
  const inputWords=tn.split(/\s+/);
  let idfBoost=0;
  for(const w of inputWords){
   if(w.length<3)continue;
   const inThis=descWords.includes(w);
   const inOthers=Object.entries(MODULE_DEFS).filter(([m])=>m!==mod).some(([,d])=>normTxt(d.desc).split(/\s+/).includes(w));
   if(inThis&&!inOthers)idfBoost+=1.5; // unique to this module
   else if(inThis&&inOthers)idfBoost+=0.3; // shared
  }
  score+=idfBoost;
  scores[mod]=score;
  totalScore+=score;
 }

 // Rank and compute confidence
 const ranked=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
 const best=ranked[0], second=ranked[1];
 if(best[1]===0)return{mod:null,conf:0,scores,ambiguous:false};

 const conf=totalScore>0?best[1]/totalScore:0;
 const gap=second?best[1]-second[1]:best[1];
 const ambiguous=conf<0.6||(second&&second[1]>0&&gap<2);

 return{mod:best[0],conf:Math.round(conf*100)/100,scores,ambiguous,top2:ranked.slice(0,2).map(([m,s])=>({mod:m,score:Math.round(s*10)/10,name:MODULE_DEFS[m].name}))};
}

function processMsg(txt){
 const S=session,tl=txt.toLowerCase();
 S.history.push({role:'user',content:txt,timestamp:new Date().toISOString()});

 if(S.stage==='detect'){
  if(txt.trim()==='1'){S.module='LP';S.stage='lp_input';return tMsg('prod_request');}
  if(txt.trim()==='2'){S.module='STOCK';S.stage='collect';return tMsg('stock_intro');}
  if(txt.trim()==='3'){S.module='QUEUE';S.stage='collect';return tMsg('queue_intro');}
  if(txt.trim()==='4'){S.module='INVEST';S.stage='invest_input';S.params._raw=txt;updUI();return processInvestInput(txt);}
  if(txt.trim()==='5'){S.module='FORECAST';S.stage='collect';S.params={};updUI();updateQuickButtons();return tMsg('forecast_q_data');}
  if(txt.trim()==='6'){S.module='RENTABILIDAD';S.stage='collect';S.params={products:[],fixed_costs:undefined};updUI();updateQuickButtons();return tMsg('rent_q_products');}
  if(txt.trim()==='7'){S.module='FLUJO_CAJA';S.stage='collect';S.params={opening_balance:undefined,periods:undefined,inflows:[],outflows:[],dso:undefined,dpo:undefined};updUI();updateQuickButtons();return tMsg('fc_q_data');}

  if(isMultiPeriodPlan(txt)){
   S.module='LP';S.stage='lp_input';
   const spec=formulateMultiPeriodLP(txt);
   if(spec){S.params=spec;S.stage='confirm';updUI();return fmtConfirmMultiPeriod(spec);}
  }

  const d=detectMod(txt);
  if(d.mod&&d.conf>0){
   // B3: If ambiguous, ask user to confirm
   if(d.ambiguous&&d.top2&&d.top2.length>=2){
    S._pendingDetection=d;
    S._pendingText=txt;
    S.stage='disambiguate';
    updUI();
    let msg=`Parece que tu problema podría ser de:\n\n`;
    d.top2.forEach((t,i)=>{msg+=`${i+1}. **${t.name}**\n`;});
    msg+=`\n¿Cuál es? Respondé con el número o describí con más detalle.`;
    return msg;
   }
   S.module=d.mod;S.stage='collect';
   if(d.mod==='STOCK')Object.assign(S.params,extractStock(txt));
   if(d.mod==='QUEUE')Object.assign(S.params,extractQueue(txt));
   if(d.mod==='INVEST'){S.params._raw=txt;S.stage='invest_input';updUI();return processInvestInput(txt);}
   if(d.mod==='LP'){S.params._raw=txt;S.stage='lp_input';updUI();return processLPInput(txt);}
   if(d.mod==='FORECAST'){Object.assign(S.params,extractForecast(txt));updUI();updateQuickButtons();return checkAndAsk();}
   if(d.mod==='RENTABILIDAD'){S.params={products:[],fixed_costs:undefined};const ex=extractRentabilidad(txt);if(ex.products.length>0)S.params.products=ex.products;if(ex.fixed_costs!==undefined)S.params.fixed_costs=ex.fixed_costs;updUI();return checkAndAsk();}
   if(d.mod==='FLUJO_CAJA'){S.params={opening_balance:undefined,periods:undefined,inflows:[],outflows:[],dso:undefined,dpo:undefined};const ex=extractFlujoCaja(txt);if(ex.opening_balance!==undefined)S.params.opening_balance=ex.opening_balance;if(ex.periods)S.params.periods=ex.periods;if(ex.inflows.length>0)S.params.inflows=ex.inflows;if(ex.outflows.length>0)S.params.outflows=ex.outflows;if(ex.dso)S.params.dso=ex.dso;if(ex.dpo)S.params.dpo=ex.dpo;updUI();return checkAndAsk();}
   return checkAndAsk();
  }
  return tMsg('module_choice');
 }

 if(S.stage==='disambiguate'){
  const pd=S._pendingDetection, pt=S._pendingText||'';
  const choice=txt.trim();
  if(pd&&pd.top2){
   let chosenMod=null;
   if(choice==='1')chosenMod=pd.top2[0].mod;
   else if(choice==='2')chosenMod=pd.top2[1].mod;
   else{
    // Re-detect with combined text
    const d2=detectMod(pt+' '+txt);
    if(d2.mod&&!d2.ambiguous)chosenMod=d2.mod;
    else if(d2.mod)chosenMod=d2.mod;
   }
   if(chosenMod){
    S.module=chosenMod;S.stage='collect';
    delete S._pendingDetection;
    const fullTxt=pt+' '+txt;
    if(chosenMod==='STOCK')Object.assign(S.params,extractStock(fullTxt));
    if(chosenMod==='QUEUE')Object.assign(S.params,extractQueue(fullTxt));
    if(chosenMod==='LP'){S.params._raw=fullTxt;S.stage='lp_input';updUI();return processLPInput(fullTxt);}
    if(chosenMod==='FORECAST'){Object.assign(S.params,extractForecast(fullTxt));updUI();updateQuickButtons();return checkAndAsk();}
    if(chosenMod==='RENTABILIDAD'){S.params={products:[],fixed_costs:undefined};const ex=extractRentabilidad(fullTxt);if(ex.products.length>0)S.params.products=ex.products;if(ex.fixed_costs!==undefined)S.params.fixed_costs=ex.fixed_costs;updUI();return checkAndAsk();}
    if(chosenMod==='FLUJO_CAJA'){S.params={opening_balance:undefined,periods:undefined,inflows:[],outflows:[]};const ex=extractFlujoCaja(fullTxt);if(ex.opening_balance!==undefined)S.params.opening_balance=ex.opening_balance;if(ex.periods)S.params.periods=ex.periods;if(ex.inflows.length>0)S.params.inflows=ex.inflows;if(ex.outflows.length>0)S.params.outflows=ex.outflows;updUI();return checkAndAsk();}
    updUI();return checkAndAsk();
   }
  }
  S.stage='detect';delete S._pendingDetection;
  return tMsg('module_choice');
 }

 if(S.stage==='collect'){
  // Escape: "nuevo problema" from any collect stage
  if(/nuevo problema|otro problema|empezar de cero|reiniciar|reset|empezar de nuevo/i.test(tl)){
   session={module:null,subtype:null,params:{},assumptions:[],stage:'detect',solution:null,history:S.history};
   updUI();updateQuickButtons();showWelcome();return tMsg('new_problem');
  }
  if(S.module==='FORECAST'){
   // Auto-select "compare all" when user doesn't know which method
   if(!S.params.method&&S.params.timeseries&&S.params.timeseries.length>=3&&/dec[ií]me?\s*vos|eleg[ií]\s*vos|no\s+s[eé]|no\s+tengo\s+idea|recomend[aá]|el\s+mejor|cualquiera|todos|compar[aá]|no\s+entiendo|vos\s+sab[eé]s|cu[aá]l\s+(?:me\s+)?(?:conviene|recomiend)/i.test(tl)){
    S.params.method='ALL';updUI();updateQuickButtons();return checkAndAsk();
   }
   // Handle bare decimal as alpha when SES method is selected and alpha missing
   const bareAlpha=txt.trim().replace(/,/g,'.');
   if(S.params.method==='SES'&&!S.params.alpha&&/^0?\.\d+$/.test(bareAlpha)){
    const av=parseFloat(bareAlpha);
    if(av>0&&av<1){S.params.alpha=av;updUI();updateQuickButtons();return checkAndAsk();}
   }
   // Handle bare integer as window when SMA and window missing
   if(S.params.method==='SMA'&&!S.params.window&&/^\d+$/.test(txt.trim())){
    const wv=parseInt(txt.trim());
    if(wv>=2&&wv<=12){S.params.window=wv;updUI();updateQuickButtons();return checkAndAsk();}
   }
   Object.assign(S.params,extractForecast(txt));
   updUI();updateQuickButtons();return checkAndAsk();
  }
  if(S.module==='RENTABILIDAD'){
   if(!Array.isArray(S.params.products))S.params.products=[];
   const ex=extractRentabilidad(txt);
   if(ex.products.length>0)S.params.products=[...S.params.products,...ex.products];
   if(ex.fixed_costs!==undefined)S.params.fixed_costs=ex.fixed_costs;
   // Handle "no fixed costs"
   if(/no\s+(?:tengo|hay)|sin\s+(?:costos?\s+)?fijos?|nada|ninguno|cero/i.test(tl)&&S.params.fixed_costs===undefined)S.params.fixed_costs=0;
   // Handle bare number as quantity for products without qty
   const bareNum=txt.trim().replace(/[\$usd\s]/gi,'').replace(/,/g,'.');
   const isNum=/^[\d.]+$/.test(bareNum)&&!isNaN(parseFloat(bareNum));
   if(isNum&&S.params.products.length>0){
    const val=parseFloat(bareNum);
    if(S.params._askingQty){
     // Assign quantity to products that don't have one
     for(const prod of S.params.products){if(!prod.quantity||prod.quantity===0){prod.quantity=val;break;}}
    }else if(S.params._askingFixed){
     S.params.fixed_costs=val;
    }
   }
   // Handle quantities like "50 hamburguesas y 30 pizzas"
   for(const prod of S.params.products){
    if(!prod.quantity||prod.quantity===0){
     const qRx=new RegExp('(\\d+)\\s*(?:' + prod.name.toLowerCase() + '|' + prod.name.toLowerCase() + 's?)','i');
     const qm=tl.match(qRx);
     if(qm)prod.quantity=parseFloat(qm[1]);
    }
   }
   updUI();return checkAndAsk();
  }
  if(S.module==='FLUJO_CAJA'){
   if(!Array.isArray(S.params.inflows))S.params.inflows=[];
   if(!Array.isArray(S.params.outflows))S.params.outflows=[];
   const ex=extractFlujoCaja(txt);
   if(ex.opening_balance!==undefined)S.params.opening_balance=ex.opening_balance;
   if(ex.periods)S.params.periods=ex.periods;
   if(ex.inflows.length>0)S.params.inflows=[...S.params.inflows,...ex.inflows];
   if(ex.outflows.length>0)S.params.outflows=[...S.params.outflows,...ex.outflows];
   if(ex.dso)S.params.dso=ex.dso;
   if(ex.dpo)S.params.dpo=ex.dpo;
   // Handle bare number for opening balance or periods
   const bareNum=txt.trim().replace(/[\$\s]/gi,'').replace(/,/g,'.');
   const isNum=/^[\d.]+$/.test(bareNum)&&!isNaN(parseFloat(bareNum));
   if(isNum){
    const val=parseFloat(bareNum);
    if(S.params._askingOpening){S.params.opening_balance=val;S.params._askingOpening=false;}
    else if(S.params._askingPeriods){S.params.periods=Math.round(val);S.params._askingPeriods=false;}
   }
   // Handle "no tengo saldo" or zero opening
   if(/no\s+tengo|arranc[oe]\s+(?:de|en|con)?\s*(?:cero|0)|sin\s+plata|sin\s+saldo|cero/i.test(tl)&&S.params.opening_balance===undefined)S.params.opening_balance=0;
   updUI();return checkAndAsk();
  }
  if(S.module==='INVEST'){
   S.stage='invest_input';
   if(S.params._raw)S.params._raw+='\n'+txt;
   else S.params._raw=txt;
   return processInvestInput(txt);
  }
  if(S.module==='LP'){
   S.stage='lp_input';
   if(S.params._raw)S.params._raw+='\n'+txt;
   else S.params._raw=txt;
   return processLPInput(S.params._raw);
  }
  if(isMultiPeriodPlan(txt)){
   S.module='LP';S.params={};
   const spec=formulateMultiPeriodLP(txt);
   if(spec){S.params=spec;S.stage='confirm';updUI();return fmtConfirmMultiPeriod(spec);}
  }
  if(/\b(?:nada|todo\s+bien|está\s+bien|esta\s+bien)\b.*\b(?:resolv|dale|ok|calcul|listo)/i.test(tl)||
     /\b(?:resolv|dale|calcul|listo)\b.*\b(?:nada|así|asi|todo\s+bien)/i.test(tl)){
   if(S.module==='STOCK'||S.module==='QUEUE'){
    S.stage='solved';
    return doSolve();
   }
  }
  const bareNum=txt.trim().replace(/[\$usd\s]/gi,'').replace(/,/g,'.');
  const isNum=/^[\d.]+$/.test(bareNum)&&!isNaN(parseFloat(bareNum));
  if(isNum){
   const val=parseFloat(bareNum);
   if(S.module==='STOCK'){
    const stockNeed=['demand_D','order_cost_k','holding_cost_c1','acquisition_cost_b'];
    for(const k of stockNeed){
     if(S.params[k]===undefined){S.params[k]=val;break;}
    }
   }
   if(S.module==='QUEUE'){
    const queueNeed=['arrival_rate_lambda','service_rate_mu','num_servers_M'];
    for(const k of queueNeed){
     if(S.params[k]===undefined){S.params[k]=k==='num_servers_M'?Math.round(val):val;break;}
    }
   }
  }else{
   if(S.module==='STOCK'){Object.assign(S.params,extractStock(txt));handleStockYN(tl);}
   if(S.module==='QUEUE'){Object.assign(S.params,extractQueue(txt));handleQueueYN(tl);}
  }
  return checkAndAsk();
 }

 if(S.stage==='lp_input'){
  // Escape hatch: detect reset intent
  if(/nuevo problema|otro problema|empezar de cero|reiniciar|reset|empezar de nuevo/i.test(tl)){
   session={module:null,subtype:null,params:{},assumptions:[],stage:'detect',solution:null,history:S.history};
   updUI();updateQuickButtons();showWelcome();return tMsg('new_problem');
  }
  // Escape hatch: detect if user is actually describing a STOCK or QUEUE problem
  const escapeCheck=detectMod(txt);
  if(escapeCheck.mod&&escapeCheck.mod!=='LP'&&escapeCheck.conf>=0.4&&!escapeCheck.ambiguous){
   S.module=escapeCheck.mod;S.stage='collect';S.params={};S.assumptions=[];
   if(escapeCheck.mod==='STOCK')Object.assign(S.params,extractStock(txt));
   if(escapeCheck.mod==='QUEUE')Object.assign(S.params,extractQueue(txt));
   updUI();return checkAndAsk();
  }
  S.params._lp_last_msg=txt;
  if(S.params._raw) S.params._raw+='\n'+txt;
  else S.params._raw=txt;
  return processLPInput(S.params._raw);
 }

 if(S.stage==='invest_input'){
  if(/nuevo problema|otro problema|empezar de cero|reiniciar|reset|empezar de nuevo/i.test(tl)){
   session={module:null,subtype:null,params:{},assumptions:[],stage:'detect',solution:null,history:S.history};
   updUI();updateQuickButtons();showWelcome();return tMsg('new_problem');
  }
  if(/solo esta|evaluar solo|una sola|single|no comparar/i.test(tl)){
   if(S.params.alternatives&&S.params.alternatives.length>=1){
    S.params.decision_type='independent';S.stage='confirm';updUI();return fmtConfirmInvest();
   }
  }
  return processInvestInput(txt);
 }

 if(S.stage==='confirm'){
  if(/(?:^|\s|,)s[ií](?:\s|$|[,\.!])|correcto|dale|\bok\b|resolv|adelante|confirm|listo|perfect|vamos|calcul/i.test(tl)){
   S.stage='solved';
   return doSolve();
  }
  if(S.module==='LP'){S.stage='lp_input';return processLPInput(txt);}
  if(S.module==='INVEST'){S.stage='invest_input';return processInvestInput(txt);}
  if(S.module==='FORECAST'){S.stage='collect';Object.assign(S.params,extractForecast(txt));updUI();updateQuickButtons();return checkAndAsk();}
  if(S.module==='RENTABILIDAD'){S.stage='collect';if(!Array.isArray(S.params.products))S.params.products=[];const ex=extractRentabilidad(txt);
   // Merge: update existing products (name-only) with new price/cost data
   if(ex.products.length>0){
    for(var ei=0;ei<ex.products.length;ei++){
     var ep=ex.products[ei];var found=false;
     for(var pi=0;pi<S.params.products.length;pi++){
      if(S.params.products[pi].name.toLowerCase()===ep.name.toLowerCase()){
       if(ep.price>0)S.params.products[pi].price=ep.price;
       if(ep.unit_cost>0)S.params.products[pi].unit_cost=ep.unit_cost;
       if(ep.quantity>0)S.params.products[pi].quantity=ep.quantity;
       found=true;break;
      }
     }
     if(!found)S.params.products.push(ep);
    }
   }
   if(ex.fixed_costs!==undefined)S.params.fixed_costs=ex.fixed_costs;updUI();return checkAndAsk();}
  if(S.module==='FLUJO_CAJA'){S.stage='collect';if(!Array.isArray(S.params.inflows))S.params.inflows=[];if(!Array.isArray(S.params.outflows))S.params.outflows=[];const ex=extractFlujoCaja(txt);if(ex.opening_balance!==undefined)S.params.opening_balance=ex.opening_balance;if(ex.periods)S.params.periods=ex.periods;if(ex.inflows.length>0)S.params.inflows=[...S.params.inflows,...ex.inflows];if(ex.outflows.length>0)S.params.outflows=[...S.params.outflows,...ex.outflows];if(ex.dso)S.params.dso=ex.dso;if(ex.dpo)S.params.dpo=ex.dpo;updUI();return checkAndAsk();}
  S.stage='collect';
  return tMsg('adjust_data');
 }

 if(S.stage==='solved'){
  // Sensitivity analysis
  if(/sensibilidad|qué pasa si|qu[ée] pasar[ií]a|cambiar|variar|si cambio|si aumento|si reduzco/i.test(tl)) return fmtSensitivity();
  // New problem
  if(/nuevo problema|otro problema|empezar de cero|reiniciar|reset/i.test(tl)){session={module:null,subtype:null,params:{},assumptions:[],stage:'detect',solution:null,history:[]};updUI();updateQuickButtons();updateScenariosUI();showWelcome();return tMsg('new_problem');}
  // Explain model
  if(/explic|modelo|fórmula|formula|cómo funciona|cómo se calcula|por qué|por que|de dónde sale/i.test(tl)) return fmtFormulas();
  // RENTABILIDAD: add product
  if(S.module==='RENTABILIDAD'&&/agregar|a[ñn]adir|m[aá]s producto|otro producto|sumar producto/i.test(tl)){
   S.stage='collect';S.solution=null;S.assumptions=[];updUI();updateQuickButtons();
   const cur=S.params.products||[];
   const names=cur.map(p=>p.name).join(', ');
   return '**Agregá tu nuevo producto.** Ya tenés: '+names+'.\n\nDecime nombre, precio de venta y costo unitario del nuevo producto.\n\n_(Ej: "Medialunas: vendo a $800, me cuestan $300, vendo 150 por día")_';
  }
  // FLUJO_CAJA: add income/expense
  if(S.module==='FLUJO_CAJA'&&/agregar|a[ñn]adir|m[aá]s ingreso|m[aá]s egreso|otro ingreso|otro egreso|sumar/i.test(tl)){
   S.stage='collect';S.solution=null;S.assumptions=[];updUI();updateQuickButtons();
   const inNames=(S.params.inflows||[]).map(i=>i.name).join(', ');
   const outNames=(S.params.outflows||[]).map(o=>o.name).join(', ');
   return '**Agregá ingresos o egresos.** Ya tenés:\n- Ingresos: '+(inNames||'ninguno')+'\n- Egresos: '+(outNames||'ninguno')+'\n\nDecime el nuevo ingreso o egreso.\n\n_(Ej: "Cobro $100.000 de un alquiler" o "Pago $50.000 de cuota")_';
  }
  // FORECAST: change method
  if(S.module==='FORECAST'&&/otro m[eé]todo|cambiar m[eé]todo|probar otro|comparar/i.test(tl)){
   S.params.method=null;S.params.window=null;S.params.weights=null;S.params.alpha=null;
   S.stage='collect';S.solution=null;S.assumptions=[];updUI();updateQuickButtons();
   return tMsg('forecast_q_method');
  }
  // What-if: user wants to change a specific parameter
  if(/(?:si|con|cambi|pon[eé]|us[aáe])\s+(?:la\s+)?(?:demanda|D)\s*(?:a|=|de|fuera|sea)?\s*([\d.,]+)/i.test(tl)&&S.module==='STOCK'){
   const newD=parseFloat(tl.match(/([\d.,]+)/)[1].replace(',','.'));
   S.params.demand_D=newD;S.stage='confirm';
   return `Actualicé la demanda a **${newD.toLocaleString('es-AR')}**. ¿Resuelvo con estos datos?\n\n`+fmtConfirm().replace('**Voy a resolver','**Resolver de nuevo');
  }
  if(/(?:si|con|cambi|pon[eé])\s+(?:el\s+)?(?:costo\s+(?:de\s+)?pedido|k)\s*(?:a|=|de|fuera|sea)?\s*\$?\s*([\d.,]+)/i.test(tl)&&S.module==='STOCK'){
   const newK=parseFloat(tl.match(/\$?\s*([\d.,]+)/)[1].replace(',','.'));
   S.params.order_cost_k=newK;S.stage='confirm';
   return `Actualicé el costo de pedido a **$${newK}**. ¿Resuelvo?\n\n`+fmtConfirm().replace('**Voy a resolver','**Resolver de nuevo');
  }
  // Comparative: solve with different number of servers
  if(/(?:si|con|prob[aáe])\s*(?:con\s+)?([\d]+)\s*(?:servidores?|cajeros?|médicos?|medicos?)/i.test(tl)&&S.module==='QUEUE'){
   const newM=parseInt(tl.match(/([\d]+)\s*(?:servidores?|cajeros?|médicos?|medicos?)/i)[1]);
   S.params.num_servers_M=newM;S.stage='solved';
   return doSolve();
  }
  // Free text: try to understand intent from context
  if(/gracias|genial|perfecto|buenísimo|excelente|joya/i.test(tl)){
   return '¡De nada! ¿Querés resolver otro problema o explorar más esta solución?';
  }
  if(/exportar modelo|export model|formato lp|formato json|exportar formulaci[oó]n/i.test(tl)){
   return fmtExport();
  }
  if(/exportar|excel|descargar|guardar|bajar/i.test(tl)){
   if(S.module==='LP'&&S.solution)return fmtExport();
   return 'Podés exportar el log completo con el botón **📥 Exportar log** en la barra lateral. Se descarga como archivo Excel.';
  }
  // Catch-all: try to detect if it's a completely new problem
  const d=detectMod(txt);
  if(d.mod&&d.conf>=0.5&&!d.ambiguous){
   session={module:null,subtype:null,params:{},assumptions:[],stage:'detect',solution:null,history:S.history};
   return processMsg(txt);
  }
  return 'Podés:\n- Preguntar **qué pasa si** cambio un dato (ej: _"si la demanda sube a 20.000"_)\n- Pedir **sensibilidad** o **explicar el modelo**\n'+(S.module==='LP'?'- **Exportar modelo** en formato LP o JSON\n':'')+'- Iniciar un **nuevo problema**\n- O escribí lo que necesites libremente';
 }
 return tMsg('describe_problem');
}

// ─── CLAUDE API FALLBACK (B5) ───
const CLAUDE_FALLBACK_URL='/api/claude-fallback';
let claudeFallbackEnabled=null; // null=unknown, true/false after first check

async function tryClaudeFallback(txt){
 if(claudeFallbackEnabled===false)return null;
 try{
  const resp=await fetch(CLAUDE_FALLBACK_URL,{
   method:'POST',
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({message:txt,session_id:window._sessionId,context:session.module||''})
  });
  const data=await resp.json();
  if(data.status==='ok'){
   claudeFallbackEnabled=true;
   return data.response;
  }
  if(data.status==='disabled')claudeFallbackEnabled=false;
  return null;
 }catch(e){
  claudeFallbackEnabled=false;
  return null;
 }
}

// ─── SERVER-SIDE LP SOLVER (OR-Tools routing) ───
const LP_SERVER_URL='/api/solve-lp';
const LP_LOCAL_MAX_VARS=30; // Problems with >30 vars go to server
let lpServerAvailable=null; // null=unknown, true/false after probe

async function solveServerSide(spec){
 try{
  const resp=await fetch(LP_SERVER_URL,{
   method:'POST',
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify(spec),
   signal:AbortSignal.timeout(30000) // 30s timeout
  });
  if(!resp.ok){
   const err=await resp.json().catch(()=>({detail:'Server error'}));
   return {status:'ERROR',message:`Server: ${err.detail||resp.statusText}`};
  }
  lpServerAvailable=true;
  return await resp.json();
 }catch(e){
  if(e.name==='TimeoutError')return {status:'TIMEOUT',message:'Servidor demoró más de 30s.'};
  lpServerAvailable=false;
  return null; // null = server unavailable, fallback to local
 }
}

function shouldRouteToServer(spec){
 if(!spec||!spec.objective_coefficients)return false;
 const nVars=Object.keys(spec.objective_coefficients).length;
 return nVars>LP_LOCAL_MAX_VARS;
}

function handleStockYN(tl){
 if(/nunca|no falt|siempre tener|no puede/i.test(tl)){session.params.shortage_cost_c2=null;session.assumptions.push('No se admiten faltantes.');}
 if(/colchón|seguridad|sí.*protección/i.test(tl)){
  const D=session.params.demand_D||0;
  if(D>0&&!session.params.safety_stock_Sp){const Sp=Math.round(3*D/365);session.params.safety_stock_Sp=Sp;session.assumptions.push(`Stock protección: ${Sp} un (≈3 días demanda).`);}
 }
 if(/no.*seguridad|no.*colchón|confío/i.test(tl)){session.params.safety_stock_Sp=0;}
}

function handleQueueYN(tl){
 if(/sin límite|puede crecer|no hay límite/i.test(tl)){session.params.system_capacity_N=null;session.assumptions.push('Capacidad infinita.');}
}

function checkAndAsk(){
 const S=session,p=S.params;
 // Chain badge: show source info once
 var _chainPrefix='';
 if(S._chainSource&&!S._chainSource._shown){
  S._chainSource._shown=true;
  _chainPrefix='📊 _Datos cargados de '+S._chainSource.moduleName+': '+S._chainSource.description+'_\n\n';
 }
 var _result=_checkAndAskInner();
 return _chainPrefix?_chainPrefix+_result:_result;
}
function _checkAndAskInner(){
 const S=session,p=S.params;
 if(S.module==='STOCK'){
  const need=[['demand_D','stock_q_demand'],['order_cost_k','stock_q_order'],['holding_cost_c1','stock_q_hold'],['acquisition_cost_b','stock_q_price']];
  for(const[k,msgKey]of need){if(p[k]===undefined)return tMsg(msgKey);}
  p.planning_horizon_T=p.planning_horizon_T||1;
  p.safety_stock_Sp=p.safety_stock_Sp||0;
  if(p.shortage_cost_c2===undefined)p.shortage_cost_c2=null;
  if(!p.lead_time_LT)p.lead_time_LT=0;
  if(!S.assumptions.includes('Demanda constante e independiente.'))S.assumptions.push('Demanda constante e independiente.','Reposición instantánea.');
  S.stage='confirm';
  return fmtConfirm();
 }
 if(S.module==='QUEUE'){
  const baseNeed=[['arrival_rate_lambda','queue_q_lambda'],['service_rate_mu','queue_q_mu']];
  for(const[k,msgKey]of baseNeed){if(p[k]===undefined)return tMsg(msgKey);}
  if(p._find_optimal_M&&p.num_servers_M===undefined){
   const costNeed=[['cost_per_wait_ce','queue_q_ce'],['cost_per_server_cs','queue_q_cs']];
   for(const[k,msgKey]of costNeed){if(p[k]===undefined)return tMsg(msgKey);}
   const Mmin=Math.ceil(p.arrival_rate_lambda/p.service_rate_mu);
   p.num_servers_M=Mmin;
   if(!S.assumptions.includes('Llegadas Poisson, servicio exponencial.'))S.assumptions.push('Llegadas Poisson, servicio exponencial.','Disciplina FIFO.','Se busca M óptimo vía análisis económico.');
   S.stage='confirm';
   return fmtConfirmQueueOptM();
  }
  if(p.num_servers_M===undefined)return tMsg('queue_q_servers');
  if(!S.assumptions.includes('Llegadas Poisson, servicio exponencial.'))S.assumptions.push('Llegadas Poisson, servicio exponencial.','Disciplina FIFO.');
  S.stage='confirm';
  return fmtConfirm();
 }
 if(S.module==='FORECAST'){
  if(!p.timeseries||!Array.isArray(p.timeseries)||p.timeseries.length<3)return tMsg('forecast_q_data');
  if(!p.method){p.method='ALL';}
  if(p.method==='ALL'){p.window=p.window||3;p.alpha=p.alpha||0.2;}
  if(p.method==='SMA'&&!p.window)return tMsg('forecast_q_window');
  if(p.method==='WMA'&&(!p.weights||p.weights.length<2))return tMsg('forecast_q_weights');
  if(p.method==='SES'&&!p.alpha)return tMsg('forecast_q_alpha');
  p.periods_ahead=p.periods_ahead||1;
  if(!S.assumptions.length)S.assumptions.push('Patrón histórico se mantiene','No hay factores externos disruptivos');
  S.stage='confirm';
  return fmtConfirmForecast();
 }
 if(S.module==='RENTABILIDAD'){
  if(!p.products||p.products.length===0){S.params._askingQty=false;S.params._askingFixed=false;S.params._askingPrices=false;return tMsg('rent_q_products');}
  // Check if products need prices/costs (names only, no prices)
  const needPrices=p.products.some(pr=>!pr.price||pr.price===0);
  if(needPrices){
   S.params._askingPrices=true;S.params._askingQty=false;S.params._askingFixed=false;
   var names=p.products.map(function(pr){return pr.name;}).join(', ');
   return '**Tenés: '+names+'.**\n\nAhora decime el **precio de venta** y el **costo** de cada uno.\n\n_(Ej: "Zapatos: vendo a $15000, me cuestan $8000. Botas: vendo a $25000, cuestan $12000")_';
  }
  S.params._askingPrices=false;
  const needQty=p.products.some(pr=>!pr.quantity||pr.quantity===0);
  if(needQty){S.params._askingQty=true;S.params._askingFixed=false;return tMsg('rent_q_quantity');}
  S.params._askingQty=false;
  if(p.fixed_costs===undefined){S.params._askingFixed=true;return tMsg('rent_q_fixed');}
  S.params._askingFixed=false;
  if(!S.assumptions.length)S.assumptions.push('Precios y costos constantes en el período analizado.');
  S.stage='confirm';
  return fmtConfirmRentabilidad();
 }
 if(S.module==='FLUJO_CAJA'){
  // Build progress summary for smarter follow-up questions
  var fcHave=[];
  if(p.opening_balance!==undefined)fcHave.push('saldo inicial $'+(+p.opening_balance).toLocaleString('es-AR'));
  if(p.inflows&&p.inflows.length>0)fcHave.push(p.inflows.length+' ingreso(s)');
  if(p.outflows&&p.outflows.length>0)fcHave.push(p.outflows.length+' egreso(s)');
  if(p.periods)fcHave.push(p.periods+' meses');
  var fcProgress=fcHave.length>0?'\n\n_Ya tengo: '+fcHave.join(', ')+'._':'';
  if(p.opening_balance===undefined){S.params._askingOpening=true;S.params._askingPeriods=false;return tMsg('fc_q_opening')+fcProgress;}
  S.params._askingOpening=false;
  if(!p.inflows||p.inflows.length===0)return tMsg('fc_q_inflows')+fcProgress;
  if(!p.outflows||p.outflows.length===0)return tMsg('fc_q_outflows')+fcProgress;
  if(!p.periods){S.params._askingPeriods=true;return tMsg('fc_q_periods')+fcProgress;}
  S.params._askingPeriods=false;
  // Ask about DSO/DPO once (optional — user can skip)
  if(S.params._askedDsoDpo===undefined){
   S.params._askedDsoDpo=true;
   if(fcHave.length>0)fcProgress='\n\n_Ya tengo: '+fcHave.join(', ')+'._';
   return '¿Tus clientes te pagan en el momento o a plazo? ¿Y vos a tus proveedores?\n\n_(Ej: "Cobro a 30 días y pago a 60 días" o "Todo al contado". Si no sabés, escribí **resolver** y asumo cobro/pago inmediato.)_'+fcProgress;
  }
  if(!S.assumptions.length){
   S.assumptions.push('Ingresos y egresos constantes cada mes.');
   if(!p.dso&&!p.dpo)S.assumptions.push('Cobro y pago inmediato (sin DSO/DPO).');
   else{
    if(p.dso)S.assumptions.push('Plazo de cobro (DSO): '+p.dso+' días.');
    if(p.dpo)S.assumptions.push('Plazo de pago (DPO): '+p.dpo+' días.');
   }
   S.assumptions.push('Sin estacionalidad ni eventos extraordinarios.');
  }
  S.stage='confirm';
  return fmtConfirmFlujoCaja();
 }
 return tMsg('describe_problem');
}

// THIS IS THE MASSIVE NLP PARSER – Limited version for brevity
// In production use, include full processLPInput from original file
function processLPInput(txt){
 const S=session;
 const tl=txt.toLowerCase().replace(/,/g,'.');
 let objType='MAX';
 if(/minim|menor\s+costo|reducir/i.test(tl))objType='MIN';

 const products=[], resources={}, consumption={};
 const pn=v=>parseFloat(v.toString().replace(',','.'));
 const sents=txt.split(/[.\n]+/).map(s=>s.trim()).filter(s=>s.length>3);

 // Find PRODUCTS
 const prodBlockRx=/(?:para\s+(?:producir|hacer|fabricar)\s+(?:un[oa]?\s+)?)([\wáéíóúñ]+)/gi;
 let pbm;
 while((pbm=prodBlockRx.exec(tl))!==null){
  const name=pbm[1].trim();
  if(name.length>1&&!['que','con','los','las','del','una','uno'].includes(name)){
   if(!products.find(p=>p.name===name))products.push({name,profit:0});
  }
 }
 const prodLabelRx=/^([\wáéíóúñ]+)\s*:/gmi;
 let plm;
 while((plm=prodLabelRx.exec(txt))!==null){
  const name=plm[1].toLowerCase().trim();
  if(name.length>2&&!['para','cada','mis','los','las','precio','costo','objetivo','harina','azúcar','azucar','manteca','capacidad','recurso','disponible'].includes(name)){
   if(!products.find(p=>p.name===name))products.push({name,profit:0});
  }
 }
 const classicProfRx=/(?:pieza|producto|artículo)?\s*(?:la\s+)?([A-Za-záéíóúñ]+\d*)\s*(?:me\s+)?(?:deja|genera|produce|da)\s*\$?\s*([\d.,]+)/gi;
 let cpm;
 while((cpm=classicProfRx.exec(tl))!==null){
  const name=cpm[1].toLowerCase().trim();
  const profit=pn(cpm[2]);
  const existing=products.find(p=>p.name===name);
  if(existing)existing.profit=profit;
  else if(name.length>0)products.push({name,profit});
 }

 // Find RESOURCE AVAILABILITY
 const resRxPatterns=[
  /([\wáéíóúñ]+(?:\s+(?:de\s+)?[\wáéíóúñ]+)*?)\s*:\s*([\d.,]+)\s*(kg|kilos?|gramos?|litros?|horas?|minutos?|min|hs?|unidades?|metros?)\s*(?:por\s+)?(d[ií]a|semana|mes|a[ñn]o|disponibles?)?/gi,
  /([\wáéíóúñ]+(?:\s+(?:de\s+)?[\wáéíóúñ]+)*?)\s*(?:disponibles?|diarios?|total(?:es)?)\s*:\s*([\d.,]+)\s*(kg|kilos?|gramos?|litros?|horas?|minutos?|min|hs?|unidades?|metros?)/gi,
  /(?:tengo|dispongo\s+de|cuento\s+con)\s*([\d.,]+)\s*(kg|kilos?|gramos?|litros?|horas?|minutos?|min|hs?|unidades?|metros?)\s*(?:de\s+)?([\wáéíóúñ]+(?:\s+[\wáéíóúñ]+)*?)\s*(?:por\s+)?(d[ií]a|semana|mes|a[ñn]o|disponibles?)?/gi,
  /([\wáéíóúñ]+(?:\s+[\wáéíóúñ]+)*?)\s*\(\s*([\d.,]+)\s*(horas?|hs?|minutos?|min|kg|unidades?)\s*(?:disponibles?)?\s*\)/gi
 ];
 let rm,rmm;
 rm=resRxPatterns[0];rm.lastIndex=0;
 while((rmm=rm.exec(tl))!==null){
  const rname=rmm[1].trim(),val=pn(rmm[2]),unit=rmm[3]||'';
  if(rname.length>1&&val>0&&!['precio','costo','cada','para','los','las','no','el','la','necesito','requiero','uso','consume','producto','venta','variable','objetivo','decidir','producir','puedo'].includes(rname)){
   resources[rname]={available:val,unit};
  }
 }
 rm=resRxPatterns[2];rm.lastIndex=0;
 while((rmm=rm.exec(tl))!==null){
  const val=pn(rmm[1]),unit=rmm[2]||'',rname=rmm[3].trim();
  if(rname.length>1&&val>0&&!['precio','costo','cada','para','los','las','no','el','la','un','una'].includes(rname)){
   resources[rname]={available:val,unit};
  }
 }
 rm=resRxPatterns[3];rm.lastIndex=0;
 while((rmm=rm.exec(tl))!==null){
  const rname=rmm[1].trim(),val=pn(rmm[2]),unit=rmm[3]||'';
  if(rname.length>1&&val>0) resources[rname]={available:val,unit};
 }

 // Find CONSUMPTION per product
 for(const prod of products){
  consumption[prod.name]={};
  const escName=prod.name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const blockPatterns=[
   new RegExp(`(?:para\\s+(?:producir|hacer|fabricar)\\s+(?:un[oa]?\\s+)?${escName}[^:]*?(?:necesito|requiero|uso|consume)?\\s*:?\\s*)([\\s\\S]*?)(?=para\\s+(?:producir|hacer|fabricar)|los\\s+precios|precio\\s+de\\s+venta|no\\s+puedo|objetivo|$)`,'i'),
   new RegExp(`(?:(?:un[oa]?\\s+)?${escName}\\s+(?:necesita|requiere|usa|consume)\\s*:?\\s*)([\\s\\S]*?)(?=(?:un[oa]?\\s+)?(?:${products.filter(p=>p.name!==prod.name).map(p=>p.name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|')||'XXXXXX'})\\s+(?:necesita|requiere|usa|consume)|para\\s+producir|los\\s+precios|precio\\s+de|no\\s+puedo|objetivo|$)`,'i'),
   new RegExp(`${escName}\\s*(?:necesita|requiere|usa|consume)\\s+([^.]+)`,'i')
  ];
  for(const bp of blockPatterns){
   const bm=tl.match(bp);
   if(bm&&bm[1]){
    const block=bm[1];
    const consRx=/([\d.,]+)\s*(kg|kilos?|gramos?|g|litros?|l|horas?|h|hs?|minutos?|min|unidades?|metros?|m)\s*(?:de\s+)?([\wáéíóúñ]+(?:\s+de\s+[\wáéíóúñ]+)?)/gi;
    let cm;
    while((cm=consRx.exec(block))!==null){
     const val=pn(cm[1]),rname=cm[3].trim();
     if(val>0&&rname.length>1&&!['cada','para','que','por','con','una','uno','del'].includes(rname)){
      consumption[prod.name][rname]=val;
     }
    }
    if(Object.keys(consumption[prod.name]).length>0)break;
   }
  }
 }

 // Find PRICES/PROFITS
 for(const prod of products){
  const escName=prod.name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  const priceBlockRx=new RegExp(`${escName}\\s*:\\s*([\\s\\S]*?)(?=(?:${products.filter(p=>p.name!==prod.name).map(p=>p.name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|')||'XXXXXX'})\\s*:|no\\s+puedo|objetivo|$)`,'i');
  const pbm2=tl.match(priceBlockRx);
  if(pbm2&&pbm2[1]){
   const block=pbm2[1];
   const pvRx=/precio\s*(?:de\s+)?venta\s*:?\s*(?:usd|\$|us\$)?\s*([\d.,]+)/i;
   const cvRx=/costo\s*(?:variable)?\s*:?\s*(?:usd|\$|us\$)?\s*([\d.,]+)/i;
   const ganRx=/ganancia\s*(?:(?:por\s+)?unidad)?\s*:?\s*(?:usd|\$|us\$)?\s*([\d.,]+)/i;
   const pvM=block.match(pvRx),cvM=block.match(cvRx),ganM=block.match(ganRx);
   if(pvM&&cvM){prod.profit=pn(pvM[1])-pn(cvM[1]);prod.sell_price=pn(pvM[1]);prod.var_cost=pn(cvM[1]);}
   else if(ganM){prod.profit=pn(ganM[1]);}
   else if(pvM){prod.profit=pn(pvM[1]);}
  }
  const classicRx=new RegExp(`${escName}\\s*(?:me\\s+)?(?:deja|genera|produce|da)\\s*(?:una\\s+(?:ganancia|utilidad)\\s+de\\s+)?\\$?\\s*([\\d.,]+)`,'i');
  const clm=tl.match(classicRx);
  if(clm&&prod.profit===0)prod.profit=pn(clm[1]);
 }

 // Match consumption resource names to actual resources (fuzzy)
 const resKeys=Object.keys(resources);
 const normalizeRes=(name)=>name.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
 const matchRes=(consName)=>{
  const cn=normalizeRes(consName);
  let found=resKeys.find(rk=>normalizeRes(rk)===cn);
  if(found)return found;
  found=resKeys.find(rk=>normalizeRes(rk).includes(cn)||cn.includes(normalizeRes(rk)));
  if(found)return found;
  const cw=cn.split(/\s+/)[0];
  found=resKeys.find(rk=>normalizeRes(rk).split(/\s+/)[0]===cw);
  return found||null;
 };
 for(const prod of products){
  const mapped={};
  for(const[cname,val]of Object.entries(consumption[prod.name]||{})){
   const rk=matchRes(cname);
   if(rk) mapped[rk]=val;
   else{mapped[cname]=val;if(!resources[cname]) resources[cname]={available:0,unit:''};}
  }
  consumption[prod.name]=mapped;
 }

 // Merge with previously saved partial data from prior messages
 if(S.params._lp_products&&products.length===0){S.params._lp_products.forEach(p=>{if(!products.find(x=>x.name===p.name))products.push(p);});}
 else if(products.length>0){S.params._lp_products=products;}
 if(S.params._lp_resources&&Object.keys(resources).length===0){Object.assign(resources,S.params._lp_resources);}
 else if(Object.keys(resources).length>0){S.params._lp_resources=resources;}
 if(S.params._lp_consumption){
  for(const pn2 of Object.keys(S.params._lp_consumption)){
   if(!consumption[pn2]||Object.keys(consumption[pn2]).length===0)consumption[pn2]=S.params._lp_consumption[pn2];
  }
 }
 if(Object.keys(consumption).some(k=>Object.keys(consumption[k]).length>0)){S.params._lp_consumption=consumption;}

 // Build LP if we have enough data
 const prodWithProfit=products.filter(p=>p.profit!==0||p.sell_price);
 const resWithAvail=Object.entries(resources).filter(([k,v])=>v.available>0);
 const prodsWithConsump=products.filter(p=>Object.keys(consumption[p.name]||{}).length>0);

 if(products.length>=1&&(resWithAvail.length>=1||prodsWithConsump.length>=1)){
  const oc={};
  products.forEach(pr=>{oc['x_'+pr.name]=pr.profit;});
  const cs2=[];
  for(const[rname,rdata]of Object.entries(resources)){
   if(rdata.available<=0)continue;
   const coeffs={};let hasCoeff=false;
   products.forEach(pr=>{const c=(consumption[pr.name]||{})[rname]||0;coeffs['x_'+pr.name]=c;if(c>0)hasCoeff=true;});
   if(hasCoeff){cs2.push({name:rname,coeffs,sense:'<=',rhs:rdata.available});}
  }
  if(cs2.length>0&&prodWithProfit.length>=1){
   S.params={objective_type:objType,objective_coefficients:oc,constraints:cs2};
   S.stage='confirm';
   return fmtConfirmLP();
  }
 }

 // Context-aware example generator
 function lpContextExample(products,type){
  const ctx={
   textil:{res:'200 metros de tela, 100 horas de costura y 50 horas de máquina por semana',cons:'2 metros de tela, 0.5 horas de costura y 0.3 horas de máquina'},
   comida:{res:'100 kg de harina, 30 kg de azúcar, 20 kg de manteca y 480 minutos de horno por día',cons:'0.5 kg de harina, 0.02 kg de azúcar, 0.01 kg de manteca y 2 minutos de horno'},
   mueble:{res:'500 metros de madera, 200 horas de carpintería y 100 litros de barniz por mes',cons:'3 metros de madera, 2 horas de carpintería y 0.5 litros de barniz'},
   metal:{res:'1000 kg de acero, 300 horas de soldadura y 200 horas de tornería por mes',cons:'5 kg de acero, 1 hora de soldadura y 0.5 horas de tornería'},
   generico:{res:'500 horas de trabajo, $100.000 de presupuesto y 200 unidades de materia prima por mes',cons:'2 horas de trabajo, $500 de presupuesto y 3 unidades de materia prima'}
  };
  const pnames=products.map(p=>(p.name||p).toLowerCase()).join(' ');
  let cat='generico';
  if(/remer|musculos|camis|pantalon|short|campera|buzo|jean|calza|ropa|tela|prenda|textil/i.test(pnames))cat='textil';
  else if(/pan |torta|medialuna|galleta|pizza|empanada|alfajor|pasta|comida|panadería|pastel/i.test(pnames))cat='comida';
  else if(/mesa|silla|mueble|estante|cama|escritorio|puerta|ventana|madera/i.test(pnames))cat='mueble';
  else if(/caño|tubo|pieza|chapa|varilla|acero|hierro|metal|soldad/i.test(pnames))cat='metal';
  if(type==='res')return ctx[cat].res;
  if(type==='cons'){
   const firstName=products[0]?(products[0].name||products[0]):'producto';
   return `Para una ${firstName}: `+ctx[cat].cons;
  }
  return ctx[cat].res;
 }

 // Smart conversational fallback
 S.stage='lp_input';
 if(products.length>0)S.params._lp_products=products;
 if(resWithAvail.length>0)S.params._lp_resources=resources;
 if(prodsWithConsump.length>0)S.params._lp_consumption=consumption;
 if(prodWithProfit.length>0)S.params._lp_profits=true;
 const has={prod:products.length>0,res:resWithAvail.length>0,cons:prodsWithConsump.length>0,prof:prodWithProfit.length>0};

 if(!has.prod){
  const lastMsg=(S.params._lp_last_msg||txt).toLowerCase();
  const simpleListRx=/(?:productos?|fabrico|hago|produzco|vendo)\s*:?\s*(?:son\s*:?\s*)?(.+)/i;
  const slm=lastMsg.match(simpleListRx);
  if(slm){
   const rawList=slm[1].split(/\n/)[0];
   const names=rawList.split(/\s*,\s*|\s+y\s+/).map(n=>n.trim().replace(/[.\d:;()]/g,'').replace(/\s+/g,' ').trim()).filter(n=>n.length>2&&!['que','con','los','las','del','una','uno','para','mis','tres','dos','cuatro','cinco'].includes(n));
   if(names.length>0){
    names.forEach(n=>{if(!products.find(p=>p.name===n))products.push({name:n,profit:0});});
    S.params._lp_products=products;
    return `Perfecto, tenés **${products.length} productos**: ${products.map(p=>'**'+p.name+'**').join(', ')}.\n\n¿Con qué **recursos** contás? Por ejemplo: _"${lpContextExample(products,'res')}"_`;
   }
  }
  return tMsg('lp_ask_products');
 }
 if(!has.res){
  return `Tengo tus productos: ${products.map(p=>'**'+p.name+'**').join(', ')}.\n\n¿Con qué **recursos** contás y cuánto tenés disponible? Por ejemplo: _"${lpContextExample(products,'res')}"_`;
 }
 if(!has.cons){
  const resNames=Object.keys(resources).slice(0,3).join(', ');
  return `Tengo tus productos (${products.map(p=>p.name).join(', ')}) y recursos (${resNames}).\n\n¿Cuánto de cada recurso necesitás **para producir una unidad** de cada producto? Por ejemplo: _"${lpContextExample(products,'cons')}"_`;
 }
 if(!has.prof){
  return `Ya tengo productos, recursos y consumos. Solo falta un dato clave:\n\n¿Cuánto **ganás con cada producto** (o precio de venta y costo)? Por ejemplo:\n${products.map(p=>`_"${p.name.charAt(0).toUpperCase()+p.name.slice(1)}: precio $X, costo $Y"_`).join('\n')}`;
 }
 // Track LP attempts to avoid infinite loops
 S.params._lp_attempts=(S.params._lp_attempts||0)+1;
 if(S.params._lp_attempts>=4){
  return '⚠️ No logro armar el modelo completo. Probá describir todo junto:\n\n_"Fabrico A y B. A me deja $500, B me deja $800. Tengo 100 kg de materia prima. A usa 2 kg y B usa 3 kg."_\n\n'+
   'O si preferís, pasame los datos en formato tabla:\n- Producto: ganancia/unidad\n- Recurso: cantidad disponible\n- Consumo: cuánto usa cada producto de cada recurso';
 }
 return `Tengo casi todo. Revisá que los datos estén completos:\n- Productos: ${products.map(p=>p.name).join(', ')}\n- Recursos: ${Object.keys(resources).join(', ')}\n- Ganancias: ${products.map(p=>p.name+' $'+p.profit).join(', ')}\n\n¿Falta algo? Si está bien, volvé a describir el consumo de cada producto.`;
}

function fmtConfirmLP(){
 const p=session.params;
 const vn=(v)=>{const n=v.replace('x_','');return n.charAt(0).toUpperCase()+n.slice(1);};
 let s='**Voy a resolver este LP:**\n\n';
 s+=`Objetivo: **${p.objective_type}** Z = ${Object.entries(p.objective_coefficients).map(([v,c])=>`${c}·${vn(v)}`).join(' + ')}\n\n`;
 s+='Restricciones:\n';
 p.constraints.forEach(c=>{
  const cn=c.name.charAt(0).toUpperCase()+c.name.slice(1);
  s+=`- ${cn}: ${Object.entries(c.coeffs).map(([v,co])=>`${co}·${vn(v)}`).join(' + ')} ≤ ${c.rhs}\n`;
 });
 s+='\n¿Es correcto? Puedo **resolver** o ajustar algo.';
 return s;
}

function fmtConfirm(){
 const S=session,p=S.params;let s=`**Voy a resolver un modelo de ${S.module==='STOCK'?'Inventarios':'Colas'} con estos datos:**\n\n`;
 if(S.module==='STOCK'){
  const lbl={demand_D:['Demanda anual (D)','un/año'],order_cost_k:['Costo pedido (k)','$/pedido'],holding_cost_c1:['Costo almac. (c₁)','$/un/año'],acquisition_cost_b:['Precio (b)','$/unidad'],lead_time_LT:['Tiempo entrega','años'],safety_stock_Sp:['Stock protección (Sp)','unidades'],shortage_cost_c2:['Costo faltante (c₂)','$/un/año']};
  for(const[k,[l,u]]of Object.entries(lbl)){
   if(p[k]!==undefined&&p[k]!==null){
    let v=p[k];if(k==='lead_time_LT')s+=`- ${l}: ${r1(v*365)} días\n`;
    else s+=`- ${l}: ${typeof v==='number'?v.toLocaleString('es-AR'):v} ${u}\n`;
   }
  }
 }else if(S.module==='QUEUE'){
  const lbl={arrival_rate_lambda:['Tasa llegada (λ)','cl/hora'],service_rate_mu:['Tasa servicio (μ)','cl/hora/serv'],num_servers_M:['Servidores (M)',''],system_capacity_N:['Capacidad (N)',''],cost_per_wait_ce:['Costo espera (ce)','$/cl/hora'],cost_per_server_cs:['Costo servidor (cs)','$/hora']};
  for(const[k,[l,u]]of Object.entries(lbl)){if(p[k]!==undefined&&p[k]!==null)s+=`- ${l}: ${p[k]} ${u}\n`;}
 }
 if(S.assumptions.length){s+='\n**Supuestos:**\n';S.assumptions.forEach(a=>s+=`- ${a}\n`);}
 s+='\n¿Es correcto? Puedo **resolver** o ajustar algo.';
 return s;
}

function fmtConfirmQueueOptM(){
 const S=session,p=S.params;
 const Mmin=Math.ceil(p.arrival_rate_lambda/p.service_rate_mu);
 let s=`**Voy a buscar el número óptimo de servidores (M) con estos datos:**\n\n`;
 s+=`- Tasa llegada (λ): ${p.arrival_rate_lambda} pacientes/hora\n`;
 s+=`- Tasa servicio (μ): ${p.service_rate_mu} pacientes/hora/servidor\n`;
 s+=`- Costo espera (ce): $${p.cost_per_wait_ce}/paciente/hora\n`;
 s+=`- Costo servidor (cs): $${p.cost_per_server_cs}/hora\n`;
 s+=`- Mínimo servidores necesarios: ${Mmin} (para ρ < 1)\n`;
 if(S.assumptions.length){s+='\n**Supuestos:**\n';S.assumptions.forEach(a=>s+=`- ${a}\n`);}
 s+='\n¿Es correcto? Puedo **resolver** o ajustar algo.';
 return s;
}

function validateModel(S){
 const p=S.params,warns=[],errors=[];
 // ── STOCK validation ─────────────────────────────────────────
 if(S.module==='STOCK'){
  if(p.demand_D!==undefined&&p.demand_D<=0){warns.push('Demanda (D) debe ser positiva. Se corrigió a valor absoluto.');p.demand_D=Math.abs(p.demand_D)||1;}
  if(p.order_cost_k!==undefined&&p.order_cost_k<=0){warns.push('Costo de pedido (k) debe ser positivo. Se corrigió.');p.order_cost_k=Math.abs(p.order_cost_k)||1;}
  if(p.holding_cost_c1!==undefined&&p.holding_cost_c1<=0){warns.push('Costo de almacenamiento (c₁) debe ser positivo. Se corrigió.');p.holding_cost_c1=Math.abs(p.holding_cost_c1)||1;}
  if(p.demand_D>1e12)warns.push('Demanda extremadamente alta (>10¹²). Verificá las unidades.');
  if(p.order_cost_k>1e9)warns.push('Costo de pedido muy alto (>10⁹). ¿Unidades correctas?');
 }
 // ── QUEUE validation ─────────────────────────────────────────
 if(S.module==='QUEUE'){
  if(p.arrival_rate_lambda!==undefined&&p.arrival_rate_lambda<=0){warns.push('Tasa de llegada (λ) debe ser positiva. Se corrigió.');p.arrival_rate_lambda=Math.abs(p.arrival_rate_lambda)||1;}
  if(p.service_rate_mu!==undefined&&p.service_rate_mu<=0){warns.push('Tasa de servicio (μ) debe ser positiva. Se corrigió.');p.service_rate_mu=Math.abs(p.service_rate_mu)||1;}
  const rho=p.arrival_rate_lambda/(p.service_rate_mu*(p.num_servers_M||1));
  if(rho>=1&&!p._find_optimal_M)warns.push(`Atención: ρ=${r2(rho)} ≥ 1. El sistema es inestable con M=${p.num_servers_M||1}. Se necesitan más servidores.`);
  if((p.num_servers_M||1)>20)warns.push('M > 20 servidores puede causar inestabilidad numérica en el cálculo factorial.');
 }
 // ── LP validation (ModelValidator enterprise) ─────────────────
 if(S.module==='LP'){
  const oc=p.objective_coefficients||{};
  const cs=p.constraints||[];
  const ocKeys=Object.keys(oc);
  // 1. Trivialidad: todos los coeficientes objetivo = 0
  if(ocKeys.length>0&&Object.values(oc).every(v=>v===0))
   errors.push('Todos los coeficientes objetivo son 0. El modelo es trivial — necesito saber las ganancias o costos de cada producto.');
  // 2. Sin restricciones
  if(cs.length===0&&ocKeys.length>0)
   errors.push('Modelo sin restricciones. Sin límites, la solución es infinita. Necesito al menos un recurso limitado.');
  // 3. Variables huérfanas: en objetivo pero no en ninguna restricción
  const cVars=new Set();
  cs.forEach(c=>Object.keys(c.coeffs||{}).forEach(v=>{if(Math.abs(c.coeffs[v])>1e-12)cVars.add(v)}));
  const orphans=ocKeys.filter(v=>Math.abs(oc[v])>1e-12&&!cVars.has(v));
  if(orphans.length>0)
   warns.push(`Variable(s) ${orphans.map(v=>v.replace('x_','')).join(', ')} aparecen en el objetivo pero no tienen restricciones. El solver las puede llevar a ±∞.`);
  // 4. Restricciones vacías (sin coeficientes no-cero)
  cs.forEach(c=>{
   const hasCoeffs=Object.values(c.coeffs||{}).some(v=>Math.abs(v)>1e-12);
   if(!hasCoeffs)errors.push(`Restricción '${c.name||'sin nombre'}' no tiene coeficientes — no aporta información al modelo.`);
  });
  // 5. Coeficientes sospechosamente grandes o pequeños
  for(const[v,coef]of Object.entries(oc)){
   if(Math.abs(coef)>1e12)warns.push(`Coeficiente muy grande: ${v.replace('x_','')}=${coef}. Posible error de unidades.`);
   if(Math.abs(coef)>0&&Math.abs(coef)<1e-8)warns.push(`Coeficiente muy pequeño: ${v.replace('x_','')}=${coef}. ¿Es correcto?`);
  }
  // 6. RHS negativo en <= (inusual, posible error de signo)
  cs.forEach(c=>{
   if((c.sense==='<='||!c.sense)&&c.rhs<0)warns.push(`Restricción '${c.name||''}' tiene RHS negativo (${c.rhs}). Verificá el signo.`);
  });
  // 7. Variables en restricciones pero no en objetivo (informativo)
  const oVars=new Set(ocKeys.filter(v=>Math.abs(oc[v])>1e-12));
  const unused=[...cVars].filter(v=>!oVars.has(v));
  if(unused.length>0&&unused.length<=5)
   warns.push(`Variable(s) ${unused.map(v=>v.replace('x_','')).join(', ')} aparecen en restricciones pero no en el objetivo. Se asumirá costo/ganancia = 0.`);
  // 8. Dimension warning
  if(ocKeys.length>100)warns.push(`Modelo grande: ${ocKeys.length} variables. Puede tardar más en resolver.`);
  if(cs.length>200)warns.push(`Modelo grande: ${cs.length} restricciones. Puede tardar más en resolver.`);
 }
 // ── FORECAST validation ─────────────────────────────────────────
 if(S.module==='FORECAST'){
  if(!p.timeseries||!Array.isArray(p.timeseries)||p.timeseries.length<3)
   errors.push('Se necesitan al menos 3 períodos de datos históricos.');
  if(p.timeseries&&p.timeseries.some(v=>isNaN(v)||v<0))
   warns.push('Algunos datos parecen inválidos. Se usarán solo valores numéricos positivos.');
  if(p.method==='WMA'&&p.weights){
   const wSum=p.weights.reduce((a,b)=>a+b,0);
   if(Math.abs(wSum-1)>0.05)warns.push(`Los pesos suman ${r2(wSum)}, no 1.0. Se normalizarán automáticamente.`);
  }
  if(p.method==='SES'&&p.alpha&&(p.alpha<=0||p.alpha>=1))
   errors.push('Alpha debe estar entre 0 y 1 (exclusivo).');
 }
 // ── RENTABILIDAD validation ───────────────────────────────────
 if(S.module==='RENTABILIDAD'){
  if(!p.products||p.products.length===0)errors.push('Se necesita al menos un producto para analizar.');
  (p.products||[]).forEach(pr=>{
   if(!pr.price||pr.price<=0)errors.push(`"${pr.name}": el precio de venta debe ser mayor a 0.`);
   if(pr.unit_cost<0)warns.push(`"${pr.name}": costo unitario negativo. ¿Es correcto?`);
   if(pr.price>0&&pr.unit_cost>pr.price)warns.push(`"${pr.name}": el costo ($${pr.unit_cost}) es mayor al precio ($${pr.price}). Generará pérdida.`);
  });
 }
 return{errors,warns};
}

function fmtDecision(res,S){
 const mod=S.module,p=S.params,r=res.results||{};
 let d='\n---\n**Decisión:**\n';
 if(mod==='STOCK'){
  const qo=r.qo,to=r.to_days,sr=r.SR_reorder_point,cte=r.CTE;
  d+=`Pedí **${r0(qo)} unidades** cada **${to} días**.`;
  if(sr!==undefined&&sr>0)d+=` Cuando el stock llegue a **${r0(sr)} unidades**, lanzá el pedido.`;
  d+=`\n\n**¿Por qué?** Este lote minimiza el costo total anual (**$${r2(cte).toLocaleString('es-AR')}**) balanceando el costo de hacer pedidos contra el de mantener inventario.`;
  const sens=res.sensitivity;
  if(sens&&sens.sensitivity_table){
   d+=`\n\n**Trade-off:** Si pedís lotes un 20% más grandes o chicos, el costo sube menos de un 2%. El EOQ es robusto — más vale redondear a un número práctico que obsesionarse con el exacto.`;
  }
 }else if(mod==='QUEUE'){
  const ec=res.economic_analysis;
  const M=p.num_servers_M||1;
  const rho=r.rho_per_server||r.rho||0;
  if(p._find_optimal_M&&ec&&ec.optimal_M){
   const opt=ec.optimal_M,comp=ec.comparisons||[];
   const optRow=comp.find(c=>c.is_optimal);
   d+=`Operá con **${opt} servidores**.`;
   if(optRow)d+=` Costo total: **$${r0(optRow.cost_total_per_hour)}/hora**.`;
   const less=comp.find(c=>c.M===opt-1&&c.status==='ESTABLE');
   if(less)d+=`\n\n**Trade-off:** Con ${opt-1} servidores ahorrás $${r0(ec.optimal_M*+(p.cost_per_server_cs||0)-(opt-1)*+(p.cost_per_server_cs||0))}/hora en sueldos, pero el costo de espera sube a $${r0(less.cost_wait_per_hour)}/hora. El neto es peor.`;
  }else{
   d+=`Con **${M} servidor${M>1?'es':''}** y utilización del **${r2(rho*100)}%**`;
   if(rho<0.7)d+=`, el sistema tiene capacidad ociosa. Podrías absorber más demanda sin degradar el servicio.`;
   else if(rho<0.85)d+=`, el sistema opera en zona eficiente.`;
   else d+=`, el sistema está al límite. Cualquier pico de demanda generará colas largas. Considerá agregar capacidad.`;
  }
 }else if(mod==='LP'){
  const vars=res.variable_values||{},obj=res.objective_value;
  const pvn=(v)=>v.replace('x_','').charAt(0).toUpperCase()+v.replace('x_','').slice(1);
  const actions=Object.entries(vars).filter(([k,v])=>v>0).map(([k,v])=>`**${pvn(k)}**: ${v} unidades`);
  const zeros=Object.entries(vars).filter(([k,v])=>v===0).map(([k])=>pvn(k));
  d+=`Producí ${actions.join(', ')}. `;
  if(zeros.length)d+=`No conviene producir ${zeros.join(' ni ')}.`;
  d+=` Resultado óptimo: **$${obj.toLocaleString('es-AR',{minimumFractionDigits:2})}**.`;
  const sat=(res.constraint_details||[]).filter(cd=>cd.slack===0);
  const slack=(res.constraint_details||[]).filter(cd=>cd.slack>0);
  if(sat.length){
   d+=`\n\n**Trade-off:** ${sat.map(c=>'**'+c.name.charAt(0).toUpperCase()+c.name.slice(1)+'**').join(' y ')} ${sat.length===1?'está saturado':'están saturados'}`;
   if(sat.some(c=>c.shadow_price>0)){
    const best=sat.reduce((a,b)=>b.shadow_price>a.shadow_price?b:a);
    d+=`. Si pudieras conseguir más **${best.name}**, cada unidad extra genera **$${best.shadow_price}** adicionales.`;
   }else d+=`.`;
  }
  if(slack.length)d+=` ${slack.map(c=>c.name.charAt(0).toUpperCase()+c.name.slice(1)).join(', ')} ${slack.length===1?'tiene':'tienen'} capacidad sobrante.`;
 }else if(mod==='FORECAST'){
  const fc=res.results||{};
  const errs=fc.errors||{};
  const forecast=fc.forecast||[];
  if(forecast.length>0){
   d+=`Pronóstico: **${forecast.map((f,i)=>`P${i+1}=${f}`).join(', ')}** unidades.`;
  }
  d+=`\n\n**¿Por qué este método?** `;
  if(res.method==='ALL'){
   d+=`Se compararon 4 métodos. **${res.best_method}** tiene el menor error promedio (MAD: ${errs.mad}).`;
  }else if(res.method==='REG'){
   const R2=fc.R2||fc.params_used?.R2||0;
   d+=`La regresión lineal captura la tendencia general de los datos. R²=${R2} indica un ${R2>0.8?'buen':R2>0.5?'moderado':'débil'} ajuste.`;
  }else{
   d+=`El error promedio (MAD) es de ±${errs.mad} unidades, equivalente a un MAPE del ${errs.mape}%.`;
  }
  const ts=errs.tracking_signal||0;
  if(Math.abs(ts)>4)d+=`\n\n⚠️ **Atención:** El Tracking Signal (${ts}) está fuera del rango [-4, 4]. Esto indica un posible sesgo sistemático. Considerá otro método o revisá los datos.`;
  else d+=`\n\n**Trade-off:** El Tracking Signal (${ts}) está dentro del rango aceptable [-4, 4], lo que indica que el modelo no tiene sesgo significativo.`;
 }else if(mod==='INVEST'){
  const alts=res.alternatives||[];
  if(alts.length===0){d+='No hay alternativas para evaluar.';return d;}
  if(alts.length===1){
   const a=alts[0];
   if(a.van>0){
    d+=`El proyecto **${a.name}** es viable: VAN positivo de **$${r0(a.van).toLocaleString('es-AR')}** y TIR del **${a.tir}%**.`;
    d+=`\n\n**¿Por qué?** Con una tasa de descuento del ${p.alternatives&&p.alternatives[0]?(p.alternatives[0].discount_rate*100).toFixed(1):'-'}%, el proyecto genera valor. El payback es de **${a.payback_simple.toFixed(1)} años**.`;
   }else{
    d+=`El proyecto **${a.name}** no es viable: VAN negativo de **$${r0(a.van).toLocaleString('es-AR')}**.`;
    d+=`\n\n**¿Por qué?** Los flujos futuros descontados no alcanzan a cubrir la inversión inicial. Reconsiderá los costos o buscá una tasa más baja.`;
   }
  }else{
   const winner=res.comparison&&res.comparison.winner?res.comparison.winner:alts[0].name;
   const best=alts.find(a=>a.name===winner)||alts[0];
   const others=alts.filter(a=>a.name!==winner);
   d+=`Invertí en **${winner}**: VAN de **$${r0(best.van).toLocaleString('es-AR')}** y TIR del **${best.tir}%**.`;
   if(others.length>0){
    d+=`\n\n**Trade-off:** ${others.map(a=>`${a.name} tiene VAN $${r0(a.van).toLocaleString('es-AR')} y TIR ${a.tir}%`).join('; ')}. ${winner} domina en ambos criterios.`;
   }
  }
 }else if(mod==='RENTABILIDAD'){
  const rr=r;
  const prods=rr.products||[];
  const netP=rr.net_profit||0;
  if(netP>=0){
   d+=`Tu negocio genera **$${r0(netP).toLocaleString('es-AR')}** de ganancia neta (${rr.net_margin_pct}% sobre ventas).`;
   if(prods.length>1){
    const best=prods.reduce((a,b)=>b.margin_pct>a.margin_pct?b:a);
    const worst=prods.reduce((a,b)=>b.margin_pct<a.margin_pct?b:a);
    d+=`\n\n**Trade-off:** Tu producto más rentable es **${best.name}** (${best.margin_pct}% margen). `;
    if(worst.margin_pct<15)d+=`**${worst.name}** tiene margen bajo (${worst.margin_pct}%) — evaluá si conviene subirle el precio o reducir el costo.`;
   }
   if(rr.fixed_costs>0&&rr.global_break_even_units<Infinity){
    d+=`\n\nNecesitás vender al menos **${rr.global_break_even_units} unidades** para cubrir costos fijos.`;
   }
  }else{
   d+=`⚠️ Tu operación genera una **pérdida de $${r0(Math.abs(netP)).toLocaleString('es-AR')}**. Revisá precios, costos o volumen de venta.`;
  }
 }else if(mod==='FLUJO_CAJA'){
  const rr=r;
  const tl=rr.timeline||[];
  const fb=rr.final_balance||0;
  const neg=rr.neg_months||0;
  if(neg===0&&fb>rr.opening){
   d+=`Tu caja crece de **$${r0(rr.opening).toLocaleString('es-AR')}** a **$${r0(fb).toLocaleString('es-AR')}** en ${rr.nPeriods} meses. Flujo neto: **$${r0(rr.net_monthly).toLocaleString('es-AR')}/mes**.`;
  }else if(neg===0){
   d+=`Tu caja se mantiene estable. Saldo final: **$${r0(fb).toLocaleString('es-AR')}**. Flujo neto: **$${r0(rr.net_monthly).toLocaleString('es-AR')}/mes**.`;
  }else{
   d+=`⚠️ Tu caja entra en **rojo en el mes ${rr.first_neg_month}**. Saldo mínimo: **$${r0(rr.min_balance).toLocaleString('es-AR')}** (mes ${rr.min_month}). Necesitás financiamiento o reducir egresos.`;
  }
 }
 return d;
}

async function doSolve(){
 // ── Auth gate: must be logged in to solve ──
 const _u=getUser();
 if(!_u||!_u.email){
  showModal('authModal');
  return '🔒 Para resolver problemas necesitás iniciar sesión con Google. Es gratis y toma 2 segundos.';
 }
 // ── Server-backed usage check (async) ──
 const serverCheck=await checkUsageLimitAsync();
 if(!serverCheck.allowed){
  showPaywall(serverCheck.solves_used||getUsage());
  return tMsg('free_limit');
 }
 // ── Sync fallback guard ──
 if(!checkUsageLimit()){
  return tMsg('free_limit');
 }
 const S=session;let res;
 const validation=validateModel(S);
 // ── Block on validation errors (model is unsolvable) ──────────
 if(validation.errors&&validation.errors.length>0){
  let msg='❌ **No puedo resolver este modelo todavía:**\n\n';
  validation.errors.forEach(e=>msg+=`• ${e}\n`);
  msg+='\nCorregí los datos y volvé a intentar.';
  S.stage='collect'; // Go back to data collection
  return msg;
 }
 const warns=validation.warns||[];
 // ── Routing: large LP → server-side OR-Tools ──────────────────
 if(S.module==='LP'&&shouldRouteToServer(S.params)){
  return doSolveServerAsync(S,warns);
 }
 return doSolveLocal(S,warns);
}

function doSolveLocal(S,warns){
 let res;
 const t0=performance.now();
 updPipe(5);
 try{
  if(S.module==='LP'){res=LP.solve(S.params);}
  else if(S.module==='STOCK'){res=STOCK.solve(S.params);}
  else if(S.module==='QUEUE'){res=QUEUE.solve(S.params);}
  else if(S.module==='INVEST'){res=INVEST.solve(S.params);}
  else if(S.module==='FORECAST'){res=FORECAST.solve(S.params);}
  else if(S.module==='RENTABILIDAD'){res=RENTABILIDAD.solve(S.params);}
  else if(S.module==='FLUJO_CAJA'){res=FLUJO_CAJA.solve(S.params);}
  else return '❌ Módulo no soportado.';
 }catch(e){
  logEntry({type:'solve',stageBefore:'confirm',solveStatus:'ERROR',solveTime:Math.round(performance.now()-t0),params:{...S.params}});
  return `❌ Error al resolver: ${e.message}`;
 }
 return finalizeSolve(S,res,warns,performance.now()-t0,'local');
}

async function doSolveServerAsync(S,warns){
 updPipe(5);
 const t0=performance.now();
 const serverRes=await solveServerSide(S.params);
 if(serverRes===null){
  // Server unavailable — fallback to local JS solver
  console.log('[ROUTING] Server unavailable, falling back to local JS solver');
  return doSolveLocal(S,warns);
 }
 return finalizeSolve(S,serverRes,warns,performance.now()-t0,'server');
}

function finalizeSolve(S,res,warns,elapsedMs,engine){
 const solveTime=Math.round(elapsedMs);
 S.solution=res;
 S._originalParams=JSON.parse(JSON.stringify(S.params));
 S._originalSolution=res;
 S._validation_warns=warns;
 updPipe(6);
 const isErr=res.status==='ERROR'||res.status==='INFACTIBLE'||res.status==='NO_ACOTADO'||res.status==='INESTABLE'||res.status==='TIMEOUT';
 const objVal=res.objective_value!==undefined?res.objective_value:(res.economic_analysis&&res.economic_analysis.optimal_M?res.economic_analysis.optimal_M:'');
 logEntry({type:'solve',stageBefore:'confirm',solveStatus:isErr?res.status:'OK',solveTime:solveTime,objectiveValue:objVal,engine:engine,params:{...S.params},response:(isErr?res.status:('Solución: '+S.module)).substring(0,200)});
 if(isErr)
  return `⚠️ **${res.status}**: ${res.message||'Error en resolución.'}`;
 addUsage();
 // Track solve event in Google Sheet
 if(INVOP_CONFIG.WEBHOOK_URL&&!INVOP_CONFIG.WEBHOOK_URL.includes('YOUR_')){
  fetch(INVOP_CONFIG.WEBHOOK_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({event:'solve',module:S.module,status:isErr?res.status:'OK',time_ms:solveTime,email:(getUser()||{}).email||'guest',fingerprint:_getFingerprint(),timestamp:new Date().toISOString()})}).catch(()=>{});
 }
 let sol=fmtSolution(res);
 if(engine==='server')sol+='\n\n_🖥️ Resuelto con OR-Tools (server-side) por dimensión del problema._';
 return sol;
}


// ═══════════════════════════════════════════════════════════
// SCENARIO COMPARISON — Save / Delete / Metrics
// ═══════════════════════════════════════════════════════════

const MODULE_ICONS={LP:'🏭',STOCK:'📦',QUEUE:'🎯',INVEST:'📊',RENTABILIDAD:'💰',FORECAST:'📈'};

function extractScenarioMetrics(mod,sol){
 const d=[];
 if(mod==='STOCK'){
  const r=sol.results||{};
  if(r.qo!==undefined)d.push({label:'Lote óptimo (qo)',value:r0(r.qo)+' un',key:'qo',num:parseFloat(r.qo)});
  if(r.to_days!==undefined)d.push({label:'Intervalo',value:r.to_days+' días',key:'to_days',num:parseFloat(r.to_days)});
  if(r.CTE!==undefined)d.push({label:'Costo total anual',value:'$'+r2(r.CTE).toLocaleString('es-AR'),key:'CTE',num:parseFloat(r.CTE)});
  if(r.SR_reorder_point!==undefined)d.push({label:'Punto de reorden',value:r0(r.SR_reorder_point)+' un',key:'SR',num:parseFloat(r.SR_reorder_point)});
 }else if(mod==='QUEUE'){
  const r=sol.results||{},ec=sol.economic_analysis;
  if(ec&&ec.optimal_M)d.push({label:'Servidores óptimos',value:ec.optimal_M+' serv.',key:'optimal_M',num:ec.optimal_M});
  if(r.Wc_minutes!==undefined)d.push({label:'Espera en cola',value:r.Wc_minutes+' min',key:'Wc',num:parseFloat(r.Wc_minutes)});
  const rho=r.rho_per_server||r.rho||0;
  d.push({label:'Utilización (ρ)',value:r2(rho*100)+'%',key:'rho',num:rho*100});
  if(ec){const opt=ec.comparisons?.find(c=>c.is_optimal);if(opt)d.push({label:'Costo total/h',value:'$'+r0(opt.cost_total_per_hour),key:'CT',num:opt.cost_total_per_hour});}
 }else if(mod==='INVEST'){
  const alts=sol.alternatives||[];
  if(alts.length>0){
   const a=alts[0];
   d.push({label:'VAN ('+a.name+')',value:'$'+a.van.toLocaleString('es-AR'),key:'van',num:a.van});
   d.push({label:'TIR ('+a.name+')',value:a.tir+'%',key:'tir',num:a.tir});
   d.push({label:'Payback',value:a.payback_simple.toFixed(1)+' años',key:'pb',num:a.payback_simple});
  }
  if(sol.comparison&&sol.comparison.winner)d.push({label:'Ganador',value:sol.comparison.winner,key:'winner',num:0});
 }else if(mod==='LP'){
  if(sol.objective_value!==undefined)d.push({label:'Z óptimo',value:'$'+sol.objective_value.toLocaleString('es-AR',{minimumFractionDigits:2}),key:'Z',num:sol.objective_value});
  const vars=sol.variable_values||{};
  Object.entries(vars).forEach(([v,val])=>{
   const name=v.replace('x_','');
   d.push({label:name.charAt(0).toUpperCase()+name.slice(1),value:val+' un',key:v,num:val});
  });
  const bots=(sol.constraint_details||[]).filter(c=>c.binding).map(c=>c.name);
  if(bots.length>0)d.push({label:'Cuellos de botella',value:bots.join(', '),key:'bots',num:bots.length});
 }else if(mod==='FORECAST'){
  const r=sol.results||{},e=r.errors||{};
  if(r.forecast&&r.forecast[0])d.push({label:'Pronóstico',value:r0(r.forecast[0])+' un',key:'forecast',num:r.forecast[0]});
  if(e.mad!==undefined)d.push({label:'MAD',value:''+e.mad,key:'mad',num:e.mad});
  if(e.mape!==undefined)d.push({label:'MAPE',value:e.mape+'%',key:'mape',num:e.mape});
  if(e.tracking_signal!==undefined)d.push({label:'Tracking Signal',value:''+e.tracking_signal,key:'ts',num:e.tracking_signal});
  if(sol.method)d.push({label:'Método',value:sol.model||sol.method,key:'method',num:0});
 }else if(mod==='RENTABILIDAD'){
  const r=sol.results||{};
  if(r.net_profit!==undefined)d.push({label:'Ganancia neta',value:'$'+r0(r.net_profit).toLocaleString('es-AR'),key:'profit',num:r.net_profit});
  if(r.net_margin_pct!==undefined)d.push({label:'Margen neto',value:r.net_margin_pct+'%',key:'margin',num:r.net_margin_pct});
  if(r.total_revenue)d.push({label:'Ingreso total',value:'$'+r0(r.total_revenue).toLocaleString('es-AR'),key:'rev',num:r.total_revenue});
  if(r.global_break_even_units&&r.global_break_even_units<Infinity)d.push({label:'Punto equilibrio',value:r.global_break_even_units+' un',key:'be',num:r.global_break_even_units});
 }else if(mod==='FLUJO_CAJA'){
  const r=sol.results||{};
  if(r.final_balance!==undefined)d.push({label:'Saldo final',value:'$'+r0(r.final_balance).toLocaleString('es-AR'),key:'final_bal',num:r.final_balance});
  if(r.net_monthly!==undefined)d.push({label:'Flujo neto/mes',value:'$'+r0(r.net_monthly).toLocaleString('es-AR'),key:'net_m',num:r.net_monthly});
  if(r.neg_months>0)d.push({label:'Meses en rojo',value:r.neg_months+'',key:'neg',num:r.neg_months});
  d.push({label:'Períodos',value:r.nPeriods+' meses',key:'periods',num:r.nPeriods});
 }
 return{display:d};
}

function extractScenarioParams(mod,params){
 const d=[];
 if(mod==='STOCK'){
  if(params.demand_D)d.push({label:'Demanda (D)',value:r0(params.demand_D).toLocaleString('es-AR')+' un',key:'demand_D',num:params.demand_D});
  if(params.order_cost_k)d.push({label:'Costo pedido (k)',value:'$'+r2(params.order_cost_k),key:'order_cost_k',num:params.order_cost_k});
  if(params.holding_cost_c1)d.push({label:'Costo almac. (c₁)',value:'$'+r2(params.holding_cost_c1),key:'holding_cost_c1',num:params.holding_cost_c1});
  if(params.acquisition_cost_b)d.push({label:'Costo adquisición (b)',value:'$'+r2(params.acquisition_cost_b),key:'acquisition_cost_b',num:params.acquisition_cost_b});
 }else if(mod==='QUEUE'){
  if(params.arrival_rate_lambda)d.push({label:'Tasa llegada (λ)',value:r2(params.arrival_rate_lambda)+'/h',key:'lambda',num:params.arrival_rate_lambda});
  if(params.service_rate_mu)d.push({label:'Tasa servicio (μ)',value:r2(params.service_rate_mu)+'/h',key:'mu',num:params.service_rate_mu});
  if(params.cost_per_wait_ce)d.push({label:'Costo espera (ce)',value:'$'+r0(params.cost_per_wait_ce)+'/h',key:'ce',num:params.cost_per_wait_ce});
  if(params.cost_per_server_cs)d.push({label:'Costo servidor (cs)',value:'$'+r0(params.cost_per_server_cs)+'/h',key:'cs',num:params.cost_per_server_cs});
 }else if(mod==='INVEST'){
  const alts=params.alternatives||[];
  if(alts.length>0){
   const a=alts[0];
   if(a.initial_investment)d.push({label:'Inversión inicial',value:'$'+r0(a.initial_investment).toLocaleString('es-AR'),key:'inv',num:a.initial_investment});
   if(a.annual_revenue)d.push({label:'Ingresos anuales',value:'$'+r0(a.annual_revenue).toLocaleString('es-AR'),key:'rev',num:a.annual_revenue});
   if(a.discount_rate)d.push({label:'Tasa descuento',value:(a.discount_rate*100).toFixed(1)+'%',key:'rate',num:a.discount_rate*100});
  }
 }else if(mod==='LP'){
  (params.constraints||[]).forEach((c,i)=>{
   d.push({label:'RHS: '+c.name,value:c.rhs+' un',key:'rhs_'+i,num:c.rhs});
  });
 }else if(mod==='FORECAST'){
  const methodNames={SMA:'Promedio Móvil Simple',WMA:'Promedio Móvil Ponderado',SES:'Suavización Exponencial',REG:'Regresión Lineal',ALL:'Comparar todos'};
  if(params.method)d.push({label:'Método',value:methodNames[params.method]||params.method,key:'method',num:0});
  if(params.timeseries)d.push({label:'Datos históricos',value:params.timeseries.length+' períodos',key:'data',num:params.timeseries.length});
  if(params.window)d.push({label:'Ventana (n)',value:''+params.window,key:'window',num:params.window});
  if(params.alpha)d.push({label:'Alpha (α)',value:''+params.alpha,key:'alpha',num:params.alpha});
  if(params.weights)d.push({label:'Pesos',value:params.weights.join(', '),key:'weights',num:0});
 }else if(mod==='RENTABILIDAD'){
  const prods=params.products||[];
  prods.forEach(p=>{
   d.push({label:p.name+' (precio)',value:'$'+p.price,key:'price_'+p.name,num:p.price});
   d.push({label:p.name+' (costo)',value:'$'+p.unit_cost,key:'cost_'+p.name,num:p.unit_cost});
  });
  if(params.fixed_costs!==undefined)d.push({label:'Costos fijos',value:'$'+r0(params.fixed_costs).toLocaleString('es-AR'),key:'fixed',num:params.fixed_costs});
 }else if(mod==='FLUJO_CAJA'){
  if(params.opening_balance!==undefined)d.push({label:'Saldo inicial',value:'$'+r0(params.opening_balance).toLocaleString('es-AR'),key:'opening',num:params.opening_balance});
  if(params.periods)d.push({label:'Períodos',value:params.periods+' meses',key:'periods',num:params.periods});
  const inf=params.inflows||[];
  inf.forEach(i=>d.push({label:'Ingreso: '+(i.name||'Ingreso'),value:'$'+r0(+(i.amount||0)).toLocaleString('es-AR')+'/mes',key:'in_'+i.name,num:+(i.amount||0)}));
  const outf=params.outflows||[];
  outf.forEach(o=>d.push({label:'Egreso: '+(o.name||'Egreso'),value:'$'+r0(+(o.amount||0)).toLocaleString('es-AR')+'/mes',key:'out_'+o.name,num:+(o.amount||0)}));
 }
 return d;
}

function saveScenario(){
 const S=session;
 if(!S.solution||S.stage!=='solved'){addMsg('a','⚠️ Resolvé un problema primero.');return;}
 const existing=scenarios.filter(sc=>sc.module===S.module);
 if(existing.length>=MAX_SCENARIOS_PER_MODULE){
  addMsg('a',`⚠️ Máximo ${MAX_SCENARIOS_PER_MODULE} escenarios por módulo. Borrá uno para guardar otro.`);
  return;
 }
 const id='scen_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);
 const num=existing.length+1;
 const time=new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
 const name=S.module+' #'+num+' — '+time;
 const metrics=extractScenarioMetrics(S.module,S.solution);
 const paramsList=extractScenarioParams(S.module,S.params);
 const scenario={id,module:S.module,name,customName:null,timestamp:Date.now(),params:JSON.parse(JSON.stringify(S.params)),solution:JSON.parse(JSON.stringify(S.solution)),metrics,paramsList};
 scenarios.push(scenario);
 saveScenariosToDisk();
 updateScenariosUI();
 addMsg('a','✅ **Escenario guardado:** '+name+'\n\nPodés seguir resolviendo variantes y compararlas desde el panel lateral.');
}

function deleteScenario(id,event){
 if(event)event.stopPropagation();
 scenarios=scenarios.filter(sc=>sc.id!==id);
 saveScenariosToDisk();
 updateScenariosUI();
}

// ── CHART SYSTEM ────────────────────────────
let chartCounter=0;
const chartInstances={};

function getChartId(){return 'invop-chart-'+(++chartCounter);}

function destroyOldCharts(){
 Object.keys(chartInstances).forEach(k=>{
  try{chartInstances[k].destroy();}catch(e){}
  delete chartInstances[k];
 });
}

function renderSolutionCharts(){
 if(typeof Chart==='undefined')return;
 const S=session,res=S.solution,mod=S.module;
 if(!res)return;
 setTimeout(()=>{
  try{
   if(mod==='LP')renderLPChart(res);
   else if(mod==='STOCK')renderStockChart(res,S.params);
   else if(mod==='QUEUE')renderQueueChart(res);
   else if(mod==='INVEST')renderInvestChart(res);
   else if(mod==='FORECAST')renderForecastChart(res,S.params);
   else if(mod==='RENTABILIDAD')renderRentChart(res);
   else if(mod==='FLUJO_CAJA')renderFlujoCajaChart(res);
  }catch(e){console.warn('Chart error:',e);}
  try{initSensSliders();}catch(e){console.error('[SENS] initSensSliders error:',e);}
 },200);
}

function chartDefaults(){
 return{
  color:'#E8E8F0',
  gridColor:'rgba(152,152,176,0.15)',
  fontFamily:'"Inter",system-ui,sans-serif'
 };
}

function renderLPChart(res){
 const el=document.getElementById('chart-lp-main');
 if(!el)return;
 const vars=res.variable_values||{};
 const labels=Object.keys(vars).map(v=>v.replace('x_','').charAt(0).toUpperCase()+v.replace('x_','').slice(1));
 const values=Object.values(vars);
 const cd=chartDefaults();
 const profits=[];
 if(res.objective_coefficients){
  Object.keys(vars).forEach(v=>{
   const coef=res.objective_coefficients[v]||0;
   profits.push(coef*vars[v]);
  });
 }
 const datasets=[{label:'Unidades a producir',data:values,backgroundColor:'rgba(108,60,225,0.7)',borderColor:'#6C3CE1',borderWidth:2,borderRadius:6}];
 if(profits.length&&profits.some(p=>p>0)){
  datasets.push({label:'Ganancia ($)',data:profits,backgroundColor:'rgba(6,214,160,0.7)',borderColor:'#06D6A0',borderWidth:2,borderRadius:6});
 }
 chartInstances['lp-main']=new Chart(el,{
  type:'bar',
  data:{labels,datasets},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:11}}},title:{display:false}},scales:{x:{ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{color:cd.gridColor}},y:{ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{color:cd.gridColor}}}}
 });
}

function renderStockChart(res,params){
 const el=document.getElementById('chart-stock-main');
 if(!el)return;
 const r=res.results||{};
 const qOpt=r.qo||100;
 const D=params.demand_D||15000;
 const k=params.order_cost_k||200;
 const c1=params.holding_cost_c1||3;
 const b=params.acquisition_cost_b||45;
 const cd=chartDefaults();
 const points=[];
 for(let q=Math.max(10,Math.round(qOpt*0.2));q<=qOpt*3;q+=Math.max(1,Math.round(qOpt*0.05))){
  const cPedido=k*(D/q);
  const cAlmac=c1*(q/2);
  const cTotal=b*D+cPedido+cAlmac;
  points.push({q,cPedido,cAlmac,cTotal});
 }
 chartInstances['stock-main']=new Chart(el,{
  type:'line',
  data:{
   labels:points.map(p=>p.q),
   datasets:[
    {label:'Costo Pedido',data:points.map(p=>p.cPedido),borderColor:'#EF476F',backgroundColor:'rgba(239,71,111,0.1)',tension:0.3,pointRadius:0,borderWidth:2},
    {label:'Costo Almac.',data:points.map(p=>p.cAlmac),borderColor:'#FFD166',backgroundColor:'rgba(255,209,102,0.1)',tension:0.3,pointRadius:0,borderWidth:2},
    {label:'Costo Total',data:points.map(p=>p.cTotal),borderColor:'#06D6A0',backgroundColor:'rgba(6,214,160,0.1)',tension:0.3,pointRadius:0,borderWidth:2.5}
   ]
  },
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:11}}},tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': $'+Math.round(ctx.parsed.y).toLocaleString('es-AR');}}}},scales:{x:{title:{display:true,text:'Cantidad por pedido (q)',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily},maxTicksLimit:10},grid:{color:cd.gridColor}},y:{title:{display:true,text:'Costo anual ($)',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily},callback:function(v){return '$'+Math.round(v).toLocaleString('es-AR');}},grid:{color:cd.gridColor}}},annotation:undefined}
 });
}

function renderQueueChart(res){
 const ec=res.economic_analysis;
 if(!ec||!ec.comparisons)return;
 const el=document.getElementById('chart-queue-main');
 if(!el)return;
 const cd=chartDefaults();
 const stable=ec.comparisons.filter(c=>c.status==='ESTABLE');
 if(stable.length<2)return;
 chartInstances['queue-main']=new Chart(el,{
  type:'bar',
  data:{
   labels:stable.map(c=>'M='+c.M),
   datasets:[
    {label:'Costo espera ($/h)',data:stable.map(c=>c.cost_wait_per_hour),backgroundColor:'rgba(239,71,111,0.7)',borderColor:'#EF476F',borderWidth:2,borderRadius:4},
    {label:'Costo servidores ($/h)',data:stable.map(c=>c.cost_servers_per_hour),backgroundColor:'rgba(108,60,225,0.7)',borderColor:'#6C3CE1',borderWidth:2,borderRadius:4},
    {label:'Costo total ($/h)',data:stable.map(c=>c.cost_total_per_hour),type:'line',borderColor:'#06D6A0',backgroundColor:'rgba(6,214,160,0.1)',borderWidth:3,pointBackgroundColor:'#06D6A0',pointRadius:5,tension:0.3}
   ]
  },
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:11}}}},scales:{x:{ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{color:cd.gridColor}},y:{title:{display:true,text:'$/hora',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily},callback:function(v){return '$'+v;}},grid:{color:cd.gridColor}}}}
 });
}

function renderInvestChart(res){
 if(!res.alternatives||res.alternatives.length<1)return;
 const el=document.getElementById('chart-invest-van');
 if(!el)return;
 const cd=chartDefaults();
 const alts=res.alternatives;
 const colors=['rgba(108,60,225,0.8)','rgba(6,214,160,0.8)','rgba(255,209,102,0.8)','rgba(239,71,111,0.8)'];
 const borders=['#6C3CE1','#06D6A0','#FFD166','#EF476F'];
 chartInstances['invest-van']=new Chart(el,{
  type:'bar',
  data:{
   labels:alts.map(a=>a.name||'Alt'),
   datasets:[
    {label:'VAN ($)',data:alts.map(a=>a.van),backgroundColor:alts.map((_,i)=>colors[i%4]),borderColor:alts.map((_,i)=>borders[i%4]),borderWidth:2,borderRadius:6}
   ]
  },
  options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:function(ctx){return 'VAN: $'+Math.round(ctx.parsed.x).toLocaleString('es-AR');}}}},scales:{x:{title:{display:true,text:'VAN ($)',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily},callback:function(v){return '$'+Math.round(v).toLocaleString('es-AR');}},grid:{color:cd.gridColor}},y:{ticks:{color:cd.color,font:{family:cd.fontFamily,size:12,weight:'bold'}},grid:{display:false}}}}
 });
 // TIR chart
 const el2=document.getElementById('chart-invest-tir');
 if(el2){
  chartInstances['invest-tir']=new Chart(el2,{
   type:'bar',
   data:{
    labels:alts.map(a=>a.name||'Alt'),
    datasets:[{label:'TIR (%)',data:alts.map(a=>a.tir),backgroundColor:alts.map((_,i)=>colors[i%4]),borderColor:alts.map((_,i)=>borders[i%4]),borderWidth:2,borderRadius:6}]
   },
   options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:function(ctx){return 'TIR: '+ctx.parsed.x+'%';}}}},scales:{x:{title:{display:true,text:'TIR (%)',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily},callback:function(v){return v+'%';}},grid:{color:cd.gridColor}},y:{ticks:{color:cd.color,font:{family:cd.fontFamily,size:12,weight:'bold'}},grid:{display:false}}}}
  });
 }
}

function renderForecastChart(res,params){
 const el=document.getElementById('chart-forecast-main');
 if(!el)return;
 const cd=chartDefaults();
 const r=res.results||{};
 const data=params.timeseries||[];
 const fitted=r.fitted||[];
 const forecast=r.forecast||[];
 const n=data.length;
 // Labels: 1..n for historical, n+1..n+forecast.length for future
 const labels=[];
 for(let i=1;i<=n;i++)labels.push(''+i);
 for(let i=1;i<=forecast.length;i++)labels.push(''+(n+i));
 // Dataset 1: Historical actuals
 const actualData=[...data,...new Array(forecast.length).fill(null)];
 // Dataset 2: Fitted (on historical periods)
 const fittedData=[...fitted,...new Array(forecast.length).fill(null)];
 // Dataset 3: Forecast future (connect from last actual to future)
 const forecastData=new Array(n).fill(null);
 forecastData[n-1]=data[n-1]; // connect from last actual point
 forecastData.push(...forecast);
 const datasets=[
  {label:'Datos reales',data:actualData,borderColor:'#6C3CE1',backgroundColor:'rgba(108,60,225,0.15)',borderWidth:2.5,pointRadius:4,pointBackgroundColor:'#6C3CE1',tension:0.1,fill:false},
  {label:'Pronóstico ajustado',data:fittedData,borderColor:'#06D6A0',backgroundColor:'rgba(6,214,160,0.1)',borderWidth:2,pointRadius:3,pointBackgroundColor:'#06D6A0',borderDash:[],tension:0.1,fill:false},
  {label:'Pronóstico futuro',data:forecastData,borderColor:'#FFD166',backgroundColor:'rgba(255,209,102,0.1)',borderWidth:2.5,pointRadius:5,pointBackgroundColor:'#FFD166',borderDash:[6,4],tension:0.1,fill:false}
 ];
 chartInstances['forecast-main']=new Chart(el,{
  type:'line',
  data:{labels,datasets},
  options:{
   responsive:true,maintainAspectRatio:false,
   plugins:{
    legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:11}}},
    annotation:forecast.length>0?{annotations:{divider:{type:'line',xMin:n-0.5,xMax:n-0.5,borderColor:'rgba(152,152,176,0.4)',borderWidth:1,borderDash:[4,4],label:{display:true,content:'Futuro →',position:'start',color:cd.color,font:{size:10}}}}}:undefined
   },
   scales:{
    x:{title:{display:true,text:'Período',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{color:cd.gridColor}},
    y:{title:{display:true,text:'Demanda',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{color:cd.gridColor}}
   }
  }
 });
}

function renderRentChart(res){
 const el=document.getElementById('chart-rent-main');
 if(!el)return;
 const cd=chartDefaults();
 const prods=(res.results||{}).products||[];
 if(prods.length===0)return;
 const labels=prods.map(p=>p.name);
 chartInstances['rent-main']=new Chart(el,{
  type:'bar',
  data:{
   labels,
   datasets:[
    {label:'Ingreso',data:prods.map(p=>p.revenue),backgroundColor:'rgba(108,60,225,0.7)',borderColor:'#6C3CE1',borderWidth:2,borderRadius:4},
    {label:'Costo variable',data:prods.map(p=>p.variable_cost),backgroundColor:'rgba(239,71,111,0.7)',borderColor:'#EF476F',borderWidth:2,borderRadius:4},
    {label:'Contribución',data:prods.map(p=>p.contribution),backgroundColor:'rgba(6,214,160,0.7)',borderColor:'#06D6A0',borderWidth:2,borderRadius:4}
   ]
  },
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:11}}},tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': $'+Math.round(ctx.parsed.y).toLocaleString('es-AR');}}}},scales:{x:{ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{color:cd.gridColor}},y:{title:{display:true,text:'$ Total',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily},callback:function(v){return '$'+Math.round(v).toLocaleString('es-AR');}},grid:{color:cd.gridColor}}}}
 });
}

function renderFlujoCajaChart(res){
 const el=document.getElementById('chart-fc-main');
 if(!el)return;
 const cd=chartDefaults();
 const tl=(res.results||{}).timeline||[];
 if(tl.length===0)return;
 const labels=tl.map(r=>'Mes '+r.month);
 const balances=tl.map(r=>r.closing);
 const colors=balances.map(v=>v>=0?'rgba(6,214,160,0.7)':'rgba(239,71,111,0.7)');
 const borderColors=balances.map(v=>v>=0?'#06D6A0':'#EF476F');
 chartInstances['fc-main']=new Chart(el,{
  type:'line',
  data:{
   labels,
   datasets:[
    {label:'Saldo de caja',data:balances,borderColor:'#6C3CE1',backgroundColor:'rgba(108,60,225,0.15)',borderWidth:3,pointBackgroundColor:borderColors,pointBorderColor:borderColors,pointRadius:5,fill:false,tension:0.2},
    {label:'Línea $0',data:Array(tl.length).fill(0),borderColor:'rgba(239,71,111,0.5)',borderWidth:2,borderDash:[8,4],pointRadius:0,fill:false}
   ]
  },
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:11}}},tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': $'+Math.round(ctx.parsed.y).toLocaleString('es-AR');}}}},scales:{x:{ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{color:cd.gridColor}},y:{title:{display:true,text:'$ Saldo',color:cd.color,font:{family:cd.fontFamily,size:11}},ticks:{color:cd.color,font:{family:cd.fontFamily},callback:function(v){return '$'+Math.round(v).toLocaleString('es-AR');}},grid:{color:cd.gridColor}}}}
 });
}

// ═══════════════════════════════════════════════════════════
// SENSITIVITY SLIDERS — Interactive What-If Analysis
// ═══════════════════════════════════════════════════════════

const SENS_DEFS={
 STOCK:[
  {key:'demand_D',label:'Demanda anual (D)',unit:'un',pct:50},
  {key:'order_cost_k',label:'Costo pedido (k)',unit:'$',pct:50},
  {key:'holding_cost_c1',label:'Costo almacenamiento (c₁)',unit:'$/un/año',pct:50}
 ],
 QUEUE:[
  {key:'arrival_rate_lambda',label:'Tasa llegada (λ)',unit:'/hora',pct:50},
  {key:'service_rate_mu',label:'Tasa servicio (μ)',unit:'/hora',pct:50},
  {key:'cost_per_wait_ce',label:'Costo espera (ce)',unit:'$/h',pct:80},
  {key:'cost_per_server_cs',label:'Costo servidor (cs)',unit:'$/h',pct:80}
 ],
 INVEST:[
  {key:'annual_revenue',label:'Ingresos anuales',unit:'$',pct:30,altKey:true},
  {key:'variable_costs',label:'Costos variables',unit:'$',pct:30,altKey:true},
  {key:'discount_rate',label:'Tasa descuento',unit:'%',abs:0.05,step:0.005,fmt:v=>(v*100).toFixed(1)+'%',altKey:true},
 ],
 LP:[], // LP sliders are dynamic (per constraint RHS)
 FORECAST:[
  {key:'window',label:'Períodos promedio móvil (n)',unit:'',abs:4,step:1,fmt:v=>Math.round(v)+' períodos'},
  {key:'alpha',label:'Alpha (α) suavización',unit:'',abs:0.15,step:0.05,fmt:v=>v.toFixed(2)}
 ],
 RENTABILIDAD:[],
 FLUJO_CAJA:[]
};

function sensGetMetrics(mod,res){
 if(mod==='STOCK'){const r=res.results||{};return[{k:'qo',l:'Lote óptimo',v:r0(r.qo),u:'un'},{k:'CTE',l:'Costo total',v:'$'+r2(r.CTE).toLocaleString('es-AR'),u:''},{k:'to',l:'Intervalo',v:r1(r.to_days)+' días',u:''}];}
 if(mod==='QUEUE'){const r=res.results||{},ec=res.economic_analysis;const opt=ec?ec.comparisons?.find(c=>c.is_optimal):null;return[{k:'M',l:'M óptimo',v:ec?.optimal_M||r.M_servers||'—',u:'serv.'},{k:'Wc',l:'Espera cola',v:r.Wc_minutes+' min',u:''},{k:'CT',l:'Costo total/h',v:opt?'$'+r0(opt.cost_total_per_hour):'—',u:''}];}
 if(mod==='INVEST'){const alts=res.alternatives||[];if(alts.length===0)return[];const a=alts[0];return[{k:'van',l:'VAN',v:'$'+a.van.toLocaleString('es-AR'),u:''},{k:'tir',l:'TIR',v:a.tir+'%',u:''},{k:'pb',l:'Payback',v:a.payback_simple.toFixed(1)+' años',u:''}];}
 if(mod==='LP'){return[{k:'Z',l:'Z óptimo',v:'$'+res.objective_value.toLocaleString('es-AR',{minimumFractionDigits:2}),u:''}];}
 if(mod==='FORECAST'){const r=res.results||{},e=r.errors||{};if(res.method==='ALL'&&r.all_methods){const sma=r.all_methods.find(m=>m.method==='SMA'),ses=r.all_methods.find(m=>m.method==='SES'),reg=r.all_methods.find(m=>m.method==='REG');return[{k:'f_sma',l:'SMA',v:sma?sma.result.results.forecast[0]:'—',u:''},{k:'f_ses',l:'SES',v:ses?ses.result.results.forecast[0]:'—',u:''},{k:'f_reg',l:'Regresión',v:reg?reg.result.results.forecast[0]:'—',u:''},{k:'best',l:'Mejor',v:res.best_method||'—',u:''}];}return[{k:'forecast',l:'Pronóstico',v:r.forecast?r.forecast[0]:'—',u:'un'},{k:'MAD',l:'MAD',v:e.mad||'—',u:''},{k:'MAPE',l:'MAPE',v:(e.mape||'—')+'%',u:''}];}
 if(mod==='RENTABILIDAD'){const r=res.results||{};return[{k:'profit',l:'Ganancia neta',v:'$'+r0(r.net_profit||0).toLocaleString('es-AR'),u:''},{k:'margin',l:'Margen neto',v:(r.net_margin_pct||0)+'%',u:''},{k:'be',l:'Equilibrio',v:(r.global_break_even_units||'—')+' un',u:''}];}
 return[];
}

function buildSensSliders(mod,params,res){
 let defs=[...SENS_DEFS[mod]||[]];
 // LP: build dynamic sliders for each constraint RHS
 if(mod==='LP'&&res.constraint_details){
  defs=res.constraint_details.map((cd,i)=>({key:'_rhs_'+i,label:cd.name,unit:'un',pct:50,rhsIdx:i,baseVal:cd.rhs}));
 }
 // QUEUE: only show cost sliders if economic analysis exists
 if(mod==='QUEUE'){defs=defs.filter(d=>{
  if(d.key==='cost_per_wait_ce'||d.key==='cost_per_server_cs')return params[d.key]!=null&&params[d.key]>0;
  return params[d.key]!=null;
 });}
 // Filter out params that don't exist or are 0
 defs=defs.filter(d=>{
  if(d.rhsIdx!==undefined)return true;
  if(d.altKey){const alts=params.alternatives;return alts&&alts.length>0&&alts[0][d.key]!=null;}
  return params[d.key]!=null&&params[d.key]>0;
 });
 if(defs.length===0)return '';
 // Build metrics display
 const metrics=sensGetMetrics(mod,res);
 let mhtml='<div class="sens-metrics" id="sensMetrics">';
 metrics.forEach(m=>{mhtml+=`<div class="sens-metric"><div class="sens-metric-label">${m.l}</div><div class="sens-metric-val" id="sensM-${m.k}">${m.v}<span class="sens-delta zero" id="sensD-${m.k}">base</span></div></div>`;});
 mhtml+='</div>';
 // Build slider rows
 let shtml='';
 defs.forEach(d=>{
  let baseVal;
  if(d.rhsIdx!==undefined)baseVal=d.baseVal;
  else if(d.altKey)baseVal=params.alternatives[0][d.key]||0;
  else baseVal=params[d.key];
  let min,max,step,dispVal;
  if(d.abs!==undefined){min=Math.max(0.001,baseVal-d.abs);max=baseVal+d.abs;step=d.step||0.001;dispVal=d.fmt?d.fmt(baseVal):r2(baseVal);}
  else{min=Math.max(0.01,baseVal*(1-d.pct/100));max=baseVal*(1+d.pct/100);step=Math.max(0.01,baseVal*0.02);dispVal=d.unit==='$'?'$'+r0(baseVal).toLocaleString('es-AR'):r2(baseVal);}
  shtml+=`<div class="sens-row"><div class="sens-label"><span class="sens-param-name">${d.label}</span><span class="sens-value" id="sensV-${d.key}">${dispVal} ${d.unit||''}</span></div>`;
  shtml+=`<input type="range" class="sens-slider" id="sensS-${d.key}" data-key="${d.key}" data-base="${baseVal}" min="${min}" max="${max}" step="${step}" value="${baseVal}"></div>`;
 });
 return `<div class="sens-panel"><button class="sens-toggle" onclick="toggleSensPanel(this)"><span>🎚️ Explorá qué pasa si...</span><span class="sens-toggle-icon">▼</span></button><div class="sens-body" id="sensBody">${mhtml}${shtml}<button class="sens-reset" onclick="resetSensSliders()">↺ Volver a valores originales</button></div></div>`;
}

function toggleSensPanel(btn){
 const body=document.getElementById('sensBody');
 const icon=btn.querySelector('.sens-toggle-icon');
 if(!body)return;
 body.classList.toggle('open');
 if(icon)icon.classList.toggle('open');
}

function initSensSliders(){
 const sliders=document.querySelectorAll('.sens-slider');
 console.log('[SENS] initSensSliders found',sliders.length,'sliders');
 sliders.forEach(sl=>{
  if(sl._sensInit)return; // avoid duplicate listeners
  sl._sensInit=true;
  sl.addEventListener('input',function(){
   try{onSensChange(this.dataset.key,parseFloat(this.value),parseFloat(this.dataset.base));}
   catch(e){console.error('[SENS] onSensChange error:',e);}
  });
 });
}

function onSensChange(key,val,baseVal){
 const S=session,mod=S.module;
 console.log('[SENS] onSensChange:',key,val,'base:',baseVal,'mod:',mod);
 if(!S._originalParams){console.warn('[SENS] No _originalParams');return;}
 // Build temp params
 let tmpP=JSON.parse(JSON.stringify(S._originalParams));
 if(mod==='LP'&&key.startsWith('_rhs_')){
  const idx=parseInt(key.replace('_rhs_',''));
  if(tmpP.constraints&&tmpP.constraints[idx])tmpP.constraints[idx].rhs=val;
 }else if(mod==='INVEST'&&SENS_DEFS.INVEST.find(d=>d.key===key)){
  if(tmpP.alternatives)tmpP.alternatives.forEach(alt=>{alt[key]=val;});
 }else{
  tmpP[key]=(key==='window'?Math.max(2,Math.round(val)):val);
 }
 // Re-solve
 let newRes;
 try{
  if(mod==='STOCK')newRes=STOCK.solve(tmpP);
  else if(mod==='QUEUE'){
   // For queue, if we have economic analysis, find optimal M
   if(S._originalParams.cost_per_wait_ce&&S._originalParams.cost_per_server_cs){
    const minM=Math.max(1,Math.ceil((tmpP.arrival_rate_lambda||tmpP.arrival_rate_lambda)/(tmpP.service_rate_mu||1)));
    let bestCT=Infinity,bestM=minM;
    for(let m=Math.max(1,minM-1);m<=minM+5;m++){
     tmpP.num_servers_M=m;
     const tr=QUEUE.solve(tmpP);
     if(tr.status==='ÓPTIMO'&&tr.economic_analysis){
      const opt=tr.economic_analysis.comparisons?.find(c=>c.is_optimal);
      if(opt&&opt.cost_total_per_hour<bestCT){bestCT=opt.cost_total_per_hour;bestM=m;newRes=tr;}
     }
    }
    if(!newRes){tmpP.num_servers_M=bestM;newRes=QUEUE.solve(tmpP);}
   }else{newRes=QUEUE.solve(tmpP);}
  }
  else if(mod==='INVEST')newRes=INVEST.solve(tmpP);
  else if(mod==='LP')newRes=LP.solve(tmpP);
  else if(mod==='FORECAST')newRes=FORECAST.solve(tmpP);
 }catch(e){console.error('[SENS] Solver error:',e);return;}
 if(!newRes||newRes.status==='ERROR'||newRes.status==='INFACTIBLE'||newRes.status==='INESTABLE'){console.warn('[SENS] Solver failed:',newRes?.status,newRes?.message);return;}
 console.log('[SENS] Re-solved OK, new result:',mod,newRes.status);
 // Update value display
 const def=mod==='LP'?null:[...SENS_DEFS[mod]||[]].find(d=>d.key===key);
 const vEl=document.getElementById('sensV-'+key);
 if(vEl){
  if(def&&def.fmt)vEl.textContent=def.fmt(val)+' '+(def.unit||'');
  else if(def&&def.unit==='$')vEl.textContent='$'+r0(val).toLocaleString('es-AR')+' '+(def.unit||'');
  else vEl.textContent=r2(val)+' '+(def?.unit||'un');
 }
 // Update metrics
 const origRes=S._originalSolution;
 const newM=sensGetMetrics(mod,newRes);
 const origM=sensGetMetrics(mod,origRes);
 newM.forEach((m,i)=>{
  const mEl=document.getElementById('sensM-'+m.k);
  const dEl=document.getElementById('sensD-'+m.k);
  if(mEl){
   // Extract numeric value for delta
   const nv=parseFloat(m.v.toString().replace(/[^0-9.\-]/g,''));
   const ov=origM[i]?parseFloat(origM[i].v.toString().replace(/[^0-9.\-]/g,'')):NaN;
   mEl.innerHTML=m.v;
   if(dEl&&!isNaN(nv)&&!isNaN(ov)&&ov!==0){
    const pct=((nv-ov)/Math.abs(ov)*100);
    const sign=pct>0?'+':'';
    const cls=Math.abs(pct)<0.5?'zero':pct>0?'pos':'neg';
    dEl.className='sens-delta '+cls;
    dEl.textContent=sign+pct.toFixed(1)+'%';
    mEl.appendChild(dEl);
   }else if(dEl){dEl.className='sens-delta zero';dEl.textContent='base';mEl.appendChild(dEl);}
  }
 });
 // Update chart
 try{sensUpdateChart(mod,newRes,tmpP);}catch(e){}
}

function sensUpdateChart(mod,res,params){
 if(mod==='STOCK'){
  const ch=chartInstances['stock-main'];
  if(!ch)return;
  const qOpt=res.results.qo||100;
  const D=params.demand_D,k=params.order_cost_k,c1=params.holding_cost_c1,b=params.acquisition_cost_b||0;
  const pts=[];
  for(let q=Math.max(10,Math.round(qOpt*0.2));q<=qOpt*3;q+=Math.max(1,Math.round(qOpt*0.05))){
   pts.push({q,cP:k*(D/q),cA:c1*(q/2),cT:b*D+k*(D/q)+c1*(q/2)});
  }
  ch.data.labels=pts.map(p=>p.q);
  ch.data.datasets[0].data=pts.map(p=>p.cP);
  ch.data.datasets[1].data=pts.map(p=>p.cA);
  ch.data.datasets[2].data=pts.map(p=>p.cT);
  ch.update('none');
 }else if(mod==='QUEUE'){
  const ch=chartInstances['queue-main'];
  if(!ch||!res.economic_analysis)return;
  const stable=res.economic_analysis.comparisons.filter(c=>c.status==='ESTABLE');
  ch.data.labels=stable.map(c=>'M='+c.M);
  ch.data.datasets[0].data=stable.map(c=>c.cost_wait_per_hour);
  ch.data.datasets[1].data=stable.map(c=>c.cost_servers_per_hour);
  ch.data.datasets[2].data=stable.map(c=>c.cost_total_per_hour);
  ch.update('none');
 }else if(mod==='INVEST'){
  const ch1=chartInstances['invest-van'],ch2=chartInstances['invest-tir'];
  const alts=res.alternatives||[];
  if(ch1){ch1.data.datasets[0].data=alts.map(a=>a.van);ch1.update('none');}
  if(ch2){ch2.data.datasets[0].data=alts.map(a=>a.tir);ch2.update('none');}
 }else if(mod==='LP'){
  const ch=chartInstances['lp-main'];
  if(!ch)return;
  const vars=res.variable_values||{};
  ch.data.datasets[0].data=Object.values(vars);
  if(ch.data.datasets[1]&&res.objective_coefficients){
   const profits=[];
   Object.keys(vars).forEach(v=>{profits.push((res.objective_coefficients[v]||0)*vars[v]);});
   ch.data.datasets[1].data=profits;
  }
  ch.update('none');
 }
}

function resetSensSliders(){
 const S=session;
 if(!S._originalParams||!S._originalSolution)return;
 document.querySelectorAll('.sens-slider').forEach(sl=>{
  sl.value=sl.dataset.base;
  const key=sl.dataset.key;
  const def=[...SENS_DEFS[S.module]||[]].find(d=>d.key===key);
  const vEl=document.getElementById('sensV-'+key);
  const bv=parseFloat(sl.dataset.base);
  if(vEl){
   if(def&&def.fmt)vEl.textContent=def.fmt(bv)+' '+(def.unit||'');
   else if(def&&def.unit==='$')vEl.textContent='$'+r0(bv).toLocaleString('es-AR')+' '+(def.unit||'');
   else vEl.textContent=r2(bv)+' '+(def?.unit||'un');
  }
 });
 // Reset metrics
 const origM=sensGetMetrics(S.module,S._originalSolution);
 origM.forEach(m=>{
  const mEl=document.getElementById('sensM-'+m.k);
  const dEl=document.getElementById('sensD-'+m.k);
  if(mEl){mEl.innerHTML=m.v;if(dEl){dEl.className='sens-delta zero';dEl.textContent='base';mEl.appendChild(dEl);}}
 });
 // Reset chart
 try{sensUpdateChart(S.module,S._originalSolution,S._originalParams);}catch(e){}
}

function fmtSolution(res){
 const S=session,mod=S.module;
 if(S.params._meta&&S.params._meta.type==='multiperiod'){
  const mp=fmtMultiPeriodSolution(res);
  if(mp)return mp;
 }
 let s=`✅ **Solución encontrada** — ${res.model||res.subtype||mod}\n\n`;
 const dec=res.decision||{};
 if(dec.summary)s+=`**${dec.summary}**\n\n`;
 if(dec.actions)(dec.actions||[]).forEach(a=>s+=`• ${a}\n`);
 const r=res.results||{};
 if(mod==='STOCK'){
  s+='\n**Resultados clave:**\n';
  if(r.qo!==undefined)s+=`• Lote óptimo (qo): **${r0(r.qo)} unidades**\n`;
  if(r.to_days!==undefined)s+=`• Intervalo entre pedidos: **${r.to_days} días**\n`;
  if(r.SR_reorder_point!==undefined)s+=`• Punto de reorden: **${r0(r.SR_reorder_point)} unidades**\n`;
  if(r.CTE!==undefined)s+=`• Costo total anual: **$${r2(r.CTE).toLocaleString('es-AR')}**\n`;
  s+='\n<!--RAW--><div class="chart-container"><div class="chart-title">Curva de costos EOQ</div><canvas id="chart-stock-main" height="250"></canvas></div>';
  s+=buildSensSliders(mod,S.params,res)+'<!--/RAW-->';
 }else if(mod==='QUEUE'){
  const ec=res.economic_analysis;
  if(S.params._find_optimal_M&&ec&&ec.optimal_M){
   s=`✅ **Recomendación: ${ec.optimal_M} servidores** — ${res.model||'M/M/M'}\n\n`;
  }
  s+='\n**Métricas del sistema';
  if(S.params._find_optimal_M&&ec&&ec.optimal_M)s+=` (con M=${ec.optimal_M})`;
  s+=':**\n';
  const rho=r.rho_per_server||r.rho||0;
  s+=`• Utilización (ρ): **${r2(rho*100)}%**\n`;
  if(r.Wc_minutes!==undefined)s+=`• Espera en cola: **${r.Wc_minutes} min**\n`;
  if(r.Lc!==undefined)s+=`• Cola promedio: **${r.Lc}**\n`;
  if(r.L!==undefined)s+=`• En sistema: **${r.L}**\n`;
  if(r.prob_wait!==undefined)s+=`• P(esperar): **${r2(r.prob_wait*100)}%**\n`;
  if(ec&&ec.comparisons){
   s+='\n**Análisis económico (costo/hora):**\n';
   s+='| M | Wc (min) | Costo espera | Costo serv. | **Total** |\n|---|----------|-------------|-------------|----------|\n';
   ec.comparisons.forEach(c=>{
    if(c.status==='ESTABLE'){
     const opt=c.is_optimal?' ← **ÓPTIMO**':'';
     s+=`| ${c.M} | ${c.Wc_minutes} | $${r0(c.cost_wait_per_hour)} | $${r0(c.cost_servers_per_hour)} | **$${r0(c.cost_total_per_hour)}**${opt} |\n`;
    }else s+=`| ${c.M} | — | — | — | INESTABLE |\n`;
   });
   s+='\n<!--RAW--><div class="chart-container"><div class="chart-title">Análisis de costos por cantidad de servidores</div><canvas id="chart-queue-main" height="250"></canvas></div><!--/RAW-->';
  }
  s+='<!--RAW-->'+buildSensSliders(mod,S.params,res)+'<!--/RAW-->';
 }else if(mod==='INVEST'){
  s+='**Análisis de Planificación**\n\n';
  if(res.comparison&&res.comparison.winner){s+=`✅ **GANADOR: ${res.comparison.winner}**\n\n`;}
  if(res.alternatives&&Array.isArray(res.alternatives)){
   s+='**Resultados por Alternativa:**\n\n';
   res.alternatives.forEach(alt=>{
    s+=`**${alt.name||'Sin nombre'}**\n`;
    s+=`| Métrica | Valor |\n`;
    s+=`|---------|-------|\n`;
    s+=`| VAN | $${alt.van.toLocaleString('es-AR')} |\n`;
    s+=`| TIR | ${alt.tir}% |\n`;
    s+=`| Payback | ${alt.payback_simple.toFixed(2)} años |\n`;
    s+=`| Payback Desc. | ${alt.payback_descontado.toFixed(2)} años |\n`;
    s+=`| Índice Rent. | ${alt.profitability_index.toFixed(4)} |\n\n`;
   });
  }
  if(res.comparison&&res.comparison.interpretation){
   s+=`**Análisis:**\n`;
   res.comparison.interpretation.forEach(interp=>{s+=`• ${interp}\n`;});
  }
  if(res.comparison&&res.comparison.recommendation){
   s+=`\n**Recomendación:**\n${res.comparison.recommendation}`;
  }
  s+='\n<!--RAW--><div class="chart-row"><div class="chart-container"><div class="chart-title">Comparación VAN</div><canvas id="chart-invest-van" height="200"></canvas></div><div class="chart-container"><div class="chart-title">Comparación TIR</div><canvas id="chart-invest-tir" height="200"></canvas></div></div>'+buildSensSliders(mod,S.params,res)+'<!--/RAW-->';
 }else if(mod==='LP'){
  s+='\n**Resultado:**\n';
  if(res.objective_value!==undefined)s+=`• Z óptimo: **$${res.objective_value.toLocaleString('es-AR',{minimumFractionDigits:2})}**\n`;
  const pvn=(v)=>{const n=v.replace('x_','');return n.charAt(0).toUpperCase()+n.slice(1);};
  for(const[v,val]of Object.entries(res.variable_values||{}))s+=`• ${pvn(v)} = **${val}**\n`;
  if(res.constraint_details){
   s+='\n**Recursos:**\n';
   s+='| Recurso | Usado | Disponible | Holgura | P. Sombra |\n|---------|-------|------------|---------|----------|\n';
   res.constraint_details.forEach(cd=>{const cn=cd.name.charAt(0).toUpperCase()+cd.name.slice(1);s+=`| ${cn} | ${cd.lhs} | ${cd.rhs} | ${cd.slack} | $${cd.shadow_price} |\n`;});
  }
  s+='\n<!--RAW--><div class="chart-container"><div class="chart-title">Producción óptima por producto</div><canvas id="chart-lp-main" height="250"></canvas></div>'+buildSensSliders(mod,S.params,res)+'<!--/RAW-->';
 }else if(mod==='RENTABILIDAD'){
  const rr=res.results||{};
  const prods=rr.products||[];
  s+='\n**Análisis por producto:**\n\n';
  s+='| Producto | Precio | Costo | Margen | Margen % | Contribución | Eq. (un) |\n|----------|--------|-------|--------|----------|-------------|----------|\n';
  prods.forEach(pr=>{
   s+=`| ${pr.name} | $${pr.price} | $${pr.unit_cost} | $${pr.margin} | ${pr.margin_pct}% | $${r0(pr.contribution).toLocaleString('es-AR')} | ${pr.break_even_units===Infinity?'∞':pr.break_even_units} |\n`;
  });
  s+='\n**Resumen:**\n';
  s+=`• Ingreso total: **$${r0(rr.total_revenue).toLocaleString('es-AR')}**\n`;
  s+=`• Costos variables: **$${r0(rr.total_variable_cost).toLocaleString('es-AR')}**\n`;
  if(rr.fixed_costs>0)s+=`• Costos fijos: **$${r0(rr.fixed_costs).toLocaleString('es-AR')}**\n`;
  s+=`• Costo total: **$${r0(rr.total_cost).toLocaleString('es-AR')}**\n`;
  const profitColor=rr.net_profit>=0?'':'⚠️ ';
  s+=`• ${profitColor}**Ganancia neta: $${r0(rr.net_profit).toLocaleString('es-AR')} (${rr.net_margin_pct}% sobre ventas)**\n`;
  if(rr.fixed_costs>0&&rr.global_break_even_units<Infinity){
   s+=`• Punto de equilibrio global: **${rr.global_break_even_units} unidades**\n`;
  }
  if(prods.length>1){
   s+='\n**Ranking por rentabilidad:**\n';
   (rr.ranking||[]).forEach((pr,i)=>{
    const medal=i===0?'🥇':i===1?'🥈':i===2?'🥉':(i+1)+'.';
    s+=`${medal} **${pr.name}** — ${pr.margin_pct}% margen ($${pr.margin} por unidad)\n`;
   });
  }
  s+='\n<!--RAW--><div class="chart-container"><div class="chart-title">Rentabilidad por producto</div><canvas id="chart-rent-main" height="250"></canvas></div>'+buildSensSliders(mod,S.params,res)+'<!--/RAW-->';
 }else if(mod==='FLUJO_CAJA'){
  const rr=res.results||{};
  const tline=rr.timeline||[];
  s+='\n**Proyección mes a mes:**\n\n';
  s+='| Mes | Saldo inicial | Ingresos | Egresos | Saldo final |\n|-----|---------------|----------|---------|-------------|\n';
  tline.forEach(t=>{
   const icon=t.closing<0?'🔴':'🟢';
   s+=`| ${t.month} | $${r0(t.opening).toLocaleString('es-AR')} | $${r0(t.inflows).toLocaleString('es-AR')} | $${r0(t.outflows).toLocaleString('es-AR')} | ${icon} $${r0(t.closing).toLocaleString('es-AR')} |\n`;
  });
  s+='\n**Resumen:**\n';
  s+=`• Saldo inicial: **$${r0(rr.opening).toLocaleString('es-AR')}**\n`;
  s+=`• Flujo neto mensual: **$${r0(rr.net_monthly).toLocaleString('es-AR')}**\n`;
  s+=`• Total ingresos (${rr.nPeriods} meses): **$${r0(rr.totalInAll).toLocaleString('es-AR')}**\n`;
  s+=`• Total egresos (${rr.nPeriods} meses): **$${r0(rr.totalOutAll).toLocaleString('es-AR')}**\n`;
  const fbIcon=rr.final_balance>=0?'':'⚠️ ';
  s+=`• ${fbIcon}**Saldo final: $${r0(rr.final_balance).toLocaleString('es-AR')}**\n`;
  if(rr.neg_months>0)s+=`• ⚠️ **${rr.neg_months} meses en rojo** (primer mes negativo: ${rr.first_neg_month})\n`;
  if(rr.inflows&&rr.inflows.length>0){
   s+='\n**Detalle ingresos:**\n';
   rr.inflows.forEach(i=>s+=`• ${i.name}: $${r0(+(i.amount||0)).toLocaleString('es-AR')}/mes\n`);
  }
  if(rr.outflows&&rr.outflows.length>0){
   s+='\n**Detalle egresos:**\n';
   rr.outflows.forEach(o=>s+=`• ${o.name}: $${r0(+(o.amount||0)).toLocaleString('es-AR')}/mes\n`);
  }
  s+='\n<!--RAW--><div class="chart-container"><div class="chart-title">Evolución del saldo de caja</div><canvas id="chart-fc-main" height="250"></canvas></div>'+buildSensSliders(mod,S.params,res)+'<!--/RAW-->';
 }else if(mod==='FORECAST'){
  const r=res.results||{};
  const errs=r.errors||{};
  if(res.method==='ALL'&&r.comparison){
   s+='\n**Comparación de métodos:**\n\n';
   s+='| Método | MAD | MSE | MAPE | TS | Pronóstico |\n|--------|-----|-----|------|----|------------|\n';
   r.comparison.forEach(c=>{
    s+=`| ${c.method}${c.is_best?' ← **MEJOR**':''} | ${c.mad} | ${r0(c.mse)} | ${c.mape}% | ${c.tracking_signal} | ${c.forecast_next} |\n`;
   });
  }
  if(r.detail_table&&r.detail_table.length>0){
   s+='\n**Detalle período a período:**\n\n';
   s+='| Per. | Real | Pronóst. | Error | |Error| | RSFE | MAD(t) | TS(t) |\n|------|------|----------|-------|--------|------|--------|-------|\n';
   r.detail_table.forEach(row=>{
    s+=`| ${row.period} | ${row.actual} | ${row.forecast!==null?row.forecast:'—'} | ${row.error!==undefined?r0(row.error):'—'} | ${row.abs_error!==undefined?r0(row.abs_error):'—'} | ${row.rsfe!==undefined?r0(row.rsfe):'—'} | ${row.mad_t!==undefined?row.mad_t:'—'} | ${row.ts_t!==undefined?row.ts_t:'—'} |\n`;
   });
  }
  s+=`\n**Métricas de error:**\n`;
  s+=`• MAD: **${errs.mad}**\n`;
  s+=`• MSE: **${r0(errs.mse)}**\n`;
  s+=`• MAPE: **${errs.mape}%**\n`;
  s+=`• Tracking Signal: **${errs.tracking_signal}**\n`;
  s+='\n<!--RAW--><div class="chart-container"><div class="chart-title">Pronóstico de demanda</div><canvas id="chart-forecast-main" height="280"></canvas></div>'+buildSensSliders(mod,S.params,res)+'<!--/RAW-->';
 }
 const warns=session._validation_warns||[];
 if(warns.length){
  s+='\n**Ajustes aplicados:**\n';
  warns.forEach(w=>s+=`• ⚠️ ${w}\n`);
 }
 if(session.assumptions&&session.assumptions.length){
  s+='\n**Supuestos del modelo:**\n';
  session.assumptions.forEach(a=>s+=`• ${a}\n`);
 }
 try{s+=fmtDecision(res,session);}catch(e){}
 s+='\n\n---\n_Preguntá sobre **sensibilidad**, pedí **explicar el modelo**, o iniciá un **nuevo problema**._';
 return s;
}

function processInvestInput(txt){const S=session;if(!S.params.alternatives)S.params.alternatives=[];if(!S.params.decision_type)S.params.decision_type='mutually_exclusive';const extracted=extractInvest(txt);if(extracted.alternatives&&extracted.alternatives.length>0){S.params.alternatives=[...S.params.alternatives,...extracted.alternatives];}if(extracted.decision_type)S.params.decision_type=extracted.decision_type;if(!S.params.alternatives||S.params.alternatives.length===0){return'Necesito información de **al menos una alternativa de inversión**. Describí:\n- Inversión inicial\n- Ingresos y costos anuales\n- Horizonte (años)\n- Tasa de descuento';}if(S.params.alternatives.length===1&&S.params.decision_type==='mutually_exclusive'){return'Tengo una alternativa. ¿Querés **comparar con otra alternativa**, o **evaluar solo esta**?\n\nSi comparás, describí los datos de la alternativa B.';}S.stage='confirm';updUI();return fmtConfirmInvest();}

function fmtConfirmInvest(){const S=session,p=S.params;let s=`**Voy a resolver evaluación de **${S.params.alternatives.length} alternativa(s)** con:**\n\n`;S.params.alternatives.forEach((alt,idx)=>{s+=`**Alternativa ${idx+1}: ${alt.name||'Sin nombre'}**\n`;s+=`- Inversión: $${(alt.initial_investment||0).toLocaleString('es-AR')}\n`;s+=`- Ingreso anual: $${(alt.annual_revenue||0).toLocaleString('es-AR')}\n`;s+=`- Costos anuales: $${((alt.variable_costs||0)+(alt.fixed_costs||0)).toLocaleString('es-AR')}\n`;s+=`- Vida útil: ${alt.useful_life||5} años\n`;s+=`- Tasa descuento: ${((alt.discount_rate||0.12)*100).toFixed(1)}%\n\n`;});s+=`**Tipo de decisión:** ${S.params.decision_type==='mutually_exclusive'?'Mutuamente excluyentes (elegir UNA)':'Independientes (aceptar todas viables)'}\n\n`;s+=`¿Es correcto? Puedo **resolver** o ajustar algo.`;return s;}

function fmtInvestSolution(res){const S=session;let s=`✅ **Planificación - Análisis de Decisión**\n\n`;s+=`**Tipo:** ${S.params.decision_type==='mutually_exclusive'?'Mutuamente Excluyentes':'Independientes'}\n\n`;if(res.comparison&&res.comparison.winner){s+=`**GANADOR: ${res.comparison.winner}**\n\n`;if(res.comparison.interpretation){res.comparison.interpretation.forEach(interp=>{s+=`• ${interp}\n`;});}s+='\n';}if(res.alternatives&&Array.isArray(res.alternatives)){s+='**Resultados por Alternativa:**\n\n';res.alternatives.forEach(alt=>{s+=`**${alt.name}**\n`;s+=`| Métrica | Valor |\n|---------|-------|\n`;s+=`| VAN (NPV) | $${alt.van.toLocaleString('es-AR')} |\n`;s+=`| TIR (IRR) | ${alt.tir}% |\n`;s+=`| Payback Simple | ${alt.payback_simple.toFixed(2)} años |\n`;s+=`| Payback Descontado | ${alt.payback_descontado.toFixed(2)} años |\n`;s+=`| Índice de Rentabilidad | ${alt.profitability_index.toFixed(4)} |\n\n`;});s+='\n';}if(res.comparison&&res.comparison.recommendation){s+='**Recomendación:**\n';s+=res.comparison.recommendation;}s+='\n\n---\n_Preguntá sobre **sensibilidad**, **explicación de fórmulas**, o iniciá un **nuevo problema**._';return s;}

// ── MODEL EXPORT (LP format + JSON + hash) ─────────────────────
function exportModelLP(spec){
 if(!spec||!spec.objective_coefficients)return null;
 const ot=spec.objective_type||'MIN';
 const oc=spec.objective_coefficients;
 const cs=spec.constraints||[];
 let lp=`\\ invop.ai — LP Export\n\\ Generated: ${new Date().toISOString()}\n\\ Hash: ${computeModelHash(spec)}\n\n`;
 // Objective
 lp+=ot==='MAX'?'Maximize\n':'Minimize\n';
 lp+=' obj: ';
 const terms=[];
 for(const[v,c]of Object.entries(oc)){
  const vn=v.replace('x_','');
  if(c===0)continue;
  if(terms.length===0)terms.push(c===1?vn:c===-1?`- ${vn}`:`${c} ${vn}`);
  else terms.push(c>0?`+ ${c===1?'':c+' '}${vn}`:`- ${Math.abs(c)===1?'':Math.abs(c)+' '}${vn}`);
 }
 lp+=terms.join(' ')+'\n\n';
 // Constraints
 lp+='Subject To\n';
 cs.forEach((c,i)=>{
  const name=c.name?c.name.replace(/[^a-zA-Z0-9_]/g,'_').substring(0,20):`R${i+1}`;
  const cterms=[];
  for(const[v,co]of Object.entries(c.coeffs||{})){
   if(Math.abs(co)<1e-12)continue;
   const vn=v.replace('x_','');
   if(cterms.length===0)cterms.push(co===1?vn:co===-1?`- ${vn}`:`${co} ${vn}`);
   else cterms.push(co>0?`+ ${co===1?'':co+' '}${vn}`:`- ${Math.abs(co)===1?'':Math.abs(co)+' '}${vn}`);
  }
  const sense=c.sense==='<='?'<=':c.sense==='>='?'>=':'=';
  lp+=` ${name}: ${cterms.join(' ')} ${sense} ${c.rhs}\n`;
 });
 // Bounds (all >= 0 by default)
 lp+='\nBounds\n';
 for(const v of Object.keys(oc)){lp+=` ${v.replace('x_','')} >= 0\n`;}
 lp+='\nEnd\n';
 return lp;
}

function computeModelHash(spec){
 // Deterministic JSON → simple hash (FNV-1a 32-bit for browser)
 const obj={ot:spec.objective_type,oc:spec.objective_coefficients,cs:(spec.constraints||[]).map(c=>({n:c.name,c:c.coeffs,s:c.sense,r:c.rhs}))};
 const str=JSON.stringify(obj,(k,v)=>v&&typeof v==='object'&&!Array.isArray(v)?Object.keys(v).sort().reduce((o,kk)=>(o[kk]=v[kk],o),{}):v);
 let h=0x811c9dc5;
 for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,0x01000193);}
 return('00000000'+(h>>>0).toString(16)).slice(-8);
}

function exportModelJSON(spec,result){
 const exported={
  version:'invop-model-v1',
  timestamp:new Date().toISOString(),
  model_hash:computeModelHash(spec),
  model:{
   objective_type:spec.objective_type,
   objective_coefficients:spec.objective_coefficients,
   constraints:(spec.constraints||[]).map(c=>({name:c.name,coefficients:c.coeffs,sense:c.sense,rhs:c.rhs})),
   meta:spec._meta||null
  },
  result:result?{
   status:result.status,
   objective_value:result.objective_value,
   variable_values:result.variable_values,
   iterations:result.iterations,
   solve_time_ms:result.solve_time_ms,
   solver_info:result.solver_info||null
  }:null
 };
 return JSON.stringify(exported,null,2);
}

function exportModelMPS(spec){
 if(!spec||!spec.objective_coefficients)return null;
 const ot=spec.objective_type||'MIN';
 const oc=spec.objective_coefficients;
 const cs=spec.constraints||[];
 const vars=Object.keys(oc).sort();
 const pad=(s,w)=>s+' '.repeat(Math.max(0,w-s.length));
 let mps='NAME          INVOP\n';
 // ROWS section
 mps+='ROWS\n';
 mps+=` N  obj\n`;
 cs.forEach((c,i)=>{
  const name=c.name?c.name.replace(/[^a-zA-Z0-9_]/g,'').substring(0,8):`R${i+1}`;
  const type=c.sense==='<='?'L':c.sense==='>='?'G':'E';
  mps+=` ${type}  ${name}\n`;
 });
 // COLUMNS section
 mps+='COLUMNS\n';
 vars.forEach(v=>{
  const vn=v.replace('x_','').substring(0,8);
  // Objective coefficient
  if(oc[v]!==0){
   mps+=`    ${pad(vn,10)}${pad('obj',10)}${ot==='MAX'?-oc[v]:oc[v]}\n`;
  }
  // Constraint coefficients
  cs.forEach((c,i)=>{
   const co=(c.coeffs||{})[v];
   if(co&&Math.abs(co)>1e-12){
    const cname=c.name?c.name.replace(/[^a-zA-Z0-9_]/g,'').substring(0,8):`R${i+1}`;
    mps+=`    ${pad(vn,10)}${pad(cname,10)}${co}\n`;
   }
  });
 });
 // RHS section
 mps+='RHS\n';
 cs.forEach((c,i)=>{
  const cname=c.name?c.name.replace(/[^a-zA-Z0-9_]/g,'').substring(0,8):`R${i+1}`;
  mps+=`    ${pad('RHS',10)}${pad(cname,10)}${c.rhs}\n`;
 });
 // BOUNDS section (all >= 0 by default in MPS, but explicit is better)
 mps+='BOUNDS\n';
 vars.forEach(v=>{
  const vn=v.replace('x_','').substring(0,8);
  mps+=` LO BND       ${pad(vn,10)}0\n`;
 });
 mps+='ENDATA\n';
 return mps;
}

function fmtExport(){
 const S=session,res=S.solution;
 if(!res||!S.params)return 'No hay modelo resuelto para exportar.';
 const spec=S.params;
 if(S.module!=='LP')return 'Exportar modelo solo está disponible para Producción (PL) por ahora.';
 const lp=exportModelLP(spec);
 const mps=exportModelMPS(spec);
 const json=exportModelJSON(spec,res);
 const hash=computeModelHash(spec);
 let s=`📦 **Exportación del Modelo** (hash: \`${hash}\`)\n\n`;
 s+=`**Formato LP** (CPLEX/Gurobi/CBC):\n\`\`\`\n${lp}\`\`\`\n\n`;
 s+=`**Formato MPS** (estándar industrial):\n\`\`\`\n${mps}\`\`\`\n\n`;
 s+=`**Formato JSON** (reproducibilidad):\n\`\`\`json\n${json}\n\`\`\`\n\n`;
 s+='_Copiá cualquiera de estos bloques. Los 3 formatos son legibles por solvers industriales._';
 return s;
}

function fmtSensitivity(){
 const S=session,res=S.solution;if(!res)return 'No hay solución para analizar.';
 const sens=res.sensitivity;if(!sens)return 'No hay análisis de sensibilidad disponible.';
 let s='📊 **Análisis de Sensibilidad**\n\n';
 if(S.module==='STOCK'){
  const tbl=sens.sensitivity_table;
  if(tbl){
   s+='| α (q/qo) | q | λ | Error ε | CTE var. |\n|----------|---|---|---------|----------|\n';
   tbl.forEach(r=>s+=`| ${r.alpha} | ${r.q} | ${r.lambda} | ${r.epsilon_pct}% | $${r.cte_variable.toLocaleString('es-AR')} |\n`);
  }
  if(sens.interpretation)s+=`\n${sens.interpretation}`;
  if(sens.formula)s+=`\n\n_Fórmula: ${sens.formula}_`;
 }else if(S.module==='QUEUE'){
  const ls=sens.lambda_sensitivity;
  if(ls){
   s+='| Factor λ | λ | ρ | L | Wc (min) | Estado |\n|----------|---|---|---|----------|--------|\n';
   ls.forEach(r=>{
    if(r.status==='ESTABLE')s+=`| ${r.lambda_factor} | ${r.lambda} | ${r.rho} | ${r.L} | ${r.Wc_minutes} | ✅ |\n`;
    else s+=`| ${r.lambda_factor} | ${r.lambda} | ${r.rho} | ∞ | ∞ | ❌ |\n`;
   });
  }
  if(sens.interpretation)s+=`\n${sens.interpretation}`;
 }else if(S.module==='LP'){
  const si=sens.interpretation||[];
  si.forEach(i=>s+=`• ${i}\n`);
  for(const[n,info]of Object.entries(sens.rhs_ranges||{})){
   if(info.binding)s+=`\n**${n}** (saturado): precio sombra = $${info.shadow_price}`;
   else s+=`\n**${n}**: holgura = ${info.slack} unidades`;
  }
 }else if(S.module==='RENTABILIDAD'){
  s+='**¿Qué pasa si cambian los precios?**\n\n';
  if(sens.price_5pct)s+=`• Precios +5%: ganancia → $${r0(sens.price_5pct.net_profit).toLocaleString('es-AR')}\n`;
  if(sens.price_10pct)s+=`• Precios +10%: ganancia → $${r0(sens.price_10pct.net_profit).toLocaleString('es-AR')}\n`;
  s+='\n**¿Qué pasa si suben los costos?**\n\n';
  if(sens.cost_5pct)s+=`• Costos +5%: ganancia → $${r0(sens.cost_5pct.net_profit).toLocaleString('es-AR')}\n`;
  if(sens.cost_10pct)s+=`• Costos +10%: ganancia → $${r0(sens.cost_10pct.net_profit).toLocaleString('es-AR')}\n`;
 }else if(S.module==='FLUJO_CAJA'){
  s+='**¿Qué pasa si bajan los ingresos?**\n\n';
  if(sens.inflows_minus10)s+=`• Ingresos −10%: saldo final → $${r0(sens.inflows_minus10.final_balance).toLocaleString('es-AR')} (${sens.inflows_minus10.negative_months} meses en rojo)\n`;
  if(sens.inflows_minus20)s+=`• Ingresos −20%: saldo final → $${r0(sens.inflows_minus20.final_balance).toLocaleString('es-AR')} (${sens.inflows_minus20.negative_months} meses en rojo)\n`;
  s+='\n**¿Qué pasa si suben los egresos?**\n\n';
  if(sens.outflows_plus10)s+=`• Egresos +10%: saldo final → $${r0(sens.outflows_plus10.final_balance).toLocaleString('es-AR')} (${sens.outflows_plus10.negative_months} meses en rojo)\n`;
  if(sens.outflows_plus20)s+=`• Egresos +20%: saldo final → $${r0(sens.outflows_plus20.final_balance).toLocaleString('es-AR')} (${sens.outflows_plus20.negative_months} meses en rojo)\n`;
 }
 return s;
}

function fmtFormulas(){
 const res=session.solution;if(!res)return 'No hay modelo resuelto.';
 const S=session;
 // Multi-period LP: generate explanation dynamically from _meta
 if(S.module==='LP'&&S.params._meta&&S.params._meta.type==='multiperiod'){
  const m=S.params._meta,pl=m.periodLabel;
  const capPl=pl.charAt(0).toUpperCase()+pl.slice(1);
  let s='📐 **Modelo de Producción-Inventario Multi-período**\n\n';
  s+=`**Fuente:** Formulación LP de planificación de producción (Miranda, IO)\n\n`;
  s+=`**Variables de decisión:**\n`;
  for(let t=1;t<=m.T;t++)s+=`• x_${pl}${t} = unidades a producir en ${pl} ${t}\n`;
  s+=`\n**Función objetivo (minimizar costo total):**\n`;
  s+=`MIN Z = Σ (costo producción + costo almacenamiento acumulado) × x_t\n`;
  s+=`Donde cada coeficiente refleja $${m.prod_cost}/un de producción + $${m.hold_cost}/un/${pl} de almacenamiento ponderado por períodos restantes.\n`;
  if(m.capacity){
   s+=`\n**Restricciones de capacidad:**\n`;
   s+=`• x_${pl}t ≤ ${m.capacity.toLocaleString('es-AR')} para cada ${pl} (capacidad máxima)\n`;
  }
  s+=`\n**Restricciones de balance de inventario:**\n`;
  s+=`• I₀ + Σ(x₁..xₜ) − Σ(d₁..dₜ) ≥ 0 para cada ${pl} (stock no negativo)\n`;
  s+=`• Stock inicial (I₀) = ${m.I0.toLocaleString('es-AR')} un\n`;
  if(m.IF>0)s+=`• Stock final requerido ≥ ${m.IF.toLocaleString('es-AR')} un\n`;
  s+=`\n**Parámetros del modelo:**\n`;
  s+=`• Períodos: ${m.T} ${pl}es\n`;
  s+=`• Costo producción: $${m.prod_cost}/un\n`;
  s+=`• Costo almacenamiento: $${m.hold_cost}/un/${pl}\n`;
  for(let t=1;t<=m.T;t++)s+=`• Demanda ${pl} ${t}: ${(m.demands[t]||0).toLocaleString('es-AR')} un\n`;
  s+=`\n**Método de resolución:** Simplex con variables artificiales (Big-M)\n`;
  return s;
 }
 const f=res.formulas||res.formulas_used;
 // Standard LP without formulas: generate from params
 if(!f&&S.module==='LP'&&S.params.objective_type){
  let s='🏭 **Modelo de Producción (Programación Lineal)**\n\n';
  s+=`**Fuente:** Método Simplex (Miranda, IO)\n\n`;
  s+=`**Función objetivo:**\n`;
  const oc=S.params.objective_coefficients||{};
  s+=`${S.params.objective_type} Z = ${Object.entries(oc).map(([v,c])=>`${c}·${v.replace('x_','')}`).join(' + ')}\n`;
  s+=`\n**Restricciones:**\n`;
  (S.params.constraints||[]).forEach(ct=>{
   const lhs=Object.entries(ct.coeffs).map(([v,c])=>`${c}·${v.replace('x_','')}`).join(' + ');
   s+=`• ${ct.name||''}: ${lhs} ${ct.sense} ${ct.rhs}\n`;
  });
  s+=`\n**Método de resolución:** Simplex con variables artificiales (Big-M)\n`;
  return s;
 }
 // INVEST model explanation with expanded cashflow
 if(S.module==='INVEST'&&res.alternatives){
  let s='📊 **Modelo de Planificación — Evaluación de Proyectos de Inversión**\n\n';
  s+='**Metodología utilizada:**\n\n';
  s+='Se evaluó cada alternativa mediante los siguientes criterios financieros:\n\n';
  s+='**1. VAN (Valor Actual Neto):** Descuenta todos los flujos futuros al presente usando la tasa de descuento. Si VAN > 0, el proyecto genera valor. Para proyectos mutuamente excluyentes, **se elige el de mayor VAN** (criterio principal).\n\n';
  s+='`VAN = Σ FCFₜ / (1 + r)ᵗ − I₀`\n\n';
  s+='**2. TIR (Tasa Interna de Retorno):** Es la tasa que hace VAN = 0. Si TIR > costo del capital, el proyecto es rentable. Calculada por Newton-Raphson.\n\n';
  s+='**3. Payback Simple:** Años para recuperar la inversión sin descontar.\n\n';
  s+='**4. Payback Descontado:** Años para recuperar la inversión con flujos descontados.\n\n';
  s+='**5. Índice de Rentabilidad:** IR = VP(flujos futuros) / Inversión. Si IR > 1, el proyecto genera valor.\n\n';
  s+='---\n\n';
  // Cashflow table for each alternative
  res.alternatives.forEach(alt=>{
   s+=`**Flujo de Caja — ${alt.name}**\n\n`;
   const fcf=alt.annual_fcf_table;
   const r_rate=S.params.alternatives.find(a=>a.name===alt.name);
   const rate=r_rate?r_rate.discount_rate:0.12;
   if(fcf&&fcf.length>0){
    s+='| Año | Flujo (FCF) | Factor | Flujo Descontado | Acumulado |\n';
    s+='|-----|------------|--------|-----------------|----------|\n';
    let cum=0;
    fcf.forEach(row=>{
     const factor=1/Math.pow(1+rate,row.year);
     const discounted=row.fcf*factor;
     cum+=discounted;
     const fmtFcf=row.fcf>=0?'$'+Math.round(row.fcf).toLocaleString('es-AR'):'-$'+Math.abs(Math.round(row.fcf)).toLocaleString('es-AR');
     const fmtDisc=discounted>=0?'$'+Math.round(discounted).toLocaleString('es-AR'):'-$'+Math.abs(Math.round(discounted)).toLocaleString('es-AR');
     const fmtCum=cum>=0?'$'+Math.round(cum).toLocaleString('es-AR'):'-$'+Math.abs(Math.round(cum)).toLocaleString('es-AR');
     s+=`| ${row.year} | ${fmtFcf} | ${factor.toFixed(4)} | ${fmtDisc} | ${fmtCum} |\n`;
    });
    s+='\n';
    s+=`**VAN = ${alt.van>=0?'$'+alt.van.toLocaleString('es-AR'):'-$'+Math.abs(alt.van).toLocaleString('es-AR')}** | **TIR = ${alt.tir}%** | **IR = ${alt.profitability_index.toFixed(3)}**\n\n`;
   }
  });
  // Sensitivity summary
  s+='---\n\n**Análisis de Sensibilidad (resumen):**\n\n';
  res.alternatives.forEach(alt=>{
   if(!alt.sensitivity)return;
   s+=`**${alt.name}:**\n`;
   if(alt.sensitivity.revenue){
    const up=alt.sensitivity.revenue[10];
    const dn=alt.sensitivity.revenue[-10];
    if(up&&dn)s+=`• Ingresos ±10%: VAN va de $${dn.van.toLocaleString('es-AR')} a $${up.van.toLocaleString('es-AR')}\n`;
   }
   if(alt.sensitivity.discount_rate){
    const up=alt.sensitivity.discount_rate[2];
    const dn=alt.sensitivity.discount_rate[-2];
    if(up&&dn)s+=`• Tasa descuento ±2%: VAN va de $${up.van.toLocaleString('es-AR')} a $${dn.van.toLocaleString('es-AR')}\n`;
   }
   s+='\n';
  });
  if(res.comparison&&res.comparison.winner){
   s+=`**Conclusión:** ${res.comparison.winner} es la alternativa recomendada basándose en el criterio de VAN como métrica principal para decisiones mutuamente excluyentes.\n`;
  }
  return s;
 }
 // FORECAST model explanation
 if(S.module==='FORECAST'){
  let s='📈 **Modelo de Pronósticos de Demanda**\n\n';
  s+='**Fuente:** Chase, Aquilano & Jacobs — Administración de Producción y Operaciones\n\n';
  s+='**Métodos disponibles:**\n\n';
  s+='**1. Promedio Móvil Simple (SMA):**\n';
  s+='`F(t+1) = (D(t) + D(t-1) + ... + D(t-n+1)) / n`\n';
  s+='Promedia los últimos n períodos. Simple pero no detecta tendencia.\n\n';
  s+='**2. Promedio Móvil Ponderado (WMA):**\n';
  s+='`F(t+1) = w₁·D(t) + w₂·D(t-1) + ... + wₙ·D(t-n+1)`\n';
  s+='Asigna más peso a los datos recientes. Los pesos deben sumar 1.\n\n';
  s+='**3. Suavización Exponencial Simple (SES):**\n';
  s+='`F(t+1) = α·D(t) + (1-α)·F(t)`\n';
  s+='Alpha (0 < α < 1) controla la reactividad. Mayor α = más peso al último dato.\n\n';
  s+='**4. Regresión Lineal:**\n';
  s+='`ŷ = β₀ + β₁·t`\n';
  s+='Ajusta una recta a los datos. Captura tendencia lineal. R² mide bondad de ajuste.\n\n';
  s+='---\n\n**Métricas de error:**\n\n';
  s+='• **MAD** = Σ|At - Ft| / n — Error absoluto promedio\n';
  s+='• **MSE** = Σ(At - Ft)² / n — Error cuadrático medio\n';
  s+='• **MAPE** = (100/n) × Σ|At - Ft|/At — Error porcentual promedio\n';
  s+='• **Tracking Signal** = RSFE / MAD — Si sale de [-4, 4], hay sesgo\n';
  if(res&&res.results){
   const pu=res.results.params_used||{};
   s+='\n---\n\n**Modelo utilizado:**\n\n';
   s+=`• Método: ${res.model||res.method}\n`;
   if(pu.n)s+=`• Períodos (n): ${pu.n}\n`;
   if(pu.alpha)s+=`• Alpha (α): ${pu.alpha}\n`;
   if(pu.b0!==undefined)s+=`• β₀ (intercepto): ${pu.b0}\n• β₁ (pendiente): ${pu.b1}\n• R²: ${pu.R2}\n`;
   if(pu.weights)s+=`• Pesos: ${pu.weights.join(', ')}\n`;
  }
  return s;
 }
 // RENTABILIDAD model explanation
 if(S.module==='RENTABILIDAD'){
  let s='💰 **Modelo de Análisis de Rentabilidad**\n\n';
  s+='**Fórmulas utilizadas:**\n\n';
  s+='**1. Margen unitario:**\n';
  s+='`Margen = Precio de venta − Costo unitario`\n\n';
  s+='**2. Margen porcentual:**\n';
  s+='`Margen % = (Margen / Precio) × 100`\n\n';
  s+='**3. Contribución marginal:**\n';
  s+='`Contribución = Margen × Cantidad vendida`\n\n';
  s+='**4. Ganancia neta:**\n';
  s+='`Ganancia = Σ Contribuciones − Costos fijos`\n\n';
  s+='**5. Punto de equilibrio:**\n';
  s+='`Punto de equilibrio (unidades) = Costos fijos / Margen unitario`\n\n';
  s+='---\n\n';
  s+='**¿Por qué importa?**\n\n';
  s+='El margen unitario te dice cuánto ganás por cada unidad vendida. El punto de equilibrio te dice cuántas unidades necesitás vender para empezar a ganar plata. ';
  s+='Si vendés más que el punto de equilibrio, todo lo que sigue es ganancia pura.\n\n';
  s+='**Tip:** Un margen alto no siempre es mejor si el volumen es bajo. Mirá la contribución total de cada producto para decidir cuál priorizar.';
  return s;
 }
 // FLUJO_CAJA model explanation
 if(S.module==='FLUJO_CAJA'){
  let s='💵 **Modelo de Proyección de Flujo de Caja**\n\n';
  s+='**Fórmulas utilizadas:**\n\n';
  s+='**1. Flujo neto mensual:**\n';
  s+='`Flujo neto = Σ Ingresos − Σ Egresos`\n\n';
  s+='**2. Saldo final de cada mes:**\n';
  s+='`Saldo final = Saldo inicial + Flujo neto`\n\n';
  s+='**3. Saldo acumulado:**\n';
  s+='`Saldo(mes N) = Saldo inicial + N × Flujo neto`\n\n';
  s+='**4. Mes de quiebre (si aplica):**\n';
  s+='`Mes quiebre = primer mes donde Saldo final < 0`\n\n';
  s+='---\n\n';
  s+='**¿Por qué importa?**\n\n';
  s+='El flujo de caja te dice si vas a tener plata suficiente cada mes para operar. ';
  s+='Una empresa puede ser rentable en papel pero fundirse por falta de liquidez. ';
  s+='Si detectás meses en rojo, necesitás buscar financiamiento antes de que lleguen.\n\n';
  s+='**Tip:** Este modelo asume ingresos y egresos constantes. En la realidad hay estacionalidad — usalo como base y ajustá para meses atípicos.';
  return s;
 }
 if(!f)return 'No hay fórmulas registradas.';
 let s='📐 **Modelo y fórmulas utilizadas**\n\n';
 s+=`**Fuente:** ${f.source||'Miranda, IO'}\n\n`;
 for(const[k,v]of Object.entries(f)){if(k!=='source')s+=`• **${k}** = ${v}\n`;}
 return s;
}

const activityLog=[];
function logEntry(evt){
 const S=session;
 const entry={
  id:activityLog.length+1,
  timestamp:new Date().toISOString(),
  event_type:evt.type||'interaction',
  module:S.module||'',
  stage_before:evt.stageBefore||'',
  stage_after:S.stage||'',
  user_input:evt.input||'',
  detected_params:evt.params?JSON.stringify(evt.params):'',
  response_summary:(evt.response||'').substring(0,200),
  solve_status:evt.solveStatus||'',
  objective_value:evt.objectiveValue||'',
  solve_time_ms:evt.solveTime||'',
  session_id:window._sessionId||''
 };
 activityLog.push(entry);
 const el=document.getElementById('logCount');
 if(el)el.textContent=activityLog.length+' '+(currentLanguage==='en'?(activityLog.length!==1?'entries':'entry'):(activityLog.length!==1?'entradas':'entrada'));
}

window._sessionId='S'+Date.now().toString(36).toUpperCase();

function updPipe(n){
 const steps=['Interpretación','Clasificación','Validación','Problem Spec','Resolución','Sensibilidad'];
 document.querySelectorAll('.sd').forEach((d,i)=>{
  d.classList.remove('on','pn');
  if(i<n)d.classList.add('on');
  else if(i===n)d.classList.add('pn');
 });
}

// ── INVOP CONFIG ──────────────────────────────────────────
const INVOP_CONFIG={
 FREE_LIMIT:3,
 GOOGLE_CLIENT_ID:'759483082155-gf5uqdlf9kee6jo6dts46eu7lesdmcsu.apps.googleusercontent.com',
 STRIPE_LINK:'https://buy.stripe.com/cNi6oG1wa2s70RScvgc7u01',
 WEBHOOK_URL:'https://script.google.com/macros/s/AKfycbz-fOubDIXELbGq5JEJTMNt9iprNuKcw3u4teP1wKZuekzReFq5lXt2nf1qmmSptkUE/exec',
 // Platform API
 API_BASE:'https://www.invop.ai',
 PLANS:{free:{name:'Free',limit:3},starter:{name:'Starter',price:3.99,limit:Infinity},pro:{name:'Pro',price:49.99,limit:Infinity,shopify:true,ai:true}}
};

// ── Device fingerprint (tracking only, no blocking) ──────
function _getFingerprint(){
 let fp=localStorage.getItem('invop_fp');
 if(fp)return fp;
 try{
  const cv=document.createElement('canvas');
  const ctx=cv.getContext('2d');
  ctx.textBaseline='top';ctx.font='14px Arial';ctx.fillText('INVOP-fp',2,2);
  const cvData=cv.toDataURL().slice(-50);
  const parts=[
   screen.width+'x'+screen.height,
   screen.colorDepth,
   Intl.DateTimeFormat().resolvedOptions().timeZone,
   navigator.language,
   navigator.hardwareConcurrency||0,
   cvData
  ].join('|');
  let h=0;for(let i=0;i<parts.length;i++){h=((h<<5)-h)+parts.charCodeAt(i);h|=0;}
  fp='fp_'+Math.abs(h).toString(36)+'_'+Date.now().toString(36);
 }catch(e){
  fp='fp_fallback_'+Date.now().toString(36);
 }
 localStorage.setItem('invop_fp',fp);
 return fp;
}

// ── User persistence ─────────────────────────────────────
function getUser(){try{return JSON.parse(localStorage.getItem('invop_user'));}catch(e){return null;}}
function setUser(u){localStorage.setItem('invop_user',JSON.stringify(u));}
// ── Pro verification with anti-tampering signature ───────
function _proSig(email,since){
 // Simple HMAC-like sig: can't fake pro by just setting pro:true
 const raw=email+'|'+since+'|invop_s3cr3t_2025';
 let h=0;for(let i=0;i<raw.length;i++){h=((h<<5)-h)+raw.charCodeAt(i);h|=0;}
 return 'ps_'+Math.abs(h).toString(36);
}
function isPro(){
 const u=getUser();
 if(!u)return false;
 // New plan field support
 if(u.plan==='pro'||u.plan==='starter')return true;
 // Legacy pro support
 if(!u.pro)return false;
 if(!u.pro_sig||!u.pro_since)return false;
 return u.pro_sig===_proSig(u.email,u.pro_since);
}
function getUserPlan(){
 const u=getUser();
 if(!u)return 'free';
 if(u.plan)return u.plan;
 if(isPro())return 'pro';
 return 'free';
}
function isProPlan(){return getUserPlan()==='pro';}
function isStarterPlan(){return getUserPlan()==='starter';}

// ── Usage tracking (per-email) ───────────────────────────
function getUsage(){
 const u=getUser();if(!u)return parseInt(localStorage.getItem('invop_usage')||'0');
 return parseInt(localStorage.getItem('invop_usage_'+u.email)||'0');
}
function addUsage(){
 if(isAdmin())return;
 const u=getUser();
 if(u){
  const k='invop_usage_'+u.email;
  const n=parseInt(localStorage.getItem(k)||'0')+1;
  localStorage.setItem(k,String(n));
 } else {
  const n=parseInt(localStorage.getItem('invop_usage')||'0')+1;
  localStorage.setItem('invop_usage',n.toString());
 }
}

// ── Admin check: email-based (no localStorage bypass) ────
function isAdmin(){const u=getUser();return u&&u.email==='tmichelich@gmail.com';}

// ── Usage limit check (sync fallback) ────────────────────
function checkUsageLimit(){
 if(isAdmin())return true;
 if(isPro())return true;
 const used=getUsage();
 if(used>=INVOP_CONFIG.FREE_LIMIT){
  showPaywall(used);
  return false;
 }
 return true;
}

// ── Server-backed usage check (async, with cache) ────────
let _serverUsageCache={ts:0,data:null};
async function checkUsageLimitAsync(){
 if(isAdmin())return{allowed:true,remaining:999,is_pro:false};
 const u=getUser();
 if(!u||!u.email)return{allowed:false,remaining:0};

 // Cache: 5 min
 const now=Date.now();
 if(_serverUsageCache.data&&(now-_serverUsageCache.ts)<300000){
  return _serverUsageCache.data;
 }

 try{
  const url=INVOP_CONFIG.WEBHOOK_URL+'?action=check_usage&email='+encodeURIComponent(u.email)+'&fp='+encodeURIComponent(_getFingerprint());
  const resp=await fetch(url,{method:'GET'});
  const data=await resp.json();
  _serverUsageCache={ts:now,data:data};

  // Sync server Pro status with local
  if(data.is_pro&&!isPro()&&data.pro_since){
   u.pro=true;u.pro_since=data.pro_since;
   u.pro_sig=_proSig(u.email,u.pro_since);
   setUser(u);
  }

  return data;
 }catch(e){
  // Server offline → fallback to localStorage
  console.warn('INVOP: server check failed, using local',e);
  const used=getUsage();
  return{allowed:isPro()||used<INVOP_CONFIG.FREE_LIMIT,remaining:Math.max(0,INVOP_CONFIG.FREE_LIMIT-used),is_pro:isPro(),solves_used:used,fallback:true};
 }
}

// ── Server-backed Pro check (async, 30 min cache) ────────
let _serverProCache={ts:0,data:null};
async function isProAsync(){
 if(isAdmin())return true;
 if(isPro())return true;// local sig valid

 const u=getUser();
 if(!u||!u.email)return false;

 const now=Date.now();
 if(_serverProCache.data!==null&&(now-_serverProCache.ts)<1800000){
  return _serverProCache.data;
 }

 try{
  const url=INVOP_CONFIG.WEBHOOK_URL+'?action=verify_pro&email='+encodeURIComponent(u.email);
  const resp=await fetch(url,{method:'GET'});
  const data=await resp.json();
  _serverProCache={ts:now,data:data.is_pro};
  if(data.is_pro&&!isPro()&&data.pro_since){
   u.pro=true;u.pro_since=data.pro_since;
   u.pro_sig=_proSig(u.email,u.pro_since);
   setUser(u);
  }
  return data.is_pro;
 }catch(e){
  return isPro();// fallback
 }
}

function showPaywall(used){
 const el=document.getElementById('pwUsage');
 if(el)el.textContent=used;
 showModal('paywallModal');
}

// ── Modal utils ──────────────────────────────────────────
function showModal(id){
 const el=document.getElementById(id);
 if(el){
  el.style.display='flex';
  void el.offsetHeight; // force reflow
  el.classList.add('show');
 }
 if(id==='authModal')setTimeout(initGoogleSignIn,100);
}
function closeModal(id){
 const el=document.getElementById(id);
 if(el){
  el.classList.remove('show');
  setTimeout(()=>{el.style.display='none';},300);
 }
}

// ── Stripe upgrade (3-tier) ──────────────────────────────
function handleUpgrade(plan){
 plan=plan||'starter';
 const u=getUser();
 if(!u||!u.email){
  closeModal('paywallModal');
  showModal('authModal');
  window._pendingUpgrade=plan;
  return;
 }
 // Try new Checkout API first, fallback to legacy link
 if(INVOP_CONFIG.API_BASE){
  fetch(INVOP_CONFIG.API_BASE+'/api/stripe/checkout',{
   method:'POST',
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({plan:plan,email:u.email})
  })
  .then(r=>r.json())
  .then(d=>{if(d.url)window.open(d.url,'_blank');else throw new Error(d.error);})
  .catch(()=>{_legacyUpgrade(u);});
 } else {
  _legacyUpgrade(u);
 }
}
function _legacyUpgrade(u){
 let url=INVOP_CONFIG.STRIPE_LINK;
 url+='?prefilled_email='+encodeURIComponent(u.email)+'&client_reference_id='+encodeURIComponent(u.email);
 window.open(url,'_blank');
}

function showUsageInfo(){
 const u=getUser();
 const used=getUsage();
 const plan=getUserPlan();
 const planNames={free:'Gratis',starter:'Starter ($3.99/mes)',pro:'Pro ($49.99/mes)'};
 if(u){
  const lim=plan==='free'?'/'+INVOP_CONFIG.FREE_LIMIT:'';
  const msg=`${u.name}\n${u.email}\n\nPlan: ${planNames[plan]||plan}\nProblemas resueltos: ${used}${lim}`;
  alert(msg);
 } else {
  showPaywall(used);
 }
}

// ── Google Auth ──────────────────────────────────────────
let gisInitialized=false;
function initGoogleSignIn(){
 const btnContainer=document.getElementById('googleSignInBtn');
 if(!btnContainer)return;
 if(typeof google==='undefined'||!google.accounts){
  // In-app browser — show copy link
  const isIOS=/iPhone|iPad/i.test(navigator.userAgent||'');
  const browserName=isIOS?'Safari':'Chrome';
  const currentUrl=window.location.href;
  btnContainer.innerHTML=`<div style="text-align:center;padding:.5rem 0">
   <p style="font-size:.85rem;color:#9898B0;line-height:1.6;margin-bottom:1rem">
    Este navegador no soporta Google Sign-In.<br>Abr\u00ed en <strong style="color:#06D6A0">${browserName}</strong> para continuar.
   </p>
   <button onclick="navigator.clipboard.writeText('${currentUrl}').then(()=>{this.textContent='\u2713 Link copiado!'})" style="width:100%;padding:.9rem;background:rgba(108,60,225,.1);border:1px solid rgba(108,60,225,.3);border-radius:12px;font-size:.9rem;font-weight:600;color:#8B5CF6;cursor:pointer">
    Copiar link para abrir en ${browserName}
   </button></div>`;
  return;
 }
 if(!gisInitialized){
  google.accounts.id.initialize({client_id:INVOP_CONFIG.GOOGLE_CLIENT_ID,callback:handleGoogleResponse,auto_select:false});
  gisInitialized=true;
 }
 btnContainer.innerHTML='';
 google.accounts.id.renderButton(btnContainer,{type:'standard',theme:'outline',size:'large',text:'continue_with',width:320,logo_alignment:'center'});
}

function handleGoogleResponse(response){
 const payload=parseJwt(response.credential);
 if(payload){
  window._googleCredentialRaw=response.credential;
  onAuthSuccess({name:payload.name||payload.given_name||'Usuario',email:payload.email,picture:payload.picture||''});
 }
}

function parseJwt(token){
 try{const base64=token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(atob(base64));}catch(e){return null;}
}

function onAuthSuccess(user){
 setUser(user);
 updateUserUI(user);
 closeModal('authModal');
 registerUser(user);
 // Also register with new platform API if available
 if(INVOP_CONFIG.API_BASE){
  fetch(INVOP_CONFIG.API_BASE+'/api/auth/google',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({credential:window._googleCredentialRaw||'',name:user.name,email:user.email,picture:user.picture||'',fingerprint:_getFingerprint()})}).catch(()=>{});
 }
 // If user was trying to upgrade before logging in, open Stripe now
 if(window._pendingUpgrade){
  const plan=window._pendingUpgrade;
  window._pendingUpgrade=false;
  setTimeout(()=>handleUpgrade(typeof plan==='string'?plan:'starter'),300);
  return;
 }
 enterApp();
}

function registerUser(user){
 if(INVOP_CONFIG.WEBHOOK_URL.includes('YOUR_'))return;
 const payload={name:user.name,email:user.email,picture:user.picture||'',timestamp:new Date().toISOString(),source:'invop.ai',event:'user_register',fingerprint:_getFingerprint()};
 fetch(INVOP_CONFIG.WEBHOOK_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)}).catch(()=>{});
}

function updateUserUI(user){
 const pill=document.getElementById('userPill');
 const avatar=document.getElementById('userAvatar');
 const name=document.getElementById('userName');
 if(pill&&user){
  pill.classList.add('logged');
  const displayName=user.name.split(' ')[0];
  if(name)name.textContent=user.pro?displayName+' \u2728':displayName;
  if(avatar&&user.picture){avatar.src=user.picture;avatar.style.display='block';}
  else if(avatar){avatar.style.display='none';}
 }
}

// ── Stripe return handler + session restore ──────────────
(function(){
 const u=getUser();
 const params=new URLSearchParams(window.location.search);
 if(params.get('payment_success')==='true'&&u){
  const plan=params.get('plan')||'starter';
  u.pro=true;
  u.plan=plan;
  u.pro_since=new Date().toISOString();
  u.pro_sig=_proSig(u.email,u.pro_since);
  setUser(u);
  window.history.replaceState({},'',window.location.pathname);
  if(INVOP_CONFIG.WEBHOOK_URL){
   fetch(INVOP_CONFIG.WEBHOOK_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({event:'upgrade_'+plan,email:u.email,name:u.name,fingerprint:_getFingerprint(),timestamp:u.pro_since})}).catch(()=>{});
  }
  const msgs={starter:'Bienvenido a INVOP AI Starter! Resolvé problemas ilimitados.',pro:'Bienvenido a INVOP AI Pro! Shopify + AI + reportes automáticos activados.'};
  setTimeout(()=>{alert(msgs[plan]||msgs.starter);},500);
 }
 if(params.get('payment_cancelled')==='true'){
  window.history.replaceState({},'',window.location.pathname);
 }
 if(u){updateUserUI(u);updatePlanUI();}
})();

// ── Navigation ───────────────────────────────────────────
function handleStart(){
 const u=getUser();
 if(!u){showModal('authModal');}
 else{enterApp();}
}
function enterApp(){document.body.classList.remove("landing-mode");document.body.classList.add("app-mode");document.getElementById("appWrap").style.opacity="1";closeModal("authModal");initScenarios()}
function enterAppGuest(){
 // Guest can view the app but NOT solve — auth required for that
 enterApp();
 window._guestMode=true;
}
function switchLanguage(lang){currentLanguage=lang;localStorage.setItem("invop_lang",lang);updUI()}
function hKey(event){if(event.key==="Enter"&&!event.shiftKey){event.preventDefault();send()}}
function aRsz(ta){ta.style.height="auto";ta.style.height=Math.min(ta.scrollHeight,150)+"px"}

// send() is overridden in Bloque C with typing indicator + stepper support
function send(){}

function mdToHtml(md){
  if(!md)return '';
  let h=md;
  // Protect raw HTML blocks from markdown regex mangling
  // Extracts content between <!--RAW--> markers and <div class="chart/sens"> blocks
  const rawBlocks=[];
  h=h.replace(/<!--RAW-->([\s\S]*?)<!--\/RAW-->/g,function(m,content){
    const idx=rawBlocks.length;
    rawBlocks.push(content);
    return '\x00RAW'+idx+'\x00';
  });
  // Fallback: protect any remaining chart/sens HTML not wrapped in RAW markers
  h=h.replace(/<div class="(?:chart-container|chart-row|sens-panel)"[^]*$/g,function(match){
    const idx=rawBlocks.length;
    rawBlocks.push(match);
    return '\x00RAW'+idx+'\x00';
  });
  h=h.replace(/\|(.+)\|\n\|[-| ]+\|\n([\s\S]*?)(?=\n\n|\n$|$)/g,function(m,hdr,body){
    const ths=hdr.split('|').filter(s=>s.trim()).map(s=>'<th>'+s.trim()+'</th>').join('');
    const rows=body.trim().split('\n').map(r=>'<tr>'+r.split('|').filter(s=>s.trim()).map(s=>'<td>'+s.trim()+'</td>').join('')+'</tr>').join('');
    return '<table><thead><tr>'+ths+'</tr></thead><tbody>'+rows+'</tbody></table>';
  });
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/_(.+?)_/g,'<em>$1</em>');
  h=h.replace(/^• (.+)$/gm,'<li>$1</li>');
  h=h.replace(/^- (.+)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>[\s\S]+?<\/li>)/g,'<ul>$1</ul>');
  h=h.replace(/<\/ul>\s*<ul>/g,'');
  h=h.replace(/\n---\n/g,'<hr>');
  h=h.replace(/\n\n/g,'<br><br>');
  h=h.replace(/\n/g,'<br>');
  // Restore protected raw HTML blocks
  h=h.replace(/\x00RAW(\d+)\x00/g,function(m,idx){return rawBlocks[parseInt(idx)];});
  return h;
}

function addMsg(type,html){const msgs=document.getElementById("msgs");const msg=document.createElement("div");msg.className=type==="u"?"msg u":"msg a";if(type==="u"){msg.innerHTML=`<div class="bubble">${escapeHtml(html)}</div>`}else{msg.innerHTML=`<div class="mlbl">INVOP AI</div><div class="bubble">${html}</div>`}msgs.appendChild(msg);msgs.scrollTop=msgs.scrollHeight}
function exSend(type){const examples={lp:'Tengo una panadería. Hago pan, medialunas y tortas. Tengo 100 kg de harina, 30 kg de azúcar y 50 kg de manteca por día. El pan me deja $0.60, la medialuna $0.80 y la torta $7. ¿Qué me conviene producir?',stock:"Soy distribuidor de caños PVC. Vendo 15.000 unidades por año. Cada pedido cuesta $200. Almacenar sale $3 por unidad por año. El caño cuesta $45. El proveedor tarda 10 días. ¿Cuánto pido y cada cuánto?",queue:"Tengo una clínica donde llegan 18 pacientes por hora. Cada médico tarda 15 minutos en atender. Un médico cuesta $40 por hora. La espera cuesta $25 por hora. ¿Cuántos médicos necesito?",invest:"Tengo dos opciones de inversión. Alternativa A: invierto $50.000, ingresos $40.000/año, costos $15.000/año, vida 5 años. Alternativa B: invierto $70.000, ingresos $50.000/año, costos $18.000/año, vida 5 años. Tasa descuento 12%. ¿Cuál es mejor?",rent:"Tengo una hamburguesería. Hamburguesa clásica: vendo a $2500, me cuesta $900, vendo 80 por día. Hamburguesa doble: vendo a $3500, cuesta $1400, vendo 45 por día. Papas fritas: $1200, cuesta $350, vendo 100. Gaseosa: $800, cuesta $250, vendo 120. Costos fijos: $350.000/mes. ¿Cuánto gano?",fc:"Arranco con $500.000 en caja. Cobro $800.000 por mes de ventas. Pago $300.000 de proveedores, $200.000 de sueldos y $150.000 de alquiler. Quiero proyectar 6 meses."};const inp=document.getElementById('inp');inp.value=examples[type]||'';send()}
function qSend(txt){document.getElementById("inp").value=txt;send()}

function selectQuestion(mod){
 const templates={
  lp:'Soy dueño de una panadería artesanal y todos los días tengo que decidir cuántos productos fabricar para maximizar la ganancia diaria, teniendo en cuenta que mis recursos son limitados.\n\nActualmente fabrico tres productos: Pan común, Medialunas y Tortas.\n\nMis recursos diarios disponibles son:\n- Harina: 100 kg/día\n- Azúcar: 30 kg/día\n- Manteca: 20 kg/día\n- Capacidad de horno: 480 minutos/día\n\nPara producir un pan necesito: 0,5 kg harina, 0,02 kg azúcar, 0,01 kg manteca, 2 min horno.\nPara una medialuna: 0,3 kg harina, 0,05 kg azúcar, 0,04 kg manteca, 1,5 min horno.\nPara una torta: 1,2 kg harina, 0,8 kg azúcar, 0,5 kg manteca, 20 min horno.\n\nPrecios y costos:\n- Pan: venta $1,50 / costo $0,90 → ganancia $0,60\n- Medialuna: venta $1,20 / costo $0,60 → ganancia $0,60\n- Torta: venta $12,00 / costo $7,00 → ganancia $5,00\n\nObjetivo: Decidir cuántas unidades de pan, medialunas y tortas producir por día para maximizar la ganancia total diaria.',
  stock:'Soy distribuidor de caños de PVC y necesito optimizar mi política de inventario.\n\nDatos de mi operación:\n- Demanda anual: 15.000 unidades\n- Costo de cada pedido al proveedor: $200\n- Costo de almacenamiento: $3 por unidad por año\n- Costo de adquisición: $45 por unidad\n- Lead time del proveedor: 10 días hábiles\n- No puedo permitir faltantes (cada venta perdida me cuesta un cliente)\n\n¿Cuántas unidades debo pedir cada vez? ¿Cada cuántos días debo hacer un pedido? ¿Cuál es el punto de reorden?',
  queue:'Tengo una clínica médica y necesito determinar el número óptimo de médicos para atender pacientes.\n\nDatos de mi operación:\n- Llegan en promedio 18 pacientes por hora (llegadas aleatorias)\n- Cada médico tarda en promedio 15 minutos en atender un paciente\n- Actualmente tengo 3 médicos\n- Costo por médico: $40/hora\n- Costo de espera del paciente (insatisfacción): $25/hora\n\n¿Necesito agregar más médicos? ¿Cuál es el número óptimo? ¿Cuánto tiempo promedio espera un paciente?',
  invest:'Tengo dos opciones de inversión para mi negocio y necesito decidir cuál me conviene más.\n\nAlternativa A – Abrir segundo local:\n- Inversión inicial: 250.000 USD\n- Ingresos estimados: 300.000/año\n- Costos operativos: 220.000/año\n- Vida estimada: 8 años\n- Valor residual: 50.000\n- Tasa descuento: 15%\n\nAlternativa B – Automatizar el local actual:\n- Inversión: 120.000 USD\n- Ahorro en costos laborales: 80.000/año\n- Incremento ingresos por mayor capacidad: 40.000/año\n- Costos adicionales mantenimiento: 20.000/año\n- Vida útil: 6 años\n- Sin valor residual\n- Tasa descuento: 15%\n\n¿Cuál alternativa es mejor?',
  rent:'Tengo una hamburguesería y quiero saber cuánto gano con cada producto.\n\nMis productos:\n- Hamburguesa clásica: vendo a $2500, me cuesta $900. Vendo 80 por día.\n- Hamburguesa doble: vendo a $3500, me cuesta $1400. Vendo 45 por día.\n- Papas fritas: vendo a $1200, me cuesta $350. Vendo 100 por día.\n- Gaseosa: vendo a $800, me cuesta $250. Vendo 120 por día.\n\nMis costos fijos son $350.000 por mes (alquiler + sueldos + servicios).\n\n¿Cuál es mi producto más rentable? ¿Cuánto gano en total? ¿Cuál es mi punto de equilibrio?',
  forecast:'Tengo un negocio de ropa y quiero proyectar cuánto voy a vender el mes que viene.\n\nMis ventas de los últimos 12 meses fueron:\n1295, 1010, 1085, 1145, 1445, 1170, 1230, 1380, 1495, 1100, 1350, 1410\n\n¿Cuánto voy a vender el próximo mes? ¿Cuál es el mejor método para predecirlo?',
  fc:'Tengo una verdulería y quiero saber si me va a alcanzar la plata los próximos meses.\n\nArranco con $500.000 en caja.\n\nMis ingresos mensuales:\n- Ventas: $800.000\n\nMis egresos mensuales:\n- Proveedores: $300.000\n- Sueldos: $200.000\n- Alquiler: $150.000\n- Servicios: $50.000\n\nQuiero proyectar 6 meses. ¿Me va a alcanzar? ¿En qué mes me quedo sin plata?'
 };
 const moduleMap={lp:'LP',stock:'STOCK',queue:'QUEUE',invest:'INVEST',forecast:'FORECAST',rent:'RENTABILIDAD',fc:'FLUJO_CAJA'};
 const tmpl=templates[mod];
 if(!tmpl)return;
 // Clear previous messages and reset
 const msgs=document.getElementById('msgs');
 if(msgs){msgs.querySelectorAll('.msg').forEach(m=>m.remove());}
 // Hide welcome with smooth transition, show back button
 const wel=document.getElementById('wel');
 if(wel){
  wel.classList.add('hiding');
  setTimeout(function(){wel.style.display='none';wel.classList.remove('hiding');},350);
 }
 const bb=document.getElementById('backBtn');
 if(bb)bb.style.display='inline-block';
 // Select module in sidebar
 document.querySelectorAll('.mcard').forEach(c=>c.classList.remove('sel'));
 const card=document.querySelector('[data-m="'+moduleMap[mod]+'"]');
 if(card)card.classList.add('sel');
 session.module=moduleMap[mod];
 session.stage='collect';
 session.params=moduleMap[mod]==='RENTABILIDAD'?{products:[],fixed_costs:undefined}:moduleMap[mod]==='FLUJO_CAJA'?{opening_balance:undefined,periods:undefined,inflows:[],outflows:[]}:moduleMap[mod]==='FORECAST'?{}:{};
 session.assumptions=[];
 updUI();updateStepper();updateScenariosUI();updateQuickButtons();
 // Show the template as an example message from the assistant
 const exampleHtml=mdToHtml('**Te muestro un ejemplo para que veas cómo funciona:**\n\n'+tmpl+'\n\n---\n**Ahora es tu turno.** Contame tu problema con tus datos y te lo resuelvo al instante.\nO si querés, podés copiar este ejemplo y modificar los números.');
 addMsg('a',exampleHtml);
 // Update mood
 currentMood='listening';
 const moodEl=document.getElementById('avatarMood');
 if(moodEl)moodEl.textContent='Esperando tu problema...';
 // Focus input
 const inp=document.getElementById('inp');
 if(inp){inp.focus();inp.placeholder='Describí tu problema de '+(mod==='lp'?'producción':mod==='stock'?'inventario':mod==='queue'?'atención al cliente':mod==='forecast'?'pronóstico de demanda':mod==='rent'?'rentabilidad':mod==='fc'?'flujo de caja':'inversión')+'...';}
}

function goBackToWelcome(){
 session={module:null,subtype:null,params:{},assumptions:[],stage:'detect',solution:null,history:session.history||[]};
 updUI();updateStepper();updateQuickButtons();
 showWelcome();
}

function showWelcome(){
 const wel=document.getElementById('wel');
 if(!wel)return;
 wel.style.display='';
 wel.style.animation='none';
 wel.offsetHeight; // force reflow
 wel.style.animation='fadeIn .4s ease both';
 // Hide back button
 const bb=document.getElementById('backBtn');
 if(bb)bb.style.display='none';
 // Clear messages
 const msgs=document.getElementById('msgs');
 if(msgs){
  const existing=msgs.querySelectorAll('.msg');
  existing.forEach(m=>m.remove());
 }
 // Deselect sidebar cards
 document.querySelectorAll('.mcard').forEach(c=>c.classList.remove('sel'));
 // Reset input placeholder
 const inp=document.getElementById('inp');
 if(inp)inp.placeholder='Describí tu problema operativo...';
 // Reset mood
 currentMood='idle';
 const moodEl=document.getElementById('avatarMood');
 if(moodEl)moodEl.textContent='Listo para resolver';
}

function updateQuickButtons(){
 const qa=document.getElementById('quickActions');
 if(!qa)return;
 const S=session;
 let buttons=[];
 if(S.stage==='solved'){
  if(S.module==='STOCK'){
   buttons=[
    {label:'💾 Guardar escenario',fn:'saveScenario()'},
    {label:'📄 Exportar reporte',fn:'exportReport()'},
    {label:'¿Qué pasa si cambia la demanda?',txt:'¿Qué pasa si cambia la demanda?'},
    {label:'Sensibilidad',txt:'Análisis de sensibilidad'},
    {label:'Explicar modelo',txt:'Explicame el modelo'},
    {label:'Exportar a Excel',txt:'Exportar a Excel'},
    {label:'🔗 Usar en → Flujo de Caja',fn:'startChain("FLUJO_CAJA")'},
    {label:'Nuevo problema',txt:'Nuevo problema'}
   ];
  }else if(S.module==='QUEUE'){
   buttons=[
    {label:'💾 Guardar escenario',fn:'saveScenario()'},
    {label:'📄 Exportar reporte',fn:'exportReport()'},
    {label:'🧮 Calculadora λ/μ',fn:'openCalcLambdaMu()'},
    {label:'Probar con más servidores',txt:'¿Qué pasa si agrego un servidor más?'},
    {label:'Sensibilidad',txt:'Análisis de sensibilidad'},
    {label:'Explicar modelo',txt:'Explicame el modelo'},
    {label:'🔗 Usar en → Flujo de Caja',fn:'startChain("FLUJO_CAJA")'},
    {label:'Nuevo problema',txt:'Nuevo problema'}
   ];
  }else if(S.module==='INVEST'){
   buttons=[
    {label:'💾 Guardar escenario',fn:'saveScenario()'},
    {label:'📄 Exportar reporte',fn:'exportReport()'},
    {label:'Comparar con otra alternativa',txt:'Quiero comparar con otra alternativa'},
    {label:'Análisis de sensibilidad',txt:'Análisis de sensibilidad'},
    {label:'Explicar fórmulas',txt:'Explicame las fórmulas de VAN y TIR'},
    {label:'🔗 Usar en → Flujo de Caja',fn:'startChain("FLUJO_CAJA")'},
    {label:'Nuevo problema',txt:'Nuevo problema'}
   ];
  }else if(S.module==='LP'){
   buttons=[
    {label:'💾 Guardar escenario',fn:'saveScenario()'},
    {label:'📄 Exportar reporte',fn:'exportReport()'},
    {label:'Sensibilidad',txt:'Análisis de sensibilidad'},
    {label:'Explicar modelo',txt:'Explicame las fórmulas'},
    {label:'Nuevo problema',txt:'Nuevo problema'}
   ];
  }else if(S.module==='FORECAST'){
   buttons=[
    {label:'💾 Guardar escenario',fn:'saveScenario()'},
    {label:'📄 Exportar reporte',fn:'exportReport()'},
    {label:'Cambiar método',txt:'Quiero probar otro método'},
    {label:'Explicar modelo',txt:'Explicame las fórmulas'},
    {label:'🔗 Usar en → Inventario',fn:'startChain("STOCK")'},
    {label:'🔗 Usar en → Flujo de Caja',fn:'startChain("FLUJO_CAJA")'},
    {label:'Nuevo problema',txt:'Nuevo problema'}
   ];
  }else if(S.module==='RENTABILIDAD'){
   buttons=[
    {label:'💾 Guardar escenario',fn:'saveScenario()'},
    {label:'📄 Exportar reporte',fn:'exportReport()'},
    {label:'Agregar producto',txt:'Quiero agregar otro producto'},
    {label:'Explicar modelo',txt:'Explicame el análisis'},
    {label:'🔗 Usar en → Flujo de Caja',fn:'startChain("FLUJO_CAJA")'},
    {label:'Nuevo problema',txt:'Nuevo problema'}
   ];
  }else if(S.module==='FLUJO_CAJA'){
   buttons=[
    {label:'💾 Guardar escenario',fn:'saveScenario()'},
    {label:'📄 Exportar reporte',fn:'exportReport()'},
    {label:'Agregar ingreso/egreso',txt:'Quiero agregar un ingreso o egreso'},
    {label:'Sensibilidad',txt:'Análisis de sensibilidad'},
    {label:'Explicar modelo',txt:'Explicame las fórmulas'},
    {label:'Nuevo problema',txt:'Nuevo problema'}
   ];
  }
 }else if(S.stage==='detect'||S.stage==='disambiguate'){
  buttons=[
   {label:'📐 Producción',txt:'Quiero resolver un problema de producción'},
   {label:'📦 Inventario',txt:'Quiero resolver un problema de inventario'},
   {label:'🔄 Colas',txt:'Quiero resolver un problema de colas'},
   {label:'💰 Proyectos',txt:'Quiero evaluar un proyecto de inversión'},
   {label:'📈 Pronósticos',txt:'Quiero hacer un pronóstico de demanda'},
   {label:'💰 Rentabilidad',txt:'Quiero analizar la rentabilidad de mis productos'},
   {label:'💵 Flujo de Caja',txt:'Quiero proyectar el flujo de caja de mi negocio'}
  ];
 }else if(S.stage==='confirm'){
  buttons=[
   {label:'✅ Resolver',txt:'Sí, resolvé'},
   {label:'✏️ Ajustar datos',txt:'Quiero ajustar un dato'}
  ];
 }else if(S.stage==='collect'&&S.module==='FORECAST'&&S.params.timeseries&&!S.params.method){
  buttons=[
   {label:'📊 Promedio Móvil',fn:"session.params.method='SMA';processMsg('Promedio Móvil Simple')"},
   {label:'⚖️ Ponderado',fn:"session.params.method='WMA';processMsg('Promedio Móvil Ponderado')"},
   {label:'📈 Suav. Exponencial',fn:"session.params.method='SES';processMsg('Suavización Exponencial')"},
   {label:'📉 Regresión',fn:"session.params.method='REG';processMsg('Regresión Lineal')"},
   {label:'🔄 Comparar todos',fn:"session.params.method='ALL';processMsg('Comparar todos los métodos')"}
  ];
 }else if(S.stage==='collect'&&S.module==='QUEUE'){
  buttons=[
   {label:'🧮 Calculadora λ/μ',fn:'openCalcLambdaMu()'},
   {label:'Nuevo problema',txt:'Nuevo problema'}
  ];
 }else if(S.stage==='collect'&&S.module==='RENTABILIDAD'){
  buttons=[
   {label:'📋 Cargar con formulario',fn:'openDataForm("RENTABILIDAD")'},
   {label:'Nuevo problema',txt:'Nuevo problema'}
  ];
 }else if(S.stage==='collect'&&S.module==='FLUJO_CAJA'){
  buttons=[
   {label:'📋 Cargar con formulario',fn:'openDataForm("FLUJO_CAJA")'},
   {label:'Nuevo problema',txt:'Nuevo problema'}
  ];
 }else if(S.stage==='collect'&&S.module==='STOCK'){
  buttons=[
   {label:'📋 Cargar con formulario',fn:'openDataForm("STOCK")'},
   {label:'Nuevo problema',txt:'Nuevo problema'}
  ];
 }else{
  buttons=[
   {label:'Nuevo problema',txt:'Nuevo problema'}
  ];
 }
 qa.innerHTML=buttons.map(b=>{
  if(b.fn)return `<button class="qb" onclick="${b.fn}">${b.label}</button>`;
  return `<button class="qb" onclick="qSend('${b.txt.replace(/'/g,"\\'")}')">${b.label}</button>`;
 }).join('');
}
function selMod(m){const reverseMap={LP:'lp',STOCK:'stock',QUEUE:'queue',INVEST:'invest',FORECAST:'forecast',RENTABILIDAD:'rent',FLUJO_CAJA:'fc'};const shorthand=reverseMap[m];if(shorthand){selectQuestion(shorthand);}}

// ═══ DATA FORM — structured input alternative to NLP ═══
var _dfModule='';
function openDataForm(mod){
 _dfModule=mod;
 var c=document.getElementById('dfContent');
 var t=document.getElementById('dfTitle');
 if(!c||!t)return;
 if(mod==='RENTABILIDAD'){
  t.innerHTML='💰 Rentabilidad';
  var existingProds=session.params.products||[];
  var rows=Math.max(existingProds.length,2);
  var html='<div style="font-size:.75rem;color:var(--ts);margin-bottom:.5rem">Productos (nombre, precio de venta, costo unitario, cantidad/mes)</div>';
  html+='<div id="dfProdRows">';
  for(var i=0;i<rows;i++){
   var p=existingProds[i]||{};
   html+='<div class="df-row" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:.3rem;margin-bottom:.3rem">';
   html+='<input class="df-in" placeholder="Nombre" value="'+(p.name||'')+'" data-f="name">';
   html+='<input class="df-in" type="number" placeholder="Precio" value="'+(p.price||'')+'" data-f="price">';
   html+='<input class="df-in" type="number" placeholder="Costo" value="'+(p.unit_cost||'')+'" data-f="cost">';
   html+='<input class="df-in" type="number" placeholder="Cant." value="'+(p.quantity||'')+'" data-f="qty">';
   html+='</div>';
  }
  html+='</div>';
  html+='<button class="qb" style="margin:.4rem 0" onclick="addDfRow()">+ Agregar producto</button>';
  html+='<div style="margin-top:.8rem"><label style="font-size:.75rem;color:var(--ts)">Costos fijos mensuales ($)</label>';
  html+='<input class="df-in" id="dfFixed" type="number" placeholder="Ej: 150000" value="'+(session.params.fixed_costs||'')+'"></div>';
 }
 else if(mod==='FLUJO_CAJA'){
  t.innerHTML='💵 Flujo de Caja';
  html='<div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.8rem">';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">Saldo inicial ($)</label><input class="df-in" id="dfOpening" type="number" placeholder="500000" value="'+(session.params.opening_balance||'')+'"></div>';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">Meses a proyectar</label><input class="df-in" id="dfPeriods" type="number" placeholder="6" value="'+(session.params.periods||'')+'"></div>';
  html+='</div>';
  html+='<div style="font-size:.75rem;color:var(--ac);font-weight:600;margin-bottom:.3rem">Ingresos mensuales</div>';
  html+='<div id="dfInRows">';
  var ins=session.params.inflows||[];
  var inRows=Math.max(ins.length,1);
  for(var j=0;j<inRows;j++){
   var inf=ins[j]||{};
   html+='<div class="df-row" style="display:grid;grid-template-columns:2fr 1fr;gap:.3rem;margin-bottom:.3rem">';
   html+='<input class="df-in" placeholder="Concepto" value="'+(inf.name||'')+'" data-f="name">';
   html+='<input class="df-in" type="number" placeholder="Monto" value="'+(inf.amount||'')+'" data-f="amount">';
   html+='</div>';
  }
  html+='</div>';
  html+='<button class="qb" style="margin:.3rem 0" onclick="addDfFlowRow(\'dfInRows\')">+ Agregar ingreso</button>';
  html+='<div style="font-size:.75rem;color:var(--dn);font-weight:600;margin:.5rem 0 .3rem">Egresos mensuales</div>';
  html+='<div id="dfOutRows">';
  var outs=session.params.outflows||[];
  var outRows=Math.max(outs.length,1);
  for(var k=0;k<outRows;k++){
   var outf=outs[k]||{};
   html+='<div class="df-row" style="display:grid;grid-template-columns:2fr 1fr;gap:.3rem;margin-bottom:.3rem">';
   html+='<input class="df-in" placeholder="Concepto" value="'+(outf.name||'')+'" data-f="name">';
   html+='<input class="df-in" type="number" placeholder="Monto" value="'+(outf.amount||'')+'" data-f="amount">';
   html+='</div>';
  }
  html+='</div>';
  html+='<button class="qb" style="margin:.3rem 0" onclick="addDfFlowRow(\'dfOutRows\')">+ Agregar egreso</button>';
  html+='<div style="font-size:.75rem;color:var(--ts);font-weight:600;margin:.8rem 0 .3rem">Plazos de cobro/pago (opcional)</div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">DSO — Plazo de cobro (días)</label><input class="df-in" id="dfDso" type="number" placeholder="Ej: 30" value="'+(session.params.dso||'')+'"></div>';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">DPO — Plazo de pago (días)</label><input class="df-in" id="dfDpo" type="number" placeholder="Ej: 60" value="'+(session.params.dpo||'')+'"></div>';
  html+='</div>';
  html+='<div style="font-size:.65rem;color:var(--ts);opacity:.7;margin-top:.2rem">0 = cobro/pago inmediato. Dejá vacío si no aplica.</div>';
 }
 else if(mod==='STOCK'){
  t.innerHTML='📦 Inventario';
  html='<div style="display:grid;gap:.5rem">';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">Demanda anual (unidades)</label><input class="df-in" id="dfDemand" type="number" placeholder="15000" value="'+(session.params.demand_D||'')+'"></div>';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">Costo por pedido ($)</label><input class="df-in" id="dfOrderCost" type="number" placeholder="200" value="'+(session.params.order_cost_k||'')+'"></div>';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">Costo almacenamiento ($/un/año)</label><input class="df-in" id="dfHoldCost" type="number" placeholder="3" value="'+(session.params.holding_cost_c1||'')+'"></div>';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">Precio unitario ($)</label><input class="df-in" id="dfPrice" type="number" placeholder="45" value="'+(session.params.acquisition_cost_b||'')+'"></div>';
  html+='<div><label style="font-size:.72rem;color:var(--ts)">Lead time (días)</label><input class="df-in" id="dfLeadTime" type="number" placeholder="0" value="'+((session.params.lead_time_LT||0)*365||'')+'"></div>';
  html+='</div>';
 }
 c.innerHTML=html;
 showModal('dataFormModal');
}
function addDfRow(){
 var c=document.getElementById('dfProdRows');if(!c)return;
 var row=document.createElement('div');row.className='df-row';row.style.cssText='display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:.3rem;margin-bottom:.3rem';
 row.innerHTML='<input class="df-in" placeholder="Nombre" data-f="name"><input class="df-in" type="number" placeholder="Precio" data-f="price"><input class="df-in" type="number" placeholder="Costo" data-f="cost"><input class="df-in" type="number" placeholder="Cant." data-f="qty">';
 c.appendChild(row);
}
function addDfFlowRow(containerId){
 var c=document.getElementById(containerId);if(!c)return;
 var row=document.createElement('div');row.className='df-row';row.style.cssText='display:grid;grid-template-columns:2fr 1fr;gap:.3rem;margin-bottom:.3rem';
 row.innerHTML='<input class="df-in" placeholder="Concepto" data-f="name"><input class="df-in" type="number" placeholder="Monto" data-f="amount">';
 c.appendChild(row);
}
function submitDataForm(){
 var S=session;
 if(_dfModule==='RENTABILIDAD'){
  var rows=document.querySelectorAll('#dfProdRows .df-row');
  var prods=[];
  rows.forEach(function(r){
   var n=r.querySelector('[data-f="name"]').value.trim();
   var p=parseFloat(r.querySelector('[data-f="price"]').value)||0;
   var c=parseFloat(r.querySelector('[data-f="cost"]').value)||0;
   var q=parseFloat(r.querySelector('[data-f="qty"]').value)||0;
   if(n)prods.push({name:n,price:p,unit_cost:c,quantity:q});
  });
  var fc=parseFloat(document.getElementById('dfFixed').value)||undefined;
  if(prods.length===0){return;}
  S.params.products=prods;
  if(fc!==undefined)S.params.fixed_costs=fc;
 }
 else if(_dfModule==='FLUJO_CAJA'){
  var ob=parseFloat(document.getElementById('dfOpening').value);
  var per=parseInt(document.getElementById('dfPeriods').value)||6;
  var inRows2=document.querySelectorAll('#dfInRows .df-row');
  var outRows2=document.querySelectorAll('#dfOutRows .df-row');
  var ins2=[],outs2=[];
  inRows2.forEach(function(r){
   var n=r.querySelector('[data-f="name"]').value.trim();
   var a=parseFloat(r.querySelector('[data-f="amount"]').value)||0;
   if(n&&a>0)ins2.push({name:n,amount:a});
  });
  outRows2.forEach(function(r){
   var n=r.querySelector('[data-f="name"]').value.trim();
   var a=parseFloat(r.querySelector('[data-f="amount"]').value)||0;
   if(n&&a>0)outs2.push({name:n,amount:a});
  });
  if(!isNaN(ob))S.params.opening_balance=ob;
  S.params.periods=per;
  if(ins2.length>0)S.params.inflows=ins2;
  if(outs2.length>0)S.params.outflows=outs2;
  var dfDso=parseInt(document.getElementById('dfDso').value);
  var dfDpo=parseInt(document.getElementById('dfDpo').value);
  if(!isNaN(dfDso)&&dfDso>0)S.params.dso=dfDso;
  if(!isNaN(dfDpo)&&dfDpo>0)S.params.dpo=dfDpo;
 }
 else if(_dfModule==='STOCK'){
  var d=parseFloat(document.getElementById('dfDemand').value);
  var k=parseFloat(document.getElementById('dfOrderCost').value);
  var h=parseFloat(document.getElementById('dfHoldCost').value);
  var b=parseFloat(document.getElementById('dfPrice').value)||0;
  var lt=parseFloat(document.getElementById('dfLeadTime').value)||0;
  if(!isNaN(d))S.params.demand_D=d;
  if(!isNaN(k))S.params.order_cost_k=k;
  if(!isNaN(h))S.params.holding_cost_c1=h;
  S.params.acquisition_cost_b=b;
  S.params.planning_horizon_T=1;
  S.params.lead_time_LT=lt/365;
  S.params.safety_stock_Sp=0;
 }
 closeModal('dataFormModal');
 S.stage='collect';
 updUI();
 var response=checkAndAsk();
 addMsg('u','[Datos cargados via formulario]');
 addMsg('a',response);
 updateQuickButtons();
}
function updUI(){document.getElementById("bmod").textContent=session.module||"Sin módulo";document.getElementById("bstg").textContent=session.stage||"Esperando"}
function exportLog(){const data=[["Timestamp","Role","Message"],...session.history.map(e=>[e.timestamp||new Date().toISOString(),e.role,e.content])];const ws=XLSX.utils.aoa_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Log");XLSX.writeFile(wb,"invop-log.xlsx")}

// ═══════════════════════════════════════════════════════════
// PDF REPORT EXPORT v2 — Professional Design
// ═══════════════════════════════════════════════════════════

const PDF_COLORS={
 brand:[88,48,190],     // deep purple
 accent:[6,214,160],    // mint
 dark:[32,32,48],       // near-black for text
 mid:[100,100,120],     // gray for secondary text
 light:[245,245,250],   // table alt rows
 white:[255,255,255],
 danger:[200,40,50],    // negative values
 success:[16,160,120],  // positive highlights
 headerBg:[42,42,58],   // dark header for tables
};

function exportReport(){
 const S=session;
 if(S.stage!=='solved'||!S.solution){addMsg('bot','⚠️ Primero resolvé un problema para poder exportar el reporte.');return;}
 if(typeof window.jspdf==='undefined'){addMsg('bot','⚠️ La librería de PDF no se cargó. Verificá tu conexión a internet y recargá.');return;}
 const{jsPDF}=window.jspdf;
 const doc=new jsPDF('p','mm','a4');
 const pw=doc.internal.pageSize.getWidth();
 const ph=doc.internal.pageSize.getHeight();
 const mx=18;
 const mod=S.module;
 const modNames={STOCK:'Inventario — Modelo EOQ',QUEUE:'Colas — Modelo M/M/s',INVEST:'Evaluación de Proyectos — VAN/TIR',LP:'Producción — Programación Lineal',FORECAST:'Pronósticos de Demanda',RENTABILIDAD:'Análisis de Rentabilidad — Margen y Punto de Equilibrio',FLUJO_CAJA:'Proyección de Flujo de Caja'};
 let y=10;

 function checkPage(need){if(y+need>ph-22){doc.addPage();y=22;}return y;}
 const tblBase={styles:{fontSize:8.5,cellPadding:{top:3,right:4,bottom:3,left:4},font:'helvetica',textColor:PDF_COLORS.dark,lineColor:[220,220,230],lineWidth:0.2},headStyles:{fillColor:PDF_COLORS.headerBg,textColor:PDF_COLORS.white,fontStyle:'bold',fontSize:8.5},alternateRowStyles:{fillColor:PDF_COLORS.light},margin:{left:mx,right:mx},theme:'grid',tableLineColor:[220,220,230],tableLineWidth:0.2};

 // ── HEADER ──
 y=pdfHeader(doc,mod,modNames,pw,mx);

 // ── PARÁMETROS ──
 y=checkPage(25);
 y=pdfSection(doc,'Parámetros de entrada',y,mx);
 const params=extractScenarioParams(mod,S.params);
 if(params.length>0){
  doc.autoTable({...tblBase,startY:y,
   head:[['Parámetro','Valor']],
   body:params.map(p=>[p.label,p.value]),
   columnStyles:{0:{cellWidth:90},1:{halign:'right',fontStyle:'bold'}}
  });
  y=doc.lastAutoTable.finalY+10;
 }

 // ── RESULTADOS ──
 y=checkPage(25);
 y=pdfSection(doc,'Resultados principales',y,mx);
 const metrics=extractScenarioMetrics(mod,S.solution);
 if(metrics.display&&metrics.display.length>0){
  doc.autoTable({...tblBase,startY:y,
   head:[['Métrica','Valor']],
   body:metrics.display.map(m=>[m.label,m.value]),
   headStyles:{...tblBase.headStyles,fillColor:PDF_COLORS.brand},
   columnStyles:{0:{cellWidth:90},1:{halign:'right',fontStyle:'bold'}}
  });
  y=doc.lastAutoTable.finalY+10;
 }

 // ── DETALLE POR MÓDULO ──
 y=pdfModuleTables(doc,mod,S,y,pw,mx,checkPage,tblBase);

 // ── GRÁFICOS ──
 y=pdfCharts(doc,mod,y,pw,mx,checkPage);

 // ── DECISIÓN ──
 y=checkPage(35);
 y=pdfSection(doc,'Recomendación',y,mx);
 let decisionText=fmtDecision(S.solution,S);
 decisionText=decisionText.replace(/\*\*/g,'').replace(/---/g,'').replace(/\n/g,' ').replace(/Decisión:\s*/i,'').replace(/\s{2,}/g,' ').trim();
 if(decisionText.length>0){
  const cardMx=mx+2;
  const cardW=pw-2*mx-4;
  const decLines=doc.splitTextToSize(decisionText,cardW-16);
  const decH=decLines.length*5.5+14;
  y=checkPage(decH+6);
  // Card bg
  doc.setFillColor(250,249,255);
  doc.setDrawColor(220,218,235);doc.setLineWidth(0.4);
  doc.roundedRect(cardMx,y-4,cardW,decH,4,4,'FD');
  // Left accent bar with rounded top
  doc.setFillColor(...PDF_COLORS.accent);
  doc.roundedRect(cardMx,y-4,3,decH,2,2,'F');
  // Text
  doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(...PDF_COLORS.dark);
  decLines.forEach((line,i)=>{
   doc.text(line,cardMx+10,y+5+i*5.5);
  });
  y+=decH+8;
 }

 // ── FOOTER on all pages ──
 const totalPages=doc.internal.getNumberOfPages();
 for(let i=1;i<=totalPages;i++){
  doc.setPage(i);
  pdfFooter(doc,i,totalPages,pw,ph);
 }

 const now=new Date();
 const dateStr=now.toISOString().slice(0,10).replace(/-/g,'');
 doc.save('invop-reporte-'+mod.toLowerCase()+'-'+dateStr+'.pdf');
 addMsg('bot','✅ Reporte PDF descargado exitosamente.');
}

// ── PDF: Header — elegant minimal ──
function pdfHeader(doc,mod,modNames,pw,mx){
 // Top accent stripe
 doc.setFillColor(...PDF_COLORS.brand);
 doc.rect(0,0,pw,2.5,'F');
 doc.setFillColor(...PDF_COLORS.accent);
 doc.rect(0,2.5,60,0.8,'F'); // short mint accent

 // Logo
 doc.setFontSize(18);doc.setFont('helvetica','bold');doc.setTextColor(...PDF_COLORS.brand);
 doc.text('INVOP',mx,14);
 doc.setTextColor(...PDF_COLORS.accent);
 doc.text('.AI',mx+doc.getTextWidth('INVOP'),14);

 // Module name as subtitle
 doc.setFontSize(9.5);doc.setFont('helvetica','normal');doc.setTextColor(...PDF_COLORS.mid);
 doc.text(modNames[mod]||mod,mx,20);

 // Right side: date + type
 const now=new Date();
 const dateStr=now.toLocaleDateString('es-AR',{day:'2-digit',month:'long',year:'numeric'});
 doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(...PDF_COLORS.mid);
 doc.text('Reporte de análisis',pw-mx,12,{align:'right'});
 doc.setFontSize(8);doc.setTextColor(170,170,185);
 doc.text(dateStr,pw-mx,17.5,{align:'right'});

 // Thin divider
 doc.setDrawColor(225,225,235);doc.setLineWidth(0.25);
 doc.line(mx,24,pw-mx,24);
 return 30;
}

// ── PDF: Section title — dot accent, no full line ──
function pdfSection(doc,title,y,mx){
 // Accent dot
 doc.setFillColor(...PDF_COLORS.accent);
 doc.circle(mx+2,y-1.5,1.5,'F');
 // Title
 doc.setFontSize(11);doc.setFont('helvetica','bold');doc.setTextColor(...PDF_COLORS.dark);
 doc.text(title.toUpperCase(),mx+7,y);
 // Subtle underline just under text
 const tw=doc.getTextWidth(title.toUpperCase());
 doc.setDrawColor(...PDF_COLORS.accent);doc.setLineWidth(0.5);
 doc.line(mx+7,y+1.5,mx+7+tw,y+1.5);
 return y+7;
}

// ── PDF: Module detail tables ──
function pdfModuleTables(doc,mod,S,y,pw,mx,checkPage,tblBase){
 const sol=S.solution;

 if(mod==='LP'){
  const cd=sol.constraint_details||[];
  if(cd.length>0){
   y=checkPage(30);
   y=pdfSection(doc,'Análisis de restricciones',y,mx);
   doc.autoTable({...tblBase,startY:y,
    head:[['Recurso','Usado','Disponible','Holgura','Precio sombra']],
    body:cd.map(c=>[
     c.name.charAt(0).toUpperCase()+c.name.slice(1),
     r2(c.used),r2(c.rhs),r2(c.slack),
     c.shadow_price?'$'+r2(c.shadow_price):'-'
    ]),
    columnStyles:{0:{cellWidth:50},3:{halign:'center'},4:{halign:'right'}},
    didParseCell:function(data){
     if(data.section==='body'&&data.column.index===3){
      const val=parseFloat(data.cell.raw);
      if(val===0){data.cell.styles.textColor=PDF_COLORS.danger;data.cell.styles.fontStyle='bold';}
     }
     if(data.section==='body'&&data.column.index===4&&data.cell.raw!=='-'){
      data.cell.styles.textColor=PDF_COLORS.success;data.cell.styles.fontStyle='bold';
     }
    }
   });
   y=doc.lastAutoTable.finalY+10;
  }
 }else if(mod==='STOCK'){
  const r=sol.results||{};
  const costRows=[];
  if(r.cost_order!==undefined)costRows.push(['Costo de pedido','$'+r2(r.cost_order).toLocaleString('es-AR')]);
  if(r.cost_holding!==undefined)costRows.push(['Costo de almacenamiento','$'+r2(r.cost_holding).toLocaleString('es-AR')]);
  if(r.cost_acquisition!==undefined)costRows.push(['Costo de adquisición','$'+r2(r.cost_acquisition).toLocaleString('es-AR')]);
  if(r.CTE!==undefined)costRows.push(['Costo total anual','$'+r2(r.CTE).toLocaleString('es-AR')]);
  if(costRows.length>0){
   y=checkPage(30);
   y=pdfSection(doc,'Desglose de costos anuales',y,mx);
   doc.autoTable({...tblBase,startY:y,
    head:[['Concepto','Monto']],
    body:costRows,
    columnStyles:{0:{cellWidth:100},1:{halign:'right',fontStyle:'bold'}},
    didParseCell:function(data){
     if(data.section==='body'&&data.row.index===costRows.length-1){
      data.cell.styles.fontStyle='bold';data.cell.styles.fillColor=[232,250,243];data.cell.styles.textColor=PDF_COLORS.success;
     }
    }
   });
   y=doc.lastAutoTable.finalY+10;
  }
 }else if(mod==='QUEUE'){
  const ec=sol.economic_analysis;
  if(ec&&ec.comparisons&&ec.comparisons.length>0){
   y=checkPage(30);
   y=pdfSection(doc,'Análisis económico por servidores',y,mx);
   doc.autoTable({...tblBase,startY:y,
    head:[['M','Costo espera/h','Costo serv./h','Costo total/h','']],
    body:ec.comparisons.map(c=>[
     c.M,'$'+r2(c.cost_wait_per_hour),'$'+r2(c.cost_server_per_hour),'$'+r2(c.cost_total_per_hour),
     c.is_optimal?'OPTIMO':c.status==='ESTABLE'?'':c.status
    ]),
    columnStyles:{0:{cellWidth:15,halign:'center'},1:{halign:'right'},2:{halign:'right'},3:{halign:'right'},4:{halign:'center',cellWidth:25}},
    didParseCell:function(data){
     if(data.section==='body'){
      const row=ec.comparisons[data.row.index];
      if(row&&row.is_optimal){
       data.cell.styles.fillColor=[232,250,243];
       if(data.column.index===4){data.cell.styles.textColor=PDF_COLORS.success;data.cell.styles.fontStyle='bold';}
      }
     }
    }
   });
   y=doc.lastAutoTable.finalY+10;
  }
 }else if(mod==='INVEST'){
  const alts=sol.alternatives||[];
  if(alts.length>0){
   y=checkPage(30);
   y=pdfSection(doc,'Comparación de alternativas',y,mx);
   const head=[['Métrica']];
   alts.forEach(a=>head[0].push(a.name));
   const rows=[
    ['VAN',...alts.map(a=>'$'+r0(a.van).toLocaleString('es-AR'))],
    ['TIR (%)',...alts.map(a=>a.tir+'%')],
    ['Payback simple',...alts.map(a=>a.payback_simple.toFixed(1)+' años')],
    ['Payback descontado',...alts.map(a=>a.payback_discounted!==undefined?a.payback_discounted.toFixed(1)+' años':'N/A')],
    ['Índice de rentabilidad',...alts.map(a=>a.profitability_index!==undefined?r2(a.profitability_index):'N/A')]
   ];
   if(sol.comparison&&sol.comparison.winner){
    rows.push(['Resultado',...alts.map(a=>a.name===sol.comparison.winner?'GANADOR':'-')]);
   }
   doc.autoTable({...tblBase,startY:y,
    head:head,body:rows,
    headStyles:{...tblBase.headStyles,fillColor:PDF_COLORS.brand},
    columnStyles:{0:{cellWidth:50}},
    didParseCell:function(data){
     if(data.section==='body'&&data.cell.raw==='GANADOR'){
      data.cell.styles.fontStyle='bold';data.cell.styles.textColor=PDF_COLORS.success;data.cell.styles.fillColor=[232,250,243];
     }
    }
   });
   y=doc.lastAutoTable.finalY+10;
  }
  // Cashflow tables
  alts.forEach(a=>{
   if(a.cashflow_table&&a.cashflow_table.length>0){
    y=checkPage(30);
    y=pdfSection(doc,'Flujo de caja — '+a.name,y,mx);
    doc.autoTable({...tblBase,startY:y,
     head:[['Año','Flujo neto','VAN acumulado']],
     body:a.cashflow_table.map(cf=>[
      cf.year,
      '$'+r0(cf.net_flow).toLocaleString('es-AR'),
      '$'+r0(cf.cumulative_npv).toLocaleString('es-AR')
     ]),
     columnStyles:{0:{cellWidth:20,halign:'center'},1:{halign:'right'},2:{halign:'right'}},
     didParseCell:function(data){
      if(data.section==='body'&&(data.column.index===1||data.column.index===2)){
       const raw=data.cell.raw.replace(/[$.]/g,'').replace(/\./g,'').replace(',','.');
       if(parseFloat(raw)<0)data.cell.styles.textColor=PDF_COLORS.danger;
      }
     }
    });
    y=doc.lastAutoTable.finalY+10;
   }
  });
 }else if(mod==='FORECAST'){
  const r=sol.results||{};
  if(sol.method==='ALL'&&r.comparison){
   y=checkPage(30);
   y=pdfSection(doc,'Comparación de métodos',y,mx);
   doc.autoTable({...tblBase,startY:y,
    head:[['Método','MAD','MSE','MAPE','TS','Pronóstico']],
    body:r.comparison.map(c=>[
     c.method+(c.is_best?' ★':''),r2(c.mad),r0(c.mse),c.mape+'%',c.tracking_signal,c.forecast_next
    ]),
    columnStyles:{0:{cellWidth:40},5:{halign:'right',fontStyle:'bold'}},
    didParseCell:function(data){
     if(data.section==='body'&&r.comparison[data.row.index]&&r.comparison[data.row.index].is_best){
      data.cell.styles.fillColor=[232,250,243];
      if(data.column.index===0)data.cell.styles.fontStyle='bold';
     }
    }
   });
   y=doc.lastAutoTable.finalY+10;
  }
  if(r.detail_table&&r.detail_table.length>0){
   y=checkPage(30);
   y=pdfSection(doc,'Detalle período a período',y,mx);
   doc.autoTable({...tblBase,startY:y,
    head:[['Per.','Real','Pronóst.','Error','|Error|','RSFE','MAD(t)','TS(t)']],
    body:r.detail_table.map(row=>[
     row.period,row.actual,row.forecast!==null?row.forecast:'—',
     row.error!==undefined?r0(row.error):'—',
     row.abs_error!==undefined?r0(row.abs_error):'—',
     row.rsfe!==undefined?r0(row.rsfe):'—',
     row.mad_t!==undefined?row.mad_t:'—',
     row.ts_t!==undefined?row.ts_t:'—'
    ]),
    columnStyles:{0:{cellWidth:15,halign:'center'},1:{halign:'right'},2:{halign:'right'},3:{halign:'right'},4:{halign:'right'},5:{halign:'right'},6:{halign:'right'},7:{halign:'right'}}
   });
   y=doc.lastAutoTable.finalY+10;
  }
 }else if(mod==='RENTABILIDAD'){
  const r=sol.results||{};
  const prods=r.products||[];
  if(prods.length>0){
   y=checkPage(30);
   y=pdfSection(doc,'Detalle por producto',y,mx);
   doc.autoTable({...tblBase,startY:y,
    head:[['Producto','Precio','Costo','Margen','Margen %','Contribución']],
    body:prods.map(p=>[
     p.name,'$'+r2(p.price).toLocaleString('es-AR'),'$'+r2(p.unit_cost).toLocaleString('es-AR'),
     '$'+r2(p.margin).toLocaleString('es-AR'),p.margin_pct+'%','$'+r0(p.contribution).toLocaleString('es-AR')
    ]),
    columnStyles:{0:{cellWidth:40},1:{halign:'right'},2:{halign:'right'},3:{halign:'right'},4:{halign:'center'},5:{halign:'right',fontStyle:'bold'}},
    didParseCell:function(data){
     if(data.section==='body'){
      // Highlight best margin row
      const prod=prods[data.row.index];
      if(prod&&r.ranking&&r.ranking[0]&&prod.name===r.ranking[0].name){
       data.cell.styles.fillColor=[232,250,243];
       if(data.column.index===0)data.cell.styles.fontStyle='bold';
      }
      // Red for negative margin
      if(data.column.index===3||data.column.index===4){
       const val=parseFloat(String(data.cell.raw).replace(/[^0-9.-]/g,''));
       if(val<0){data.cell.styles.textColor=PDF_COLORS.danger;}
      }
     }
    }
   });
   y=doc.lastAutoTable.finalY+10;
  }
  // Break-even summary
  if(r.global_break_even_units&&r.global_break_even_units<Infinity){
   y=checkPage(20);
   y=pdfSection(doc,'Punto de equilibrio',y,mx);
   const beRows=[
    ['Punto de equilibrio global',r.global_break_even_units+' unidades'],
    ['Margen contribución promedio','$'+r2(r.avg_contribution_margin).toLocaleString('es-AR')],
    ['Costos fijos','$'+r0(r.fixed_costs).toLocaleString('es-AR')]
   ];
   doc.autoTable({...tblBase,startY:y,
    head:[['Concepto','Valor']],body:beRows,
    columnStyles:{0:{cellWidth:100},1:{halign:'right',fontStyle:'bold'}}
   });
   y=doc.lastAutoTable.finalY+10;
  }
 }else if(mod==='FLUJO_CAJA'){
  const r=sol.results||{};
  const tl=r.timeline||[];
  if(tl.length>0){
   y=checkPage(30);
   y=pdfSection(doc,'Proyección mensual',y,mx);
   doc.autoTable({...tblBase,startY:y,
    head:[['Mes','Saldo Inicial','Ingresos','Egresos','Saldo Final']],
    body:tl.map(t=>[
     'Mes '+t.month,
     '$'+r0(t.opening).toLocaleString('es-AR'),
     '$'+r0(t.inflows).toLocaleString('es-AR'),
     '$'+r0(t.outflows).toLocaleString('es-AR'),
     '$'+r0(t.closing).toLocaleString('es-AR')
    ]),
    columnStyles:{0:{cellWidth:20,halign:'center'},1:{halign:'right'},2:{halign:'right'},3:{halign:'right'},4:{halign:'right',fontStyle:'bold'}},
    didParseCell:function(data){
     if(data.section==='body'&&data.column.index===4){
      const row=tl[data.row.index];
      if(row&&row.closing<0){data.cell.styles.textColor=PDF_COLORS.danger;data.cell.styles.fontStyle='bold';}
      else{data.cell.styles.textColor=PDF_COLORS.success;}
     }
    }
   });
   y=doc.lastAutoTable.finalY+10;
  }
  // Summary
  y=checkPage(25);
  y=pdfSection(doc,'Resumen financiero',y,mx);
  const summaryRows=[
   ['Saldo inicial','$'+r0(r.opening).toLocaleString('es-AR')],
   ['Ingresos totales ('+r.nPeriods+' meses)','$'+r0(r.totalInAll).toLocaleString('es-AR')],
   ['Egresos totales ('+r.nPeriods+' meses)','$'+r0(r.totalOutAll).toLocaleString('es-AR')],
   ['Flujo neto mensual','$'+r0(r.net_monthly).toLocaleString('es-AR')],
   ['Saldo final','$'+r0(r.final_balance).toLocaleString('es-AR')],
   ['Meses en rojo',''+r.neg_months]
  ];
  doc.autoTable({...tblBase,startY:y,
   head:[['Concepto','Valor']],body:summaryRows,
   columnStyles:{0:{cellWidth:100},1:{halign:'right',fontStyle:'bold'}},
   headStyles:{...tblBase.headStyles,fillColor:PDF_COLORS.brand},
   didParseCell:function(data){
    if(data.section==='body'){
     // Red for negative final balance
     if(data.row.index===4){
      const val=r.final_balance;
      if(val<0)data.cell.styles.textColor=PDF_COLORS.danger;
      else data.cell.styles.textColor=PDF_COLORS.success;
     }
     // Red for months in red > 0
     if(data.row.index===5&&r.neg_months>0){
      data.cell.styles.textColor=PDF_COLORS.danger;data.cell.styles.fontStyle='bold';
     }
    }
   }
  });
  y=doc.lastAutoTable.finalY+10;
 }
 return y;
}

// ── PDF: Charts — offscreen canvas with white bg ──
function pdfCharts(doc,mod,y,pw,mx,checkPage){
 // Only one chart per module for clean PDF (TIR data is already in comparison table)
 const chartKeys={STOCK:['stock-main'],QUEUE:['queue-main'],LP:['lp-main'],INVEST:['invest-van'],FORECAST:['forecast-main'],RENTABILIDAD:['rent-main'],FLUJO_CAJA:['fc-main']};
 const keys=chartKeys[mod]||[];
 if(keys.length===0)return y;

 y=checkPage(80);
 y=pdfSection(doc,'Visualización',y,mx);

 keys.forEach(key=>{
  const chart=chartInstances[key];
  if(!chart||!chart.canvas)return;
  try{
   // 1. Switch chart to light theme
   const opts=chart.options;
   const saved={scales:{},legendColor:null};
   Object.keys(opts.scales||{}).forEach(sk=>{
    const sc=opts.scales[sk];
    saved.scales[sk]={
     tickColor:sc.ticks?sc.ticks.color:undefined,
     titleColor:sc.title?sc.title.color:undefined,
     gridColor:sc.grid?sc.grid.color:undefined
    };
    if(sc.ticks)sc.ticks.color='#555';
    if(sc.title)sc.title.color='#333';
    if(sc.grid)sc.grid.color='rgba(0,0,0,0.06)';
   });
   const leg=opts.plugins&&opts.plugins.legend&&opts.plugins.legend.labels;
   if(leg){saved.legendColor=leg.color;leg.color='#444';}
   chart.update('none');

   // 2. Offscreen canvas: white bg + chart
   const src=chart.canvas;
   const tmp=document.createElement('canvas');
   tmp.width=src.width;tmp.height=src.height;
   const ctx=tmp.getContext('2d');
   ctx.fillStyle='#fff';ctx.fillRect(0,0,tmp.width,tmp.height);
   ctx.drawImage(src,0,0);
   const imgData=tmp.toDataURL('image/png',1.0);

   // 3. Restore dark theme
   Object.keys(saved.scales).forEach(sk=>{
    const sc=opts.scales[sk];const o=saved.scales[sk];
    if(sc.ticks&&o.tickColor!==undefined)sc.ticks.color=o.tickColor;
    if(sc.title&&o.titleColor!==undefined)sc.title.color=o.titleColor;
    if(sc.grid&&o.gridColor!==undefined)sc.grid.color=o.gridColor;
   });
   if(leg&&saved.legendColor!==undefined)leg.color=saved.legendColor;
   chart.update('none');

   // 4. Embed in PDF — generous size
   const cw=src.width,ch2=src.height;
   const maxW=pw-2*mx-4;
   const maxH=80;
   let imgW=maxW,imgH=(ch2/cw)*maxW;
   if(imgH>maxH){imgH=maxH;imgW=(cw/ch2)*maxH;}
   y=checkPage(imgH+8);
   const xOff=mx+(pw-2*mx-imgW)/2;
   // Soft shadow effect (light gray rect behind)
   doc.setFillColor(240,240,245);
   doc.roundedRect(xOff+1,y+1,imgW+2,imgH+2,2,2,'F');
   // Border
   doc.setDrawColor(210,210,220);doc.setLineWidth(0.3);
   doc.roundedRect(xOff-1,y-1,imgW+2,imgH+2,2,2,'S');
   doc.addImage(imgData,'PNG',xOff,y,imgW,imgH);
   y+=imgH+10;
  }catch(e){
   console.warn('[PDF] Chart error:',key,e);
  }
 });
 return y;
}

// ── PDF: Footer — minimal ──
function pdfFooter(doc,pageNum,totalPages,pw,ph){
 doc.setDrawColor(230,230,240);doc.setLineWidth(0.2);
 doc.line(18,ph-14,pw-18,ph-14);
 doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(160,160,175);
 doc.text('invop.ai',18,ph-9);
 // Accent dot in footer
 doc.setFillColor(...PDF_COLORS.accent);
 doc.circle(18+doc.getTextWidth('invop.ai')+3,ph-10.5,0.8,'F');
 doc.text('Reporte generado automáticamente',18+doc.getTextWidth('invop.ai')+6,ph-9);
 doc.text(pageNum+' / '+totalPages,pw-18,ph-9,{align:'right'});
}

function avatarClick(){console.log("Avatar clicked")}

// ═══════════════════════════════════════════════════════════
// CALCULADORA λ/μ — Queue Helper Tool
// ═══════════════════════════════════════════════════════════

function openCalcLambdaMu(){
 showModal('calcLambdaMuModal');
 document.getElementById('lambdaFormat').value='perHour';
 document.getElementById('muFormat').value='serviceMin';
 renderCalcInputs();
}

function renderCalcInputs(){
 // Lambda inputs
 const lf=document.getElementById('lambdaFormat').value;
 const lc=document.getElementById('lambdaInputs');
 if(lf==='perHour'){
  lc.innerHTML='<div class="calc-input-group"><label>Clientes por hora:</label><input type="number" id="lVal1" placeholder="Ej: 15" min="0" step="0.1" oninput="updateCalcDisplay()"></div>';
 }else if(lf==='interval'){
  lc.innerHTML='<div class="calc-input-group"><label>Llega un cliente cada:</label><div class="calc-input-row"><input type="number" id="lVal1" placeholder="Ej: 4" min="0" step="0.1" oninput="updateCalcDisplay()"><select id="lUnit1" onchange="updateCalcDisplay()"><option value="min">minutos</option><option value="sec">segundos</option></select></div></div>';
 }else if(lf==='batch'){
  lc.innerHTML='<div class="calc-input-group"><label>Cantidad de clientes:</label><input type="number" id="lVal1" placeholder="Ej: 30" min="0" step="1" oninput="updateCalcDisplay()"></div><div class="calc-input-group"><label>En un período de:</label><div class="calc-input-row"><input type="number" id="lVal2" placeholder="Ej: 2" min="0" step="0.1" oninput="updateCalcDisplay()"><select id="lUnit2" onchange="updateCalcDisplay()"><option value="hour">horas</option><option value="min">minutos</option></select></div></div>';
 }
 // Mu inputs
 const mf=document.getElementById('muFormat').value;
 const mc=document.getElementById('muInputs');
 if(mf==='perHour'){
  mc.innerHTML='<div class="calc-input-group"><label>Clientes atendidos por hora:</label><input type="number" id="mVal1" placeholder="Ej: 20" min="0" step="0.1" oninput="updateCalcDisplay()"></div>';
 }else if(mf==='serviceMin'){
  mc.innerHTML='<div class="calc-input-group"><label>Tiempo de atención:</label><div class="calc-input-row"><input type="number" id="mVal1" placeholder="Ej: 8" min="0" step="0.1" oninput="updateCalcDisplay()"><select id="mUnit1" onchange="updateCalcDisplay()"><option value="min">minutos</option><option value="sec">segundos</option></select></div></div>';
 }else if(mf==='serviceHour'){
  mc.innerHTML='<div class="calc-input-group"><label>Horas por atención:</label><input type="number" id="mVal1" placeholder="Ej: 0.25" min="0" step="0.001" oninput="updateCalcDisplay()"></div>';
 }
 updateCalcDisplay();
}

function calcLambda(){
 const f=document.getElementById('lambdaFormat').value;
 const v1=parseFloat(document.getElementById('lVal1')?.value);
 if(f==='perHour')return isNaN(v1)||v1<0?null:v1;
 if(f==='interval'){
  if(isNaN(v1)||v1<=0)return null;
  const u=document.getElementById('lUnit1')?.value||'min';
  return u==='sec'?3600/v1:60/v1;
 }
 if(f==='batch'){
  const v2=parseFloat(document.getElementById('lVal2')?.value);
  if(isNaN(v1)||isNaN(v2)||v1<0||v2<=0)return null;
  const u=document.getElementById('lUnit2')?.value||'hour';
  const hrs=u==='min'?v2/60:v2;
  return v1/hrs;
 }
 return null;
}

function calcMu(){
 const f=document.getElementById('muFormat').value;
 const v1=parseFloat(document.getElementById('mVal1')?.value);
 if(f==='perHour')return isNaN(v1)||v1<0?null:v1;
 if(f==='serviceMin'){
  if(isNaN(v1)||v1<=0)return null;
  const u=document.getElementById('mUnit1')?.value||'min';
  return u==='sec'?3600/v1:60/v1;
 }
 if(f==='serviceHour'){
  if(isNaN(v1)||v1<=0)return null;
  return 1/v1;
 }
 return null;
}

function updateCalcDisplay(){
 const lam=calcLambda();
 document.getElementById('lambdaResult').textContent=lam!==null?r2(lam):'—';
 const mu=calcMu();
 document.getElementById('muResult').textContent=mu!==null?r2(mu):'—';
}

function useCalcValues(){
 const lam=calcLambda(),mu=calcMu();
 if(lam===null||mu===null){addMsg('bot','⚠️ Completá ambos campos (λ y μ) para usar la calculadora.');return;}
 if(lam<=0||mu<=0){addMsg('bot','⚠️ Las tasas deben ser positivas.');return;}
 session.params.arrival_rate_lambda=Math.round(lam*1000)/1000;
 session.params.service_rate_mu=Math.round(mu*1000)/1000;
 closeModal('calcLambdaMuModal');
 addMsg('bot','✅ **Valores calculados:**\n- **λ (llegada):** '+session.params.arrival_rate_lambda+' clientes/hora\n- **μ (servicio):** '+session.params.service_rate_mu+' clientes/hora/servidor\n\n¿Continuamos con el resto de los datos?');
 // Continue QUEUE flow — ask for next missing param
 setTimeout(function(){
  if(session.stage==='collect'){
   updUI();updateQuickButtons();
   const next=checkAndAsk();
   if(next){addMsg('bot',next);updateQuickButtons();}
  }
 },600);
}

// ═══════════════════════════════════════════════════════════
// SCENARIO COMPARISON — UI + Comparison Modal
// ═══════════════════════════════════════════════════════════

function updateScenariosUI(){
 const sec=document.getElementById('scenariosSection');
 if(!sec)return;
 const mod=session.module;
 if(!mod){sec.style.display='none';return;}
 const modScen=scenarios.filter(sc=>sc.module===mod);
 if(modScen.length===0){sec.style.display='none';return;}
 sec.style.display='block';
 const list=document.getElementById('scenariosList');
 list.innerHTML=modScen.map(sc=>{
  const icon=MODULE_ICONS[sc.module]||'📋';
  const mainMetric=sc.metrics.display[0];
  const mStr=mainMetric?mainMetric.value:'';
  return `<div class="scenario-item" data-id="${sc.id}" onclick="selectScenarioForCompare('${sc.id}')">
   <span class="scenario-item-icon">${icon}</span>
   <span class="scenario-item-name">${sc.customName||sc.name}</span>
   <span class="scenario-item-metric">${mStr}</span>
   <button class="scenario-item-delete" onclick="deleteScenario('${sc.id}',event)" title="Borrar">✕</button>
  </div>`;
 }).join('');
 const hint=document.getElementById('scenarioHint');
 const cmpBtn=document.getElementById('compareBtn');
 if(modScen.length>=2){
  if(hint)hint.textContent='Seleccioná 2 o 3 para comparar';
  if(cmpBtn)cmpBtn.style.display='block';
 }else{
  if(hint)hint.textContent='Guardá otro escenario para comparar';
  if(cmpBtn)cmpBtn.style.display='none';
 }
}

function selectScenarioForCompare(id){
 const item=document.querySelector(`.scenario-item[data-id="${id}"]`);
 if(!item)return;
 const selected=document.querySelectorAll('.scenario-item.selected');
 if(item.classList.contains('selected')){item.classList.remove('selected');return;}
 if(selected.length>=3)return; // max 3
 item.classList.toggle('selected');
}

function clearScenarioSelection(){
 document.querySelectorAll('.scenario-item.selected').forEach(el=>el.classList.remove('selected'));
}

function compareScenarios(){
 const selected=document.querySelectorAll('.scenario-item.selected');
 if(selected.length<2){addMsg('a','⚠️ Seleccioná al menos 2 escenarios del panel lateral para comparar.');return;}
 const ids=Array.from(selected).map(el=>el.dataset.id);
 const toCompare=scenarios.filter(sc=>ids.includes(sc.id));
 if(toCompare.length<2)return;
 showComparisonModal(toCompare);
}

const compChartInstances={};
function destroyCompCharts(){
 Object.keys(compChartInstances).forEach(k=>{try{compChartInstances[k].destroy();}catch(e){}delete compChartInstances[k];});
}

function showComparisonModal(scens){
 destroyCompCharts();
 const modal=document.getElementById('comparisonModal');
 const title=document.getElementById('comparisonTitle');
 const body=document.getElementById('comparisonBody');
 if(!modal||!body)return;
 const mod=scens[0].module;
 title.textContent='Comparación: '+scens.map(s=>s.customName||s.name).join(' vs ');
 let html='';
 // ── PARAMETERS TABLE ──
 html+='<div class="comparison-section"><div class="comparison-section-title">Parámetros de entrada</div>';
 html+=buildComparisonTable(scens,'paramsList');
 html+='</div>';
 // ── METRICS TABLE ──
 html+='<div class="comparison-section"><div class="comparison-section-title">Resultados</div>';
 html+=buildComparisonTable(scens,'metrics');
 html+='</div>';
 // ── CHARTS ──
 html+='<div class="comparison-section"><div class="comparison-section-title">Gráficos</div>';
 html+='<div class="comparison-charts-grid" id="compChartsGrid">';
 scens.forEach((sc,i)=>{
  html+=`<div class="comparison-chart-card"><div class="chart-title">${sc.customName||sc.name}</div><canvas id="comp-chart-${i}" height="220"></canvas></div>`;
 });
 html+='</div></div>';
 body.innerHTML=html;
 modal.style.display='flex';
 void modal.offsetHeight;
 modal.classList.add('show');
 // Render charts after DOM update
 setTimeout(()=>{
  scens.forEach((sc,i)=>{renderComparisonChart(mod,sc,i);});
  // Force resize after render
  setTimeout(()=>{Object.values(compChartInstances).forEach(ch=>{try{ch.resize();}catch(e){}});},100);
 },300);
 clearScenarioSelection();
}

function buildComparisonTable(scens,sourceKey){
 // Collect all unique keys across scenarios
 const allKeys=[];
 scens.forEach(sc=>{
  const items=sourceKey==='metrics'?sc.metrics.display:(sc.paramsList||[]);
  items.forEach(m=>{if(!allKeys.find(ak=>ak.key===m.key))allKeys.push({key:m.key,label:m.label});});
 });
 if(allKeys.length===0)return '<p style="color:var(--ts);font-size:.8rem">Sin datos</p>';
 let t='<table class="comparison-table"><thead><tr><th>Métrica</th>';
 scens.forEach(sc=>{t+=`<th style="text-align:center">${sc.customName||sc.name}</th>`;});
 t+='</tr></thead><tbody>';
 allKeys.forEach(ak=>{
  const vals=scens.map(sc=>{
   const items=sourceKey==='metrics'?sc.metrics.display:(sc.paramsList||[]);
   const m=items.find(mm=>mm.key===ak.key);
   return m?{value:m.value,num:m.num}:{value:'—',num:null};
  });
  const nums=vals.map(v=>v.num).filter(n=>n!==null);
  const allSame=nums.length>1&&new Set(nums.map(n=>n.toFixed(4))).size===1;
  const isChanged=nums.length>1&&!allSame;
  // Find best value (highest for profit metrics, lowest for cost metrics)
  let bestIdx=-1;
  if(isChanged&&sourceKey==='metrics'&&nums.length>1){
   const costKeys=['CTE','CT','Wc','pb','rho'];
   const isCost=costKeys.some(ck=>ak.key.includes(ck));
   if(isCost){bestIdx=nums.indexOf(Math.min(...nums));}
   else{bestIdx=nums.indexOf(Math.max(...nums));}
  }
  t+=`<tr class="${isChanged?'changed':''}"><td>${ak.label}</td>`;
  vals.forEach((v,i)=>{
   const best=i===bestIdx?' best':'';
   t+=`<td style="text-align:center" class="${best}">${v.value}</td>`;
  });
  t+='</tr>';
 });
 t+='</tbody></table>';
 return t;
}

function renderComparisonChart(mod,sc,idx){
 if(typeof Chart==='undefined'){console.warn('[COMP] Chart.js not loaded');return;}
 const el=document.getElementById('comp-chart-'+idx);
 if(!el){console.warn('[COMP] Canvas not found: comp-chart-'+idx);return;}
 console.log('[COMP] Rendering chart',idx,'for',mod,'canvas:',el.offsetWidth,'x',el.offsetHeight);
 const cd={color:'#E8E8F0',gridColor:'rgba(152,152,176,0.15)',fontFamily:'"Inter",system-ui,sans-serif'};
 const colors=['#6C3CE1','#06D6A0','#EF476F','#FFD166'];
 const borders=['#8B5CF6','#10B981','#F87171','#FCD34D'];
 if(mod==='STOCK'){
  const r=sc.solution.results||{},p=sc.params;
  const qOpt=parseFloat(r.qo)||100;
  const D=p.demand_D,k=p.order_cost_k,c1=p.holding_cost_c1,b=p.acquisition_cost_b||0;
  const pts=[];
  for(let q=Math.max(10,Math.round(qOpt*0.2));q<=qOpt*3;q+=Math.max(1,Math.round(qOpt*0.05))){
   pts.push({q,cP:k*(D/q),cA:c1*(q/2),cT:b*D+k*(D/q)+c1*(q/2)});
  }
  compChartInstances['comp-'+idx]=new Chart(el,{type:'line',data:{labels:pts.map(p=>p.q),datasets:[
   {label:'Costo pedido',data:pts.map(p=>p.cP),borderColor:'#EF476F',borderWidth:2,fill:false,pointRadius:0},
   {label:'Costo almac.',data:pts.map(p=>p.cA),borderColor:'#06D6A0',borderWidth:2,fill:false,pointRadius:0},
   {label:'Costo total',data:pts.map(p=>p.cT),borderColor:'#6C3CE1',borderWidth:3,fill:false,pointRadius:0}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:10}}}},scales:{x:{ticks:{color:cd.color,font:{family:cd.fontFamily,size:9}},grid:{color:cd.gridColor}},y:{ticks:{color:cd.color,font:{family:cd.fontFamily,size:9},callback:v=>'$'+v.toLocaleString('es-AR')},grid:{color:cd.gridColor}}}}});
 }else if(mod==='QUEUE'){
  const ec=sc.solution.economic_analysis;
  if(!ec||!ec.comparisons)return;
  const stable=ec.comparisons.filter(c=>c.status==='ESTABLE');
  compChartInstances['comp-'+idx]=new Chart(el,{type:'bar',data:{labels:stable.map(c=>'M='+c.M),datasets:[
   {label:'Costo espera',data:stable.map(c=>c.cost_wait_per_hour),backgroundColor:'rgba(239,71,111,.7)',borderRadius:4},
   {label:'Costo serv.',data:stable.map(c=>c.cost_servers_per_hour),backgroundColor:'rgba(6,214,160,.7)',borderRadius:4},
   {label:'Total',data:stable.map(c=>c.cost_total_per_hour),type:'line',borderColor:'#6C3CE1',borderWidth:3,fill:false,pointRadius:4,pointBackgroundColor:'#6C3CE1'}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:cd.color,font:{family:cd.fontFamily,size:10}}}},scales:{x:{ticks:{color:cd.color},grid:{color:cd.gridColor},stacked:true},y:{ticks:{color:cd.color,callback:v=>'$'+v},grid:{color:cd.gridColor}}}}});
 }else if(mod==='INVEST'){
  const alts=sc.solution.alternatives||[];
  if(alts.length===0)return;
  compChartInstances['comp-'+idx]=new Chart(el,{type:'bar',data:{labels:alts.map(a=>a.name||'Alt'),datasets:[
   {label:'VAN ($)',data:alts.map(a=>parseFloat(a.van)||0),backgroundColor:alts.map((_,i)=>colors[i%4]),borderColor:alts.map((_,i)=>borders[i%4]),borderWidth:2,borderRadius:6}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:function(ctx){return 'VAN: $'+ctx.parsed.y.toLocaleString('es-AR');}}}},scales:{x:{ticks:{color:cd.color,font:{family:cd.fontFamily}},grid:{display:false}},y:{ticks:{color:cd.color,font:{family:cd.fontFamily},callback:v=>'$'+v.toLocaleString('es-AR')},grid:{color:cd.gridColor}}}}});
 }else if(mod==='LP'){
  const vars=sc.solution.variable_values||{};
  const labels=Object.keys(vars).map(v=>v.replace('x_',''));
  const values=Object.values(vars);
  compChartInstances['comp-'+idx]=new Chart(el,{type:'bar',data:{labels,datasets:[
   {label:'Producción',data:values,backgroundColor:labels.map((_,i)=>colors[i%4]),borderColor:labels.map((_,i)=>borders[i%4]),borderWidth:2,borderRadius:6}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:cd.color},grid:{display:false}},y:{ticks:{color:cd.color},grid:{color:cd.gridColor}}}}});
 }
}

updUI();

// Landing navbar: show after scrolling past hero
const landNav=document.getElementById('landNav');
const heroSection=document.querySelector('.land-hero');
if(landNav&&heroSection){
  const navObserver=new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){landNav.classList.remove('visible');}
      else{landNav.classList.add('visible');}
    });
  },{threshold:0.1});
  navObserver.observe(heroSection);
}

// Smooth scroll for nav links
document.querySelectorAll('.land-nav-links a[href^="#"]').forEach(a=>{
  a.addEventListener('click',function(e){
    e.preventDefault();
    const target=document.querySelector(this.getAttribute('href'));
    if(target)target.scrollIntoView({behavior:'smooth',block:'start'});
  });
});

// Fade-up animations on scroll
const fadeEls=document.querySelectorAll('.fade-up');
if(fadeEls.length){
  const fadeObs=new IntersectionObserver((entries)=>{
    entries.forEach(e=>{if(e.isIntersecting){e.target.classList.add('visible');fadeObs.unobserve(e.target);}});
  },{threshold:0.15});
  fadeEls.forEach(el=>fadeObs.observe(el));
}

// Floating CTA: show after scrolling past first section
const floatingCta=document.getElementById('floatingCta');
if(floatingCta){
  const ctaObs=new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){floatingCta.classList.remove('show');}
      else{floatingCta.classList.add('show');}
    });
  },{threshold:0.3});
  ctaObs.observe(heroSection);
}

// Module tab switching (landing page)
function switchModule(name){
 document.querySelectorAll('.module-content').forEach(function(el){el.style.display='none';});
 document.querySelectorAll('.module-tab').forEach(function(el){el.classList.remove('active');});
 var target=document.getElementById('mod-'+name);
 if(target){target.style.display='block';target.style.opacity='0';target.style.transition='opacity .3s';setTimeout(function(){target.style.opacity='1';},10);}
 var tab=document.querySelector('[data-module="'+name+'"]');
 if(tab)tab.classList.add('active');
}

// Hero demo rotation — cycles through 3 examples
(function(){
 const demos=[
  {tag:'📦 Inventario',q:'"Vendo 15.000 unidades/año. Cada pedido cuesta $200, almacenar $3/un/año, me cuesta $45..."',a:'<strong>Lote óptimo:</strong> 1.414 un. <strong>Frecuencia:</strong> cada 34 días. <strong>Costo anual:</strong> $677.500'},
  {tag:'💰 Rentabilidad',q:'"Vendo remeras a $2500, me cuestan $1200, costos fijos $180.000/mes. ¿Cuántas necesito vender?"',a:'<strong>Punto de equilibrio:</strong> 139 un. <strong>Margen unitario:</strong> $1.300. <strong>Margen:</strong> 52%'},
  {tag:'📈 Pronóstico',q:'"Mis ventas fueron: 120, 135, 142, 128, 155. ¿Cuánto voy a vender el próximo mes?"',a:'<strong>Mejor método:</strong> SES (α=0.3). <strong>Pronóstico:</strong> 148 un. <strong>MAD:</strong> 8.2'}
 ];
 let idx=0;
 const tagEl=document.getElementById('heroDemoTag');
 const qEl=document.getElementById('heroDemoQ');
 const aEl=document.getElementById('heroDemoA');
 const container=document.getElementById('heroDemoContent');
 if(!tagEl||!qEl||!aEl||!container)return;
 setInterval(()=>{
  idx=(idx+1)%demos.length;
  container.style.opacity='0';container.style.transition='opacity .4s';
  // Clear all animations first to prevent ghost text
  container.querySelectorAll('.demo-msg').forEach(el=>{el.style.animation='none';el.style.opacity='0';});
  const typingEl=container.querySelector('.demo-typing');
  if(typingEl){typingEl.style.animation='none';typingEl.style.opacity='0';}
  setTimeout(()=>{
   tagEl.textContent=demos[idx].tag;
   qEl.textContent=demos[idx].q;
   aEl.innerHTML=demos[idx].a;
   container.style.opacity='1';
   // Re-trigger animations cleanly
   container.querySelectorAll('.demo-msg').forEach(el=>{el.offsetHeight;el.style.opacity='0';});
   const msgs=container.querySelectorAll('.demo-msg');
   if(msgs[0]){msgs[0].style.animation='demoFadeIn .5s .3s forwards';}
   if(typingEl){typingEl.offsetHeight;typingEl.style.animation='demoFadeIn .3s 1.2s forwards,demoFadeOut .3s 2.2s forwards';}
   if(msgs[1]){msgs[1].style.animation='demoFadeIn .5s 2.5s forwards';}
  },500);
 },7000);
})();

// i18n
let currentLanguage=localStorage.getItem('invop_lang')||'es';
let currentMood='idle';
function t(key){return key;}

// ─── BLOQUE C: UX PROFESIONAL ───────────────────────────

// C1: STEPPER — Update stepper based on session stage
function updateStepper(){
 const stepper=document.getElementById('chatStepper');
 if(!stepper)return;
 const S=session;
 const stageMap={
  'detect':0,'disambiguate':0,
  'collect':1,'lp_input':1,'invest_input':1,
  'confirm':2,
  'solved':3
 };
 const currentIdx=stageMap[S.stage]!==undefined?stageMap[S.stage]:0;
 const steps=stepper.querySelectorAll('.step');
 const lines=stepper.querySelectorAll('.step-line');
 steps.forEach((step,i)=>{
  step.classList.remove('active','done','stage-transition');
  if(i<currentIdx){step.classList.add('done');}
  else if(i===currentIdx){step.classList.add('active','stage-transition');}
 });
 lines.forEach((line,i)=>{
  line.classList.remove('done');
  if(i<currentIdx)line.classList.add('done');
 });
}

// C2: TRANSITIONS — Enhanced addMsg with solve animation
const _origAddMsg=addMsg;
addMsg=function(type,html){
 const msgs=document.getElementById('msgs');
 const msg=document.createElement('div');
 msg.className=type==='u'?'msg u':'msg a';
 // Detect if this is a solve result
 const isSolveResult=type==='a'&&(html.includes('Solución encontrada')||html.includes('Recomendación:')||html.includes('Plan de Producción'));
 if(isSolveResult)msg.classList.add('solve-result');
 if(type==='u'){msg.innerHTML=`<div class="bubble">${escapeHtml(html)}</div>`;}
 else{msg.innerHTML=`<div class="mlbl">INVOP AI</div><div class="bubble">${html}</div>`;}
 msgs.appendChild(msg);
 msgs.scrollTop=msgs.scrollHeight;
};

// Show typing indicator
function showTyping(){
 const msgs=document.getElementById('msgs');
 const tip=document.createElement('div');
 tip.className='msg a';
 tip.id='typingMsg';
 tip.innerHTML='<div class="mlbl">INVOP AI</div><div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
 msgs.appendChild(tip);
 msgs.scrollTop=msgs.scrollHeight;
}
function hideTyping(){
 const tip=document.getElementById('typingMsg');
 if(tip)tip.remove();
}

// Override send() to use typing indicator and stepper
const _origSend=send;
send=function(){
 const inp=document.getElementById('inp');
 const txt=inp.value.trim();
 if(!txt)return;
 if(txt.length>2000){addMsg('a','⚠️ Mensaje demasiado largo.');return;}
 if(Date.now()-lastMsgTime<MSG_DELAY)return;
 lastMsgTime=Date.now();
 addMsg('u',txt);
 inp.value='';aRsz(inp);
 const wel=document.getElementById('wel');
 if(wel)wel.style.display='none';
 showTyping();
 setTimeout(async()=>{
  try{
   const rawResp=processMsg(txt);
   const resp=rawResp instanceof Promise?await rawResp:rawResp;
   const isGenericFallback=resp===tMsg('module_choice')||resp===tMsg('describe_problem');
   const isOffTopicQuestion=/\?$/.test(txt.trim())&&session.stage==='detect'&&!detectMod(txt).mod;
   hideTyping();
   if((isGenericFallback||isOffTopicQuestion)&&claudeFallbackEnabled!==false){
    showTyping();
    const fallback=await tryClaudeFallback(txt);
    hideTyping();
    if(fallback){
     const fullResp=fallback+'\n\n---\n_Respuesta vía IA. Para resolver un problema, describí tu caso con datos concretos._';
     session.history.push({role:'assistant',content:fullResp,timestamp:new Date().toISOString()});
     addMsg('a',mdToHtml(fullResp));
    }else{
     session.history.push({role:'assistant',content:resp,timestamp:new Date().toISOString()});
     addMsg('a',mdToHtml(resp));
    }
   }else{
    session.history.push({role:'assistant',content:resp,timestamp:new Date().toISOString()});
    addMsg('a',mdToHtml(resp));
   }
   updUI();
   updateStepper();
   updateQuickButtons();
   if(session.stage==='solved'){renderSolutionCharts();updateScenariosUI();}
  }catch(e){
   hideTyping();
   addMsg('a','❌ Error: '+e.message);
  }
 },400);
};

// C3: ONBOARDING TOUR — Spotlight-guided walkthrough for new users
const ONBOARD_STEPS=[
 {target:'.welcome .avatar-wrap',emoji:'👋',title:'¡Bienvenido a INVOP AI!',desc:'Soy tu asistente de decisiones. Te voy a guiar en un tour rápido de 30 segundos.',arrow:'bottom',pos:'above'},
 {target:'#chatStepper',emoji:'📍',title:'Tu progreso paso a paso',desc:'Esta barra te muestra dónde estás: Módulo → Datos → Confirmar → Solución. Siempre sabés qué falta.',arrow:'top',pos:'below'},
 {target:'.question-grid',emoji:'💡',title:'Elegí tu problema',desc:'7 preguntas, una para cada decisión de tu negocio. Hacé click en la que necesitás resolver.',arrow:'top',pos:'below'},
 {target:'#inp',emoji:'✍️',title:'Escribí como hablás',desc:'Describí tu problema en español. No necesitás fórmulas — INVOP AI las aplica solo.',arrow:'bottom',pos:'above'},
 {target:'.sidebar .ssec:first-child',emoji:'📂',title:'7 módulos disponibles',desc:'Producción, Inventario, Colas, Inversión, Pronósticos, Rentabilidad y Flujo de Caja. Elegí desde acá o escribí directo.',arrow:'right',pos:'right',openSidebar:true},
 {target:'#pipeP',emoji:'⚙️',title:'Pipeline inteligente',desc:'Cada problema pasa por 6 etapas automáticas: desde interpretar tu texto hasta el análisis de sensibilidad.',arrow:'right',pos:'right',showPipeline:true},
 {target:'#userPill',emoji:'👤',title:'Tu cuenta y plan',desc:'Acá ves tu nombre, plan y cuántos problemas resolviste. Con Pro tenés resolución ilimitada.',arrow:'top',pos:'below'}
];

function startOnboarding(){
 if(localStorage.getItem('invop_onboard_done'))return;
 let step=0;
 let clickblock=null;
 let spotlight=null;

 function createOverlay(){
  // Transparent click-blocker (no color — spotlight box-shadow handles the dim)
  clickblock=document.createElement('div');
  clickblock.className='onboard-clickblock';
  document.body.appendChild(clickblock);
  spotlight=document.createElement('div');
  spotlight.className='onboard-spotlight';
  document.body.appendChild(spotlight);
 }

 function buildDots(){
  let html='<div class="onboard-progress">';
  for(let i=0;i<ONBOARD_STEPS.length;i++){
   const cls=i<step?'onboard-dot done':i===step?'onboard-dot active':'onboard-dot';
   html+=`<div class="${cls}"></div>`;
  }
  html+='</div>';
  return html;
 }

 function showStep(){
  // Remove previous tip
  const old=document.querySelector('.onboard-tip');
  if(old)old.remove();

  if(step>=ONBOARD_STEPS.length){
   endOnboarding();
   return;
  }
  const s=ONBOARD_STEPS[step];

  // Scroll target into view before spotlighting
  if(s.target){
   const scrollEl=document.querySelector(s.target);
   if(scrollEl&&scrollEl.getBoundingClientRect){
    const r=scrollEl.getBoundingClientRect();
    if(r.top<0||r.bottom>window.innerHeight){
     scrollEl.scrollIntoView({behavior:'smooth',block:'center'});
    }
   }
  }

  // Open sidebar if needed
  if(s.openSidebar){
   const sb=document.getElementById('sidebarEl');
   if(sb&&!sb.classList.contains('open')&&window.innerWidth<=1024){
    sb.classList.add('open');
    document.getElementById('sidebarBackdrop').classList.add('show');
   }
  }
  // Show pipeline section if needed
  if(s.showPipeline){
   const pp=document.getElementById('pipeP');
   if(pp)pp.style.display='block';
  }

  const el=document.querySelector(s.target);
  if(!el||el.offsetParent===null){step++;showStep();return;}

  const rect=el.getBoundingClientRect();
  const pad=8;

  // Position spotlight
  spotlight.style.top=(rect.top-pad)+'px';
  spotlight.style.left=(rect.left-pad)+'px';
  spotlight.style.width=(rect.width+pad*2)+'px';
  spotlight.style.height=(rect.height+pad*2)+'px';

  // Create tip
  const tip=document.createElement('div');
  const isLast=step>=ONBOARD_STEPS.length-1;
  tip.className='onboard-tip arrow-'+s.arrow;
  tip.innerHTML=`${buildDots()}<span class="onboard-emoji">${s.emoji||''}</span><h4>${s.title}</h4><p>${s.desc}</p><div class="tip-actions"><button class="tip-skip" onclick="endOnboarding()">Saltar tour</button><button class="tip-next" onclick="nextOnboardStep()">${isLast?'¡Listo! →':'Siguiente →'}</button></div>`;

  document.body.appendChild(tip);

  // Position tip relative to element
  const tipRect=tip.getBoundingClientRect();
  let top,left;
  if(s.pos==='above'){
   top=rect.top-tipRect.height-16;
   left=rect.left+rect.width/2-tipRect.width/2;
  }else if(s.pos==='right'){
   top=rect.top+rect.height/2-tipRect.height/2;
   left=rect.right+16;
  }else{// below
   top=rect.bottom+16;
   left=rect.left+rect.width/2-tipRect.width/2;
  }
  // Clamp to viewport
  left=Math.max(12,Math.min(left,window.innerWidth-tipRect.width-12));
  top=Math.max(12,Math.min(top,window.innerHeight-tipRect.height-12));
  tip.style.top=top+'px';
  tip.style.left=left+'px';
 }

 window.nextOnboardStep=function(){
  step++;
  showStep();
 };

 window.endOnboarding=function(){
  // Remove ALL onboarding elements (brute-force cleanup)
  document.querySelectorAll('.onboard-tip,.onboard-clickblock,.onboard-spotlight').forEach(function(el){el.remove();});
  clickblock=null;
  spotlight=null;
  localStorage.setItem('invop_onboard_done','1');
  // Remove keyboard handler
  if(window._onboardKeyHandler){
   document.removeEventListener('keydown',window._onboardKeyHandler);
   window._onboardKeyHandler=null;
  }
  // Reset sidebar state
  const sb=document.getElementById('sidebarEl');
  if(sb&&sb.classList.contains('open')&&window.innerWidth<=1024){
   sb.classList.remove('open');
   document.getElementById('sidebarBackdrop').classList.remove('show');
  }
  // Pulse the input to guide user
  const inp=document.getElementById('inp');
  if(inp){
   inp.placeholder='¡Listo! Escribí tu primer problema acá...';
   inp.focus();
   inp.style.boxShadow='0 0 0 2px var(--ac)';
   setTimeout(function(){inp.style.boxShadow='';},2000);
  }
 };

 // Keyboard support: Enter/Right = next, Esc = skip
 window._onboardKeyHandler=function(e){
  if(!document.querySelector('.onboard-tip'))return;
  if(e.key==='Escape'){endOnboarding();return;}
  if(e.key==='ArrowRight'||e.key==='Enter')window.nextOnboardStep();
 };
 document.addEventListener('keydown',window._onboardKeyHandler);

 createOverlay();
 setTimeout(showStep,600);
}

// C4: MOBILE — Sidebar toggle
function toggleSidebar(){
 const sb=document.getElementById('sidebarEl');
 const bd=document.getElementById('sidebarBackdrop');
 if(!sb)return;
 const isOpen=sb.classList.contains('open');
 if(isOpen){sb.classList.remove('open');bd.classList.remove('show');}
 else{sb.classList.add('open');bd.classList.add('show');}
}

// Hook into enterApp to trigger onboarding
const _origEnterApp=enterApp;
enterApp=function(){
 _origEnterApp();
 updateStepper();
 setTimeout(startOnboarding,500);
};

// Also trigger onboarding for enterAppGuest
const _origEnterAppGuest=enterAppGuest;
enterAppGuest=function(){
 _origEnterAppGuest();
 updateStepper();
 setTimeout(startOnboarding,500);
};

// ─── BLOQUE D: ROBUSTEZ TÉCNICA ─────────────────────────

// D1: ERROR HANDLING — Global error catcher + graceful degradation
window.onerror=function(msg,src,line,col,err){
 console.error('[INVOP Error]',msg,'at',src,line);
 // Show user-friendly message only if in app mode
 if(document.body.classList.contains('app-mode')){
  const msgs=document.getElementById('msgs');
  if(msgs&&msgs.children.length>0){
   // Don't spam errors — only show if last msg isn't already an error
   const last=msgs.lastElementChild;
   if(!last||!last.innerHTML.includes('Error interno')){
    addMsg('a','⚠️ <strong>Error interno.</strong> Intentá de nuevo. Si persiste, recargá la página.');
   }
  }
 }
 return true; // Prevent default browser error
};

window.addEventListener('unhandledrejection',function(e){
 console.error('[INVOP Promise Error]',e.reason);
 e.preventDefault();
});

// D1: Safe processMsg wrapper
const _origProcessMsg=processMsg;
processMsg=function(txt){
 try{
  return _origProcessMsg(txt);
 }catch(e){
  console.error('[processMsg Error]',e);
  session.stage=session.stage||'detect';
  return '⚠️ Ocurrió un error al procesar tu mensaje. Intentá reformularlo o iniciá un **nuevo problema**.';
 }
};

// D1: Safe solver wrappers
const _origDoSolve=doSolve;
doSolve=function(){
 try{
  return _origDoSolve();
 }catch(e){
  console.error('[doSolve Error]',e);
  session.stage='collect';
  return '❌ Error al resolver: '+e.message+'\n\nRevisá los datos e intentá de nuevo.';
 }
};

// D2: SESSION PERSISTENCE — Save/restore to sessionStorage
const SESSION_KEY='invop_session_v2';

function saveSession(){
 try{
  const data={
   module:session.module,
   subtype:session.subtype,
   params:session.params,
   assumptions:session.assumptions,
   stage:session.stage,
   history:session.history.slice(-20), // Keep last 20 messages
   solution:null, // Don't persist solution (too big)
   _sessionId:window._sessionId,
   _savedAt:Date.now()
  };
  sessionStorage.setItem(SESSION_KEY,JSON.stringify(data));
 }catch(e){
  // sessionStorage full or unavailable — silently fail
  console.warn('[Session save failed]',e.message);
 }
}

function restoreSession(){
 try{
  const raw=sessionStorage.getItem(SESSION_KEY);
  if(!raw)return false;
  const data=JSON.parse(raw);
  // Only restore if saved less than 30 minutes ago
  if(Date.now()-data._savedAt>30*60*1000){
   sessionStorage.removeItem(SESSION_KEY);
   return false;
  }
  session.module=data.module;
  session.subtype=data.subtype;
  session.params=data.params||{};
  session.assumptions=data.assumptions||[];
  session.stage=data.stage||'detect';
  session.history=data.history||[];
  if(data._sessionId)window._sessionId=data._sessionId;
  return true;
 }catch(e){
  console.warn('[Session restore failed]',e.message);
  return false;
 }
}

// Auto-save after each message
const _origUpdUI=updUI;
updUI=function(){
 _origUpdUI();
 saveSession();
};

// Restore session on app enter if available
const _origEnterApp2=enterApp;
enterApp=function(){
 _origEnterApp2();
 if(restoreSession()&&session.history.length>0){
  // Replay last messages in chat
  const msgs=document.getElementById('msgs');
  const wel=document.getElementById('wel');
  if(wel)wel.style.display='none';
  session.history.slice(-10).forEach(h=>{
   if(h.role==='user')addMsg('u',h.content);
   else addMsg('a',mdToHtml(h.content));
  });
  updUI();
  updateStepper();
  updateQuickButtons();
  console.log('[Session restored]',session.stage,session.module);
 }
};

// D3: RATE LIMITING — Enhanced frontend + backend awareness
const RATE_LIMIT={
 minDelay:800,       // ms between messages
 maxPerMinute:15,    // max messages per minute
 maxPerSession:200,  // max messages per session total
 _timestamps:[],
 _total:0,
 check:function(){
  const now=Date.now();
  // Clean old timestamps (>60s)
  this._timestamps=this._timestamps.filter(t=>now-t<60000);
  // Check per-minute
  if(this._timestamps.length>=this.maxPerMinute){
   return{ok:false,msg:'⏳ Demasiados mensajes. Esperá un momento antes de enviar otro.'};
  }
  // Check total session
  this._total++;
  if(this._total>this.maxPerSession){
   return{ok:false,msg:'🔒 Límite de mensajes por sesión alcanzado. Recargá la página para continuar.'};
  }
  // Check min delay
  if(this._timestamps.length>0&&now-this._timestamps[this._timestamps.length-1]<this.minDelay){
   return{ok:false,msg:null}; // Silent reject
  }
  this._timestamps.push(now);
  return{ok:true};
 }
};

// Patch send to use enhanced rate limiting
const _origSend2=send;
send=function(){
 const inp=document.getElementById('inp');
 const txt=(inp.value||'').trim();
 if(!txt)return;
 const rl=RATE_LIMIT.check();
 if(!rl.ok){
  if(rl.msg)addMsg('a',rl.msg);
  return;
 }
 _origSend2();
};

// D4: INPUT SANITIZATION & DEFENSIVE VALIDATION
// Sanitize: max length, strip control chars, basic XSS prevention
function sanitizeInput(txt){
 if(!txt||typeof txt!=='string')return '';
 // Strip null bytes and control characters (keep newlines/tabs)
 let clean=txt.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,'');
 // Limit length
 if(clean.length>3000)clean=clean.substring(0,3000);
 return clean.trim();
}

// Patch processMsg to sanitize input
const _origProcessMsg2=processMsg;
processMsg=function(txt){
 return _origProcessMsg2(sanitizeInput(txt));
};

// Defensive: protect against prototype pollution in params
function safeAssign(target,source){
 if(!source||typeof source!=='object')return target;
 for(const key of Object.keys(source)){
  if(key==='__proto__'||key==='constructor'||key==='prototype')continue;
  if(source[key]!==undefined&&source[key]!==null){
   target[key]=source[key];
  }
 }
 return target;
}

// D4: Validate numeric params before solving
const _origValidateModel=validateModel;
validateModel=function(S){
 const warns=_origValidateModel(S);
 const p=S.params;
 // Extra validation: check for NaN/Infinity
 for(const[key,val]of Object.entries(p)){
  if(typeof val==='number'&&(isNaN(val)||!isFinite(val))){
   warns.push('Parámetro '+key+' tiene un valor inválido. Se necesita un número real.');
   p[key]=0;
  }
 }
 // Check for unreasonable values
 if(S.module==='STOCK'){
  if(p.demand_D>1e12)warns.push('Demanda extremadamente alta. Verificá el valor.');
  if(p.order_cost_k>1e9)warns.push('Costo de pedido extremadamente alto.');
 }
 if(S.module==='QUEUE'){
  if(p.arrival_rate_lambda>1e6)warns.push('Tasa de llegada extremadamente alta.');
  if(p.num_servers_M>100)warns.push('Más de 100 servidores. ¿Es correcto?');
 }
 return warns;
};

// D5: QA — Automated solver tests (run in console with invopQA())
window.invopQA=function(){
 const results=[];
 function test(name,fn){
  try{
   const r=fn();
   results.push({name,status:r?'PASS':'FAIL',detail:r});
  }catch(e){
   results.push({name,status:'ERROR',detail:e.message});
  }
 }

 // STOCK tests
 test('STOCK: EOQ básico',()=>{
  const r=STOCK.solve({demand_D:15000,order_cost_k:200,holding_cost_c1:3,acquisition_cost_b:45,planning_horizon_T:1});
  return r.status==='ÓPTIMO'&&r.results.qo>0&&r.results.CTE>0;
 });
 test('STOCK: EOQ con faltante',()=>{
  const r=STOCK.solve({demand_D:10000,order_cost_k:150,holding_cost_c1:5,acquisition_cost_b:30,shortage_cost_c2:8,planning_horizon_T:1});
  return r.status==='ÓPTIMO'&&r.results.So>0;
 });
 test('STOCK: demanda cero → error',()=>{
  const r=STOCK.solve({demand_D:0,order_cost_k:100,holding_cost_c1:2,acquisition_cost_b:10});
  return r.status==='ERROR';
 });
 test('STOCK: costo negativo → error',()=>{
  const r=STOCK.solve({demand_D:1000,order_cost_k:100,holding_cost_c1:-5,acquisition_cost_b:10});
  return r.status==='ERROR';
 });

 // QUEUE tests
 test('QUEUE: M/M/1 estable',()=>{
  const r=QUEUE.solve({arrival_rate_lambda:10,service_rate_mu:15,num_servers_M:1});
  return r.status==='ÓPTIMO'&&r.model==='M/M/1'&&r.results.rho<1;
 });
 test('QUEUE: M/M/1 inestable',()=>{
  const r=QUEUE.solve({arrival_rate_lambda:20,service_rate_mu:15,num_servers_M:1});
  return r.status==='INESTABLE';
 });
 test('QUEUE: M/M/M con 3 servidores',()=>{
  const r=QUEUE.solve({arrival_rate_lambda:18,service_rate_mu:4,num_servers_M:5});
  return r.status==='ÓPTIMO'&&r.model==='M/M/M';
 });
 test('QUEUE: M/M/1/N capacidad finita',()=>{
  const r=QUEUE.solve({arrival_rate_lambda:10,service_rate_mu:8,num_servers_M:1,system_capacity_N:10});
  return r.status==='ÓPTIMO'&&r.model==='M/M/1/N';
 });
 test('QUEUE: análisis económico',()=>{
  const r=QUEUE.solve({arrival_rate_lambda:18,service_rate_mu:4,num_servers_M:5,cost_per_wait_ce:25,cost_per_server_cs:40});
  return r.economic_analysis&&r.economic_analysis.optimal_M>0;
 });

 // LP tests
 test('LP: panadería clásica',()=>{
  const r=LP.solve({
   objective_type:'MAX',
   objective_coefficients:{x_pan:0.6,x_medialuna:0.8,x_torta:7},
   constraints:[
    {name:'harina',coeffs:{x_pan:0.5,x_medialuna:0.1,x_torta:2},sense:'<=',rhs:100},
    {name:'azúcar',coeffs:{x_pan:0.05,x_medialuna:0.08,x_torta:1},sense:'<=',rhs:30},
    {name:'manteca',coeffs:{x_pan:0.01,x_medialuna:0.04,x_torta:0.5},sense:'<=',rhs:50}
   ]
  });
  return r.status==='ÓPTIMO'&&r.objective_value>0;
 });
 test('LP: infactible',()=>{
  const r=LP.solve({
   objective_type:'MAX',
   objective_coefficients:{x_a:1},
   constraints:[
    {name:'r1',coeffs:{x_a:1},sense:'<=',rhs:10},
    {name:'r2',coeffs:{x_a:-1},sense:'<=',rhs:-20}
   ]
  });
  return r.status==='INFACTIBLE';
 });
 test('LP: MIN objetivo',()=>{
  const r=LP.solve({
   objective_type:'MIN',
   objective_coefficients:{x_a:3,x_b:5},
   constraints:[
    {name:'r1',coeffs:{x_a:1,x_b:0},sense:'>=',rhs:4},
    {name:'r2',coeffs:{x_a:0,x_b:1},sense:'>=',rhs:6}
   ]
  });
  return r.status==='ÓPTIMO'&&r.objective_value>0;
 });

 // Detection tests
 test('DETECT: stock problem',()=>{
  const d=detectMod('Vendo 15000 unidades por año, cada pedido cuesta $200');
  return d.mod==='STOCK'&&d.conf>0.3;
 });
 test('DETECT: queue problem',()=>{
  const d=detectMod('Llegan 18 pacientes por hora y cada médico tarda 15 minutos');
  return d.mod==='QUEUE'&&d.conf>0.3;
 });
 test('DETECT: LP problem',()=>{
  const d=detectMod('Quiero maximizar la ganancia de producción con restricciones de harina y azúcar');
  return d.mod==='LP'&&d.conf>0.3;
 });

 // Sanitization tests
 test('SANITIZE: strips control chars',()=>{
  const r=sanitizeInput('hola\x00mundo\x07test');
  return r==='holamundotest';
 });
 test('SANITIZE: max length',()=>{
  const r=sanitizeInput('a'.repeat(5000));
  return r.length===3000;
 });
 test('SANITIZE: empty/null',()=>{
  return sanitizeInput('')===''&&sanitizeInput(null)===''&&sanitizeInput(undefined)==='';
 });

 // Rate limit test
 test('RATE_LIMIT: object exists',()=>{
  return typeof RATE_LIMIT==='object'&&typeof RATE_LIMIT.check==='function';
 });

 // Print results
 console.log('\\n===== INVOP QA RESULTS =====');
 let pass=0,fail=0,err=0;
 results.forEach(r=>{
  const icon=r.status==='PASS'?'[OK]':r.status==='FAIL'?'[FAIL]':'[ERR]';
  console.log(icon+' '+r.name+(r.status!=='PASS'?' → '+r.detail:''));
  if(r.status==='PASS')pass++;
  else if(r.status==='FAIL')fail++;
  else err++;
 });
 console.log('\\nTotal: '+pass+' passed, '+fail+' failed, '+err+' errors out of '+results.length+' tests');
 console.log('============================\\n');
 return {pass,fail,err,total:results.length,results};
};

console.log('[INVOP AI] Bloque D loaded. Run invopQA() in console for tests.');

// ─── BLOQUE E: UX NAVIGATION & SCROLL IMPROVEMENTS ────────

// E1: SIDEBAR AUTO-CLOSE ON MOBILE after module selection
(function(){
 const _origSelMod=selMod;
 selMod=function(m){
  _origSelMod(m);
  // Auto-close sidebar on mobile
  if(window.innerWidth<=768){
   const sb=document.getElementById('sidebarEl');
   const bd=document.getElementById('sidebarBackdrop');
   if(sb&&sb.classList.contains('open')){
    sb.classList.remove('open');
    if(bd)bd.classList.remove('show');
   }
   // Focus input after short delay
   setTimeout(function(){
    var inp=document.getElementById('inp');
    if(inp)inp.focus();
   },350);
  }
 };
 // Also auto-close on mcard click
 document.addEventListener('click',function(e){
  var mcard=e.target.closest('.mcard');
  if(!mcard||window.innerWidth>768)return;
  setTimeout(function(){
   var sb=document.getElementById('sidebarEl');
   var bd=document.getElementById('sidebarBackdrop');
   if(sb&&sb.classList.contains('open')){
    sb.classList.remove('open');
    if(bd)bd.classList.remove('show');
   }
  },150);
 });
})();

// E2: SWIPE GESTURES FOR SIDEBAR
(function(){
 var touchStartX=0,touchStartY=0,touchStartTime=0,swiping=false;
 var SWIPE_THRESHOLD=60,SWIPE_MAX_Y=80,SWIPE_MAX_TIME=400;
 document.addEventListener('touchstart',function(e){
  if(!document.body.classList.contains('app-mode'))return;
  if(window.innerWidth>768)return;
  var t=e.touches[0];
  touchStartX=t.clientX;touchStartY=t.clientY;touchStartTime=Date.now();swiping=true;
 },{passive:true});
 document.addEventListener('touchend',function(e){
  if(!swiping)return;swiping=false;
  if(window.innerWidth>768)return;
  var t=e.changedTouches[0];
  var dx=t.clientX-touchStartX;
  var dy=Math.abs(t.clientY-touchStartY);
  var dt=Date.now()-touchStartTime;
  if(dy>SWIPE_MAX_Y||dt>SWIPE_MAX_TIME)return;
  var sb=document.getElementById('sidebarEl');
  var bd=document.getElementById('sidebarBackdrop');
  if(!sb)return;
  var isOpen=sb.classList.contains('open');
  // Swipe right to open (from left edge only)
  if(dx>SWIPE_THRESHOLD&&!isOpen&&touchStartX<40){
   sb.classList.add('open');if(bd)bd.classList.add('show');
  }
  // Swipe left to close
  if(dx<-SWIPE_THRESHOLD&&isOpen){
   sb.classList.remove('open');if(bd)bd.classList.remove('show');
  }
 },{passive:true});
})();

// E3: SCROLL-TO-BOTTOM FLOATING BUTTON
function scrollChatBottom(){
 var msgs=document.getElementById('msgs');
 if(msgs)msgs.scrollTo({top:msgs.scrollHeight,behavior:'smooth'});
}
(function(){
 var msgs=document.getElementById('msgs');
 var btn=document.getElementById('scrollBottomBtn');
 if(!msgs||!btn)return;
 var _checkScroll=function(){
  var distFromBottom=msgs.scrollHeight-msgs.scrollTop-msgs.clientHeight;
  if(distFromBottom>150){btn.classList.add('show');}
  else{btn.classList.remove('show');}
 };
 msgs.addEventListener('scroll',_checkScroll,{passive:true});
 // Re-check after messages added
 var _obs=new MutationObserver(_checkScroll);
 _obs.observe(msgs,{childList:true,subtree:true});
})();

// E4: BACK-TO-TOP BUTTON (landing page)
(function(){
 var btt=document.getElementById('backToTop');
 if(!btt)return;
 window.addEventListener('scroll',function(){
  if(document.body.classList.contains('app-mode'))return;
  if(window.scrollY>400){btt.classList.add('show');}
  else{btt.classList.remove('show');}
 },{passive:true});
})();

// E5: CHARTS SCROLL-INTO-VIEW after render
(function(){
 var _origRenderCharts=renderSolutionCharts;
 renderSolutionCharts=function(){
  _origRenderCharts();
  // After chart renders, scroll last chart into view
  setTimeout(function(){
   var charts=document.querySelectorAll('.chart-container canvas');
   if(charts.length>0){
    var last=charts[charts.length-1].closest('.chart-container')||charts[charts.length-1];
    last.scrollIntoView({behavior:'smooth',block:'center'});
   }
  },600);
 };
})();

// E6: INPUT SCROLL-INTO-VIEW ON MOBILE KEYBOARD
(function(){
 var inp=document.getElementById('inp');
 if(!inp)return;
 inp.addEventListener('focus',function(){
  if(window.innerWidth>768)return;
  // Small delay for keyboard to appear
  setTimeout(function(){
   inp.scrollIntoView({behavior:'smooth',block:'end'});
  },350);
 });
})();

// E7: MODAL BODY SCROLL LOCK
(function(){
 var _origShowModal=showModal;
 showModal=function(id){
  // Save scroll position before locking
  document.documentElement.style.setProperty('--scroll-y','-'+window.scrollY+'px');
  document.body.classList.add('modal-open');
  _origShowModal(id);
 };
 var _origCloseModal=closeModal;
 closeModal=function(id){
  _origCloseModal(id);
  // Restore scroll after modal closes
  setTimeout(function(){
   // Only unlock if no other modals are open
   var anyOpen=document.querySelector('.modal.show');
   if(!anyOpen){
    document.body.classList.remove('modal-open');
    var scrollY=document.documentElement.style.getPropertyValue('--scroll-y');
    document.documentElement.style.removeProperty('--scroll-y');
    window.scrollTo(0,parseInt(scrollY||'0')*-1);
   }
  },350);
 };
})();

// E8: ONBOARDING SCROLL-TO-TARGET → patched inline in showStep() above

console.log('[INVOP AI] Bloque E loaded — UX navigation improvements active.');

// ═══════════════════════════════════════════════════════════
// BLOQUE F — Shopify + AI + Plans Integration
// ═══════════════════════════════════════════════════════════

// F1: PLAN UI — badge, sidebar sections
function updatePlanUI(){
 var plan=getUserPlan();
 var badge=document.getElementById('planBadge');
 if(badge){
  badge.className='plan-badge '+plan;
  badge.textContent=plan==='free'?'FREE':plan.toUpperCase();
 }
 // Show Shopify section always, but locked for non-Pro
 var shopSec=document.getElementById('shopifySection');
 var lockOverlay=document.getElementById('proLockOverlay');
 var lockWrap=document.getElementById('shopifyPanelContent');
 if(shopSec){
  shopSec.style.display='block';
  if(plan==='pro'){
   if(lockOverlay)lockOverlay.style.display='none';
   if(lockWrap)lockWrap.classList.remove('locked');
  }else{
   if(lockOverlay)lockOverlay.style.display='flex';
   if(lockWrap)lockWrap.classList.add('locked');
  }
 }
 // Update connected store UI if we have store data
 var storeData=getShopifyStore();
 if(storeData&&plan==='pro'){
  showConnectedStore(storeData);
  // Background refresh: if last sync > 1h, pull fresh data from Supabase
  if(storeData.shop_domain&&INVOP_CONFIG.API_BASE){
   var lastS=storeData.last_sync?new Date(storeData.last_sync).getTime():0;
   if(Date.now()-lastS>3600000){
    loadShopifyStoreData(storeData.shop_domain);
   }
  }
 }
}

// F2: SHOPIFY STORE PERSISTENCE
function getShopifyStore(){try{return JSON.parse(localStorage.getItem('invop_shopify_store'));}catch(e){return null;}}
function setShopifyStore(s){localStorage.setItem('invop_shopify_store',JSON.stringify(s));}

function showConnectedStore(store){
 var nc=document.getElementById('shopifyNotConnected');
 var cc=document.getElementById('shopifyConnected');
 if(nc)nc.style.display='none';
 if(cc)cc.style.display='block';
 var nameEl=document.getElementById('shopStoreName');
 if(nameEl)nameEl.textContent=store.shop_domain||'Tu tienda';
 var prodEl=document.getElementById('shopProductCount');
 if(prodEl)prodEl.textContent=store.product_count||'0';
 var ordEl=document.getElementById('shopOrderCount');
 if(ordEl)ordEl.textContent=store.order_count||'0';
 var statusEl=document.getElementById('shopSyncStatus');
 if(statusEl){
  var ago=store.last_sync?_timeAgo(new Date(store.last_sync)):'Nunca';
  statusEl.textContent='Sync: '+ago;
 }
}

function _timeAgo(date){
 var s=Math.floor((Date.now()-date.getTime())/1000);
 if(s<60)return 'hace '+s+'s';
 if(s<3600)return 'hace '+Math.floor(s/60)+'m';
 if(s<86400)return 'hace '+Math.floor(s/3600)+'h';
 return 'hace '+Math.floor(s/86400)+'d';
}

// F2b: RE-SYNC SHOPIFY DATA
function resyncShopify(){
 var store=getShopifyStore();
 var u=getUser();
 if(!store||!u||!u.email||!INVOP_CONFIG.API_BASE)return;

 var btn=document.getElementById('resyncBtn');
 var feedback=document.getElementById('syncFeedback');
 if(btn){btn.disabled=true;btn.textContent='⏳';}
 if(feedback){feedback.style.display='block';feedback.textContent='Sincronizando con Shopify...';}

 fetch(INVOP_CONFIG.API_BASE+'/api/shopify/sync',{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({shop:store.shop_domain,email:u.email})
 })
 .then(function(r){return r.json().then(function(d){return{ok:r.ok,status:r.status,data:d};});})
 .then(function(res){
  if(btn){btn.disabled=false;btn.textContent='🔄';}
  if(res.ok&&res.data.success){
   // Update local store data
   store.product_count=res.data.synced.products;
   store.order_count=res.data.synced.orders;
   store.last_sync=res.data.last_sync;
   setShopifyStore(store);
   showConnectedStore(store);
   if(feedback){feedback.textContent='✅ '+res.data.synced.products+' productos, '+res.data.synced.orders+' órdenes';feedback.style.color='var(--ac)';}
   setTimeout(function(){if(feedback){feedback.style.display='none';feedback.style.color='var(--ts)';}},4000);
  } else if(res.status===429){
   if(feedback){feedback.textContent='⏳ '+res.data.message;feedback.style.color='var(--wr)';}
   setTimeout(function(){if(feedback){feedback.style.display='none';feedback.style.color='var(--ts)';}},4000);
  } else {
   if(feedback){feedback.textContent='❌ '+(res.data.error||'Error al sincronizar');feedback.style.color='var(--dn)';}
   setTimeout(function(){if(feedback){feedback.style.display='none';feedback.style.color='var(--ts)';}},5000);
  }
 })
 .catch(function(e){
  if(btn){btn.disabled=false;btn.textContent='🔄';}
  if(feedback){feedback.textContent='❌ Error de conexión';feedback.style.color='var(--dn)';feedback.style.display='block';}
  setTimeout(function(){if(feedback){feedback.style.display='none';feedback.style.color='var(--ts)';}},5000);
 });
}

// F3: SHOPIFY OAUTH FLOW
function startShopifyOAuth(){
 var input=document.getElementById('shopDomainInput');
 var shop=(input?input.value:'').trim().toLowerCase().replace(/\.myshopify\.com$/,'');
 if(!shop){
  input.style.borderColor='var(--dn)';
  input.focus();
  return;
 }
 input.style.borderColor='';
 var u=getUser();
 if(!u||!u.email){
  closeModal('shopifyModal');
  showModal('authModal');
  window._pendingShopify=shop;
  return;
 }
 // If API_BASE is configured, use OAuth flow
 if(INVOP_CONFIG.API_BASE){
  var userEmail=(window._invopUser&&window._invopUser.email)||localStorage.getItem('invop_email')||'tmichelich@gmail.com';
  var url=INVOP_CONFIG.API_BASE+'/api/shopify/auth?shop='+encodeURIComponent(shop+'.myshopify.com')+'&email='+encodeURIComponent(userEmail);
  window.location.href=url;
 } else {
  // Demo/fallback — simulate connection
  closeModal('shopifyModal');
  var demoStore={shop_domain:shop+'.myshopify.com',product_count:0,order_count:0,last_sync:null,store_id:'demo'};
  setShopifyStore(demoStore);
  showConnectedStore(demoStore);
  alert('Shopify OAuth requiere la plataforma deployada en Vercel.\nSe guardó la config para cuando esté lista.');
 }
}

// F4: AI ANALYSIS — redirect to smart analyzer
function runAIAnalysis(){ autoAnalyzeShopify(); }
function _legacyRunAIAnalysis(){
 var store=getShopifyStore();
 var u=getUser();
 if(!store||!u)return;
 if(!INVOP_CONFIG.API_BASE){
  alert('AI Analysis requiere la plataforma deployada en Vercel.');
  return;
 }
 showModal('aiAnalysisModal');
 fetch(INVOP_CONFIG.API_BASE+'/api/ai/analyze',{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({store_id:store.store_id,user_id:u.id||u.email,modules:['STOCK','FORECAST','RENTABILIDAD','FLUJO_CAJA']})
 })
 .then(function(r){return r.json();})
 .then(function(data){
  if(data.error){throw new Error(data.error);}
  renderAIAnalysis(data.analysis);
 })
 .catch(function(err){
  var el=document.getElementById('aiAnalysisContent');
  if(el)el.innerHTML='<div style="text-align:center;padding:1.5rem"><p style="color:var(--dn);font-size:.85rem">Error: '+err.message+'</p><button class="shopify-connect-btn" style="margin-top:1rem;max-width:200px" onclick="closeModal(\'aiAnalysisModal\')">Cerrar</button></div>';
 });
}

function renderAIAnalysis(analysis){
 var el=document.getElementById('aiAnalysisContent');
 if(!el||!analysis)return;
 var html='';
 // General insights
 if(analysis.general_insights){
  html+='<div class="ai-insight-card" style="border-color:var(--ac)"><h5>📊 Resumen General</h5><p>'+analysis.general_insights+'</p></div>';
 }
 // Module insights
 if(analysis.modules){
  for(var i=0;i<analysis.modules.length;i++){
   var mod=analysis.modules[i];
   if(!mod.applicable)continue;
   var icons={STOCK:'📦',FORECAST:'📈',RENTABILIDAD:'💰',FLUJO_CAJA:'💵'};
   var tagClass=mod.priority==='high'?'high':mod.priority==='medium'?'medium':'low';
   html+='<div class="ai-insight-card"><h5>'+(icons[mod.module]||'🔧')+' '+mod.module+'</h5>';
   html+='<p>'+mod.insights+'</p>';
   html+='<span class="insight-tag '+tagClass+'">Prioridad: '+mod.priority+'</span>';
   html+='<button class="shopify-connect-btn" style="margin-top:.5rem;background:linear-gradient(135deg,var(--p),var(--ac));font-size:.72rem;padding:.4rem" onclick="closeModal(\'aiAnalysisModal\');loadAIModule(\''+mod.module+'\','+JSON.stringify(JSON.stringify(mod.inputs))+')">Resolver con estos datos</button>';
   html+='</div>';
  }
 }
 // Recommendations
 if(analysis.recommendations&&analysis.recommendations.length){
  html+='<div class="ai-insight-card"><h5>💡 Recomendaciones</h5><ul style="margin:.5rem 0;padding-left:1.2rem">';
  for(var r=0;r<analysis.recommendations.length;r++){
   html+='<li style="font-size:.78rem;color:var(--ts);margin:.3rem 0">'+analysis.recommendations[r]+'</li>';
  }
  html+='</ul></div>';
 }
 html+='<button class="shopify-connect-btn" style="margin-top:1rem;background:var(--card);border:1px solid var(--bd);color:var(--tx)" onclick="closeModal(\'aiAnalysisModal\')">Cerrar</button>';
 el.innerHTML=html;
 // Also render insights in sidebar
 renderSidebarInsights(analysis);
}

function renderSidebarInsights(analysis){
 var container=document.getElementById('aiInsightsContainer');
 if(!container||!analysis||!analysis.modules)return;
 var html='';
 for(var i=0;i<analysis.modules.length;i++){
  var mod=analysis.modules[i];
  if(!mod.applicable)continue;
  var icons={STOCK:'📦',FORECAST:'📈',RENTABILIDAD:'💰',FLUJO_CAJA:'💵'};
  var tagClass=mod.priority==='high'?'high':mod.priority==='medium'?'medium':'low';
  html+='<div class="ai-insight-card" style="cursor:pointer" onclick="loadAIModule(\''+mod.module+'\','+JSON.stringify(JSON.stringify(mod.inputs))+')">';
  html+='<h5>'+(icons[mod.module]||'🔧')+' '+mod.module+'</h5>';
  html+='<p style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">'+mod.insights+'</p>';
  html+='<span class="insight-tag '+tagClass+'">'+mod.priority+'</span>';
  html+='</div>';
 }
 container.innerHTML=html;
}

function loadAIModule(moduleName,inputsStr){
 // Parse AI inputs
 var inputs;
 try{inputs=JSON.parse(inputsStr);}catch(e){inputs=null;}
 if(!inputs){addMsg('a','❌ Error al cargar datos del análisis.');return;}

 // Close AI modal
 closeModal('aiAnalysisModal');

 // Setup UI: select module in sidebar, hide welcome, show chat
 document.querySelectorAll('.mcard').forEach(function(c){c.classList.remove('sel');});
 var card=document.querySelector('[data-m="'+moduleName+'"]');
 if(card)card.classList.add('sel');
 var wel=document.getElementById('wel');
 if(wel){wel.style.display='none';}
 var bb=document.getElementById('backBtn');
 if(bb)bb.style.display='inline-block';
 var msgs=document.getElementById('msgs');
 if(msgs)msgs.querySelectorAll('.msg').forEach(function(m){m.remove();});

 // Map AI engine data → solver params format
 var params={};
 var summary='';

 if(moduleName==='STOCK'&&inputs.D){
  params={
   demand_D:inputs.D,
   order_cost_k:inputs.K,
   holding_cost_c1:inputs.h,
   acquisition_cost_b:inputs.cost||0,
   planning_horizon_T:1,
   lead_time_LT:inputs.L||0,
   safety_stock_Sp:0
  };
  summary='**📦 Inventario — '+( inputs.product_name||'Producto')+' **\n\n'+
   '| Parámetro | Valor |\n|---|---|\n'+
   '| Demanda anual | '+(+inputs.D).toLocaleString('es-AR')+' un |\n'+
   '| Costo de pedido | $'+(+inputs.K).toLocaleString('es-AR')+' |\n'+
   '| Costo almacenamiento | $'+r2(inputs.h)+'/un/año |\n'+
   '| Lead time | '+(inputs.L||0)+' días |\n\n'+
   '_Datos de Shopify AI._ ¿Confirmo y resuelvo? Escribí **sí** o ajustá algún dato.';
 }
 else if(moduleName==='RENTABILIDAD'&&inputs.products){
  params={
   products:inputs.products.map(function(p){
    return{name:p.name,price:p.price_venta||p.price||0,unit_cost:p.cost||p.unit_cost||0,quantity:p.volume||p.quantity||0};
   }),
   fixed_costs:inputs.fixed_costs||0
  };
  var nProds=params.products.length;
  var withCost=params.products.filter(function(p){return p.unit_cost>0;}).length;
  summary='**💰 Rentabilidad — '+nProds+' productos**\n\n'+
   '| Producto | Precio | Costo | Cantidad |\n|---|---|---|---|\n'+
   params.products.slice(0,8).map(function(p){
    return'| '+p.name+' | $'+r2(p.price)+' | '+(p.unit_cost>0?'$'+r2(p.unit_cost):'❌ falta')+' | '+r0(p.quantity)+' |';
   }).join('\n')+
   (nProds>8?'\n| ... y '+(nProds-8)+' más | | | |':'')+'\n\n'+
   (inputs.fixed_costs?'Costos fijos: $'+(+inputs.fixed_costs).toLocaleString('es-AR')+'/mes\n\n':'')+
   (withCost<nProds?'⚠️ '+withCost+'/'+nProds+' con costos. Resultado aproximado.\n\n':'')+
   '_Datos de Shopify AI._ ¿Confirmo y resuelvo? Escribí **sí** o ajustá algún dato.';
 }
 else if(moduleName==='FORECAST'&&inputs.timeseries){
  params={
   timeseries:inputs.timeseries,
   method:'ALL',
   periods_ahead:3
  };
  summary='**📈 Pronóstico de Ventas**\n\n'+
   'Serie temporal: '+inputs.timeseries.length+' meses de datos.\n'+
   'Valores: '+inputs.timeseries.map(function(v){return '$'+r0(v);}).join(', ')+'\n\n'+
   'Método: Todos (SMA, SES, Regresión) — compara y elige el mejor.\n\n'+
   '_Datos de Shopify AI._ ¿Confirmo y resuelvo? Escribí **sí** o ajustá algún dato.';
 }
 else if(moduleName==='FLUJO_CAJA'){
  params={
   opening_balance:inputs.opening_balance||0,
   periods:inputs.periods||6,
   inflows:inputs.inflows||[],
   outflows:inputs.outflows||[]
  };
  var totalIn=(params.inflows||[]).reduce(function(s,i){return s+(+(i.amount||0));},0);
  var totalOut=(params.outflows||[]).reduce(function(s,o){return s+(+(o.amount||0));},0);
  summary='**💵 Flujo de Caja — '+params.periods+' meses**\n\n'+
   '| Concepto | Monto/mes |\n|---|---|\n'+
   '| Saldo inicial | $'+(+params.opening_balance).toLocaleString('es-AR')+' |\n'+
   params.inflows.map(function(i){return'| ✅ '+i.name+' | +$'+(+i.amount).toLocaleString('es-AR')+' |';}).join('\n')+'\n'+
   params.outflows.map(function(o){return'| ❌ '+o.name+' | -$'+(+o.amount).toLocaleString('es-AR')+' |';}).join('\n')+'\n'+
   '| **Neto mensual** | **$'+(totalIn-totalOut).toLocaleString('es-AR')+'** |\n\n'+
   '_Datos de Shopify AI._ ¿Confirmo y resuelvo? Escribí **sí** o ajustá algún dato.';
 }
 else{
  addMsg('a','⚠️ Módulo '+moduleName+' no tiene datos suficientes del análisis.');
  return;
 }

 // Load params into session and go to confirm stage
 session.module=moduleName;
 session.params=params;
 session.stage='confirm';
 session.assumptions=[];
 session.solution=null;
 session.history=session.history||[];
 updUI();
 updateStepper();

 // Show confirmation in chat
 addMsg('u','[Shopify AI → '+moduleName+']');
 addMsg('a',mdToHtml(summary));
 updateQuickButtons();

 // Focus input for quick "sí"
 var inp=document.getElementById('inp');
 if(inp){inp.focus();inp.placeholder='Escribí "sí" para resolver o ajustá datos...';}
}

// F5: SHOPIFY CALLBACK HANDLER (after OAuth redirect back)
(function(){
 var params=new URLSearchParams(window.location.search);
 if(params.get('shopify_connected')==='true'){
  var storeData={
   shop_domain:params.get('shop')||'',
   store_id:params.get('store_id')||'',
   product_count:parseInt(params.get('products')||'0'),
   order_count:parseInt(params.get('orders')||'0'),
   last_sync:new Date().toISOString()
  };
  setShopifyStore(storeData);
  window.history.replaceState({},'',window.location.pathname);
  setTimeout(function(){
   showConnectedStore(storeData);
   alert('Shopify conectado! '+storeData.product_count+' productos y '+storeData.order_count+' órdenes sincronizados.');
  },500);
 }
})();

// F6: UPDATE UI ON LOAD
(function(){
 // Patch enterApp to also update plan UI
 var _origEnterApp=enterApp;
 enterApp=function(){
  _origEnterApp();
  updatePlanUI();
 };
 // If already in app mode, update now
 if(document.body.classList.contains('app-mode')){updatePlanUI();}
})();

// F7: SHOPIFY EMBEDDED MODE DETECTION
// When app is loaded inside Shopify admin (iframe), auto-detect and load store data
(function(){
 var isEmbedded=false;
 try{isEmbedded=window!==window.top;}catch(e){isEmbedded=true;}

 // Also check URL for Shopify params
 var params=new URLSearchParams(window.location.search);
 var shopParam=params.get('shop')||params.get('hmac')?true:false;
 var hostParam=params.get('host');

 // Detect shop domain from referrer or Shopify context
 var shopDomain='';
 if(params.get('shop')){
  shopDomain=params.get('shop');
 } else if(document.referrer&&document.referrer.includes('admin.shopify.com')){
  var refMatch=document.referrer.match(/store\/([^\/]+)/);
  if(refMatch)shopDomain=refMatch[1]+'.myshopify.com';
 }

 if((isEmbedded||shopParam)&&INVOP_CONFIG.API_BASE){
  console.log('[INVOP] Shopify embedded mode detected. Shop:',shopDomain);

  // Mark as embedded
  window._shopifyEmbedded=true;
  window._shopifyDomain=shopDomain;

  // Force show Shopify panel unlocked (they installed the app!)
  var _origUpdatePlan=updatePlanUI;
  updatePlanUI=function(){
   _origUpdatePlan();
   if(window._shopifyEmbedded){
    var shopSec=document.getElementById('shopifySection');
    if(shopSec)shopSec.style.display='block';
    var lockOverlay=document.getElementById('proLockOverlay');
    var lockWrap=document.getElementById('shopifyPanelContent');
    if(lockOverlay)lockOverlay.style.display='none';
    if(lockWrap)lockWrap.classList.remove('locked');
    var badge=document.getElementById('planBadge');
    if(badge){badge.className='plan-badge pro';badge.textContent='SHOPIFY';}
   }
  };

  // Auto-load store data when entering app
  var _origEnterApp2=enterApp;
  enterApp=function(){
   _origEnterApp2();
   if(window._shopifyDomain){
    loadShopifyStoreData(window._shopifyDomain);
   }
  };

  // If already in app mode, load now
  if(document.body.classList.contains('app-mode')&&shopDomain){
   loadShopifyStoreData(shopDomain);
  }
 }
})();

function loadShopifyStoreData(shop){
 if(!INVOP_CONFIG.API_BASE||!shop)return;
 console.log('[INVOP] Loading store data for:',shop);

 fetch(INVOP_CONFIG.API_BASE+'/api/shopify/store-data?shop='+encodeURIComponent(shop))
 .then(function(r){return r.json();})
 .then(function(data){
  if(data.connected&&data.store){
   // Store locally
   setShopifyStore({
    shop_domain:data.store.shop_domain,
    store_id:data.store.id,
    product_count:data.store.products_count||data.products.length,
    order_count:data.store.orders_count||data.orders.length,
    last_sync:data.store.last_sync
   });
   showConnectedStore(getShopifyStore());

   // Store products for AI usage
   window._shopifyProducts=data.products||[];
   window._shopifyOrders=data.orders||[];

   console.log('[INVOP] Store data loaded:',data.products.length,'products,',data.orders.length,'orders');

   // Show inline insight if products available
   if(data.products.length>0){
    showShopifyProductsInsight(data.products);
   }
  } else if(data.needs_sync){
   // Store exists in Shopify but no data synced yet — trigger sync
   console.log('[INVOP] Store not synced yet, needs initial sync');
   var nc=document.getElementById('shopifyNotConnected');
   if(nc){
    nc.innerHTML='<h4>🔄 Sincronizando datos...</h4><p style="font-size:.72rem;color:var(--ts)">Primera vez — estamos cargando tus productos y órdenes.</p>';
   }
  }
 })
 .catch(function(err){
  console.log('[INVOP] Store data fetch error:',err);
 });
}

function showShopifyProductsInsight(products){
 var container=document.getElementById('aiInsightsContainer');
 if(!container)return;
 var total=products.length;
 var withCost=products.filter(function(p){return p.cost_per_item&&p.price;}).length;
 var outOfStock=products.filter(function(p){return p.inventory_quantity<=0;}).length;

 var html='<div class="ai-insight-card" style="border-color:var(--ac)">';
 html+='<h5>🛍️ Tu tienda</h5>';
 html+='<p>'+total+' productos cargados';
 if(outOfStock>0)html+=' · <span style="color:var(--dn)">'+outOfStock+' sin stock</span>';
 if(withCost>0)html+=' · '+withCost+' con costo registrado';
 html+='</p>';
 html+='<button class="shopify-connect-btn" style="margin-top:.5rem;background:linear-gradient(135deg,var(--p),var(--ac));font-size:.72rem;padding:.4rem" onclick="autoAnalyzeShopify()">Analizar con AI</button>';
 html+='</div>';
 container.innerHTML=html;
}

function autoAnalyzeShopify(){
 var store=getShopifyStore();
 var u=getUser();
 if(!store){alert('Conectá tu tienda Shopify primero.');return;}

 // Get any saved user costs
 var savedCosts={};
 try{savedCosts=JSON.parse(localStorage.getItem('invop_user_costs'))||{};}catch(e){}

 showModal('aiAnalysisModal');
 var el=document.getElementById('aiAnalysisContent');
 if(el)el.innerHTML='<div style="text-align:center;padding:2rem"><div style="width:40px;height:40px;border:3px solid var(--ac);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div><p style="margin-top:1rem;color:var(--ts);font-size:.8rem">Analizando tu tienda...</p></div>';

 fetch(INVOP_CONFIG.API_BASE+'/api/ai/analyze',{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({
   store_id:store.store_id||null,
   user_id:(u&&u.email)||'tmichelich@gmail.com',
   modules:['STOCK','FORECAST','RENTABILIDAD','FLUJO_CAJA'],
   user_costs:Object.keys(savedCosts).length?savedCosts:null
  })
 })
 .then(function(r){return r.json();})
 .then(function(data){
  if(data.error){throw new Error(data.error);}
  window._lastAnalysis=data.analysis;
  renderSmartAnalysis(data.analysis);
 })
 .catch(function(err){
  if(el)el.innerHTML='<div style="text-align:center;padding:1.5rem"><p style="color:var(--dn);font-size:.85rem">Error: '+err.message+'</p><button class="shopify-connect-btn" style="margin-top:1rem;max-width:200px" onclick="closeModal(\'aiAnalysisModal\')">Cerrar</button></div>';
 });
}

function renderSmartAnalysis(analysis){
 var el=document.getElementById('aiAnalysisContent');
 if(!el)return;
 var html='';

 // General insights
 html+='<div class="ai-insight-card" style="border-color:var(--ac)"><h5>📊 Tu tienda Shopify</h5><p>'+analysis.general_insights+'</p></div>';

 // ── COST INPUT FORM ──────────────────────────────────
 if(analysis.missing_data&&analysis.missing_data.length>0){
  html+='<div class="ai-insight-card" style="border-color:#f59e0b;background:rgba(245,158,11,0.05)">';
  html+='<h5>⚡ Completá estos datos para mejores resultados</h5>';
  html+='<div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem">';

  // Single value fields
  for(var i=0;i<analysis.missing_data.length;i++){
   var md=analysis.missing_data[i];
   if(md.input_type==='single_value'){
    html+='<div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">';
    html+='<label style="font-size:.73rem;color:var(--ts);min-width:200px;flex:1">'+md.description+'</label>';
    html+='<input type="number" id="cost_'+md.field+'" placeholder="$0" style="width:90px;padding:.35rem .5rem;border-radius:6px;border:1px solid var(--bd);background:var(--bg);color:var(--tx);font-size:.75rem">';
    html+='</div>';
   }
  }

  // Per-product costs
  var needsProductCost=analysis.missing_data.some(function(m){return m.field==='cost_per_item';});
  if(needsProductCost&&analysis.product_summary){
   html+='<div style="margin-top:.4rem;border-top:1px solid var(--bd);padding-top:.5rem">';
   html+='<p style="font-size:.73rem;color:var(--ts);margin-bottom:.3rem">Costo unitario por producto:</p>';

   // Excel upload
   html+='<div style="display:flex;gap:.5rem;margin-bottom:.4rem;align-items:center">';
   html+='<label style="cursor:pointer;font-size:.7rem;padding:.3rem .7rem;border-radius:6px;background:var(--card);border:1px dashed var(--ac);color:var(--ac);display:inline-flex;align-items:center;gap:.3rem" onclick="document.getElementById(\'costExcelUpload\').click()">📎 Subir Excel con costos</label>';
   html+='<input type="file" id="costExcelUpload" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleCostExcelUpload(this)">';
   html+='<span id="excelUploadStatus" style="font-size:.65rem;color:var(--ts)"></span>';
   html+='</div>';

   // Manual per-product inputs
   html+='<details><summary style="font-size:.72rem;color:var(--ac);cursor:pointer">O cargar manualmente</summary>';
   html+='<div style="max-height:200px;overflow-y:auto;margin-top:.3rem">';
   for(var j=0;j<Math.min(analysis.product_summary.length,15);j++){
    var p=analysis.product_summary[j];
    html+='<div style="display:flex;align-items:center;gap:.4rem;padding:.25rem 0;border-bottom:1px solid var(--bd)">';
    html+='<span style="font-size:.7rem;color:var(--ts);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+p.title+'">'+p.title+' <span style="color:var(--ac)">$'+p.price+'</span></span>';
    html+='<input type="number" id="pcost_'+p.shopify_id+'" placeholder="costo" style="width:75px;padding:.25rem .4rem;border-radius:4px;border:1px solid var(--bd);background:var(--bg);color:var(--tx);font-size:.7rem">';
    html+='</div>';
   }
   html+='</div></details>';
   html+='</div>';
  }

  html+='<button class="shopify-connect-btn" style="margin-top:.5rem;background:linear-gradient(135deg,#f59e0b,#f97316);font-size:.75rem;padding:.45rem .8rem" onclick="saveCostsAndReanalyze()">Guardar costos y re-analizar</button>';
  html+='</div></div>';
 }

 // ── MODULE CARDS WITH CHECKLIST ──────────────────────
 if(analysis.modules){
  var icons={STOCK:'📦',FORECAST:'📈',RENTABILIDAD:'💰',FLUJO_CAJA:'💵'};
  // Build checklist per module: all data items with status
  var moduleChecklist={
   RENTABILIDAD:[
    {label:'Productos',field:null},
    {label:'Precios de venta',field:null},
    {label:'Costos unitarios',field:'cost_per_item'},
    {label:'Costos fijos mensuales',field:'fixed_costs'},
    {label:'Volumen de ventas',field:'demand_data'}
   ],
   STOCK:[
    {label:'Productos',field:null},
    {label:'Niveles de inventario',field:null},
    {label:'Costo por pedido',field:'ordering_cost'},
    {label:'Costo de almacenamiento',field:'holding_cost_pct'}
   ],
   FORECAST:[
    {label:'Historial de ventas (min 3 meses)',field:'sales_history'}
   ],
   FLUJO_CAJA:[
    {label:'Productos',field:null},
    {label:'Ingresos mensuales',field:'demand_data'},
    {label:'Costos fijos',field:'fixed_costs'}
   ]
  };

  for(var k=0;k<analysis.modules.length;k++){
   var mod=analysis.modules[k];
   var isComplete=mod.needs.length===0;
   var borderColor=isComplete?'var(--ac)':'var(--bd)';

   html+='<div class="ai-insight-card" style="border-color:'+borderColor+'">';
   html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem">';
   html+='<h5 style="margin:0">'+(icons[mod.module]||'🔧')+' '+mod.module+'</h5>';
   var tagClass=mod.priority==='high'?'high':mod.priority==='medium'?'medium':'low';
   html+='<span class="insight-tag '+tagClass+'">'+mod.priority+'</span>';
   html+='</div>';

   // Checklist — each item is ✓ or ✗ based on needs array
   var checklist=moduleChecklist[mod.module]||[];
   if(checklist.length>0){
    html+='<div style="margin:.3rem 0;font-size:.7rem">';
    for(var ci=0;ci<checklist.length;ci++){
     var item=checklist[ci];
     var isMissing=item.field&&mod.needs.indexOf(item.field)>=0;
     if(isMissing){
      html+='<div style="color:#ef4444;padding:.1rem 0">✗ '+item.label+'</div>';
     } else {
      html+='<div style="color:#22c55e;padding:.1rem 0">✓ '+item.label+'</div>';
     }
    }
    html+='</div>';
   }

   html+='<p style="font-size:.73rem;color:var(--ts);margin:.3rem 0">'+mod.insights+'</p>';

   // Button: green if complete, amber/red if incomplete
   if(mod.inputs){
    if(isComplete){
     html+='<button class="shopify-connect-btn" style="margin-top:.4rem;background:linear-gradient(135deg,var(--p),var(--ac));font-size:.72rem;padding:.35rem .8rem" onclick="closeModal(\'aiAnalysisModal\');loadAIModule(\''+mod.module+'\','+JSON.stringify(JSON.stringify(mod.inputs))+')">✓ Resolver con datos completos</button>';
    } else {
     html+='<div style="margin-top:.4rem">';
     html+='<button class="shopify-connect-btn" style="background:linear-gradient(135deg,#dc2626,#f97316);font-size:.72rem;padding:.35rem .8rem;opacity:.9" onclick="if(confirm(\'Faltan datos. El resultado será aproximado, no óptimo. ¿Continuar?\')){closeModal(\'aiAnalysisModal\');loadAIModule(\''+mod.module+'\','+JSON.stringify(JSON.stringify(mod.inputs))+');}">⚠ Resolver (resultado aproximado)</button>';
     html+='<p style="font-size:.62rem;color:#f59e0b;margin-top:.2rem">Completá los datos faltantes arriba para un resultado óptimo</p>';
     html+='</div>';
    }
   } else {
    html+='<p style="font-size:.68rem;color:#ef4444;margin-top:.3rem">✗ Faltan datos esenciales para este módulo</p>';
   }

   html+='</div>';
  }
 }

 // Recommendations
 if(analysis.recommendations&&analysis.recommendations.length){
  html+='<div class="ai-insight-card"><h5>💡 Recomendaciones</h5>';
  for(var r=0;r<analysis.recommendations.length;r++){
   html+='<p style="font-size:.75rem;color:var(--ts);margin:.3rem 0;padding-left:.5rem;border-left:2px solid var(--ac)">'+analysis.recommendations[r]+'</p>';
  }
  html+='</div>';
 }

 html+='<button class="shopify-connect-btn" style="margin-top:.8rem;background:var(--card);border:1px solid var(--bd);color:var(--tx)" onclick="closeModal(\'aiAnalysisModal\')">Cerrar</button>';
 el.innerHTML=html;
 renderSidebarInsights(analysis);
}

// Excel upload handler for costs
function handleCostExcelUpload(input){
 var file=input.files[0];
 if(!file)return;
 var status=document.getElementById('excelUploadStatus');
 if(status)status.textContent='Leyendo '+file.name+'...';

 var reader=new FileReader();
 reader.onload=function(e){
  try{
   var data=e.target.result;
   var rows=[];

   if(file.name.endsWith('.csv')||file.name.endsWith('.tsv')){
    // Parse CSV
    var text=new TextDecoder().decode(data);
    var lines=text.split(/\r?\n/).filter(function(l){return l.trim();});
    for(var i=0;i<lines.length;i++){
     var cols=lines[i].split(/[,;\t]/);
     rows.push(cols.map(function(c){return c.trim().replace(/^"|"$/g,'');}));
    }
   } else {
    // For xlsx we need SheetJS — try loading it
    if(typeof XLSX==='undefined'){
     var script=document.createElement('script');
     script.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
     script.onload=function(){parseExcelData(data,status);};
     document.head.appendChild(script);
     return;
    }
    parseExcelData(data,status);
    return;
   }

   matchCostRows(rows,status);
  }catch(err){
   if(status)status.textContent='Error: '+err.message;
  }
 };
 reader.readAsArrayBuffer(file);
}

function parseExcelData(data,status){
 try{
  var wb=XLSX.read(data,{type:'array'});
  var ws=wb.Sheets[wb.SheetNames[0]];
  var rows=XLSX.utils.sheet_to_json(ws,{header:1});
  matchCostRows(rows,status);
 }catch(err){
  if(status)status.textContent='Error leyendo Excel: '+err.message;
 }
}

function matchCostRows(rows,status){
 if(!rows||rows.length<2){
  if(status)status.textContent='El archivo está vacío o no tiene datos.';
  return;
 }

 // Try to find name/product column and cost column
 var header=rows[0].map(function(h){return(h||'').toString().toLowerCase();});
 var nameCol=-1,costCol=-1;

 for(var c=0;c<header.length;c++){
  if(/product|nombre|titulo|title|sku|item/i.test(header[c]))nameCol=c;
  if(/cost|costo|precio.?compra|unit.?cost|costo.?unit/i.test(header[c]))costCol=c;
 }

 // Fallback: assume col 0 = name, col 1 = cost
 if(nameCol===-1)nameCol=0;
 if(costCol===-1)costCol=1;

 var matched=0;
 var products=window._lastAnalysis&&window._lastAnalysis.product_summary?window._lastAnalysis.product_summary:[];

 for(var r=1;r<rows.length;r++){
  var rowName=(rows[r][nameCol]||'').toString().toLowerCase().trim();
  var rowCost=parseFloat(rows[r][costCol]);
  if(!rowName||isNaN(rowCost)||rowCost<=0)continue;

  // Try to match with a product
  for(var p=0;p<products.length;p++){
   var prodTitle=products[p].title.toLowerCase();
   if(prodTitle.indexOf(rowName)>=0||rowName.indexOf(prodTitle)>=0||
      (rowName.length>3&&prodTitle.indexOf(rowName.substring(0,Math.min(rowName.length,15)))>=0)){
    var inp=document.getElementById('pcost_'+products[p].shopify_id);
    if(inp){inp.value=rowCost;matched++;}
    break;
   }
  }
 }

 if(status){
  if(matched>0){
   status.textContent='✓ '+matched+' producto(s) matcheados de '+(rows.length-1)+' filas.';
   status.style.color='#22c55e';
  } else {
   status.textContent='No se pudo matchear automáticamente. Formato esperado: columna "Producto" y columna "Costo".';
   status.style.color='#f59e0b';
  }
 }
}

function saveCostsAndReanalyze(){
 var costs={};
 // Single values
 var fields=['ordering_cost','holding_cost_pct','fixed_costs'];
 for(var i=0;i<fields.length;i++){
  var inp=document.getElementById('cost_'+fields[i]);
  if(inp&&inp.value)costs[fields[i]]=parseFloat(inp.value);
 }
 // Per-product costs
 if(window._lastAnalysis&&window._lastAnalysis.product_summary){
  for(var j=0;j<window._lastAnalysis.product_summary.length;j++){
   var p=window._lastAnalysis.product_summary[j];
   var pinp=document.getElementById('pcost_'+p.shopify_id);
   if(pinp&&pinp.value){
    if(!costs[p.shopify_id])costs[p.shopify_id]={};
    costs[p.shopify_id]={cost:parseFloat(pinp.value)};
   }
  }
 }
 // Save for future
 localStorage.setItem('invop_user_costs',JSON.stringify(costs));
 // Re-analyze with costs
 autoAnalyzeShopify();
}

console.log('[INVOP AI] Bloque F loaded — Shopify + AI + Plans integration active.');
</script>

</body>
</html>
